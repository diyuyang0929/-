<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼€å¿ƒå†œåœº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .crop-plot {
            transition: all 0.3s ease;
        }
        .crop-plot:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }
        .progress-bar {
            transition: width 0.5s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .notification {
            animation: slideIn 0.5s forwards, stay 2s 0.5s forwards, slideOut 0.5s 2.5s forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes stay {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        /* æ·»åŠ ä¿å­˜æŒ‡ç¤ºå™¨æ ·å¼ */
        .save-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 100;
        }
        .save-indicator.show {
            opacity: 1;
        }
        /* åœ°åŒºèƒŒæ™¯æ ·å¼ */
        body.bg-north_china {
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            background-image: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-south_china {
            background: linear-gradient(135deg, #f9f6e7 0%, #f7e8aa 100%);
            background-image: url('https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-east_china {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            background-image: url('https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-west_china {
            background: linear-gradient(135deg, #fceabb 0%, #f8b500 100%);
            background-image: url('https://images.unsplash.com/photo-1502082553048-f009c37129b9?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-japan {
            background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
            background-image: url('https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-us_midwest {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            background-image: url('https://images.unsplash.com/photo-1465101178521-c1a9136a3b99?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-europe {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            background-image: url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        
        /* å¤©æ°”æ•ˆæœæ ·å¼ */
        .weather-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        /* æ™´å¤©æ•ˆæœ - é˜³å…‰ç…§å°„ */
        .weather-sunny::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 0, 0.1) 0%, transparent 70%);
            animation: sunnyGlow 3s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes sunnyGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        
        /* é›¨å¤©æ•ˆæœ - é›¨æ»´åŠ¨ç”» */
        .weather-rainy::before {
            content: 'ğŸŒ§ï¸';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2rem;
            animation: rainFall 1s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes rainFall {
            0% { transform: translateY(-100px); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
        }
        
        /* æš´é›¨æ•ˆæœ - å¯†é›†é›¨æ»´å’Œé—ªç”µ */
        .weather-stormy::before {
            content: 'â›ˆï¸';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2.5rem;
            animation: stormRain 0.8s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        .weather-stormy::after {
            content: 'âš¡';
            position: fixed;
            top: 20%;
            left: 30%;
            font-size: 4rem;
            animation: lightning 2s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes stormRain {
            0% { transform: translateY(-100px); opacity: 0; }
            5% { opacity: 1; }
            95% { opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
        }
        
        @keyframes lightning {
            0%, 90% { opacity: 0; }
            95% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* å¹²æ—±æ•ˆæœ - çƒ­æµªæ‰­æ›² */
        .weather-drought::before {
            content: 'ğŸ”¥';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2rem;
            animation: heatWave 2s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes heatWave {
            0%, 100% { 
                opacity: 0.3; 
                transform: scale(1) rotate(0deg); 
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.1) rotate(5deg); 
            }
        }
        
        /* å°é£æ•ˆæœ - æ—‹è½¬é£ */
        .weather-typhoon::before {
            content: 'ğŸŒ€';
            position: fixed;
            top: 20%;
            left: 20%;
            font-size: 3rem;
            animation: typhoonSpin 1.5s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        .weather-typhoon::after {
            content: 'ğŸ’¨';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 1.5rem;
            animation: windBlow 1s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes typhoonSpin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        @keyframes windBlow {
            0% { transform: translateX(-100px) translateY(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100vw) translateY(50px); opacity: 0; }
        }
        
        /* å½©è™¹å¤©æ•ˆæœ - å½©è™¹è‰²å½© */
        .weather-rainbow::before {
            content: 'ğŸŒˆ';
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 4rem;
            animation: rainbowGlow 3s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes rainbowGlow {
            0%, 100% { 
                opacity: 0.6; 
                transform: translateX(-50%) scale(1); 
            }
            50% { 
                opacity: 1; 
                transform: translateX(-50%) scale(1.1); 
            }
        }
        
        /* æ²™å°˜æš´æ•ˆæœ - æ²™å°˜é£èˆ */
        .weather-sandstorm::before {
            content: 'ğŸŒªï¸';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2rem;
            animation: sandstormSwirl 2s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes sandstormSwirl {
            0% { 
                transform: translateX(-50px) translateY(0) rotate(0deg); 
                opacity: 0.3; 
            }
            50% { 
                transform: translateX(50px) translateY(50px) rotate(180deg); 
                opacity: 0.7; 
            }
            100% { 
                transform: translateX(-50px) translateY(100px) rotate(360deg); 
                opacity: 0.3; 
            }
        }
        /* å¡ç‰‡å’ŒæŒ‰é’®ç¾åŒ– */
        .card-strong {
            background: rgba(255,255,255,0.92);
            border-radius: 1.25rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
            border: 1.5px solid rgba(255,255,255,0.18);
            transition: box-shadow 0.3s, transform 0.2s;
        }
        .card-strong:hover {
            box-shadow: 0 16px 48px 0 rgba(31, 38, 135, 0.25);
            transform: translateY(-2px) scale(1.01);
        }
        .btn-strong {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            color: #fff;
            font-weight: bold;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px 0 rgba(67,233,123,0.15);
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
        }
        .btn-strong:hover {
            background: linear-gradient(90deg, #38f9d7 0%, #43e97b 100%);
            box-shadow: 0 4px 16px 0 rgba(67,233,123,0.25);
            transform: scale(1.05);
        }

        /* å•†åº—æ ‡ç­¾æŒ‰é’®æ ·å¼ */
        .shop-tab-btn {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            color: #374151;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }

        .shop-tab-btn:hover {
            background: linear-gradient(135deg, #d1d5db, #9ca3af);
            transform: translateY(-1px);
        }

        .shop-tab-btn.active {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* å•†åº—å†…å®¹åŒºåŸŸæ ·å¼ */
        .shop-content {
            transition: all 0.3s ease;
        }

        .shop-content.active {
            display: block !important;
        }
        .title-strong {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 2px;
            color: #1a4d2e;
            text-shadow: 0 2px 8px rgba(67,233,123,0.15);
        }
        .subtitle-strong {
            font-size: 1.25rem;
            font-weight: 700;
            color: #388e3c;
        }
        /* ç™»å½•å¼¹çª—ç¾åŒ– */
        #login-modal input[type="text"], #login-modal input[type="password"] {
            font-size: 1.1rem;
            border-radius: 1rem;
            border: 1.5px solid #b2dfdb;
            box-shadow: 0 2px 8px 0 rgba(67,233,123,0.08);
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            transition: border 0.2s, box-shadow 0.2s;
        }
        #login-modal input[type="text"]:focus, #login-modal input[type="password"]:focus {
            border: 2px solid #43e97b;
            box-shadow: 0 4px 16px 0 rgba(67,233,123,0.15);
        }
        #login-modal .register-btn {
            border-radius: 50%;
            font-size: 0.95rem;
            font-weight: bold;
            box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.10);
            transition: box-shadow 0.2s, transform 0.15s, background 0.2s;
            padding: 0;
            margin-bottom: 0;
            min-width: 0;
            flex: 1 1 0;
            margin-right: 0;
            width: 48px;
            height: 48px;
            justify-content: center;
            align-items: center;
            display: flex;
        }
        #login-modal .register-btn:not(:last-child) {
            margin-right: 0.5rem;
        }
        #login-modal .register-btn i {
            font-size: 1.5rem;
            margin: 0;
        }
        #login-modal .register-btn:hover {
            box-shadow: 0 8px 24px 0 rgba(67,233,123,0.18);
            transform: translateY(-2px) scale(1.08);
            filter: brightness(1.05);
        }
        #login-modal .w-full.flex.flex-row.items-center.justify-between.gap-2.mt-2 {
            gap: 0.7rem;
        }
        #login-modal .w-full.flex.items-center.my-4 {
            margin: 1.2rem 0 1.1rem 0;
        }
        #login-modal hr {
            margin: 1.2rem 0 1.1rem 0;
        }
        #login-modal input::placeholder {
            color: #bdbdbd;
            font-size: 1rem;
        }
        #login-btn {
            border-radius: 1.2rem;
            font-size: 1.1rem;
            font-weight: bold;
            box-shadow: 0 2px 8px 0 rgba(67,233,123,0.10);
            transition: box-shadow 0.2s, background 0.2s, transform 0.1s;
        }
        #login-btn:hover {
            background: #43e97b;
            box-shadow: 0 8px 24px 0 rgba(67,233,123,0.18);
            transform: scale(1.04);
        }
        /* é€€å‡ºç™»å½•æŒ‰é’®æ ·å¼åŠ å¼º */
        #logout-btn {
            border-radius: 1.5rem;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.10);
            transition: box-shadow 0.2s, background 0.2s, transform 0.1s;
        }
        #logout-btn:hover {
            background: #e0f2f1;
            box-shadow: 0 8px 24px 0 rgba(67,233,123,0.18);
            transform: scale(1.04);
        }
        
        /* éšæœºäº‹ä»¶åŠ¨ç”»æ ·å¼ */
        .event-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 1000;
            animation: eventPopup 3s ease-in-out forwards;
            text-align: center;
            min-width: 300px;
        }
        
        @keyframes eventPopup {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        
        /* é‡‘é›¨åŠ¨ç”» */
        .rainbow-rain {
            position: relative;
            overflow: hidden;
        }
        .rainbow-rain::before {
            content: 'ğŸŒ§ï¸';
            position: absolute;
            top: -20px;
            left: 0;
            width: 100%;
            height: 100%;
            animation: goldenRain 2s linear infinite;
            font-size: 2rem;
            color: #ffd700;
        }
        
        @keyframes goldenRain {
            0% { transform: translateY(-100px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }
        
        /* ç²¾çµé—ªçƒåŠ¨ç”» */
        .fairy-sparkle {
            animation: fairySparkle 1.5s ease-in-out;
        }
        
        @keyframes fairySparkle {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.2); filter: brightness(1.5) hue-rotate(60deg); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        
        /* è¥å…»å‘å…‰åŠ¨ç”» */
        .nutrient-glow {
            animation: nutrientGlow 2s ease-in-out infinite;
        }
        
        @keyframes nutrientGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(0, 255, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.8); }
        }
        
        /* æ—¶é’Ÿæ—‹è½¬åŠ¨ç”» */
        .clock-spin {
            animation: clockSpin 1s linear infinite;
        }
        
        @keyframes clockSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* è™«å®³çˆ¬è¡ŒåŠ¨ç”» */
        .pest-crawl {
            animation: pestCrawl 1s ease-in-out;
        }
        
        .pest-crawl::after {
            content: 'ğŸ›';
            position: absolute;
            top: 0;
            left: 0;
            animation: bugCrawl 2s linear infinite;
        }
        
        @keyframes pestCrawl {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(0.9); filter: brightness(0.7); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        
        @keyframes bugCrawl {
            0% { transform: translateX(-20px) translateY(0); }
            25% { transform: translateX(0) translateY(-5px); }
            50% { transform: translateX(20px) translateY(0); }
            75% { transform: translateX(0) translateY(5px); }
            100% { transform: translateX(-20px) translateY(0); }
        }
        
        /* ç—…å®³æ‰©æ•£åŠ¨ç”» */
        .disease-spread {
            animation: diseaseSpread 2s ease-in-out;
        }
        
        @keyframes diseaseSpread {
            0% { filter: brightness(1) saturate(1); }
            50% { filter: brightness(0.8) saturate(0.5) hue-rotate(180deg); }
            100% { filter: brightness(1) saturate(1); }
        }
        
        /* éœœå†»å†»ç»“åŠ¨ç”» */
        .frost-freeze {
            animation: frostFreeze 1.5s ease-in-out;
        }
        
        .frost-freeze::after {
            content: 'â„ï¸';
            position: absolute;
            top: 0;
            left: 0;
            animation: frostFall 2s linear infinite;
        }
        
        @keyframes frostFreeze {
            0% { filter: brightness(1) saturate(1); }
            100% { filter: brightness(0.7) saturate(0.3) hue-rotate(180deg); }
        }
        
        @keyframes frostFall {
            0% { transform: translateY(-10px) rotate(0deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(10px) rotate(180deg); opacity: 0; }
        }
        
        /* æ‚è‰ç”Ÿé•¿åŠ¨ç”» */
        .weed-grow {
            animation: weedGrow 2s ease-in-out;
        }
        
        .weed-grow::after {
            content: 'ğŸŒ¿';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            animation: weedSprout 1.5s ease-out;
        }
        
        @keyframes weedGrow {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        
        @keyframes weedSprout {
            0% { transform: translateX(-50%) scale(0); opacity: 0; }
            50% { transform: translateX(-50%) scale(1.2); opacity: 1; }
            100% { transform: translateX(-50%) scale(1); opacity: 0.8; }
        }
        
        /* è¿·é›¾æ—‹è½¬åŠ¨ç”» */
        .fog-swirl {
            animation: fogSwirl 3s ease-in-out infinite;
        }
        
        @keyframes fogSwirl {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        /* åœŸå£¤å˜åŒ–åŠ¨ç”» */
        .soil-shift {
            animation: soilShift 2s ease-in-out;
        }
        
        @keyframes soilShift {
            0% { filter: brightness(1) saturate(1); }
            50% { filter: brightness(1.2) saturate(1.3) hue-rotate(30deg); }
            100% { filter: brightness(1) saturate(1); }
        }
        
        /* äº‹ä»¶å½±å“æŒ‡ç¤ºå™¨ */
        .event-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            animation: eventIndicator 2s ease-in-out infinite;
            z-index: 10;
        }
        
        @keyframes eventIndicator {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        @keyframes lightning {
            0%, 90% { opacity: 0; }
            95% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* ç‰§åœºåŠ¨ç‰©åŠ¨ç”»æ•ˆæœ */
        .ranch-animal {
            position: relative;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ranch-animal:hover {
            transform: scale(1.2);
            filter: brightness(1.2);
        }
        
        /* åŠ¨ç‰©ç§»åŠ¨åŠ¨ç”» */
        .animal-walk {
            animation: walkAround 8s linear infinite;
        }
        
        @keyframes walkAround {
            0% { transform: translateX(0px) translateY(0px); }
            25% { transform: translateX(20px) translateY(-10px); }
            50% { transform: translateX(-15px) translateY(5px); }
            75% { transform: translateX(10px) translateY(-5px); }
            100% { transform: translateX(0px) translateY(0px); }
        }
        
        /* åŠ¨ç‰©è·³è·ƒåŠ¨ç”» */
        .animal-bounce {
            animation: bounceUp 2s ease-in-out infinite;
        }
        
        @keyframes bounceUp {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        /* åŠ¨ç‰©æ‘‡æ‘†åŠ¨ç”» */
        .animal-sway {
            animation: sway 3s ease-in-out infinite;
        }
        
        @keyframes sway {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
        }
        
        /* åŠ¨ç‰©å‘¼å¸åŠ¨ç”» */
        .animal-breathe {
            animation: breathe 4s ease-in-out infinite;
        }
        
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* åŠ¨ç‰©çœ¨çœ¼åŠ¨ç”» */
        .animal-blink {
            animation: blink 5s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 90%, 100% { opacity: 1; }
            95% { opacity: 0.3; }
        }
        
        /* ç‰§åœºç¯å¢ƒåŠ¨ç”» */
        .ranch-environment {
            position: relative;
            overflow: hidden;
        }
        
        /* è‰åœ°æ‘‡æ‘†æ•ˆæœ */
        .grass-sway {
            animation: grassWave 6s ease-in-out infinite;
        }
        
        @keyframes grassWave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(1deg); }
            75% { transform: rotate(-1deg); }
        }
        
        /* äº‘æœµé£˜åŠ¨æ•ˆæœ */
        .cloud-float {
            animation: cloudMove 20s linear infinite;
        }
        
        @keyframes cloudMove {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(100px); }
        }
        
        /* åŠ¨ç‰©å¥åº·çŠ¶æ€åŠ¨ç”» */
        .animal-healthy {
            animation: healthyGlow 3s ease-in-out infinite;
        }
        
        @keyframes healthyGlow {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 5px rgba(0, 255, 0, 0.3)); }
            50% { filter: brightness(1.1) drop-shadow(0 0 10px rgba(0, 255, 0, 0.5)); }
        }
        
        .animal-sick {
            animation: sickShake 2s ease-in-out infinite;
        }
        
        @keyframes sickShake {
            0%, 100% { transform: translateX(0px); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        
        /* ç‰§åœºå¤§æ°”æ•ˆæœ */
        .ranch-atmosphere {
            position: relative;
        }
        
        .ranch-atmosphere::before {
            content: 'ğŸŒ¾';
            position: absolute;
            top: 10%;
            left: 10%;
            font-size: 1.5rem;
            animation: grassWave 4s ease-in-out infinite;
            opacity: 0.6;
        }
        
        .ranch-atmosphere::after {
            content: 'â˜ï¸';
            position: absolute;
            top: 5%;
            right: 20%;
            font-size: 2rem;
            animation: cloudMove 15s linear infinite;
            opacity: 0.7;
        }
        
        /* å¤©æ°”æ•ˆæœå¢å¼º */
        .sunny-effect {
            background: radial-gradient(circle at 80% 20%, rgba(255, 255, 0, 0.1) 0%, transparent 50%);
            animation: sunnyShine 4s ease-in-out infinite;
        }
        
        @keyframes sunnyShine {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        .cloudy-effect {
            background: linear-gradient(135deg, rgba(200, 200, 200, 0.2) 0%, rgba(150, 150, 150, 0.1) 100%);
        }
        
        .rainy-effect {
            background: linear-gradient(135deg, rgba(0, 100, 200, 0.1) 0%, rgba(0, 50, 150, 0.05) 100%);
            animation: rainEffect 1s linear infinite;
        }
        
        .rainy-effect::before {
            content: 'ğŸ’§';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 1rem;
            animation: rainDrop 2s linear infinite;
            opacity: 0.6;
        }
        
        @keyframes rainDrop {
            0% { transform: translateY(-20px); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(100px); opacity: 0; }
        }
        
        .snowy-effect {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(200, 200, 255, 0.1) 100%);
        }
        
        .snowy-effect::before {
            content: 'â„ï¸';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 1.5rem;
            animation: snowFall 3s linear infinite;
            opacity: 0.8;
        }
        
        @keyframes snowFall {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(100px) rotate(360deg); opacity: 0; }
        }
        
        /* ç‰§åœºäº’åŠ¨æ•ˆæœ */
        .ranch-animal:hover::after {
            content: 'ğŸ’•';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 1rem;
            animation: loveFloat 1s ease-out forwards;
        }
        
        @keyframes loveFloat {
            0% { transform: translateY(0px); opacity: 1; }
            100% { transform: translateY(-20px); opacity: 0; }
        }
        
        /* åŠ¨ç‰©å¥åº·çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .health-indicator {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            border-radius: 2px;
            background: #ddd;
        }
        
        .health-indicator::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .health-high::after {
            background: #10b981;
        }
        
        .health-medium::after {
            background: #f59e0b;
        }
        
        .health-low::after {
            background: #ef4444;
        }
        
        @keyframes snowFall {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(100px) rotate(360deg); opacity: 0; }
        }
        
        /* å¹²æ—±æ•ˆæœ */
        .drought-effect {
            background: linear-gradient(135deg, rgba(255, 100, 0, 0.2) 0%, rgba(255, 150, 0, 0.1) 100%);
            animation: heatWave 3s ease-in-out infinite;
        }
        
        @keyframes heatWave {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(10deg); }
        }
        
        /* å°é£æ•ˆæœ */
        .typhoon-effect {
            background: linear-gradient(135deg, rgba(50, 50, 100, 0.3) 0%, rgba(100, 100, 150, 0.2) 100%);
            animation: typhoonSpin 2s linear infinite;
        }
        
        .typhoon-effect::before {
            content: 'ğŸŒªï¸';
            position: absolute;
            top: 20%;
            left: 30%;
            font-size: 3rem;
            animation: typhoonMove 4s linear infinite;
            opacity: 0.7;
        }
        
        @keyframes typhoonSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes typhoonMove {
            0% { transform: translateX(0px) rotate(0deg); }
            25% { transform: translateX(50px) rotate(90deg); }
            50% { transform: translateX(0px) rotate(180deg); }
            75% { transform: translateX(-50px) rotate(270deg); }
            100% { transform: translateX(0px) rotate(360deg); }
        }
        
        /* å½©è™¹å¤©æ•ˆæœ */
        .rainbow-effect {
            background: linear-gradient(135deg, 
                rgba(255, 0, 0, 0.1) 0%, 
                rgba(255, 165, 0, 0.1) 16.66%, 
                rgba(255, 255, 0, 0.1) 33.33%, 
                rgba(0, 255, 0, 0.1) 50%, 
                rgba(0, 0, 255, 0.1) 66.66%, 
                rgba(75, 0, 130, 0.1) 83.33%, 
                rgba(238, 130, 238, 0.1) 100%);
            animation: rainbowShimmer 4s ease-in-out infinite;
        }
        
        @keyframes rainbowShimmer {
            0%, 100% { opacity: 0.8; filter: brightness(1); }
            50% { opacity: 1; filter: brightness(1.2); }
        }
        
        /* æ²™å°˜æš´æ•ˆæœ */
        .sandstorm-effect {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.3) 0%, rgba(160, 82, 45, 0.2) 100%);
            animation: sandstormBlow 2s ease-in-out infinite;
        }
        
        .sandstorm-effect::before {
            content: 'ğŸŒªï¸';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2rem;
            animation: sandSwirl 3s linear infinite;
            opacity: 0.6;
            color: #8B4513;
        }
        
        @keyframes sandstormBlow {
            0%, 100% { filter: blur(0px); }
            50% { filter: blur(1px); }
        }
        
        @keyframes sandSwirl {
            0% { transform: translateX(-20px) rotate(0deg); }
            25% { transform: translateX(20px) rotate(90deg); }
            50% { transform: translateX(-10px) rotate(180deg); }
            75% { transform: translateX(10px) rotate(270deg); }
            100% { transform: translateX(-20px) rotate(360deg); }
        }
        
        /* æš´é›¨æ•ˆæœå¢å¼º */
        .stormy-effect {
            background: linear-gradient(135deg, rgba(25, 25, 112, 0.3) 0%, rgba(0, 0, 139, 0.2) 100%);
            animation: stormyWeather 1s ease-in-out infinite;
        }
        
        .stormy-effect::before {
            content: 'âš¡';
            position: absolute;
            top: 10%;
            right: 20%;
            font-size: 4rem;
            animation: lightning 2s ease-in-out infinite;
            opacity: 0;
        }
        
        @keyframes stormyWeather {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(0.7); }
        }
    </style>
</head>
<body class="bg-green-50 min-h-screen" id="main-body">
    <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
    <button id="logout-btn" class="fixed top-4 left-4 bg-white border border-gray-300 shadow px-4 py-2 rounded-lg text-green-700 font-bold hover:bg-green-100" style="z-index: 9999;">
      <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡ºç™»å½•
    </button>
    <!-- ç™»å½•å¼¹çª— -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl p-10 flex flex-col items-center w-80">
        <h2 id="login-title-main" class="text-2xl font-bold mb-6 text-green-700">ç™»å½•å¼€å¿ƒå†œåœº</h2>
        <!-- ç™»å½•è¡¨å• -->
        <form id="login-form" class="w-full flex flex-col items-center mb-2">
          <input id="login-account" type="text" placeholder="è´¦å·" class="w-full mb-3 px-3 py-2 border rounded-lg focus:outline-none" required />
          <input id="login-password" type="password" placeholder="å¯†ç " class="w-full mb-3 px-3 py-2 border rounded-lg focus:outline-none" required />
          <button type="button" id="login-btn" class="w-full mb-2 py-2 rounded-2xl bg-green-500 hover:bg-green-600 text-white font-bold text-lg shadow transition">ç™»å½•</button>
        </form>
        <div id="login-divider" class="w-full flex items-center my-2">
          <div class="flex-1 h-px bg-gray-300"></div>
          <span class="mx-3 text-gray-400 text-sm select-none">æˆ–ä½¿ç”¨ä»¥ä¸‹æ–¹å¼æ³¨å†Œ</span>
          <div class="flex-1 h-px bg-gray-300"></div>
        </div>
        <!-- æ³¨å†Œæ–¹å¼æŒ‰é’®åŒºåŸŸ -->
        <div id="register-choice" class="w-full flex flex-row items-center justify-between gap-2 mt-2 mb-2">
          <button type="button" class="register-way-btn flex-1 flex flex-col items-center justify-center bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-full shadow transition text-xs" data-type="qq" style="min-width:0;max-width:48px;max-height:48px;">
            <i class="fab fa-qq" style="font-size:1.5rem;"></i>
          </button>
          <button type="button" class="register-way-btn flex-1 flex flex-col items-center justify-center bg-green-500 hover:bg-green-600 text-white py-3 rounded-full shadow transition text-xs" data-type="wx" style="min-width:0;max-width:48px;max-height:48px;">
            <i class="fab fa-weixin" style="font-size:1.5rem;"></i>
          </button>
          <button type="button" class="register-way-btn flex-1 flex flex-col items-center justify-center bg-black hover:bg-gray-800 text-white py-3 rounded-full shadow transition text-xs" data-type="douyin" style="min-width:0;max-width:48px;max-height:48px;">
            <i class="fab fa-tiktok" style="font-size:1.5rem;"></i>
          </button>
          <button type="button" class="register-way-btn flex-1 flex flex-col items-center justify-center bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-full shadow transition text-xs" data-type="account" style="min-width:0;max-width:48px;max-height:48px;">
            <i class="fas fa-user" style="font-size:1.5rem;"></i>
          </button>
        </div>
        <!-- ç‹¬ç«‹æ³¨å†Œè¡¨å• -->
        <form id="register-form" class="w-full flex flex-col items-center" style="display:none;">
          <div class="flex flex-col items-center mb-4">
            <span id="register-icon" class="text-3xl mb-2"></span>
            <span id="register-title" class="text-lg font-bold"></span>
          </div>
          <input id="register-account" type="text" placeholder="è´¦å·" class="w-full mb-3 px-3 py-2 border rounded-lg focus:outline-none" required />
          <input id="register-password" type="password" placeholder="å¯†ç " class="w-full mb-3 px-3 py-2 border rounded-lg focus:outline-none" required />
          <div class="flex w-full justify-between">
            <button type="button" id="register-back-choice" class="px-4 py-2 rounded-lg bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold mr-2">è¿”å›</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-white font-semibold">æ³¨å†Œ</button>
          </div>
        </form>
      </div>
    </div>
    <!-- ç®¡ç†å‘˜é¢æ¿å¼¹çª— -->
    <div id="admin-panel" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50" style="display:none;">
      <div class="bg-white rounded-2xl shadow-2xl p-8 w-[95vw] max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
        <h2 class="text-2xl font-bold mb-4 text-green-700">ç®¡ç†å‘˜é¢æ¿</h2>
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-2">å½“å‰æ¸¸æˆæ•°æ®</h3>
          <div class="grid grid-cols-2 gap-4 mb-2">
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-1">é‡‘å¸</label>
              <input id="admin-money" type="number" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-1">ç»éªŒ</label>
              <input id="admin-xp" type="number" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-1">ç­‰çº§</label>
              <input id="admin-level" type="number" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-1">å¤©æ°”</label>
              <div class="flex items-center gap-2">
              <select id="admin-weather" class="w-full border rounded px-2 py-1">
                <option value="sunny">æ™´å¤©</option>
                <option value="rainy">é›¨å¤©</option>
                <option value="cloudy">é˜´å¤©</option>
                <option value="stormy">æš´é£é›¨</option>
                  <option value="typhoon">å°é£</option>
                  <option value="rainbow">å½©è™¹å¤©</option>
              </select>
                <span class="text-xs text-gray-500 ml-2">ä»…æœ¬åœ°å‰ç«¯ç”Ÿæ•ˆ</span>
              </div>
            </div>
          </div>
          <button id="admin-save" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-bold mt-2">ä¿å­˜ä¿®æ”¹</button>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2">æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯</h3>
          <div id="admin-users-list" class="overflow-x-auto text-sm"></div>
        </div>
        <!-- éšæœºäº‹ä»¶ç®¡ç† -->
        <div class="mt-8">
          <h3 class="text-lg font-semibold mb-2">éšæœºäº‹ä»¶ç®¡ç†</h3>
          <div id="admin-events-list" class="grid grid-cols-1 gap-2"></div>
        </div>
        <button id="admin-close" class="mt-6 bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded font-bold self-end">å…³é—­</button>
      </div>
    </div>
    <!-- ç®¡ç†å‘˜æŒ‰é’®ï¼Œä»…ç®¡ç†å‘˜å¯è§ -->
    <button id="admin-open-btn" class="fixed top-4 right-4 z-50 bg-green-600 hover:bg-green-700 text-white font-bold px-5 py-2 rounded-xl shadow-lg" style="display:none;">ç®¡ç†å‘˜</button>
    <!-- ç«‹å³å®Œæˆç”Ÿé•¿æŒ‰é’®ï¼Œä»…ç®¡ç†å‘˜å¯è§ -->
    <button id="admin-grow-btn" class="fixed top-16 right-4 z-50 bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-5 py-2 rounded-xl shadow-lg" style="display:none;">ç«‹å³å®Œæˆç”Ÿé•¿</button>
    <div class="container mx-auto px-4 py-8">
        <!-- åœ°åŒºåˆ‡æ¢åŒºåŸŸï¼ˆæ›´å¤§æ›´æ˜¾çœ¼ï¼‰ -->
        <div class="mb-8 flex items-center justify-center">
            <div class="bg-green-200 rounded-xl px-6 py-4 flex items-center shadow-lg border-2 border-green-400">
                <label for="region-select" class="mr-4 text-2xl font-extrabold text-green-900 title-strong">ğŸŒ é€‰æ‹©åœ°åŒºï¼š</label>
                <select id="region-select" class="border-2 border-green-500 rounded-lg px-6 py-3 text-xl font-bold text-green-900 bg-white shadow focus:outline-none focus:ring-2 focus:ring-green-400 transition">
                    <!-- é€‰é¡¹é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </select>
            </div>
        </div>
        <!-- æ¸¸æˆæ ‡é¢˜å’ŒçŠ¶æ€æ  -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 card-strong p-6">
            <h1 class="title-strong mb-4 md:mb-0">ğŸ® å¼€å¿ƒå†œåœº ğŸšœ</h1>
            <div class="flex space-x-4">
                <div class="bg-white rounded-lg p-3 shadow flex items-center">
                    <div id="weather-icon" class="text-xl mr-1">â˜€ï¸</div>
                    <div>
                        <p class="font-semibold text-green-700 text-sm">å¤©æ°”: <span id="weather-name">æ™´å¤©</span></p>
                        <p class="text-xs text-gray-600" id="weather-effects">ç”Ÿé•¿+0% å”®ä»·+0%</p>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow">
                    <p class="font-semibold text-green-700"><i class="fas fa-coins text-yellow-500 mr-1"></i> é‡‘å¸: <span id="money">100</span></p>
                </div>
                <div class="bg-white rounded-lg p-3 shadow">
                    <p class="font-semibold text-green-700"><i class="fas fa-star text-yellow-400 mr-1"></i> ç­‰çº§: <span id="level">1</span></p>
                </div>
                <div class="bg-white rounded-lg p-3 shadow">
                    <p class="font-semibold text-green-700"><i class="fas fa-chart-line text-blue-500 mr-1"></i> ç»éªŒ: <span id="xp">0</span>/<span id="maxXp">100</span></p>
                </div>
                <!-- å¤©æ°”è¯¦ç»†ä¿¡æ¯ -->
                <div id="weather-details" class="bg-white rounded-lg p-3 shadow cursor-pointer hover:bg-gray-50 transition">
                    <p class="font-semibold text-green-700 text-sm mb-1"><i class="fas fa-cloud text-blue-500 mr-1"></i> å¤©æ°”è¯¦æƒ…</p>
                    <div id="weather-description" class="text-xs text-gray-600">
                        <!-- å¤©æ°”æè¿°å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                    </div>
                </div>
                <!-- äº‹ä»¶çŠ¶æ€æ˜¾ç¤º -->
                <div id="events-panel" class="bg-white rounded-lg p-3 shadow" style="display: none;">
                    <p class="font-semibold text-green-700 text-sm mb-1"><i class="fas fa-magic text-purple-500 mr-1"></i> æ´»è·ƒäº‹ä»¶</p>
                    <div id="active-events-list" class="text-xs text-gray-600">
                        <!-- äº‹ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </header>

        <!-- æ¸¸æˆå†…å®¹åŒºåŸŸ -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§ä¸»åŒºï¼šå†œç”°+ç‰§åœº -->
            <div class="lg:col-span-2 flex flex-col gap-6">
            <!-- å†œåœºåŒºåŸŸ -->
                <div class="card-strong p-8">
                <h2 class="text-3xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                    <i class="fas fa-tractor mr-3"></i> æˆ‘çš„å†œåœº
                </h2>
                <div class="flex justify-between items-center mb-4">
                    <p class="text-gray-600">ä½ æœ‰ <span id="plots-count">4</span> å—å†œç”° (æœ€å¤§: 12)</p>
                    <button id="expand-farm" class="btn-strong px-6 py-2 text-lg transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-plus mr-2"></i> æ‰©å±•å†œç”° (200é‡‘å¸)
                    </button>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="farm-grid">
                    <!-- å†œç”°åœ°å—å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
                <!-- ç‰§åœºåŒºåŸŸ -->
                <div class="card-strong p-8">
                    <h2 class="text-3xl subtitle-strong mb-6 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-warehouse mr-3"></i> æˆ‘çš„ç‰§åœº
                    </h2>
                    <!-- ç‰§åœºç»Ÿè®¡å’Œç®¡ç† -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                            <div class="text-3xl font-bold text-blue-600" id="total-animals">0</div>
                            <div class="text-sm text-gray-600">æ€»åŠ¨ç‰©æ•°</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg border-2 border-green-200">
                            <div class="text-3xl font-bold text-green-600" id="avg-health">100%</div>
                            <div class="text-sm text-gray-600">å¹³å‡å¥åº·åº¦</div>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg border-2 border-yellow-200">
                            <div class="text-3xl font-bold text-yellow-600" id="feed-count">0</div>
                            <div class="text-sm text-gray-600">é¥²æ–™åº“å­˜</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                            <div class="text-3xl font-bold text-purple-600" id="happiness-value">0</div>
                            <div class="text-sm text-gray-600">å¹¸ç¦å€¼</div>
                        </div>
                    </div>
                    <!-- ç‰§åœºç®¡ç†æŒ‰é’® -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <button id="buy-feed-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-semibold text-lg transition">
                            <i class="fas fa-shopping-cart mr-2"></i> è´­ä¹°é¥²æ–™ (10é‡‘å¸/åŒ…)
                        </button>
                        <button id="feed-animals-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold text-lg transition">
                            <i class="fas fa-apple-alt mr-2"></i> å–‚å…»å…¨éƒ¨åŠ¨ç‰©
                        </button>
                        <button id="sell-all-products-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold text-lg transition">
                            <i class="fas fa-coins mr-2"></i> ä¸€é”®å‡ºå”®æ‰€æœ‰å‰¯äº§å“
                        </button>
                    </div>
                    <!-- ç‰§åœºå†…å®¹åŒºåŸŸ -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- åªä¿ç•™ç‰§åœºæ°›å›´ä¼˜åŒ–åŒºåŸŸ -->
                        <div class="bg-green-50 rounded-lg p-6 shadow-lg flex flex-col items-center justify-center relative overflow-hidden min-h-[220px] w-full col-span-2">
                            <div class="absolute inset-0 pointer-events-none select-none" style="background: repeating-linear-gradient(135deg, #d1fae5 0 10px, #bbf7d0 10px 20px);"></div>
                            
                            <!-- ç‰§åœºæ§åˆ¶é¢æ¿ -->
                            <div class="absolute top-4 right-4 z-20 flex gap-2">
                                <button id="ranch-sound-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-200 flex items-center gap-1">
                                    <span id="sound-icon">ğŸ”Š</span>
                                    <span id="sound-text">éŸ³æ•ˆ</span>
                                </button>
                            </div>
                            
                            <!-- å¤©æ°”æ•ˆæœå±‚ -->
                            <div id="ranch-weather-effect" class="absolute inset-0 pointer-events-none z-5"></div>
                            
                            <!-- åŠ¨ç‰©æ´»åŠ¨åŒºåŸŸ -->
                            <div class="relative z-10 w-full flex flex-wrap justify-center gap-6">
                                <div id="ranch-animal-icons" class="flex flex-wrap gap-4"></div>
                            </div>
                            
                            <!-- ç‰§åœºæ ‡é¢˜å’ŒçŠ¶æ€ -->
                            <div class="relative z-10 mt-4 text-center">
                                <div class="text-green-700 font-bold text-lg flex items-center justify-center">
                                    <span class="mr-2">ğŸ¾</span>
                                    <span id="ranch-title">ç‰§åœºæ‚ é—²æ—¶å…‰</span>
                                </div>
                                <div class="text-sm text-green-600 mt-1 flex items-center justify-center gap-4">
                                    <span id="ranch-time">ğŸ• ç°åœ¨æ˜¯ç™½å¤©</span>
                                    <span id="ranch-season">ğŸŒ¸ æ˜¥å­£</span>
                                    <span id="ranch-mood">ğŸ˜Š åŠ¨ç‰©ä»¬å¾ˆå¼€å¿ƒ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- å³ä¾§ä¾§è¾¹æ  -->
            <div class="space-y-6">
                <!-- ç»Ÿä¸€å•†åº— -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-store mr-3"></i> ç»¼åˆå•†åº—
                    </h2>
                    <!-- å•†åº—åˆ†ç±»é€‰æ‹© -->
                    <div class="flex space-x-2 mb-4">
                        <button class="shop-tab-btn btn-strong px-4 py-2 text-sm active" data-category="seeds">
                            <i class="fas fa-seedling mr-2"></i> ç§å­
                        </button>
                        <button class="shop-tab-btn btn-strong px-4 py-2 text-sm" data-category="items">
                            <i class="fas fa-toolbox mr-2"></i> é“å…·
                        </button>
                        <button class="shop-tab-btn btn-strong px-4 py-2 text-sm" data-category="decor">
                            <i class="fas fa-tree mr-2"></i> è£…é¥°
                        </button>
                        <button class="shop-tab-btn btn-strong px-4 py-2 text-sm" data-category="animals">
                            <i class="fas fa-dog mr-2"></i> åŠ¨ç‰©
                        </button>
                    </div>
                    <!-- ç§å­å•†åº—å†…å®¹ -->
                    <div id="shop-items" class="shop-content active">
                        <!-- ç§å­å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <!-- é“å…·å•†åº—å†…å®¹ -->
                    <div id="item-shop" class="shop-content space-y-3" style="display: none;">
                        <!-- é“å…·å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                    <!-- è£…é¥°å•†åº—å†…å®¹ -->
                    <div id="decor-shop" class="shop-content space-y-3" style="display: none;">
                        <!-- è£…é¥°å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <!-- åŠ¨ç‰©å•†åº—å†…å®¹ -->
                    <div id="animal-shop" class="shop-content space-y-3" style="display: none;">
                        <!-- åŠ¨ç‰©å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <!-- åº“å­˜åŒºåŸŸ -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-box-open mr-3"></i> æˆ‘çš„åº“å­˜
                    </h2>
                    <div id="inventory-items">
                        <!-- ä½œç‰©/æ°´æœåˆ—è¡¨ -->
                        <div id="crop-inventory-list">
                            <!-- ç”±JSæ¸²æŸ“ä½œç‰©/æ°´æœåº“å­˜ -->
                    </div>
                        <!-- åŠ¨ç‰©äº§å“åˆ—è¡¨ -->
                        <div id="animal-inventory-list" class="mt-6">
                            <!-- ç”±JSæ¸²æŸ“åŠ¨ç‰©äº§å“åº“å­˜ -->
                </div>
                    </div>
                </div>
                <!-- ä»»åŠ¡åŒºåŸŸ -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-tasks mr-3"></i> æ¯æ—¥ä»»åŠ¡
                    </h2>
                    <div id="tasks-list">
                        <p class="text-gray-500 italic">ä»Šæ—¥ä»»åŠ¡å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                    </div>
                </div>
                <!-- å‡çº§åŒºåŸŸ -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-wrench mr-3"></i> å†œåœºå‡çº§
                    </h2>
                    <div class="space-y-4" id="upgrades">
                        <!-- å‡çº§é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <!-- æˆ‘çš„è£…é¥° -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-gift mr-3"></i> æˆ‘çš„è£…é¥°
                    </h2>
                    <div id="my-decors" class="space-y-3"></div>
                </div>
                <!-- æˆ‘çš„åŠ¨ç‰© -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-paw mr-3"></i> æˆ‘çš„åŠ¨ç‰©
                    </h2>
                    <div id="my-animals" class="space-y-3"></div>
                </div>
            </div>
        </main>

        <!-- é€šçŸ¥åŒºåŸŸ -->
        <div id="notifications" class="fixed bottom-4 right-4 space-y-2 w-64"></div>

        <!-- ä¿å­˜æŒ‡ç¤ºå™¨ -->
        <div id="save-indicator" class="save-indicator">
            <i class="fas fa-save mr-2"></i> æ¸¸æˆæ•°æ®å·²ä¿å­˜
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            money: 100,
            level: 1,
            xp: 0,
            maxXp: 100,
            plots: 4, // å½“å‰åŒºåŸŸå†œç”°æ•°é‡
            maxPlots: 12,
            regionPlots: {}, // å„åŒºåŸŸç‹¬ç«‹å†œç”°æ•°é‡
            inventory: {}, // æ”¹ä¸ºæŒ‰å“è´¨å­˜å‚¨: {seedId: {quality0: count, quality1: count, ...}}
            qualityInventory: {}, // æ–°çš„å“è´¨åº“å­˜ç³»ç»Ÿ {seedId: {0: count, 1: count, 2: count, 3: count}}
            upgrades: {
                watering: 0,
                quality: 0,
                greenhouse: 0
            },
            currentSelectedSeed: null,
            purchasedSeeds: {},
            weather: 'sunny',
            dailyStreak: 0,
            lastPlayed: null,
            completedTasks: 0,
            achievements: [],
            currentRegion: 'north_china', // æ–°å¢å­—æ®µï¼Œé»˜è®¤ä¸­å›½ä¸œåŒ—
            tasks: [],
            farmData: [], // å½“å‰åŒºåŸŸå†œç”°æ•°æ®ï¼ˆè§†å›¾ï¼‰
            regionFarmData: {}, // å„åŒºåŸŸç‹¬ç«‹å†œç”°æ•°æ®
            // éšæœºäº‹ä»¶ç›¸å…³å­—æ®µ
            activeEvents: [], // å½“å‰æ¿€æ´»çš„äº‹ä»¶
            lastEventTime: 0, // ä¸Šæ¬¡è§¦å‘äº‹ä»¶çš„æ—¶é—´
            eventCooldown: 30000, // äº‹ä»¶å†·å´æ—¶é—´ï¼ˆ30ç§’ï¼‰
            eventChance: 0.1, // æ¯ç§’è§¦å‘äº‹ä»¶çš„æ¦‚ç‡ï¼ˆ10%ï¼‰
            items: { pesticide: 0, medicine: 0, weedkiller: 0, insulation: 0 }, // æ–°å¢é“å…·èƒŒåŒ…ï¼Œç›´æ¥é»˜è®¤å€¼
            decors: { fence: 0, fountain: 0, scarecrow: 0, flowerbed: 0 },
            animals: { chicken: 0, cow: 0, sheep: 0, pig: 0, duck: 0, goat: 0, rabbit: 0, horse: 0 }, // æ‰©å±•åŠ¨ç‰©åº“å­˜
            animalHealth: { chicken: 100, cow: 100, sheep: 100, pig: 100, duck: 100, goat: 100, rabbit: 100, horse: 100 }, // å¥åº·åº¦
            animalFeed: 5, // é¥²æ–™åº“å­˜
            animalProducts: { egg: 0, milk: 0, wool: 0, pork: 0, duck_egg: 0, goat_milk: 0, rabbit_fur: 0, horse_manure: 0 }, // å‰¯äº§å“åº“å­˜
            happiness: 0, // å¹¸ç¦å€¼
            // åœŸåœ°æ”¹è‰¯ç³»ç»Ÿ
            landImprovements: {}, // å„åŒºåŸŸåœŸåœ°æ”¹è‰¯ç­‰çº§ {regionId: {plotIndex: level}}
            regionLandImprovements: {} // å„åŒºåŸŸç‹¬ç«‹åœŸåœ°æ”¹è‰¯æ•°æ®
        };

        // åœ°åŒºæ•°æ®ï¼ˆæ›´ç»†åˆ†ä¸”ä¸é‡å¤ï¼‰
        const regions = [
            { id: 'north_china', name: 'ä¸­å›½ä¸œåŒ—' },
            { id: 'south_china', name: 'ä¸­å›½åå—' },
            { id: 'east_china', name: 'ä¸­å›½åä¸œ' },
            { id: 'west_china', name: 'ä¸­å›½è¥¿éƒ¨' },
            { id: 'japan', name: 'æ—¥æœ¬' },
            { id: 'us_midwest', name: 'ç¾å›½ä¸­éƒ¨' },
            { id: 'europe', name: 'æ¬§æ´²' }
        ];
        // æ¤ç‰©ç§ç±»ä¸é‡å¤ï¼Œæ¯ä¸ªåŒºåŸŸç‹¬æœ‰ï¼Œ5-6ç§
        const seeds = [
            // ä¸­å›½ä¸œåŒ—
            { id: 'soybean', name: 'å¤§è±†', price: 10, growTime: 30, sellPrice: 20, xp: 5, icon: 'ğŸŒ±', color: 'bg-lime-100', regions: ['north_china'] },
            { id: 'millet', name: 'å°ç±³', price: 12, growTime: 36, sellPrice: 22, xp: 6, icon: 'ğŸŒ¾', color: 'bg-yellow-200', regions: ['north_china'] },
            { id: 'sorghum', name: 'é«˜ç²±', price: 15, growTime: 45, sellPrice: 30, xp: 8, icon: 'ğŸŒ¾', color: 'bg-red-200', regions: ['north_china'] },
            { id: 'potato', name: 'åœŸè±†', price: 20, growTime: 60, sellPrice: 45, xp: 12, icon: 'ğŸ¥”', color: 'bg-amber-100', regions: ['north_china'] },
            { id: 'corn', name: 'ç‰ç±³', price: 18, growTime: 54, sellPrice: 38, xp: 10, icon: 'ğŸŒ½', color: 'bg-yellow-100', regions: ['north_china'] },
            // ä¸­å›½åå—
            { id: 'lychee', name: 'è”æ', price: 22, growTime: 66, sellPrice: 50, xp: 13, icon: 'ğŸ¥­', color: 'bg-pink-100', regions: ['south_china'] },
            { id: 'banana', name: 'é¦™è•‰', price: 25, growTime: 75, sellPrice: 60, xp: 15, icon: 'ğŸŒ', color: 'bg-yellow-200', regions: ['south_china'] },
            { id: 'sugarcane', name: 'ç”˜è”—', price: 20, growTime: 60, sellPrice: 48, xp: 12, icon: 'ğŸ‹', color: 'bg-green-200', regions: ['south_china'] },
            { id: 'pineapple', name: 'è è', price: 28, growTime: 84, sellPrice: 70, xp: 18, icon: 'ğŸ', color: 'bg-amber-200', regions: ['south_china'] },
            { id: 'dragonfruit', name: 'ç«é¾™æœ', price: 35, growTime: 105, sellPrice: 90, xp: 22, icon: 'ğŸ‰', color: 'bg-pink-200', regions: ['south_china'] },
            // ä¸­å›½åä¸œ
            { id: 'rice', name: 'æ°´ç¨»', price: 15, growTime: 45, sellPrice: 32, xp: 9, icon: 'ğŸŒ¾', color: 'bg-green-200', regions: ['east_china'] },
            { id: 'peanut', name: 'èŠ±ç”Ÿ', price: 18, growTime: 54, sellPrice: 38, xp: 10, icon: 'ğŸ¥œ', color: 'bg-yellow-300', regions: ['east_china'] },
            { id: 'rapeseed', name: 'æ²¹èœ', price: 16, growTime: 48, sellPrice: 34, xp: 9, icon: 'ğŸŒ»', color: 'bg-yellow-100', regions: ['east_china'] },
            { id: 'lotus', name: 'è²è—•', price: 22, growTime: 66, sellPrice: 50, xp: 13, icon: 'ğŸŒ¸', color: 'bg-pink-100', regions: ['east_china'] },
            { id: 'tea', name: 'èŒ¶å¶', price: 30, growTime: 90, sellPrice: 80, xp: 20, icon: 'ğŸƒ', color: 'bg-green-100', regions: ['east_china'] },
            // ä¸­å›½è¥¿éƒ¨
            { id: 'walnut', name: 'æ ¸æ¡ƒ', price: 25, growTime: 75, sellPrice: 60, xp: 15, icon: 'ğŸŒ°', color: 'bg-amber-200', regions: ['west_china'] },
            { id: 'apple', name: 'è‹¹æœ', price: 20, growTime: 60, sellPrice: 48, xp: 12, icon: 'ğŸ', color: 'bg-red-100', regions: ['west_china'] },
            { id: 'grape', name: 'è‘¡è„', price: 28, growTime: 84, sellPrice: 70, xp: 18, icon: 'ğŸ‡', color: 'bg-purple-100', regions: ['west_china'] },
            { id: 'apricot', name: 'æ', price: 18, growTime: 54, sellPrice: 38, xp: 10, icon: 'ğŸ‘', color: 'bg-orange-100', regions: ['west_china'] },
            { id: 'melon', name: 'å“ˆå¯†ç“œ', price: 35, growTime: 105, sellPrice: 90, xp: 22, icon: 'ğŸˆ', color: 'bg-green-100', regions: ['west_china'] },
            // æ—¥æœ¬
            { id: 'wasabi', name: 'èŠ¥æœ«', price: 30, growTime: 90, sellPrice: 80, xp: 20, icon: 'ğŸŒ±', color: 'bg-lime-100', regions: ['japan'] },
            { id: 'sakura', name: 'æ¨±èŠ±', price: 40, growTime: 120, sellPrice: 100, xp: 25, icon: 'ğŸŒ¸', color: 'bg-pink-200', regions: ['japan'] },
            { id: 'sweet_potato', name: 'çº¢è–¯', price: 18, growTime: 54, sellPrice: 38, xp: 10, icon: 'ğŸ ', color: 'bg-orange-200', regions: ['japan'] },
            { id: 'daikon', name: 'å¤§æ ¹', price: 22, growTime: 66, sellPrice: 50, xp: 13, icon: 'ğŸ¥•', color: 'bg-orange-100', regions: ['japan'] },
            { id: 'mikan', name: 'èœœæŸ‘', price: 28, growTime: 84, sellPrice: 70, xp: 18, icon: 'ğŸŠ', color: 'bg-yellow-100', regions: ['japan'] },
            // ç¾å›½ä¸­éƒ¨
            { id: 'blueberry', name: 'è“è“', price: 25, growTime: 75, sellPrice: 60, xp: 15, icon: 'ğŸ«', color: 'bg-indigo-100', regions: ['us_midwest'] },
            { id: 'pumpkin', name: 'å—ç“œ', price: 20, growTime: 60, sellPrice: 48, xp: 12, icon: 'ğŸƒ', color: 'bg-orange-200', regions: ['us_midwest'] },
            { id: 'wheat', name: 'å°éº¦', price: 15, growTime: 45, sellPrice: 32, xp: 9, icon: 'ğŸŒ¾', color: 'bg-yellow-100', regions: ['us_midwest'] },
            { id: 'cranberry', name: 'è”“è¶Šè“', price: 28, growTime: 84, sellPrice: 70, xp: 18, icon: 'ğŸ’', color: 'bg-red-200', regions: ['us_midwest'] },
            { id: 'sunflower', name: 'å‘æ—¥è‘µ', price: 18, growTime: 54, sellPrice: 38, xp: 10, icon: 'ğŸŒ»', color: 'bg-yellow-200', regions: ['us_midwest'] },
            // æ¬§æ´²
            { id: 'carrot', name: 'èƒ¡èåœ', price: 15, growTime: 45, sellPrice: 32, xp: 9, icon: 'ğŸ¥•', color: 'bg-orange-100', regions: ['europe'] },
            { id: 'strawberry', name: 'è‰è“', price: 22, growTime: 66, sellPrice: 50, xp: 13, icon: 'ğŸ“', color: 'bg-red-100', regions: ['europe'] },
            { id: 'lettuce', name: 'ç”Ÿèœ', price: 18, growTime: 54, sellPrice: 38, xp: 10, icon: 'ğŸ¥¬', color: 'bg-green-100', regions: ['europe'] },
            { id: 'asparagus', name: 'èŠ¦ç¬‹', price: 28, growTime: 84, sellPrice: 70, xp: 18, icon: 'ğŸ¥¦', color: 'bg-green-200', regions: ['europe'] },
            { id: 'grapefruit', name: 'è‘¡è„æŸš', price: 35, growTime: 105, sellPrice: 90, xp: 22, icon: 'ğŸ‡', color: 'bg-purple-100', regions: ['europe'] }
        ];

        // å‡çº§æ•°æ®
        const upgrades = [
            { id: 'watering', name: 'æµ‡æ°´æ•ˆç‡', description: 'å‡å°‘ä½œç‰©ç”Ÿé•¿æ—¶é—´10%', cost: 150, maxLevel: 3 },
            { id: 'quality', name: 'ä½œç‰©å“è´¨', description: 'æé«˜ä½œç‰©å”®ä»·15%', cost: 250, maxLevel: 3 },
            { id: 'greenhouse', name: 'æ¸©å®¤å¤§æ£š', description: 'å‡å°‘å¤©æ°”å½±å“50%', cost: 400, maxLevel: 1 }
        ];

        // åœŸåœ°æ”¹è‰¯ç­‰çº§å®šä¹‰
        const landImprovementLevels = [
            { level: 0, name: 'æ™®é€šåœŸåœ°', icon: 'ğŸŸ«', color: 'bg-amber-100', growthBonus: 1.0, yieldBonus: 1.0, description: 'åŸºç¡€åœŸåœ°ï¼Œæ— ç‰¹æ®Šæ•ˆæœ' },
            { level: 1, name: 'è‚¥æ²ƒåœŸåœ°', icon: 'ğŸŸ¤', color: 'bg-yellow-200', growthBonus: 1.15, yieldBonus: 1.1, cost: 100, description: 'æ–½è‚¥æ”¹è‰¯ï¼Œç”Ÿé•¿é€Ÿåº¦+15%ï¼Œäº§é‡+10%' },
            { level: 2, name: 'ä¼˜è´¨åœŸåœ°', icon: 'ğŸŸ¢', color: 'bg-green-200', growthBonus: 1.3, yieldBonus: 1.25, cost: 200, description: 'æ·±åº¦æ”¹è‰¯ï¼Œç”Ÿé•¿é€Ÿåº¦+30%ï¼Œäº§é‡+25%' },
            { level: 3, name: 'å®Œç¾åœŸåœ°', icon: 'âœ¨', color: 'bg-purple-200', growthBonus: 1.5, yieldBonus: 1.5, cost: 400, description: 'æè‡´æ”¹è‰¯ï¼Œç”Ÿé•¿é€Ÿåº¦+50%ï¼Œäº§é‡+50%' }
        ];

        // æ°´æœå“è´¨ç³»ç»Ÿ
        const fruitQualities = [
            { 
                level: 0, 
                name: 'æ™®é€š', 
                icon: 'ğŸŸ«', 
                color: 'bg-gray-100 border-gray-300', 
                priceMultiplier: 1.0, 
                description: 'æ™®é€šå“è´¨çš„æ°´æœ',
                landRequirement: 0 // å¯¹åº”åœŸåœ°ç­‰çº§
            },
            { 
                level: 1, 
                name: 'ä¼˜è‰¯', 
                icon: 'ğŸŸ¤', 
                color: 'bg-green-100 border-green-300', 
                priceMultiplier: 1.3, 
                description: 'ä¼˜è‰¯å“è´¨çš„æ°´æœï¼Œå”®ä»·+30%',
                landRequirement: 1
            },
            { 
                level: 2, 
                name: 'ç²¾å“', 
                icon: 'ğŸŸ¢', 
                color: 'bg-blue-100 border-blue-300', 
                priceMultiplier: 1.6, 
                description: 'ç²¾å“å“è´¨çš„æ°´æœï¼Œå”®ä»·+60%',
                landRequirement: 2
            },
            { 
                level: 3, 
                name: 'å®Œç¾', 
                icon: 'âœ¨', 
                color: 'bg-purple-100 border-purple-300', 
                priceMultiplier: 2.0, 
                description: 'å®Œç¾å“è´¨çš„æ°´æœï¼Œå”®ä»·+100%',
                landRequirement: 3
            }
        ];

        // ä»»åŠ¡æ•°æ®
        const tasks = [
            { id: 'harvest_5', name: 'æ”¶è·5ä¸ªä½œç‰©', goal: 5, reward: 50, desc: 'æ”¶è·ä»»æ„5ä¸ªä½œç‰©' },
            { id: 'plant_3', name: 'ç§æ¤3æ¬¡', goal: 3, reward: 30, desc: 'ç§æ¤3æ¬¡ä»»æ„ç§å­' },
            { id: 'sell_100', name: 'é”€å”®100é‡‘å¸', goal: 100, reward: 20, desc: 'ç´¯è®¡é”€å”®ä½œç‰©ä»·å€¼è¾¾åˆ°100é‡‘å¸' },
            { id: 'upgrade_1', name: 'å®Œæˆ1æ¬¡å‡çº§', goal: 1, reward: 40, desc: 'è´­ä¹°ä»»æ„1æ¬¡å†œåœºå‡çº§' },
            { id: 'expand_1', name: 'æ‰©å±•1å—å†œç”°', goal: 1, reward: 60, desc: 'æ‰©å±•1å—å†œç”°' }
        ];

        // å¤©æ°”ç³»ç»Ÿ
        const weatherTypes = [
            { 
                id: 'sunny', 
                name: 'æ™´å¤©', 
                icon: 'â˜€ï¸', 
                effect: { growth: 1.2, needWater: true, yieldPenaltyIfNoWater: true },
                description: 'é˜³å…‰å……è¶³ï¼Œä½œç‰©ç”Ÿé•¿åŠ å¿«20%ï¼Œä½†éœ€è¦åŠæ—¶æµ‡æ°´'
            },
            { 
                id: 'rainy', 
                name: 'é›¨å¤©', 
                icon: 'ğŸŒ§ï¸', 
                effect: { growth: 1.0, needWater: false, pestChance: 0.1 },
                description: 'é›¨æ°´æ»‹æ¶¦ï¼Œæ— éœ€æµ‡æ°´ï¼Œä½†æœ‰10%æ¦‚ç‡å‡ºç°ç—…è™«å®³'
            },
            { 
                id: 'stormy', 
                name: 'æš´é›¨', 
                icon: 'â›ˆï¸', 
                effect: { destroyLowFarm: true, fishDouble: true },
                description: 'æš´é›¨æ¥è¢­ï¼Œæœªå‡çº§æ’æ°´çš„å†œç”°å¯èƒ½è¢«ç ´å'
            },
            { 
                id: 'drought', 
                name: 'å¹²æ—±', 
                icon: 'ğŸ”¥', 
                effect: { growth: 0, needWater: true, witherIfNoWater: true },
                description: 'æåº¦å¹²æ—±ï¼Œä½œç‰©åœæ­¢ç”Ÿé•¿ï¼Œ3å¤©ä¸æµ‡æ°´ä¼šæ¯æ­»'
            },
            { 
                id: 'typhoon', 
                name: 'å°é£', 
                icon: 'ğŸŒ€', 
                effect: { blowFruitTree: true, rareSeedDrop: true },
                description: 'å°é£è¿‡å¢ƒï¼ŒæœªåŠ å›ºçš„æœæ ‘å¯èƒ½å€’ä¼'
            },
            { 
                id: 'rainbow', 
                name: 'å½©è™¹å¤©', 
                icon: 'ğŸŒˆ', 
                effect: { yieldBonus: 0.5 },
                description: 'å½©è™¹å¤©èµç¦ï¼Œä½œç‰©å”®ä»·æå‡50%'
            },
            { 
                id: 'sandstorm', 
                name: 'æ²™å°˜æš´', 
                icon: 'ğŸŒªï¸', 
                effect: { disableCollect: true },
                description: 'æ²™å°˜æš´è‚†è™ï¼Œæ— æ³•æ”¶è·ä½œç‰©'
            }
        ];

        // éšæœºäº‹ä»¶ç³»ç»Ÿ
        const randomEvents = [
            // æ­£é¢äº‹ä»¶
            { 
                id: 'golden_rain', 
                name: 'é‡‘é›¨é™ä¸´', 
                icon: 'ğŸŒ§ï¸', 
                color: 'text-yellow-500',
                effect: 'growth_boost',
                duration: 30, // 30ç§’
                description: 'ä½œç‰©ç”Ÿé•¿é€Ÿåº¦æå‡50%',
                animation: 'rainbow-rain'
            },
            { 
                id: 'fairy_blessing', 
                name: 'ç²¾çµç¥ç¦', 
                icon: 'ğŸ§š', 
                color: 'text-pink-500',
                effect: 'instant_growth',
                duration: 0, // ç«‹å³ç”Ÿæ•ˆ
                description: 'æ‰€æœ‰ä½œç‰©ç«‹å³æˆç†Ÿ',
                animation: 'fairy-sparkle'
            },
            { 
                id: 'nutrient_boost', 
                name: 'è¥å…»çˆ†å‘', 
                icon: 'ğŸ’š', 
                color: 'text-green-500',
                effect: 'quality_boost',
                duration: 60, // 60ç§’
                description: 'ä½œç‰©å“è´¨æå‡ï¼Œå”®ä»·ç¿»å€',
                animation: 'nutrient-glow'
            },
            { 
                id: 'time_acceleration', 
                name: 'æ—¶é—´åŠ é€Ÿ', 
                icon: 'â°', 
                color: 'text-blue-500',
                effect: 'time_speed',
                duration: 45, // 45ç§’
                description: 'æ—¶é—´æµé€åŠ å¿«3å€',
                animation: 'clock-spin'
            },
            
            // è´Ÿé¢äº‹ä»¶
            { 
                id: 'pest_invasion', 
                name: 'è™«å®³å…¥ä¾µ', 
                icon: 'ğŸ›', 
                color: 'text-red-500',
                effect: 'pest_damage',
                duration: 20, // 20ç§’
                description: 'ä½œç‰©å—åˆ°è™«å®³ï¼Œç”Ÿé•¿åœæ»',
                animation: 'pest-crawl'
            },
            { 
                id: 'disease_outbreak', 
                name: 'ç—…å®³çˆ†å‘', 
                icon: 'ğŸ¦ ', 
                color: 'text-purple-500',
                effect: 'disease_damage',
                duration: 25, // 25ç§’
                description: 'ä½œç‰©æ„ŸæŸ“ç—…å®³ï¼Œäº§é‡å‡åŠ',
                animation: 'disease-spread'
            },
            { 
                id: 'frost_damage', 
                name: 'éœœå†»ä¼¤å®³', 
                icon: 'â„ï¸', 
                color: 'text-cyan-500',
                effect: 'frost_damage',
                duration: 15, // 15ç§’
                description: 'ä½œç‰©å—åˆ°éœœå†»ï¼Œç”Ÿé•¿ç¼“æ…¢',
                animation: 'frost-freeze'
            },
            { 
                id: 'weed_infestation', 
                name: 'æ‚è‰ä¸›ç”Ÿ', 
                icon: 'ğŸŒ¿', 
                color: 'text-brown-500',
                effect: 'weed_competition',
                duration: 35, // 35ç§’
                description: 'æ‚è‰æŠ¢å¤ºå…»åˆ†ï¼Œç”Ÿé•¿å‡é€Ÿ',
                animation: 'weed-grow'
            },
            
            // ä¸­æ€§äº‹ä»¶
            { 
                id: 'mysterious_fog', 
                name: 'ç¥ç§˜è¿·é›¾', 
                icon: 'ğŸŒ«ï¸', 
                color: 'text-gray-500',
                effect: 'random_effect',
                duration: 40, // 40ç§’
                description: 'è¿·é›¾ç¬¼ç½©ï¼Œéšæœºæ•ˆæœ',
                animation: 'fog-swirl'
            },
            { 
                id: 'soil_change', 
                name: 'åœŸå£¤å˜åŒ–', 
                icon: 'ğŸŒ±', 
                color: 'text-orange-500',
                effect: 'soil_alteration',
                duration: 50, // 50ç§’
                description: 'åœŸå£¤æ€§è´¨æ”¹å˜ï¼Œå½±å“æœªçŸ¥',
                animation: 'soil-shift'
            }
        ];

        // æˆå°±ç³»ç»Ÿ
        const achievements = [
            { id: 'first_harvest', name: 'åˆæ¬¡æ”¶è·', reward: 20, condition: (state) => state.completedTasks >= 1, unlocked: false },
            { id: 'farmer_10', name: '10çº§å†œåœºä¸»', reward: 100, condition: (state) => state.level >= 10, unlocked: false },
            { id: 'millionaire', name: 'ç™¾ä¸‡å¯Œç¿', reward: 200, condition: (state) => state.money >= 1000, unlocked: false },
            { id: 'seed_collector', name: 'ç§å­æ”¶é›†è€…', reward: 80, condition: (state) => Object.keys(state.purchasedSeeds).length >= 3, unlocked: false },
            { id: 'plot_master', name: 'å†œç”°å¤§å¸ˆ', reward: 150, condition: (state) => state.plots >= 8, unlocked: false }
        ];

        // DOMå…ƒç´ 
        const elements = {
            money: document.getElementById('money'),
            level: document.getElementById('level'),
            xp: document.getElementById('xp'),
            maxXp: document.getElementById('maxXp'),
            plotsCount: document.getElementById('plots-count'),
            farmGrid: document.getElementById('farm-grid'),
            shopItems: document.getElementById('shop-items'),
            inventoryItems: document.getElementById('inventory-items'),
            tasksList: document.getElementById('tasks-list'),
            upgrades: document.getElementById('upgrades'),
            expandFarmBtn: document.getElementById('expand-farm'),
            notifications: document.getElementById('notifications'),
            saveIndicator: document.getElementById('save-indicator')
        };

        // å½“å‰ç™»å½•è´¦å·
        let currentUserAccount = null;
        // ä¿å­˜æ¸¸æˆæ•°æ®åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆæ”¯æŒå¤šè´¦å·ï¼‰
        function saveGameData() {
            try {
                // ä¿å­˜æ¸¸æˆçŠ¶æ€
                if(currentUserAccount && currentUserAccount !== 'dyyssb'){
                    localStorage.setItem('happyFarmGameState_' + currentUserAccount, JSON.stringify(gameState));
                } else {
                localStorage.setItem('happyFarmGameState', JSON.stringify(gameState));
                }
                // å¦‚æœæ˜¯æ™®é€šç”¨æˆ·ï¼Œæ›´æ–°happyFarmUsersä¸­çš„æ•°æ®
                const userInfo = JSON.parse(localStorage.getItem('happyFarmUserInfo')||'{}');
                if(userInfo && userInfo.account && userInfo.account !== 'dyyssb'){
                    let users = JSON.parse(localStorage.getItem('happyFarmUsers')||'[]');
                    users = users.map(u => u.account === userInfo.account ? {
                        ...u,
                        lastPlayed: new Date().toLocaleString(),
                        money: gameState.money,
                        xp: gameState.xp,
                        level: gameState.level
                    } : u);
                    localStorage.setItem('happyFarmUsers', JSON.stringify(users));
                }
                // æ˜¾ç¤ºä¿å­˜æŒ‡ç¤ºå™¨
                elements.saveIndicator.classList.add('show');
                setTimeout(() => {
                    elements.saveIndicator.classList.remove('show');
                }, 2000);
                return true;
            } catch (error) {
                console.error('ä¿å­˜æ¸¸æˆæ•°æ®å¤±è´¥:', error);
                return false;
            }
        }
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¸¸æˆæ•°æ®ï¼ˆæ”¯æŒå¤šè´¦å·ï¼‰
        function loadGameData() {
            try {
                let savedState = null;
                if(currentUserAccount && currentUserAccount !== 'dyyssb'){
                    savedState = localStorage.getItem('happyFarmGameState_' + currentUserAccount);
                } else {
                    savedState = localStorage.getItem('happyFarmGameState');
                }
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    Object.assign(gameState, parsedState);
                    if (!gameState.purchasedSeeds) {
                        gameState.purchasedSeeds = {};
                    }
                    showNotification('æ¸¸æˆæ•°æ®å·²åŠ è½½', 'info');
                    return true;
                }
            } catch (error) {
                console.error('åŠ è½½æ¸¸æˆæ•°æ®å¤±è´¥:', error);
            }
            return false;
        }
        // è®¾ç½®è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
        function setupAutoSave() {
            // æ¯5åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
            setInterval(() => {
                saveGameData();
            }, 5 * 60 * 1000);

            // é¡µé¢å¸è½½æ—¶ä¿å­˜
            window.addEventListener('beforeunload', () => {
                saveGameData();
            });
        }

        // åˆå§‹åŒ–æ¸¸æˆï¼ˆå¤šè´¦å·æ”¯æŒï¼‰
        function initGame() {
            // è¯†åˆ«å½“å‰è´¦å·
            if(!currentUserAccount){
                if(localStorage.getItem('happyFarmLoggedIn') === 'admin'){
                    currentUserAccount = 'dyyssb';
                } else {
                    const userInfo = JSON.parse(localStorage.getItem('happyFarmUserInfo')||'{}');
                    currentUserAccount = userInfo.account || null;
                }
            }
            renderRegionSelect();
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¸¸æˆæ•°æ®
            loadGameData();
            // åˆå§‹åŒ–regionFarmDataç»“æ„
            if (!gameState.regionFarmData) gameState.regionFarmData = {};
            if (!gameState.regionPlots) gameState.regionPlots = {};
            
            // åˆå§‹åŒ–å“è´¨åº“å­˜ç³»ç»Ÿ
            if (!gameState.qualityInventory) {
                gameState.qualityInventory = {};
            }
            
            // åˆå§‹åŒ–å½“å‰åŒºåŸŸå†œç”°
            if (!gameState.regionFarmData[gameState.currentRegion]) {
                if (typeof gameState.regionPlots[gameState.currentRegion] !== 'number') {
                    gameState.regionPlots[gameState.currentRegion] = 4;
                }
                gameState.regionFarmData[gameState.currentRegion] = [];
                for (let i = 0; i < gameState.regionPlots[gameState.currentRegion]; i++) {
                    gameState.regionFarmData[gameState.currentRegion].push({
                        state: 'empty',
                        seedId: null,
                        growth: null,
                        progress: 0,
                        growthTime: 0,
                        plantedAt: null,
                        lastWateredAt: null, // æ–°å¢ï¼šä¸Šæ¬¡æµ‡æ°´æ—¶é—´æˆ³
                        pest: false,         // æ–°å¢ï¼šæ˜¯å¦æœ‰ç—…è™«å®³
                        witherCountdown: 0,  // æ–°å¢ï¼šå¹²æ—±å¤©æœªæµ‡æ°´å¤©æ•°
                        reinforced: false,   // æ–°å¢ï¼šæ˜¯å¦åŠ å›ºï¼ˆæœæ ‘ï¼‰
                        drainageUpgraded: false // æ–°å¢ï¼šæ˜¯å¦å‡çº§æ’æ°´ç³»ç»Ÿ
                    });
                }
            }
            gameState.farmData = gameState.regionFarmData[gameState.currentRegion];

            // æ£€æŸ¥ä¸Šæ¬¡æ¸¸ç©æ—¶é—´
            checkDailyLogin();

            // è·å–å½“å‰æ—¥æœŸ
            const today = new Date().toDateString();
            
            // åªæœ‰åœ¨æ–°çš„ä¸€å¤©æˆ–è€…æ²¡æœ‰ä»»åŠ¡æ—¶æ‰ç”Ÿæˆæ–°ä»»åŠ¡
            if (!gameState.lastTasksGenerated || gameState.lastTasksGenerated !== today || gameState.tasks.length === 0) {
                // ç”Ÿæˆä»Šæ—¥å¤©æ°”
                generateWeather();
                
                // ç”Ÿæˆæ¯æ—¥ä»»åŠ¡
                generateDailyTasks();
                
                // è®°å½•ä»»åŠ¡ç”Ÿæˆæ—¥æœŸ
                gameState.lastTasksGenerated = today;
                saveGameData();
            }

            renderShop();
            renderFarm();
            renderUpgrades();
            renderWeather();
            renderTasks();
            updateUI();
            renderItemShop(); // ç¡®ä¿é“å…·å•†åº—æ¸²æŸ“
            renderDecorShop(); // ç¡®ä¿è£…é¥°å•†åº—æ¸²æŸ“
            renderAnimalShop(); // ç¡®ä¿åŠ¨ç‰©å•†åº—æ¸²æŸ“
            renderInventory(); // ç¡®ä¿åº“å­˜æ˜¾ç¤ºæ­£ç¡®æ¸²æŸ“

            // ç¡®ä¿å¤©æ°”æ•ˆæœåœ¨åˆå§‹åŒ–æ—¶åº”ç”¨
            applyWeatherEffect(gameState.weather);

            // æ£€æŸ¥æ‰©å±•å†œç”°æŒ‰é’®
            checkExpandFarmButton();

            // è®¾ç½®è‡ªåŠ¨ä¿å­˜
            setupAutoSave();

            // æ£€æŸ¥ç®¡ç†å‘˜æŒ‰é’®
            if(localStorage.getItem('happyFarmLoggedIn') === 'admin'){
                document.getElementById('admin-open-btn').style.display = 'block';
                document.getElementById('admin-grow-btn').style.display = 'block';
            } else {
                document.getElementById('admin-open-btn').style.display = 'none';
                document.getElementById('admin-grow-btn').style.display = 'none';
            }

            // 2. æ–°å¢"èŠ±è´¹é‡‘å¸åˆ·æ–°å¤©æ°”"æŒ‰é’®
            setupWeatherRefreshBtn();

            // æ¸²æŸ“æˆ‘çš„è£…é¥°å’Œæˆ‘çš„åŠ¨ç‰©
            renderMyDecors();
            renderMyAnimals();

            // æ¸²æŸ“å¹¸ç¦å€¼ã€åŠ¨ç‰©å¥åº·ã€åŠ¨ç‰©å‰¯äº§å“
            renderHappiness();
            renderAnimalHealth();
            renderAnimalProducts();

            // è®¾ç½®å•†åº—æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
            setupShopTabSwitching();
            
            // è®¾ç½®ç‰§åœºç®¡ç†åŠŸèƒ½
            setupRanchManagement();
        }

        // åˆ‡æ¢åœ°åŒºèƒŒæ™¯
        function updateRegionBackground() {
            const body = document.getElementById('main-body');
            body.className = '';
            body.classList.add('min-h-screen');
            body.classList.add('bg-' + gameState.currentRegion);
        }
        // åˆ‡æ¢åœ°åŒºæ—¶ä¿å­˜/åˆ‡æ¢å†œç”°æ•°æ®
        function switchRegionFarmData(newRegion) {
            // ä¿å­˜å½“å‰åŒºåŸŸå†œç”°æ•°æ®å’Œç”°æ•°é‡
            if (gameState.currentRegion) {
                if (!gameState.regionFarmData) gameState.regionFarmData = {};
                gameState.regionFarmData[gameState.currentRegion] = JSON.parse(JSON.stringify(gameState.farmData));
                if (!gameState.regionPlots) gameState.regionPlots = {};
                gameState.regionPlots[gameState.currentRegion] = gameState.plots;
            }
            // åˆ‡æ¢åˆ°æ–°åŒºåŸŸ
            gameState.currentRegion = newRegion;
            // è¯»å–æ–°åŒºåŸŸå†œç”°æ•°é‡
            if (!gameState.regionPlots) gameState.regionPlots = {};
            if (typeof gameState.regionPlots[newRegion] !== 'number') {
                gameState.regionPlots[newRegion] = 4;
            }
            gameState.plots = gameState.regionPlots[newRegion];
            // è¯»å–æ–°åŒºåŸŸå†œç”°æ•°æ®
            if (!gameState.regionFarmData) gameState.regionFarmData = {};
            if (!gameState.regionFarmData[newRegion]) {
                // åˆå§‹åŒ–æ–°åŒºåŸŸå†œç”°
                gameState.regionFarmData[newRegion] = [];
                for (let i = 0; i < gameState.plots; i++) {
                    gameState.regionFarmData[newRegion].push({
                        state: 'empty',
                        seedId: null,
                        growth: null,
                        progress: 0,
                        growthTime: 0,
                        plantedAt: null,
                        lastWateredAt: null, // æ–°å¢ï¼šä¸Šæ¬¡æµ‡æ°´æ—¶é—´æˆ³
                        pest: false,         // æ–°å¢ï¼šæ˜¯å¦æœ‰ç—…è™«å®³
                        witherCountdown: 0,  // æ–°å¢ï¼šå¹²æ—±å¤©æœªæµ‡æ°´å¤©æ•°
                        reinforced: false,   // æ–°å¢ï¼šæ˜¯å¦åŠ å›ºï¼ˆæœæ ‘ï¼‰
                        drainageUpgraded: false // æ–°å¢ï¼šæ˜¯å¦å‡çº§æ’æ°´ç³»ç»Ÿ
                    });
                }
            }
            gameState.farmData = gameState.regionFarmData[newRegion];
        }
        // æ¸²æŸ“åœ°åŒºä¸‹æ‹‰èœå•
        function renderRegionSelect() {
            const select = document.getElementById('region-select');
            select.innerHTML = regions.map(region =>
                `<option value="${region.id}" ${region.id === gameState.currentRegion ? 'selected' : ''}>${region.name}</option>`
            ).join('');
            select.onchange = function() {
                switchRegionFarmData(this.value);
                saveGameData();
                renderShop();
                renderItemShop();
                renderDecorShop();
                renderAnimalShop();
                renderFarm();
                renderInventory();
                updateRegionBackground();
            };
            // åˆå§‹åŒ–æ—¶ä¹Ÿåˆ‡æ¢èƒŒæ™¯
            updateRegionBackground();
        }

        // æ¸²æŸ“å•†åº—ï¼ˆåªæ˜¾ç¤ºå½“å‰åœ°åŒºçš„ç§å­ï¼‰
        function renderShop() {
            const regionSeeds = seeds.filter(seed => seed.regions.includes(gameState.currentRegion));
            elements.shopItems.innerHTML = regionSeeds.map(seed => `
                <div class="seed-item flex flex-col p-4 rounded-2xl ${seed.color} cursor-pointer shadow-lg hover:shadow-2xl transition card-strong" data-seed-id="${seed.id}">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-medium">${seed.icon} ${seed.name}</div>
                            <div class="text-sm text-gray-600">å”®ä»·: ${seed.sellPrice}é‡‘å¸ | ç»éªŒ: ${seed.xp}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold">${seed.price}é‡‘å¸</div>
                            <div class="text-xs text-gray-600">${seed.growTime}åˆ†é’Ÿ</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">åº“å­˜: ${gameState.purchasedSeeds[seed.id] || 0}</span>
                        <button class="buy-btn btn-strong px-4 py-2 text-base" data-seed-id="${seed.id}">
                            <i class="fas fa-shopping-cart mr-2"></i> è´­ä¹°
                        </button>
                    </div>
                </div>
            `).join('');

            // æ·»åŠ è´­ä¹°æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.buy-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const seedId = this.getAttribute('data-seed-id');
                    buySeed(seedId);
                });
            });

            // æ·»åŠ ç§å­é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.seed-item').forEach(item => {
                item.addEventListener('click', function() {
                    const seedId = this.getAttribute('data-seed-id');
                    selectSeed(seedId);
                });
            });
        }

        // è´­ä¹°ç§å­
        function buySeed(seedId) {
            const seed = getSeedById(seedId);

            if (gameState.money >= seed.price) {
                gameState.money -= seed.price;

                if (!gameState.purchasedSeeds[seedId]) {
                    gameState.purchasedSeeds[seedId] = 0;
                }
                gameState.purchasedSeeds[seedId]++;

                updateUI();
                renderShop();
                showNotification(`æˆåŠŸè´­ä¹° ${seed.name} ç§å­!`, 'success');

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            } else {
                showNotification('é‡‘å¸ä¸è¶³!', 'error');
            }
        }

        // é€‰æ‹©ç§å­æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å±äºæœ¬åœ°åŒº
        function selectSeed(seedId) {
            const seed = getSeedById(seedId);
            if (!seed.regions.includes(gameState.currentRegion)) {
                showNotification('è¯¥ç§å­ä¸å±äºå½“å‰åœ°åŒº!', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²è´­ä¹°è¯¥ç§å­
            if (!gameState.purchasedSeeds[seedId] || gameState.purchasedSeeds[seedId] <= 0) {
                showNotification('è¯·å…ˆè´­ä¹°è¯¥ç§å­!', 'error');
                return;
            }

            gameState.currentSelectedSeed = seedId;

            // æ›´æ–°UIæ˜¾ç¤ºé€‰ä¸­çš„ç§å­
            document.querySelectorAll('.seed-item').forEach(item => {
                if (item.getAttribute('data-seed-id') === seedId) {
                    item.classList.add('ring-2', 'ring-green-500');
                } else {
                    item.classList.remove('ring-2', 'ring-green-500');
                }
            });

            showNotification(`å·²é€‰æ‹©: ${seed.name}ç§å­`, 'info');
        }

        // æ¸²æŸ“å†œç”°ï¼ˆåªå…è®¸ç§æ¤æœ¬åœ°åŒºçš„ç§å­ï¼‰
        function renderFarm() {
            elements.farmGrid.innerHTML = '';
            
            // ç¡®ä¿farmDataæ•°ç»„é•¿åº¦ä¸plotsä¸€è‡´
            while (gameState.farmData.length < gameState.plots) {
                gameState.farmData.push({
                    state: 'empty', // empty, planted, wasteland
                    seedId: null,
                    growth: null, // null, growing, completed
                    progress: 0,
                    growthTime: 0
                });
            }

            for (let i = 0; i < gameState.plots; i++) {
                const plotData = gameState.farmData[i];
                const plot = document.createElement('div');
                
                // è·å–åœŸåœ°æ”¹è‰¯ç­‰çº§å’Œæ•°æ®
                const landLevel = getLandImprovementLevel(i);
                const landData = getLandImprovementData(landLevel);
                
                // æ ¹æ®åœŸåœ°ç­‰çº§è®¾ç½®èƒŒæ™¯è‰²
                plot.className = `crop-plot ${landData.color} border-2 border-yellow-200 rounded-2xl aspect-square flex flex-col items-center justify-center p-4 cursor-pointer shadow-md hover:shadow-xl transition`;
                
                // æ·»åŠ åœŸåœ°æ”¹è‰¯ç­‰çº§æŒ‡ç¤ºå™¨
                const landIndicator = document.createElement('div');
                landIndicator.className = 'absolute top-1 left-1 text-xs px-1 py-0.5 bg-black bg-opacity-50 text-white rounded';
                landIndicator.innerHTML = `${landData.icon} ${landData.name}`;
                landIndicator.style.fontSize = '10px';
                plot.style.position = 'relative';
                plot.appendChild(landIndicator);
                
                // æ ¹æ®åœ°å—çŠ¶æ€è®¾ç½®ä¸åŒçš„æ˜¾ç¤º
                if (plotData.state === 'empty') {
                    // ç©ºé—²å†œç”°
                    plot.innerHTML += `
                        <div class="text-5xl mb-2">ğŸŒ±</div>
                        <p class="text-base text-center text-gray-600 font-semibold">ç©ºé—²å†œç”°</p>
                        <div class="w-full bg-gray-200 rounded-full h-2 hidden">
                            <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    `;
                    
                    // æ·»åŠ åœŸåœ°æ”¹è‰¯æŒ‰é’®
                    if (landLevel < landImprovementLevels.length - 1) {
                        const nextLevelData = getLandImprovementData(landLevel + 1);
                        const upgradeBtn = document.createElement('button');
                        upgradeBtn.className = 'land-upgrade-btn bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs mt-1';
                        upgradeBtn.textContent = `å‡çº§åœŸåœ° (${nextLevelData.cost}é‡‘å¸)`;
                        upgradeBtn.setAttribute('data-plot-index', i);
                        upgradeBtn.onclick = function(e) {
                            e.stopPropagation();
                            upgradeLandImprovement(i);
                        };
                        plot.appendChild(upgradeBtn);
                    }
                } else if (plotData.state === 'wasteland') {
                    // è’åœ°
                    plot.innerHTML += `
                        <div class="text-5xl mb-2">ğŸŒµ</div>
                        <p class="text-base text-center font-semibold text-red-800">è’åœ°(éœ€ä¿®å¤)</p>
                        <button class="repair-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm mt-1" data-plot-index="${i}">
                            ä¿®å¤ (50é‡‘å¸)
                        </button>
                    `;
                    plot.querySelector('.repair-btn').addEventListener('click', function() {
                        repairPlot(i);
                    });
                } else if (plotData.state === 'planted') {
                    // å·²ç§æ¤
                    const seed = getSeedById(plotData.seedId);
                    if (seed) {
                        plot.setAttribute('data-planted', seed.id);
                        // è®¡ç®—ç”Ÿé•¿è¿›åº¦å’Œæˆç†ŸçŠ¶æ€ï¼Œåº”ç”¨åœŸåœ°æ”¹è‰¯åŠ æˆ
                        if (plotData.plantedAt && plotData.growthTime) {
                            const now = Date.now();
                            const elapsed = (now - plotData.plantedAt) / 1000; // ç§’
                            if (plotData.growthTime) {
                                // åº”ç”¨åœŸåœ°æ”¹è‰¯çš„ç”Ÿé•¿é€Ÿåº¦åŠ æˆ
                                const totalSeconds = (plotData.growthTime * 60) / landData.growthBonus;
                                plotData.progress = elapsed;
                                if (plotData.progress >= totalSeconds) {
                                    plotData.growth = 'completed';
                                    plotData.progress = totalSeconds;
                                } else {
                                    plotData.growth = 'growing';
                                }
                            }
                        }
                        plot.setAttribute('data-growth', plotData.growth);
                        if (plotData.growth === 'completed') {
                            // æˆç†Ÿçš„ä½œç‰©
                            plot.innerHTML += `
                                <div class="text-5xl mb-2">${seed.icon}</div>
                                <p class="text-base text-center font-semibold text-green-800">${seed.name}</p>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="progress-bar bg-yellow-500 h-2 rounded-full" style="width: 100%"></div>
                                </div>
                                <p class="text-base text-gray-500 mt-1">å¯ä»¥æ”¶è·äº†!</p>
                            `;
                            plot.classList.add('animate-pulse');
                        } else {
                            // ç”Ÿé•¿ä¸­çš„ä½œç‰©
                            const totalSeconds = (plotData.growthTime * 60) / landData.growthBonus;
                            let percent = plotData.progress / totalSeconds * 100;
                            if (percent >= 100) {
                                // æ²¡æˆç†Ÿæ—¶è¿›åº¦æ¡æ»¡äº†ä¹Ÿå¾ªç¯åŠ¨ç”»
                                percent = (Date.now() % 2000) / 2000 * 100;
                            }
                            plot.innerHTML += `
                                <div class="text-5xl mb-2">${seed.icon}</div>
                                <p class="text-base text-center font-semibold text-green-800">${seed.name}</p>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: ${percent}%"></div>
                                </div>
                                <p class="text-base text-gray-500 mt-1">æˆé•¿ä¸­...</p>
                            `;
                            // æ–°å¢ï¼šæ’å…¥æµ‡æ°´æŒ‰é’®å’ŒçŠ¶æ€
                            let statusHtml = '';
                            if (plotData.pest) {
                                statusHtml += '<span class="text-red-600 font-bold">ç—…è™«å®³</span> ';
                                statusHtml += `<button class='pesticide-btn bg-green-700 hover:bg-green-800 text-white px-2 py-1 rounded text-xs mt-1' data-plot-index='${i}'>ç”¨å†œè¯(10é‡‘å¸)</button> `;
                            }
                            if (plotData.witherCountdown >= 3) statusHtml += '<span class="text-gray-700 font-bold">å·²æ¯æ­»</span> ';
                            if (gameState.weather === 'drought' && (!plotData.lastWateredAt || Date.now() - plotData.lastWateredAt > 24*60*60*1000)) {
                                statusHtml += '<span class="text-yellow-700 font-bold">éœ€æµ‡æ°´</span> ';
                            }
                            if (gameState.weather === 'sunny' && (!plotData.lastWateredAt || Date.now() - plotData.lastWateredAt > 24*60*60*1000)) {
                                statusHtml += '<span class="text-yellow-700 font-bold">éœ€æµ‡æ°´</span> ';
                            }
                            let wateredToday = false;
                            if (plotData.lastWateredAt) {
                                const last = new Date(plotData.lastWateredAt);
                                const now = new Date();
                                wateredToday = last.getFullYear() === now.getFullYear() && last.getMonth() === now.getMonth() && last.getDate() === now.getDate();
                            }
                            if (wateredToday) {
                                statusHtml += `<button class='water-btn bg-gray-400 text-white px-2 py-1 rounded text-xs mt-1' data-plot-index='${i}' disabled>å·²æµ‡æ°´</button>`;
                            } else {
                                statusHtml += `<button class='water-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs mt-1' data-plot-index='${i}'>æµ‡æ°´</button>`;
                            }
                            plot.innerHTML += `<div class='mt-2 text-center'>${statusHtml}</div>`;
                        }
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°ç§å­æ•°æ®ï¼Œé‡ç½®ä¸ºç©ºé—²
                        plotData.state = 'empty';
                        plotData.seedId = null;
                        plotData.growth = null;
                        plot.innerHTML += `
                            <div class="text-5xl mb-2">ğŸŒ±</div>
                            <p class="text-base text-center text-gray-600 font-semibold">ç©ºé—²å†œç”°</p>
                            <div class="w-full bg-gray-200 rounded-full h-2 hidden">
                                <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        `;
                    }
                }
                
                // æ·»åŠ äº‹ä»¶å½±å“æŒ‡ç¤ºå™¨
                const activeEvent = gameState.activeEvents.find(event => 
                    event.affectedPlots.includes(i)
                );
                
                if (activeEvent) {
                    const eventIndicator = document.createElement('div');
                    eventIndicator.className = `event-indicator ${activeEvent.color}`;
                    eventIndicator.innerHTML = activeEvent.icon;
                    eventIndicator.title = `${activeEvent.name}: ${activeEvent.description}`;
                    plot.appendChild(eventIndicator);
                    
                    // æ·»åŠ äº‹ä»¶åŠ¨ç”»ç±»
                    plot.classList.add(activeEvent.animation);
                }
                
                plot.setAttribute('data-plot-index', i);
                plot.addEventListener('click', () => handlePlotClick(i));
                elements.farmGrid.appendChild(plot);
            }
            
            // ä¿å­˜æ¸¸æˆæ•°æ®
            saveGameData();
            // ä¿®æ­£ï¼šæ¸²æŸ“åç«‹å³ç»‘å®šæµ‡æ°´æŒ‰é’®äº‹ä»¶
            setTimeout(() => {
                // ç»‘å®šå†œè¯æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.pesticide-btn').forEach(btn => {
                    btn.onclick = function(e) {
                        e.stopPropagation();
                        const idx = parseInt(this.getAttribute('data-plot-index'));
                        const plot = gameState.farmData[idx];
                        if (gameState.money < 10) {
                            showNotification('é‡‘å¸ä¸è¶³ï¼Œæ— æ³•ä½¿ç”¨å†œè¯', 'error');
                            return;
                        }
                        gameState.money -= 10;
                        plot.pest = false;
                        renderFarm();
                        saveGameData();
                        showNotification('ç—…è™«å®³å·²æ¸…é™¤ï¼', 'success');
                    };
                });
                
                // ç»‘å®šæµ‡æ°´æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.water-btn').forEach(btn => {
                    if (btn.disabled) return;
                    btn.onclick = function(e) {
                        e.stopPropagation();
                        const idx = parseInt(this.getAttribute('data-plot-index'));
                        const plot = gameState.farmData[idx];
                        plot.lastWateredAt = Date.now();
                        plot.witherCountdown = 0;
                        renderFarm();
                        saveGameData();
                        showNotification('æµ‡æ°´æˆåŠŸï¼', 'success');
                    };
                });
            }, 0);
        }
        
        // ç»§ç»­æ¤ç‰©ç”Ÿé•¿
        function continuePlantGrowth(plotIndex, plot) {
            // è¯¥å‡½æ•°ä¸å†éœ€è¦å®šæ—¶å™¨é€»è¾‘ï¼Œä¿ç•™ç©ºå®ç°æˆ–ç›´æ¥ç§»é™¤
        }

        // å¤„ç†å†œç”°ç‚¹å‡»
        function handlePlotClick(plotIndex) {
            const plot = document.querySelector(`[data-plot-index="${plotIndex}"]`);

            // æ£€æŸ¥åœ°å—æ˜¯å¦ç©ºé—²
            if (!plot.hasAttribute('data-planted')) {
                // å¦‚æœæœ‰é€‰ä¸­çš„ç§å­ï¼Œåˆ™ç§æ¤
                if (gameState.currentSelectedSeed) {
                    const seed = getSeedById(gameState.currentSelectedSeed);

                    // ç›´æ¥ç§æ¤ï¼Œä¸æ¶ˆè€—é‡‘å¸
                    plantSeed(plotIndex, seed);
                    updateUI();

                    // ä¿å­˜æ¸¸æˆæ•°æ®
                    saveGameData();
                } else {
                    showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç§å­!', 'error');
                }
            } else {
                // æ£€æŸ¥ä½œç‰©æ˜¯å¦æˆç†Ÿ
                if (plot.getAttribute('data-growth') === 'completed') {
                    harvestCrop(plotIndex);
                }
            }
        }

        // ç§æ¤ç§å­
        function plantSeed(plotIndex, seed) {
            const plot = document.querySelector(`[data-plot-index="${plotIndex}"]`);
            const plotData = gameState.farmData[plotIndex];

            // æœ‰10%çš„æ¦‚ç‡ç§æ¤å¤±è´¥ï¼Œå˜æˆè’åœ°
            if (Math.random() < 0.1) {
                // æ›´æ–°æ¸¸æˆçŠ¶æ€ä¸­çš„å†œç”°æ•°æ®
                plotData.state = 'wasteland';
                plotData.seedId = null;
                plotData.growth = null;
                plotData.progress = 0;
                plotData.growthTime = 0;
                
                // æ›´æ–°DOM
                plot.setAttribute('data-state', 'wasteland');
                plot.innerHTML = `
                    <div class="text-5xl mb-2">ğŸŒµ</div>
                    <p class="text-base text-center font-semibold text-red-800">è’åœ°(éœ€ä¿®å¤)</p>
                    <button class="repair-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm mt-1" data-plot-index="${plotIndex}">
                        ä¿®å¤ (50é‡‘å¸)
                    </button>
                `;
                plot.querySelector('.repair-btn').addEventListener('click', function() {
                    repairPlot(plotIndex);
                });
                showNotification('ç§æ¤å¤±è´¥! å†œç”°å˜æˆäº†è’åœ°!', 'error');
                
                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
                return;
            }

            // è·å–å½“å‰å¤©æ°”
            const weather = weatherTypes.find(w => w.id === gameState.weather);

            // åº”ç”¨æµ‡æ°´æ•ˆç‡å‡çº§å’Œå¤©æ°”å½±å“
            let growthTime = seed.growTime *
                           (1 - (gameState.upgrades.watering * 0.1)) *
                           (1 / weather.effect.growth);

            // åº”ç”¨æ¸©å®¤å‡çº§å‡å°‘å¤©æ°”å½±å“
            if (gameState.upgrades.greenhouse > 0) {
                const weatherImpactReduction = 0.5; // æ¸©å®¤å‡å°‘50%å¤©æ°”å½±å“
                const adjustedGrowthEffect = weather.effect.growth + (1 - weather.effect.growth) * weatherImpactReduction;
                growthTime = seed.growTime * (1 - (gameState.upgrades.watering * 0.1)) * (1 / adjustedGrowthEffect);
            }

            // æ›´æ–°æ¸¸æˆçŠ¶æ€ä¸­çš„å†œç”°æ•°æ®
            plotData.state = 'planted';
            plotData.seedId = seed.id;
            plotData.growth = 'growing';
            plotData.progress = 0;
            plotData.growthTime = growthTime;
            plotData.plantedAt = Date.now(); // æ–°å¢ï¼Œè®°å½•ç§æ¤æ—¶é—´æˆ³
            
            // æ›´æ–°DOM
            plot.setAttribute('data-planted', seed.id);
            plot.setAttribute('data-state', 'planted');
            plot.setAttribute('data-growth', 'growing');
            plot.innerHTML = `
                <div class="text-5xl mb-2">${seed.icon}</div>
                <p class="text-base text-center font-semibold text-green-800">${seed.name}</p>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                    <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-base text-gray-500 mt-1">æˆé•¿ä¸­...</p>
            `;

            // å¼€å§‹ç”Ÿé•¿è®¡æ—¶å™¨
            continuePlantGrowth(plotIndex, plot);

            // æ›´æ–°ç§å­åº“å­˜
            gameState.purchasedSeeds[seed.id]--;
            if (gameState.purchasedSeeds[seed.id] <= 0) {
                delete gameState.purchasedSeeds[seed.id];
                gameState.currentSelectedSeed = null;
                // Clear selected seed UI
                document.querySelectorAll('.seed-item').forEach(item => {
                    item.classList.remove('ring-2', 'ring-green-500');
                });
            }
            
            // æ›´æ–°UIæ˜¾ç¤ºç§å­æ•°é‡
            updateUI();
            renderShop();
            
            showNotification(`å·²ç§æ¤ ${seed.name}!`, 'success');

            // æ›´æ–°ä»»åŠ¡è¿›åº¦
            updateTaskProgress('plant');

            // ä¿å­˜æ¸¸æˆæ•°æ®
            saveGameData();
        }

        // æ”¶è·ä½œç‰©
        function harvestCrop(plotIndex) {
            const plot = document.querySelector(`[data-plot-index="${plotIndex}"]`);
            const plotData = gameState.farmData[plotIndex];
            // ç¡®ä¿åœ°å—çŠ¶æ€æ­£ç¡®
            if (plotData.state !== 'planted' || plotData.growth !== 'completed') {
                showNotification('æ”¶è·å¤±è´¥ï¼šä½œç‰©æœªæˆç†Ÿæˆ–çŠ¶æ€å¼‚å¸¸', 'error');
                return;
            }
            // å¹²æ—±æ¯æ­»æ— æ³•æ”¶è·
            if (plotData.witherCountdown >= 3) {
                showNotification('ä½œç‰©å·²æ¯æ­»ï¼Œæ— æ³•æ”¶è·', 'error');
                return;
            }
            const seedId = plotData.seedId;
            const seed = getSeedById(seedId);
            if (!seed) {
                // å¦‚æœæ‰¾ä¸åˆ°ç§å­æ•°æ®ï¼Œé‡ç½®ä¸ºç©ºé—²
                plotData.state = 'empty';
                plotData.seedId = null;
                plotData.growth = null;
                plotData.progress = 0;
                plotData.growthTime = 0;
                saveGameData();
                renderFarm();
                showNotification('æ”¶è·å¤±è´¥ï¼šä½œç‰©æ•°æ®å¼‚å¸¸', 'error');
                return;
            }
            // è·å–å½“å‰å¤©æ°”
            const weather = weatherTypes.find(w => w.id === gameState.weather);
            
            // è·å–åœŸåœ°æ”¹è‰¯ç­‰çº§å’ŒåŠ æˆ
            const landLevel = getLandImprovementLevel(plotIndex);
            const landData = getLandImprovementData(landLevel);
            
            // åº”ç”¨è´¨é‡å‡çº§ã€åœŸåœ°æ”¹è‰¯å’Œå¤©æ°”å½±å“
            let sellPrice = Math.floor(seed.sellPrice * (1 + (gameState.upgrades.quality * 0.15)) * landData.yieldBonus);

            // æ ¹æ®å¤©æ°”ç±»å‹åº”ç”¨ä¸åŒçš„ä»·æ ¼å½±å“
            if (weather) {
                if (weather.id === 'rainbow') {
                    // å½©è™¹å¤©ï¼šäº§é‡åŠ æˆ50%
                    sellPrice = Math.floor(sellPrice * 1.5);
                } else if (weather.id === 'sunny') {
                    // æ™´å¤©ï¼šæ­£å¸¸ä»·æ ¼ï¼Œä½†æœªæµ‡æ°´å‡äº§
                    if (!plotData.lastWateredAt || Date.now() - plotData.lastWateredAt > 24*60*60*1000) {
                        sellPrice = Math.floor(sellPrice * 0.5);
                    }
                } else if (weather.id === 'rainy') {
                    // é›¨å¤©ï¼šæ­£å¸¸ä»·æ ¼
                    sellPrice = sellPrice;
                } else if (weather.id === 'stormy') {
                    // æš´é›¨ï¼šä»·æ ¼é™ä½20%
                    sellPrice = Math.floor(sellPrice * 0.8);
                } else if (weather.id === 'drought') {
                    // å¹²æ—±ï¼šä»·æ ¼é™ä½30%
                    sellPrice = Math.floor(sellPrice * 0.7);
                } else if (weather.id === 'typhoon') {
                    // å°é£ï¼šä»·æ ¼é™ä½25%
                    sellPrice = Math.floor(sellPrice * 0.75);
                } else if (weather.id === 'sandstorm') {
                    // æ²™å°˜æš´ï¼šä»·æ ¼é™ä½40%
                    sellPrice = Math.floor(sellPrice * 0.6);
                }
            }
            
            // åº”ç”¨äº‹ä»¶å½±å“
            if (plotData.qualityMultiplier) {
                sellPrice = Math.floor(sellPrice * plotData.qualityMultiplier);
            }
            if (plotData.disease) {
                sellPrice = Math.floor(sellPrice * 0.5);
            }
            if (plotData.soilEffect) {
                sellPrice = Math.floor(sellPrice * plotData.soilEffect.quality);
            }
            
            // ç—…è™«å®³å‡äº§
            if (plotData.pest) {
                sellPrice = Math.floor(sellPrice * 0.7);
            }
            // æ›´æ–°æ¸¸æˆçŠ¶æ€ï¼ˆåªè·å¾—ç»éªŒï¼Œä¸è·å¾—é‡‘å¸ï¼‰
            gameState.xp += seed.xp;
            // æ›´æ–°ä»»åŠ¡è¿›åº¦
            updateTaskProgress('harvest');
            
            // æ ¹æ®åœŸåœ°å“è´¨ç¡®å®šæ°´æœå“è´¨å¹¶æ›´æ–°åº“å­˜
            const fruitQuality = determineFruitQuality(plotIndex);
            const qualityData = getFruitQualityData(fruitQuality);
            addQualityFruitToInventory(seedId, fruitQuality, 1);
            
            // åŒæ—¶ä¿æŒæ—§åº“å­˜ç³»ç»Ÿå…¼å®¹æ€§ï¼ˆæš‚æ—¶ï¼‰
            if (!gameState.inventory[seedId]) {
                gameState.inventory[seedId] = 0;
            }
            gameState.inventory[seedId]++;
            
            // æ¸…é™¤ç—…è™«å®³
            plotData.pest = false;
            // é‡ç½®åœ°å—æ•°æ®
            plotData.state = 'empty';
            plotData.seedId = null;
            plotData.growth = null;
            plotData.progress = 0;
            plotData.growthTime = 0;
            plotData.lastWateredAt = null;
            plotData.witherCountdown = 0;
            // é‡ç½®DOM
            plot.removeAttribute('data-planted');
            plot.removeAttribute('data-growth');
            plot.classList.remove('animate-pulse');
            plot.innerHTML = `
                <div class="text-5xl mb-2">ğŸŒ±</div>
                <p class="text-base text-center text-gray-600 font-semibold">ç©ºé—²å†œç”°</p>
                <div class="w-full bg-gray-200 rounded-full h-2 hidden">
                    <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
            `;
            // é‡æ–°æ·»åŠ äº‹ä»¶ç›‘å¬
            plot.addEventListener('click', () => handlePlotClick(plotIndex));
            // æ›´æ–°UI
            updateUI();
            renderInventory();
            // ä¿å­˜æ¸¸æˆæ•°æ®
            saveGameData();
            showNotification(`æ”¶è· ${qualityData.name}${seed.name}! +${seed.xp}ç»éªŒï¼Œä»“åº“+1`, 'success');
        }

        // ä¿®å¤è’åœ°
        function repairPlot(plotIndex) {
            const plot = document.querySelector(`[data-plot-index="${plotIndex}"]`);

            if (gameState.money >= 50) {
                gameState.money -= 50;
                
                // æ›´æ–°æ¸¸æˆçŠ¶æ€ä¸­çš„å†œç”°æ•°æ®
                const plotData = gameState.farmData[plotIndex];
                plotData.state = 'empty';
                plotData.seedId = null;
                plotData.growth = null;
                plotData.progress = 0;
                plotData.growthTime = 0;
                
                // æ›´æ–°DOM
                plot.removeAttribute('data-state');
                plot.innerHTML = `
                    <div class="text-5xl mb-2">ğŸŒ±</div>
                    <p class="text-base text-center text-gray-600 font-semibold">ç©ºé—²å†œç”°</p>
                    <div class="w-full bg-gray-200 rounded-full h-2 hidden">
                        <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                `;
                plot.addEventListener('click', () => handlePlotClick(plotIndex));
                updateUI();
                showNotification('å†œç”°ä¿®å¤æˆåŠŸ!', 'success');

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            } else {
                showNotification('é‡‘å¸ä¸è¶³!', 'error');
            }
        }

        // æ¸²æŸ“åº“å­˜ï¼ˆæ˜¾ç¤ºæ‰€æœ‰ä½œç‰©ï¼ŒæŒ‰å“è´¨åˆ†ç±»ï¼‰
        function renderInventory() {
            // ä½œç‰©/æ°´æœåˆ—è¡¨
            const cropBox = document.getElementById('crop-inventory-list');
            // åŠ¨ç‰©äº§å“åˆ—è¡¨
            const animalBox = document.getElementById('animal-inventory-list');

            // æ¸²æŸ“æŒ‰å“è´¨åˆ†ç±»çš„ä½œç‰©/æ°´æœ
            const qualityInventory = gameState.qualityInventory || {};
            const hasQualityInventory = Object.keys(qualityInventory).length > 0;
            
            if (!hasQualityInventory) {
                cropBox.innerHTML = '<div class="text-gray-500 italic">è¿™é‡Œä¼šæ˜¾ç¤ºä½ æ”¶è·çš„ä½œç‰©</div>';
            } else {
                let inventoryHtml = '<div class="font-bold text-lg mb-4 flex items-center"><i class="fas fa-apple-alt mr-2 text-green-500"></i>ä½œç‰©/æ°´æœ (æŒ‰å“è´¨åˆ†ç±»)</div>';
                
                // éå†æ¯ç§ä½œç‰©
                Object.entries(qualityInventory).forEach(([seedId, qualityData]) => {
                    const seed = getSeedById(seedId);
                    if (!seed) return;
                    
                    // ä¸ºæ¯ç§å“è´¨åˆ›å»ºå•ç‹¬çš„æ¡ç›®
                    fruitQualities.forEach(quality => {
                        const count = qualityData[quality.level] || 0;
                        if (count > 0) {
                            const baseSellPrice = Math.floor(seed.sellPrice * (1 + (gameState.upgrades.quality * 0.15)));
                            const qualityPrice = Math.floor(baseSellPrice * quality.priceMultiplier);
                            
                            // åº”ç”¨å¤©æ°”å½±å“
                            const weather = weatherTypes.find(w => w.id === gameState.weather);
                            let adjustedPrice = qualityPrice;
                            if (weather) {
                                if (weather.id === 'rainbow') adjustedPrice = Math.floor(qualityPrice * 1.5);
                                else if (weather.id === 'stormy') adjustedPrice = Math.floor(qualityPrice * 0.8);
                                else if (weather.id === 'drought') adjustedPrice = Math.floor(qualityPrice * 0.7);
                                else if (weather.id === 'typhoon') adjustedPrice = Math.floor(qualityPrice * 0.75);
                                else if (weather.id === 'sandstorm') adjustedPrice = Math.floor(qualityPrice * 0.6);
                            }
                            
                            inventoryHtml += `
                                <div class="flex justify-between items-center p-3 border rounded-lg mb-2 ${quality.color}">
                                    <div class="flex items-center">
                                        <span class="text-2xl mr-3">${seed.icon}</span>
                                        <div>
                                            <div class="font-semibold text-lg flex items-center">
                                                <span class="mr-2">${quality.icon}</span>
                                                <span>${quality.name}${seed.name}</span>
                                                <span class="ml-2 text-sm text-gray-600">Ã— ${count}</span>
                                            </div>
                                            <div class="text-xs text-gray-500">${quality.description}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" min="1" max="${count}" value="1" class="quality-sell-qty-input w-14 px-1 py-0.5 border rounded text-center mr-1" data-seed-id="${seedId}" data-quality="${quality.level}" />
                                        <button class="quality-sell-btn btn-strong px-4 py-2 text-base" data-seed-id="${seedId}" data-quality="${quality.level}" data-price="${adjustedPrice}">
                                            å‡ºå”® (${adjustedPrice}é‡‘å¸)
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                });
                
                cropBox.innerHTML = inventoryHtml;
            }
            // æ¸²æŸ“åŠ¨ç‰©äº§å“
            const animalProducts = [
                { id: 'egg', name: 'é¸¡è›‹', icon: 'ğŸ¥š', price: 8, card: 'border-l-4 border-gray-200 bg-gray-50' },
                { id: 'milk', name: 'ç‰›å¥¶', icon: 'ğŸ¥›', price: 20, card: 'border-l-4 border-blue-200 bg-blue-50' },
                { id: 'wool', name: 'ç¾Šæ¯›', icon: 'ğŸ§¶', price: 15, card: 'border-l-4 border-gray-200 bg-gray-50' },
                { id: 'pork', name: 'çŒªè‚‰', icon: 'ğŸ¥©', price: 25, card: 'border-l-4 border-green-200 bg-green-50' },
                { id: 'duck_egg', name: 'é¸­è›‹', icon: 'ğŸ¥š', price: 12, card: 'border-l-4 border-gray-200 bg-gray-50' },
                { id: 'goat_milk', name: 'ç¾Šå¥¶', icon: 'ğŸ¥›', price: 30, card: 'border-l-4 border-green-200 bg-green-50' },
                { id: 'rabbit_fur', name: 'å…”æ¯›', icon: 'ğŸ§¶', price: 40, card: 'border-l-4 border-blue-200 bg-blue-50' },
                { id: 'horse_manure', name: 'é©¬ç²ª', icon: 'ğŸ’©', price: 5, card: 'border-l-4 border-gray-200 bg-gray-50' }
            ];
            let hasAnimalProduct = false;
            animalBox.innerHTML = '<div class="font-bold text-xl mb-4 flex items-center"><i class="fas fa-gift mr-2 text-green-600"></i>åŠ¨ç‰©å‰¯äº§å“</div>' +
                animalProducts.map(p => {
                    const count = gameState.animalProducts[p.id] || 0;
                    if (count > 0) hasAnimalProduct = true;
                    return `
                        <div class="flex justify-between items-center rounded-xl shadow-sm px-5 py-4 mb-4 ${p.card}">
                            <div class="flex items-center">
                                <span class="text-4xl mr-4">${p.icon}</span>
                                <div>
                                    <div class="font-bold text-xl">${p.name}</div>
                                    <div class="text-gray-500 text-base">å”®ä»·: ${p.price}é‡‘å¸</div>
                                </div>
                            </div>
                            <div class="flex flex-col items-end">
                                <div class="font-bold text-green-700 text-lg mb-2">æ•°é‡: <span>${count}</span></div>
                                <button class="sell-animal-btn bg-yellow-400 hover:bg-yellow-500 text-white font-bold px-6 py-2 rounded-lg text-lg" data-product-id="${p.id}" data-price="${p.price}" ${count === 0 ? 'disabled style=\'opacity:0.5;cursor:not-allowed;\'' : ''}>å‡ºå”®</button>
                            </div>
                        </div>
                    `;
                }).join('');
            if (!hasAnimalProduct) {
                animalBox.innerHTML += '<div class="text-gray-500 italic">è¿™é‡Œä¼šæ˜¾ç¤ºä½ è·å¾—çš„åŠ¨ç‰©äº§å“</div>';
            }
            // ç»‘å®šåŠ¨ç‰©äº§å“å‡ºå”®æŒ‰é’®
            document.querySelectorAll('.sell-animal-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-product-id');
                    const price = parseInt(this.getAttribute('data-price'));
                    if ((gameState.animalProducts[id]||0) < 1) return;
                    gameState.animalProducts[id] -= 1;
                    gameState.money += price;
                    renderInventory();
                    updateUI();
                    saveGameData();
                    const productNames = {
                        'egg': 'é¸¡è›‹', 'milk': 'ç‰›å¥¶', 'wool': 'ç¾Šæ¯›', 'pork': 'çŒªè‚‰',
                        'duck_egg': 'é¸­è›‹', 'goat_milk': 'ç¾Šå¥¶', 'rabbit_fur': 'å…”æ¯›', 'horse_manure': 'é©¬ç²ª'
                    };
                    showNotification(`å‡ºå”®${productNames[id]} Ã—1æˆåŠŸï¼+${price}é‡‘å¸`,'success');
                });
            });
            
            // ç»‘å®šå“è´¨ä½œç‰©å‡ºå”®æŒ‰é’®
            document.querySelectorAll('.quality-sell-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const seedId = this.getAttribute('data-seed-id');
                    const quality = parseInt(this.getAttribute('data-quality'));
                    const price = parseInt(this.getAttribute('data-price'));
                    const qtyInput = document.querySelector(`.quality-sell-qty-input[data-seed-id="${seedId}"][data-quality="${quality}"]`);
                    const qty = parseInt(qtyInput.value) || 1;
                    sellQualityFruit(seedId, quality, qty, price);
                });
            });
            
            // ç»‘å®šä½œç‰©å‡ºå”®æŒ‰é’®ï¼ˆæ—§ç³»ç»Ÿå…¼å®¹ï¼‰
            document.querySelectorAll('.sell-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const seedId = this.getAttribute('data-seed-id');
                    const qtyInput = document.querySelector(`.sell-qty-input[data-seed-id="${seedId}"]`);
                    const qty = parseInt(qtyInput.value) || 1;
                    sellCrops(seedId, qty);
                });
            });
        }

        // å‡ºå”®ä½œç‰©ï¼Œæ”¯æŒæ•°é‡
        function sellCrops(seedId, qty = 1) {
            if (gameState.inventory[seedId] && gameState.inventory[seedId] > 0) {
                qty = Math.max(1, Math.min(qty, gameState.inventory[seedId]));
                const seed = getSeedById(seedId);
                const sellPrice = Math.floor(seed.sellPrice * (1 + (gameState.upgrades.quality * 0.15)));
                const weather = weatherTypes.find(w => w.id === gameState.weather);
                let adjustedPrice = sellPrice;
                
                // æ ¹æ®å¤©æ°”ç±»å‹åº”ç”¨ä¸åŒçš„ä»·æ ¼å½±å“
                if (weather) {
                    if (weather.id === 'rainbow') {
                        // å½©è™¹å¤©ï¼šäº§é‡åŠ æˆ50%
                        adjustedPrice = Math.floor(sellPrice * 1.5);
                    } else if (weather.id === 'sunny') {
                        // æ™´å¤©ï¼šæ­£å¸¸ä»·æ ¼
                        adjustedPrice = sellPrice;
                    } else if (weather.id === 'rainy') {
                        // é›¨å¤©ï¼šæ­£å¸¸ä»·æ ¼
                        adjustedPrice = sellPrice;
                    } else if (weather.id === 'stormy') {
                        // æš´é›¨ï¼šä»·æ ¼é™ä½20%
                        adjustedPrice = Math.floor(sellPrice * 0.8);
                    } else if (weather.id === 'drought') {
                        // å¹²æ—±ï¼šä»·æ ¼é™ä½30%
                        adjustedPrice = Math.floor(sellPrice * 0.7);
                    } else if (weather.id === 'typhoon') {
                        // å°é£ï¼šä»·æ ¼é™ä½25%
                        adjustedPrice = Math.floor(sellPrice * 0.75);
                    } else if (weather.id === 'sandstorm') {
                        // æ²™å°˜æš´ï¼šä»·æ ¼é™ä½40%
                        adjustedPrice = Math.floor(sellPrice * 0.6);
                } else {
                        // é»˜è®¤æ­£å¸¸ä»·æ ¼
                        adjustedPrice = sellPrice;
                }
                }
                
                gameState.money += adjustedPrice * qty;
                gameState.inventory[seedId] -= qty;
                if (gameState.inventory[seedId] <= 0) {
                    delete gameState.inventory[seedId];
                }
                updateUI();
                renderInventory();
                showNotification(`å”®å‡º ${seed.name} Ã—${qty}! +${adjustedPrice * qty}é‡‘å¸`, 'success');
                // æ›´æ–°ä»»åŠ¡è¿›åº¦
                updateTaskProgress('sell', adjustedPrice * qty);
                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        }

        // æ¸²æŸ“å‡çº§
        function renderUpgrades() {
            elements.upgrades.innerHTML = upgrades.map(upgrade => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                    <div>
                        <h3 class="font-semibold">${upgrade.name} (${gameState.upgrades[upgrade.id]}/${upgrade.maxLevel})</h3>
                        <p class="text-sm text-gray-600">${upgrade.description}</p>
                    </div>
                    <button class="upgrade-btn ${gameState.upgrades[upgrade.id] >= upgrade.maxLevel ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'} text-white px-3 py-1 rounded-lg"
                            data-upgrade="${upgrade.id}"
                            data-cost="${upgrades.find(u => u.id === upgrade.id).cost * (gameState.upgrades[upgrade.id] + 1)}"
                            ${gameState.upgrades[upgrade.id] >= upgrade.maxLevel ? 'disabled' : ''}>
                        <i class="fas fa-arrow-up mr-1"></i> ${upgrades.find(u => u.id === upgrade.id).cost * (gameState.upgrades[upgrade.id] + 1)}é‡‘å¸
                    </button>
                </div>
            `).join('');

            // æ·»åŠ å‡çº§æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.upgrade-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const upgradeId = this.getAttribute('data-upgrade');
                    const cost = parseInt(this.getAttribute('data-cost'));

                    purchaseUpgrade(upgradeId, cost);
                });
            });
        }
                // è´­ä¹°å‡çº§
        function purchaseUpgrade(upgradeId, cost) {
            if (gameState.upgrades[upgradeId] >= upgrades.find(u => u.id === upgradeId).maxLevel) return;
            if (gameState.money >= cost && cost > 0) {
                gameState.money -= cost;
                gameState.upgrades[upgradeId]++;
                updateUI();
                renderUpgrades();

                showNotification(`å‡çº§ ${upgrades.find(u => u.id === upgradeId).name} æˆåŠŸ!`, 'success');

                // æ›´æ–°ä»»åŠ¡è¿›åº¦
                updateTaskProgress('upgrade');

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            } else {
                showNotification('é‡‘å¸ä¸è¶³!', 'error');
            }
        }

        // æ‰©å±•å†œåœº
        elements.expandFarmBtn.addEventListener('click', function() {
            if (gameState.money >= 200 && gameState.plots < gameState.maxPlots) {
                gameState.money -= 200;
                // åªæ‰©å±•å½“å‰åŒºåŸŸ
                if (!gameState.regionPlots) gameState.regionPlots = {};
                if (!gameState.regionFarmData) gameState.regionFarmData = {};
                if (typeof gameState.regionPlots[gameState.currentRegion] !== 'number') {
                    gameState.regionPlots[gameState.currentRegion] = 4;
                }
                gameState.regionPlots[gameState.currentRegion]++;
                gameState.plots = gameState.regionPlots[gameState.currentRegion];
                if (!gameState.regionFarmData[gameState.currentRegion]) {
                    gameState.regionFarmData[gameState.currentRegion] = [];
                }
                while (gameState.regionFarmData[gameState.currentRegion].length < gameState.plots) {
                    gameState.regionFarmData[gameState.currentRegion].push({
                        state: 'empty',
                        seedId: null,
                        growth: null,
                        progress: 0,
                        growthTime: 0
                    });
                }
                gameState.farmData = gameState.regionFarmData[gameState.currentRegion];
                updateUI();
                renderFarm();
                checkExpandFarmButton();

                showNotification('å†œåœºæ‰©å±•æˆåŠŸ!', 'success');

                // æ›´æ–°ä»»åŠ¡è¿›åº¦
                updateTaskProgress('expand');

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        });

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰©å±•å†œåœº
        function checkExpandFarmButton() {
            if (gameState.plots >= gameState.maxPlots) {
                elements.expandFarmBtn.disabled = true;
                elements.expandFarmBtn.textContent = 'å·²è¾¾åˆ°æœ€å¤§å†œç”°æ•°é‡';
            } else {
                elements.expandFarmBtn.disabled = gameState.money < 200;
            }
        }

        // æ£€æŸ¥æ˜¯å¦å‡çº§
        function checkLevelUp() {
            if (gameState.xp >= gameState.maxXp) {
                gameState.level++;
                gameState.xp = gameState.xp - gameState.maxXp;
                gameState.maxXp = Math.floor(gameState.maxXp * 1.5);

                showNotification(`å‡çº§åˆ° ${gameState.level} çº§!`, 'info');

                // æ¯2çº§è§£é”ä¸€ä¸ªæ–°ç§å­
                if (gameState.level % 2 === 0 && gameState.level / 2 <= seeds.length) {
                    const newSeedIndex = Math.floor(gameState.level / 2) - 1;
                    if (newSeedIndex < seeds.length && !gameState.purchasedSeeds[seeds[newSeedIndex].id]) {
                        showNotification(`è§£é”æ–°ç§å­: ${seeds[newSeedIndex].name}!`, 'info');
                    }
                }

                updateUI();

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            elements.money.textContent = gameState.money;
            elements.level.textContent = gameState.level;
            elements.xp.textContent = gameState.xp;
            elements.maxXp.textContent = gameState.maxXp;
            elements.plotsCount.textContent = gameState.plots;

            // æ›´æ–°å•†åº—ç§å­å¯ç”¨æ€§
            document.querySelectorAll('.seed-item').forEach(item => {
                const seedId = item.getAttribute('data-seed-id');
                const seed = getSeedById(seedId);

                if (gameState.money < seed.price) {
                    item.classList.add('opacity-50');
                } else {
                    item.classList.remove('opacity-50');
                }
                
                // æ›´æ–°ç§å­æ•°é‡æ˜¾ç¤º
                const inventorySpan = item.querySelector('span.text-sm');
                if (inventorySpan) {
                    inventorySpan.textContent = `åº“å­˜: ${gameState.purchasedSeeds[seedId] || 0}`;
                }
            });

            // æ£€æŸ¥æ‰©å±•å†œç”°æŒ‰é’®
            checkExpandFarmButton();
        }

        // é€šè¿‡IDè·å–ç§å­
        function getSeedById(id) {
            return seeds.find(seed => seed.id === id);
        }

        // è·å–åœŸåœ°æ”¹è‰¯ç­‰çº§
        function getLandImprovementLevel(plotIndex) {
            if (!gameState.regionLandImprovements[gameState.currentRegion]) {
                return 0;
            }
            return gameState.regionLandImprovements[gameState.currentRegion][plotIndex] || 0;
        }

        // è®¾ç½®åœŸåœ°æ”¹è‰¯ç­‰çº§
        function setLandImprovementLevel(plotIndex, level) {
            if (!gameState.regionLandImprovements[gameState.currentRegion]) {
                gameState.regionLandImprovements[gameState.currentRegion] = {};
            }
            gameState.regionLandImprovements[gameState.currentRegion][plotIndex] = level;
        }

        // è·å–åœŸåœ°æ”¹è‰¯æ•°æ®
        function getLandImprovementData(level) {
            return landImprovementLevels.find(l => l.level === level) || landImprovementLevels[0];
        }

        // å‡çº§åœŸåœ°æ”¹è‰¯
        function upgradeLandImprovement(plotIndex) {
            const currentLevel = getLandImprovementLevel(plotIndex);
            const nextLevel = currentLevel + 1;
            
            if (nextLevel >= landImprovementLevels.length) {
                showNotification('åœŸåœ°å·²è¾¾åˆ°æœ€é«˜ç­‰çº§ï¼', 'info');
                return;
            }
            
            const nextLevelData = getLandImprovementData(nextLevel);
            if (gameState.money < nextLevelData.cost) {
                showNotification(`é‡‘å¸ä¸è¶³ï¼éœ€è¦ ${nextLevelData.cost} é‡‘å¸`, 'error');
                return;
            }
            
            gameState.money -= nextLevelData.cost;
            setLandImprovementLevel(plotIndex, nextLevel);
            
            showNotification(`åœŸåœ°æ”¹è‰¯æˆåŠŸï¼å‡çº§åˆ° ${nextLevelData.name}`, 'success');
            updateUI();
            renderFarm();
            saveGameData();
        }

        // ç”Ÿæˆæ¯æ—¥å¤©æ°”
        function generateWeather() {
            const weatherWeights = [0.5, 0.25, 0.15, 0.1]; // æ™´å¤©ã€é›¨å¤©ã€é˜´å¤©ã€æš´é£é›¨çš„æ¦‚ç‡æƒé‡
            const random = Math.random();
            let cumulativeWeight = 0;

            for (let i = 0; i < weatherTypes.length; i++) {
                cumulativeWeight += weatherWeights[i];
                if (random <= cumulativeWeight) {
                    gameState.weather = weatherTypes[i].id;
                    break;
                }
            }
            
            // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œä¿å­˜æ¸¸æˆæ•°æ®ï¼Œé¿å…é‡å¤ä¿å­˜
            // ä¿å­˜æ“ä½œå·²ç§»è‡³initGameå‡½æ•°ä¸­
        }

        // æ¸²æŸ“å¤©æ°”ä¿¡æ¯
        function renderWeather() {
            const weatherIcon = document.getElementById('weather-icon');
            const weatherName = document.getElementById('weather-name');
            const weatherEffects = document.getElementById('weather-effects');
            let icon = 'â˜€ï¸', name = 'æ™´å¤©', effects = 'ç”Ÿé•¿+0% å”®ä»·+0%';
            switch(gameState.weather){
                case 'sunny':
                    icon = 'â˜€ï¸'; name = 'æ™´å¤©'; effects = 'ç”Ÿé•¿+0% å”®ä»·+0%'; break;
                case 'rainy':
                    icon = 'ğŸŒ§ï¸'; name = 'é›¨å¤©'; effects = 'ç”Ÿé•¿+10% å”®ä»·-5%'; break;
                case 'cloudy':
                    icon = 'â˜ï¸'; name = 'é˜´å¤©'; effects = 'ç”Ÿé•¿-5% å”®ä»·+0%'; break;
                case 'stormy':
                    icon = 'â›ˆï¸'; name = 'æš´é£é›¨'; effects = 'ç”Ÿé•¿-20% å”®ä»·-10%'; break;
                case 'typhoon':
                    icon = 'ğŸŒ€'; name = 'å°é£'; effects = 'ä½œç‰©æ˜“å€’ä¼ï¼Œç”Ÿé•¿-50%'; break;
                case 'rainbow':
                    icon = 'ğŸŒˆ'; name = 'å½©è™¹å¤©'; effects = 'ç”Ÿé•¿+20% å”®ä»·+10%'; break;
            }
            weatherIcon.textContent = icon;
            weatherName.textContent = name;
            weatherEffects.textContent = effects;
            
            // åŒæ—¶æ›´æ–°ç‰§åœºå¤©æ°”æ˜¾ç¤º
            updateRanchWeather();
        }
        
        // æ›´æ–°å¤©æ°”è¯¦æƒ…é¢æ¿
        function updateWeatherDetails(weather) {
            const weatherDetails = document.getElementById('weather-details');
            const weatherDescription = document.getElementById('weather-description');
            
            if (weather && weatherDetails && weatherDescription) {
                let detailsText = weather.description;
                
                // æ·»åŠ ç‰¹æ®Šæ•ˆæœè¯´æ˜
                if (weather.effect.growth > 1) {
                    detailsText += `\nç”Ÿé•¿é€Ÿåº¦: +${Math.round((weather.effect.growth - 1) * 100)}%`;
                } else if (weather.effect.growth === 0) {
                    detailsText += '\nç”Ÿé•¿é€Ÿåº¦: åœæ­¢';
                } else {
                    detailsText += '\nç”Ÿé•¿é€Ÿåº¦: æ­£å¸¸';
                }
                
                if (weather.effect.yieldBonus) {
                    detailsText += `\nå”®ä»·åŠ æˆ: +${Math.round(weather.effect.yieldBonus * 100)}%`;
                }
                
                if (weather.effect.needWater) {
                    detailsText += '\néœ€è¦æµ‡æ°´: æ˜¯';
                } else {
                    detailsText += '\néœ€è¦æµ‡æ°´: å¦';
                }
                
                if (weather.effect.pestChance) {
                    detailsText += `\nç—…è™«å®³æ¦‚ç‡: ${Math.round(weather.effect.pestChance * 100)}%`;
                }
                
                weatherDescription.textContent = detailsText;
                
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
                weatherDetails.removeEventListener('click', weatherDetails._weatherClickHandler);
                
                // åˆ›å»ºæ–°çš„ç‚¹å‡»å¤„ç†å‡½æ•°
                weatherDetails._weatherClickHandler = function() {
                    showWeatherInfoModal(weather);
                };
                
                // æ·»åŠ æ–°çš„ç‚¹å‡»äº‹ä»¶
                weatherDetails.addEventListener('click', weatherDetails._weatherClickHandler);
            }
        }
        
        // æ˜¾ç¤ºå¤©æ°”ä¿¡æ¯å¼¹çª—
        function showWeatherInfoModal(weather) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000]';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">${weather.icon}</div>
                        <h2 class="text-xl font-bold text-gray-800">${weather.name}</h2>
                    </div>
                    <div class="text-gray-600 mb-4">
                        <p class="mb-2">${weather.description}</p>
                        <div class="border-t pt-2">
                            <p><strong>ç”Ÿé•¿é€Ÿåº¦:</strong> ${weather.effect.growth > 1 ? '+' + Math.round((weather.effect.growth - 1) * 100) + '%' : weather.effect.growth === 0 ? 'åœæ­¢' : 'æ­£å¸¸'}</p>
                            ${weather.effect.yieldBonus ? `<p><strong>å”®ä»·åŠ æˆ:</strong> +${Math.round(weather.effect.yieldBonus * 100)}%</p>` : ''}
                            <p><strong>éœ€è¦æµ‡æ°´:</strong> ${weather.effect.needWater ? 'æ˜¯' : 'å¦'}</p>
                            ${weather.effect.pestChance ? `<p><strong>ç—…è™«å®³æ¦‚ç‡:</strong> ${Math.round(weather.effect.pestChance * 100)}%</p>` : ''}
                        </div>
                    </div>
                    <button class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg" onclick="this.parentElement.parentElement.remove()">
                        å…³é—­
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }
        
        // åº”ç”¨å¤©æ°”è§†è§‰æ•ˆæœ
        function applyWeatherEffect(weatherId) {
            const body = document.getElementById('main-body');
            
            // ç§»é™¤æ‰€æœ‰å¤©æ°”æ•ˆæœç±»
            body.classList.remove('weather-sunny', 'weather-rainy', 'weather-stormy', 
                                'weather-drought', 'weather-typhoon', 'weather-rainbow', 'weather-sandstorm');
            
            // æ·»åŠ å½“å‰å¤©æ°”æ•ˆæœç±»
            body.classList.add(`weather-${weatherId}`);
            
            // æ›´æ–°ç‰§åœºå¤©æ°”æ˜¾ç¤º
            updateRanchWeather();
            
            // æ˜¾ç¤ºå¤©æ°”å¯¹åŠ¨ç‰©çš„å½±å“æç¤º
            const currentWeatherEffect = ranchEnvironment.weatherEffects[weatherId];
            if (currentWeatherEffect) {
                const effects = currentWeatherEffect.animalEffects;
                let message = `å¤©æ°”å˜ä¸º${currentWeatherEffect.title}ï¼`;
                
                if (effects.benefits.length > 0) {
                    message += `\nåŠ¨ç‰©å¥½å¤„ï¼š${effects.benefits.join('ã€')}`;
                }
                if (effects.drawbacks.length > 0) {
                    message += `\nåŠ¨ç‰©åå¤„ï¼š${effects.drawbacks.join('ã€')}`;
                }
                
                const notificationType = effects.drawbacks.length > effects.benefits.length ? 'warning' : 'info';
                showNotification(message, notificationType);
            }
        }

        // ç”Ÿæˆæ¯æ—¥ä»»åŠ¡
        function generateDailyTasks() {
            const shuffled = [...tasks].sort(() => 0.5 - Math.random());
            gameState.tasks = shuffled.slice(0, 3).map(task => ({
                ...task,
                progress: 0,
                completed: false
            }));
            
            // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œä¿å­˜æ¸¸æˆæ•°æ®ï¼Œé¿å…é‡å¤ä¿å­˜
            // ä¿å­˜æ“ä½œå·²ç§»è‡³initGameå‡½æ•°ä¸­
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks() {
            const tasksList = document.getElementById('tasks-list');

            if (gameState.tasks.length === 0) {
                tasksList.innerHTML = '<p class="text-gray-500 italic">ä»Šæ—¥æ²¡æœ‰ä»»åŠ¡</p>';
                return;
            }

            tasksList.innerHTML = gameState.tasks.map(task => `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium">${task.name}</h3>
                        <span class="text-sm ${task.completed ? 'text-green-600' : 'text-gray-600'}">
                            ${task.progress}/${task.goal}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${task.desc}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="progress-bar bg-blue-500 h-2 rounded-full"
                             style="width: ${Math.min(task.progress / task.goal * 100, 100)}%">
                        </div>
                    </div>
                    <div class="mt-2 text-sm text-right">
                        <span class="text-yellow-600">å¥–åŠ±: ${task.reward}é‡‘å¸</span>
                        ${task.completed ?
                          '<span class="ml-2 text-green-600">âœ“ å·²å®Œæˆ</span>' :
                          '<button class="ml-2 claim-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs" ' +
                          'data-task-id="${task.id}" ${task.completed ? "hidden" : ""}>å®Œæˆä»»åŠ¡</button>'}
                    </div>
                </div>
            `).join('');

            // æ·»åŠ é¢†å–å¥–åŠ±æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.claim-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    claimTaskReward(taskId);
                });
            });
        }

        // å®Œæˆç‰¹å®šç±»å‹çš„ä»»åŠ¡è¿›åº¦
        function updateTaskProgress(type, amount = 1) {
            let updated = false;

            gameState.tasks.forEach(task => {
                if (!task.completed && (
                    (type === 'harvest' && task.id.startsWith('harvest')) ||
                    (type === 'plant' && task.id.startsWith('plant')) ||
                    (type === 'sell' && task.id.startsWith('sell')) ||
                    (type === 'upgrade' && task.id.startsWith('upgrade')) ||
                    (type === 'expand' && task.id.startsWith('expand'))
                )) {
                    task.progress += amount;
                    if (task.progress >= task.goal) {
                        task.completed = true;
                        showNotification(`ä»»åŠ¡å®Œæˆ: ${task.name}`, 'info');
                    }
                    updated = true;
                }
            });

            if (updated) {
                renderTasks();

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        }

        // é¢†å–ä»»åŠ¡å¥–åŠ±
        function claimTaskReward(taskId) {
            const task = gameState.tasks.find(t => t.id === taskId);
            if (task && task.completed) {
                gameState.money += task.reward;
                gameState.completedTasks++;

                // ç§»é™¤å·²é¢†å–çš„ä»»åŠ¡
                gameState.tasks = gameState.tasks.filter(t => t.id !== taskId);

                updateUI();
                renderTasks();
                checkAchievements();

                showNotification(`å·²é¢†å–ä»»åŠ¡å¥–åŠ± +${task.reward}é‡‘å¸`, 'success');

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        }

        // æ£€æŸ¥æˆå°±
        function checkAchievements() {
            let newAchievements = false;

            achievements.forEach(achievement => {
                if (!gameState.achievements.includes(achievement.id) &&
                    achievement.condition(gameState)) {

                    gameState.achievements.push(achievement.id);
                    gameState.money += achievement.reward;
                    newAchievements = true;

                    showNotification(`è§£é”æˆå°±: ${achievement.name}! +${achievement.reward}é‡‘å¸`, 'info');
                }
            });

            if (newAchievements) {
                updateUI();

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        }

        // æ£€æŸ¥è¿ç»­ç™»å½•
        function checkDailyLogin() {
            const today = new Date().toDateString();
            const lastPlayed = gameState.lastPlayed;

            if (!lastPlayed) {
                // é¦–æ¬¡æ¸¸ç©
                gameState.dailyStreak = 1;
            } else if (lastPlayed !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (lastPlayed === yesterday.toDateString()) {
                    gameState.dailyStreak++;
                } else {
                    gameState.dailyStreak = 1;
                }
            }

            gameState.lastPlayed = today;

            // æ¯æ—¥ç™»å½•å¥–åŠ±
            if (lastPlayed !== today) {
                const reward = 10 * gameState.dailyStreak;
                gameState.money += reward;

                showNotification(`è¿ç»­ç™»å½• ${gameState.dailyStreak} å¤©! +${reward}é‡‘å¸`, 'info');
                updateUI();

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification p-3 rounded-lg shadow-lg text-white fade-in ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'}`;
            notification.innerHTML = `<p>${message}</p>`;

            elements.notifications.appendChild(notification);

            // 3ç§’åç§»é™¤é€šçŸ¥
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ç™»å½•é€»è¾‘
        function checkLogin() {
            const loginModal = document.getElementById('login-modal');
            const logoutBtn = document.getElementById('logout-btn');
            const isLoggedIn = localStorage.getItem('happyFarmLoggedIn');
            if (!isLoggedIn) {
                loginModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                // ç¡®ä¿é€€å‡ºç™»å½•æŒ‰é’®åœ¨ç™»å½•å¼¹çª—æ—¶ä¹Ÿå¯è§
                logoutBtn.style.display = 'block';
                logoutBtn.style.zIndex = '9999';
            } else {
                loginModal.style.display = 'none';
                document.body.style.overflow = '';
                // ç¡®ä¿é€€å‡ºç™»å½•æŒ‰é’®åœ¨æ¸¸æˆç•Œé¢æ—¶ä¹Ÿå¯è§
                logoutBtn.style.display = 'block';
                logoutBtn.style.zIndex = '9999';
            }
        }
        // é€€å‡ºç™»å½•é€»è¾‘
        function setupLogoutBtn() {
            const logoutBtn = document.getElementById('logout-btn');
            // å§‹ç»ˆæ˜¾ç¤ºé€€å‡ºç™»å½•æŒ‰é’®ï¼ˆå³ä½¿åœ¨ç™»å½•å¼¹çª—æ—¶ä¹Ÿå¯è§ï¼‰
            logoutBtn.style.display = 'block';
            logoutBtn.style.zIndex = '9999';
            
            // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
            logoutBtn.removeEventListener('click', handleLogout);
            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            logoutBtn.addEventListener('click', handleLogout);
        }
        
        // é€€å‡ºç™»å½•å¤„ç†å‡½æ•°
        function handleLogout() {
            console.log('é€€å‡ºç™»å½•æŒ‰é’®è¢«ç‚¹å‡»');
                localStorage.removeItem('happyFarmLoggedIn');
            localStorage.removeItem('happyFarmUserInfo');
            currentUserAccount = null;
                location.reload();
        }
        // DOMåŠ è½½å®Œæˆåç«‹å³è®¾ç½®é€€å‡ºç™»å½•æŒ‰é’®
        document.addEventListener('DOMContentLoaded', function() {
            setupLogoutBtn();
        });
        
        // é¡µé¢åŠ è½½æ—¶å…ˆæ£€æŸ¥ç™»å½•
        window.onload = function() {
            // ç«‹å³è®¾ç½®é€€å‡ºç™»å½•æŒ‰é’®
            setupLogoutBtn();
            setupLoginRegisterSwitch();
            checkLogin();
            if (localStorage.getItem('happyFarmLoggedIn')) {
                initGame();
            }
            // ç®¡ç†å‘˜æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
            if(localStorage.getItem('happyFarmLoggedIn') === 'admin'){
                document.getElementById('admin-open-btn').style.display = 'block';
                document.getElementById('admin-grow-btn').style.display = 'block';
            } else {
                document.getElementById('admin-open-btn').style.display = 'none';
                document.getElementById('admin-grow-btn').style.display = 'none';
            }
            document.getElementById('admin-open-btn').onclick = function() {
                showAdminPanel();
            };
            document.getElementById('admin-grow-btn').onclick = function() {
                // ç«‹å³å®Œæˆæ‰€æœ‰å†œç”°ä½œç‰©ç”Ÿé•¿
                if(Array.isArray(gameState.farmData)){
                    for(let i=0;i<gameState.farmData.length;i++){
                        if(gameState.farmData[i].state === 'planted' && gameState.farmData[i].growth !== 'completed'){
                            gameState.farmData[i].growth = 'completed';
                            // ç«‹å³æˆç†Ÿï¼Œç›´æ¥æŠŠç§æ¤æ—¶é—´æˆ³å¾€å‰æ¨åˆ°æˆç†Ÿ
                            gameState.farmData[i].progress = gameState.farmData[i].growthTime * 60;
                            gameState.farmData[i].plantedAt = Date.now() - gameState.farmData[i].growthTime * 60 * 1000;
                        }
                    }
                    renderFarm();
                    saveGameData();
                    showNotification('æ‰€æœ‰ä½œç‰©å·²æˆç†Ÿï¼', 'success');
                }
            };

            // æ–°å¢ï¼šå…¨å±€å®šæ—¶å™¨ï¼Œæ¯ç§’åˆ·æ–°æ‰€æœ‰åœ°åŒºæ‰€æœ‰å†œç”°çš„ç”Ÿé•¿è¿›åº¦
            setInterval(function() {
                // åˆ·æ–°æ‰€æœ‰åœ°åŒºçš„å†œç”°æ•°æ®
                if (gameState.regionFarmData) {
                    for (const regionId in gameState.regionFarmData) {
                        const farmArr = gameState.regionFarmData[regionId];
                        if (Array.isArray(farmArr)) {
                            for (let i = 0; i < farmArr.length; i++) {
                                const plotData = farmArr[i];
                                if (plotData.state === 'planted' && plotData.plantedAt && plotData.growthTime) {
                                    const now = Date.now();
                                    const elapsed = (now - plotData.plantedAt) / 1000;
                                    
                                    // è®¡ç®—äº‹ä»¶å½±å“
                                    let timeMultiplier = 1;
                                    if (plotData.timeSpeedMultiplier) {
                                        timeMultiplier = plotData.timeSpeedMultiplier;
                                    }
                                    if (plotData.growthSpeedMultiplier) {
                                        timeMultiplier *= plotData.growthSpeedMultiplier;
                                    }
                                    
                                    // åº”ç”¨æ—¶é—´å€æ•°
                                    const adjustedElapsed = elapsed * timeMultiplier;
                                    plotData.progress = adjustedElapsed;
                                    
                                    if (plotData.growthTime) {
                                        const totalSeconds = plotData.growthTime * 60; // growTime å•ä½å˜ä¸ºåˆ†é’Ÿ
                                        if (plotData.progress >= totalSeconds) {
                                            plotData.growth = 'completed';
                                            plotData.progress = totalSeconds;
                                        } else {
                                            plotData.growth = 'growing';
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                // åªåˆ·æ–°å½“å‰åœ°åŒºçš„å†œç”°æ˜¾ç¤º
                renderFarm();
            }, 1000);
        };

        // ç®¡ç†å‘˜é¢æ¿é€»è¾‘
        function showAdminPanel() {
            const adminPanel = document.getElementById('admin-panel');
            adminPanel.style.display = 'flex';
            // æ˜¾ç¤ºå½“å‰æ¸¸æˆæ•°æ®
            document.getElementById('admin-money').value = gameState.money;
            document.getElementById('admin-xp').value = gameState.xp;
            document.getElementById('admin-level').value = gameState.level;
            document.getElementById('admin-weather').value = gameState.weather;
            // å®æ—¶å¤©æ°”åˆ‡æ¢
            const adminWeather = document.getElementById('admin-weather');
            adminWeather.onchange = function() {
                gameState.weather = this.value;
                updateUI();
                renderWeather();
                saveGameData();
                showNotification('å¤©æ°”å·²åˆ‡æ¢', 'success');
            };
            // æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
            const users = JSON.parse(localStorage.getItem('happyFarmUsers') || '[]');
            const typeMap = { account: 'è´¦å·å¯†ç ', qq: 'QQ', wx: 'å¾®ä¿¡', douyin: 'æŠ–éŸ³' };
            let html = '<table class="min-w-full border text-center"><thead><tr><th class="border px-2">è´¦å·</th><th class="border px-2">æ³¨å†Œæ–¹å¼</th><th class="border px-2">æœ€è¿‘æ¸¸ç©</th><th class="border px-2">é‡‘å¸</th><th class="border px-2">ç»éªŒ</th><th class="border px-2">ç­‰çº§</th></tr></thead><tbody>';
            users.forEach(u => {
                html += `<tr><td class="border px-2">${u.account}</td><td class="border px-2">${typeMap[u.type]||u.type}</td><td class="border px-2">${u.lastPlayed||''}</td><td class="border px-2">${u.money||''}</td><td class="border px-2">${u.xp||''}</td><td class="border px-2">${u.level||''}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('admin-users-list').innerHTML = html;
            // ä¿å­˜æŒ‰é’®
            document.getElementById('admin-save').onclick = function() {
                gameState.money = parseInt(document.getElementById('admin-money').value)||0;
                gameState.xp = parseInt(document.getElementById('admin-xp').value)||0;
                gameState.level = parseInt(document.getElementById('admin-level').value)||1;
                gameState.weather = document.getElementById('admin-weather').value;
                updateUI();
                renderWeather();
                saveGameData();
                showNotification('æ•°æ®å·²ä¿å­˜', 'success');
            };
            // é‡ç½®æŒ‰é’®
            if (!document.getElementById('admin-reset')) {
                const resetBtn = document.createElement('button');
                resetBtn.id = 'admin-reset';
                resetBtn.className = 'bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-bold mt-2 ml-2';
                resetBtn.textContent = 'é‡ç½®ç®¡ç†å‘˜æ•°æ®';
                document.getElementById('admin-save').after(resetBtn);
                resetBtn.onclick = function() {
                    // å½»åº•é‡ç½®ç®¡ç†å‘˜è‡ªå·±çš„æ•°æ®
                    const def = getDefaultGameState();
                    for (const k in def) gameState[k] = def[k];
                    // åˆå§‹åŒ–æ‰€æœ‰åŒºåŸŸå†œç”°
                    for (const region of regions) {
                        gameState.regionFarmData[region.id] = [];
                        for (let i = 0; i < gameState.plots; i++) {
                            gameState.regionFarmData[region.id].push({
                                state: 'empty',
                                seedId: null,
                                growth: null,
                                progress: 0,
                                growthTime: 0
                            });
                        }
                    }
                    gameState.farmData = gameState.regionFarmData[gameState.currentRegion];
                    saveGameData();
                    updateUI();
                    renderFarm();
                    renderWeather();
                    renderShop();
                    renderInventory();
                    renderUpgrades();
                    renderTasks();
                    checkExpandFarmButton();
                    showNotification('ç®¡ç†å‘˜æ•°æ®å·²é‡ç½®', 'success');
                    // åˆ·æ–°é¢æ¿æ•°æ®
                    showAdminPanel();
                };
            }
            // å…³é—­æŒ‰é’®
            document.getElementById('admin-close').onclick = function() {
                adminPanel.style.display = 'none';
            };
            // éšæœºäº‹ä»¶ç®¡ç†
            const eventsList = document.getElementById('admin-events-list');
            if (eventsList) {
                eventsList.innerHTML = randomEvents.map(event => `
                    <div class="flex items-center gap-2 p-2 border rounded-lg">
                        <span class="text-2xl">${event.icon}</span>
                        <span class="font-bold">${event.name}</span>
                        <span class="text-xs text-gray-500">${event.description}</span>
                        <button class="admin-trigger-event bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded ml-auto" data-event-id="${event.id}">è§¦å‘</button>
                    </div>
                `).join('');
                // ç»‘å®šè§¦å‘äº‹ä»¶æŒ‰é’®
                eventsList.querySelectorAll('.admin-trigger-event').forEach(btn => {
                    btn.onclick = function() {
                        const eventId = this.getAttribute('data-event-id');
                        const event = randomEvents.find(e => e.id === eventId);
                        if (!event) return;
                        // éšæœºå½±å“éƒ¨åˆ†åœ°å—
                        const plantedPlots = gameState.farmData.filter(p => p.state === 'planted');
                        if (plantedPlots.length === 0) {
                            showNotification('å½“å‰æ²¡æœ‰å·²ç§æ¤ä½œç‰©ï¼Œæ— æ³•è§¦å‘äº‹ä»¶', 'error');
                            return;
                        }
                        const affectedCount = Math.max(1, Math.floor(Math.random() * plantedPlots.length));
                        const affectedIndexes = [];
                        while (affectedIndexes.length < affectedCount) {
                            const idx = Math.floor(Math.random() * gameState.farmData.length);
                            if (!affectedIndexes.includes(idx) && gameState.farmData[idx].state === 'planted') {
                                affectedIndexes.push(idx);
                            }
                        }
                        const now = Date.now();
                        const eventObj = {
                            ...event,
                            affectedPlots: affectedIndexes,
                            startTime: now
                        };
                        gameState.activeEvents.push(eventObj);
                        gameState.lastEventTime = now;
                        showNotification(`ç®¡ç†å‘˜è§¦å‘äº‹ä»¶ï¼š${event.icon} ${event.name} - ${event.description}`,'info');
                        // åº”ç”¨äº‹ä»¶æ•ˆæœ
                        affectedIndexes.forEach(i => {
                            const plot = gameState.farmData[i];
                            switch(event.effect){
                                case 'growth_boost':
                                    plot.growthSpeedMultiplier = 1.5; break;
                                case 'instant_growth':
                                    plot.progress = plot.growthTime * 60; plot.growth = 'completed'; break;
                                case 'quality_boost':
                                    plot.qualityBoost = true; break;
                                case 'time_speed':
                                    plot.timeSpeedMultiplier = 3; break;
                                case 'pest_damage':
                                    plot.pest = true; break;
                                case 'disease_damage':
                                    plot.disease = true; break;
                                case 'frost_damage':
                                    plot.growthSpeedMultiplier = 0.5; break;
                                case 'weed_competition':
                                    plot.growthSpeedMultiplier = 0.7; break;
                                case 'random_effect':
                                    if (Math.random()<0.5) plot.pest = true; else plot.growthSpeedMultiplier = 2; break;
                            }
                        });
                        renderFarm();
                        saveGameData();
                        // å®šæ—¶ç§»é™¤äº‹ä»¶
                        setTimeout(()=>{
                            affectedIndexes.forEach(i => {
                                const plot = gameState.farmData[i];
                                delete plot.growthSpeedMultiplier;
                                delete plot.timeSpeedMultiplier;
                                delete plot.qualityBoost;
                                delete plot.disease;
                            });
                            gameState.activeEvents = gameState.activeEvents.filter(e=>e!==eventObj);
                            renderFarm();
                            saveGameData();
                        }, event.duration*1000 || 20000);
                    };
                });
            }
        }

        // ç™»å½•/æ³¨å†Œå¼¹çª—åˆ‡æ¢é€»è¾‘
        function setupLoginRegisterSwitch() {
            // æ³¨å†Œæ–¹å¼æŒ‰é’®->å…·ä½“æ³¨å†Œè¡¨å•
            document.querySelectorAll('.register-way-btn').forEach(btn => {
                btn.onclick = function() {
                    const type = this.getAttribute('data-type');
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('register-choice').style.display = 'none';
                    document.getElementById('register-form').style.display = 'flex';
                    document.getElementById('login-divider').style.visibility = 'hidden';
                    // è®¾ç½®iconå’Œæ ‡é¢˜
                    let icon = '', title = '';
                    if(type==='qq'){
                        icon = '<i class="fab fa-qq"></i>';
                        title = 'QQæ³¨å†Œ';
                    } else if(type==='wx'){
                        icon = '<i class="fab fa-weixin"></i>';
                        title = 'å¾®ä¿¡æ³¨å†Œ';
                    } else if(type==='douyin'){
                        icon = '<i class="fab fa-tiktok"></i>';
                        title = 'æŠ–éŸ³æ³¨å†Œ';
                    } else {
                        icon = '<i class="fas fa-user"></i>';
                        title = 'è´¦å·å¯†ç æ³¨å†Œ';
                    }
                    document.getElementById('register-icon').innerHTML = icon;
                    document.getElementById('register-title').textContent = title;
                    document.getElementById('register-form').setAttribute('data-type', type);
                };
            });
            // æ³¨å†Œè¡¨å•->è¿”å›ç™»å½•ä¸»ç•Œé¢
            document.getElementById('register-back-choice').onclick = function() {
                document.getElementById('register-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'flex';
                document.getElementById('register-choice').style.display = 'flex';
                document.getElementById('login-divider').style.visibility = 'visible';
            };
        }

        // æ³¨å†Œè¡¨å•æäº¤é€»è¾‘ï¼ˆç‹¬ç«‹ï¼‰
        document.getElementById('register-form').onsubmit = function(e) {
            e.preventDefault();
            const type = this.getAttribute('data-type');
            const account = document.getElementById('register-account').value;
            const password = document.getElementById('register-password').value;
            if(!account || !password){
                showNotification('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ', 'error');
                return;
            }
            if(account === 'dyyssb'){
                showNotification('è¯¥è´¦å·ä¸ºç®¡ç†å‘˜ä¸“ç”¨ï¼Œä¸èƒ½æ³¨å†Œï¼', 'error');
                return;
            }
            let users = JSON.parse(localStorage.getItem('happyFarmUsers') || '[]');
            if(users.find(u => u.account === account)){
                showNotification('è¯¥è´¦å·å·²è¢«æ³¨å†Œï¼', 'error');
                return;
            }
            const userInfo = {
                type,
                account,
                password,
                lastPlayed: new Date().toLocaleString(),
                money: 100,
                xp: 0,
                level: 1
            };
            users.push(userInfo);
            localStorage.setItem('happyFarmUsers', JSON.stringify(users));
            localStorage.setItem('happyFarmUserInfo', JSON.stringify(userInfo));
            localStorage.setItem('happyFarmLoggedIn', type);
            currentUserAccount = userInfo.account;
            document.getElementById('login-modal').style.display = 'none';
            document.body.style.overflow = '';
            showNotification('æ³¨å†Œå¹¶ç™»å½•æˆåŠŸï¼', 'success');
            document.getElementById('admin-open-btn').style.display = 'none';
            document.getElementById('admin-grow-btn').style.display = 'none';
            initGame();
        };

        // è·å–åˆå§‹æ¸¸æˆçŠ¶æ€
        function getDefaultGameState() {
            return {
                money: 100,
                level: 1,
                xp: 0,
                maxXp: 100,
                plots: 4,
                maxPlots: 12,
                regionPlots: {},
                inventory: {},
                qualityInventory: {},
                upgrades: { watering: 0, quality: 0, greenhouse: 0 },
                currentSelectedSeed: null,
                purchasedSeeds: {},
                weather: 'sunny',
                dailyStreak: 0,
                lastPlayed: null,
                completedTasks: 0,
                achievements: [],
                currentRegion: 'north_china',
                tasks: [],
                regionFarmData: {},
                farmData: [],
            };
        }

        // æ¯æ—¥åˆ·æ–°å¤©æ°”å½±å“
        function dailyWeatherAffect() {
            const weather = weatherTypes.find(w => w.id === gameState.weather);
            if (!weather) return;
            // éå†æ‰€æœ‰åœ°åŒºæ‰€æœ‰å†œç”°
            for (const regionId in gameState.regionFarmData) {
                const farmArr = gameState.regionFarmData[regionId];
                if (!Array.isArray(farmArr)) continue;
                for (let i = 0; i < farmArr.length; i++) {
                    const plot = farmArr[i];
                    // åªå¤„ç†å·²ç§æ¤ä½œç‰©
                    if (plot.state !== 'planted') continue;
                    // æ™´å¤©ï¼šæœªæµ‡æ°´åˆ™è®°ä¸ºæœªæµ‡æ°´
                    if (weather.id === 'sunny') {
                        // nothing, æ”¶è·æ—¶åˆ¤æ–­
                    }
                    // é›¨å¤©ï¼š10%æ¦‚ç‡ç—…è™«å®³
                    if (weather.id === 'rainy') {
                        let scarecrowCount = gameState.decors.scarecrow||0;
                        let pestChance = 0.1 * (1 - Math.min(scarecrowCount*0.1,0.5));
                        if (Math.random() < pestChance) plot.pest = true;
                    }
                    // æš´é›¨ï¼šæœªå‡çº§æ’æ°´çš„å†œç”°å˜è’åœ°
                    if (weather.id === 'stormy') {
                        if (!plot.drainageUpgraded) {
                            plot.state = 'wasteland';
                            plot.seedId = null;
                            plot.growth = null;
                            plot.progress = 0;
                            plot.growthTime = 0;
                            plot.plantedAt = null;
                            plot.lastWateredAt = null;
                            plot.pest = false;
                            plot.witherCountdown = 0;
                        }
                    }
                    // å¹²æ—±ï¼šæœªæµ‡æ°´å¤©æ•°+1ï¼Œ3å¤©æœªæµ‡æ°´æ¯æ­»
                    if (weather.id === 'drought') {
                        const now = Date.now();
                        if (!plot.lastWateredAt || now - plot.lastWateredAt > 24*60*60*1000) {
                            plot.witherCountdown = (plot.witherCountdown || 0) + 1;
                        } else {
                            plot.witherCountdown = 0;
                        }
                        if (plot.witherCountdown >= 3) {
                            plot.state = 'wasteland';
                            plot.seedId = null;
                            plot.growth = null;
                            plot.progress = 0;
                            plot.growthTime = 0;
                            plot.plantedAt = null;
                            plot.lastWateredAt = null;
                            plot.pest = false;
                            plot.witherCountdown = 0;
                        }
                    }
                    // å°é£ï¼šæœªåŠ å›ºæœæ ‘å€’ä¼
                    if (weather.id === 'typhoon') {
                        const fruitTreeIds = ['apple','banana','grape','apricot','melon','mikan','walnut','sakura'];
                        if (fruitTreeIds.includes(plot.seedId) && !plot.reinforced) {
                            plot.state = 'wasteland';
                            plot.seedId = null;
                            plot.growth = null;
                            plot.progress = 0;
                            plot.growthTime = 0;
                            plot.plantedAt = null;
                            plot.lastWateredAt = null;
                            plot.pest = false;
                            plot.witherCountdown = 0;
                        }
                    }
                }
            }
        }

        // åœ¨initGameå’ŒgenerateDailyTasksåè°ƒç”¨
        dailyWeatherAffect();

        // 3. æµ‡æ°´æŒ‰é’®äº¤äº’
        setTimeout(() => {
            document.querySelectorAll('.water-btn').forEach(btn => {
                if (btn.disabled) return;
                btn.onclick = function(e) {
                    e.stopPropagation();
                    const idx = parseInt(this.getAttribute('data-plot-index'));
                    const plot = gameState.farmData[idx];
                    plot.lastWateredAt = Date.now();
                    plot.witherCountdown = 0;
                    renderFarm();
                    saveGameData();
                    showNotification('æµ‡æ°´æˆåŠŸï¼', 'success');
                };
            });
        }, 0);

        // 1. æ¯å¤©è‡ªåŠ¨åˆ·æ–°å¤©æ°”
        function autoRefreshWeather() {
            // æŒ‰æƒé‡æ¦‚ç‡ç”Ÿæˆå¤©æ°”ï¼Œæƒé‡è¶Šé«˜è¶Šå¸¸è§
            const weatherPool = [
                { id: 'sunny', weight: 30 },
                { id: 'rainy', weight: 20 },
                { id: 'stormy', weight: 8 },
                { id: 'drought', weight: 6 },
                { id: 'typhoon', weight: 4 },
                { id: 'rainbow', weight: 2 },
                { id: 'sandstorm', weight: 2 }
            ];
            let total = weatherPool.reduce((sum, w) => sum + w.weight, 0);
            let r = Math.random() * total;
            let newWeather = 'sunny';
            for (let w of weatherPool) {
                if (r < w.weight) {
                    newWeather = w.id;
                    break;
                }
                r -= w.weight;
            }
            
            // å¦‚æœå¤©æ°”å‘ç”Ÿå˜åŒ–ï¼Œæ˜¾ç¤ºç‰¹æ®Šæ•ˆæœ
            if (newWeather !== gameState.weather) {
                const oldWeather = weatherTypes.find(w => w.id === gameState.weather);
                const newWeatherObj = weatherTypes.find(w => w.id === newWeather);
                
                // æ˜¾ç¤ºå¤©æ°”å˜åŒ–åŠ¨ç”»
                showWeatherChangeAnimation(oldWeather, newWeatherObj);
            }
            
            gameState.weather = newWeather;
            saveGameData();
            renderWeather();
            dailyWeatherAffect();
            renderFarm();
            
            // åŒæ—¶æ›´æ–°ç‰§åœºå¤©æ°”æ˜¾ç¤º
            updateRanchWeather();
        }
        
        // æ˜¾ç¤ºå¤©æ°”å˜åŒ–åŠ¨ç”»
        function showWeatherChangeAnimation(oldWeather, newWeather) {
            // åˆ›å»ºå¤©æ°”å˜åŒ–é€šçŸ¥
            const notification = document.createElement('div');
            notification.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-80 text-white p-6 rounded-lg text-center z-[10000]';
            notification.innerHTML = `
                <div class="text-4xl mb-4">${oldWeather ? oldWeather.icon : 'ğŸŒ¤ï¸'} â†’ ${newWeather.icon}</div>
                <div class="text-xl mb-2">${oldWeather ? oldWeather.name : 'æœªçŸ¥'} â†’ ${newWeather.name}</div>
                <div class="text-sm opacity-75">å¤©æ°”æ­£åœ¨å˜åŒ–...</div>
            `;
            
            document.body.appendChild(notification);
            
            // 3ç§’åç§»é™¤é€šçŸ¥
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // 2. æ–°å¢"èŠ±è´¹é‡‘å¸åˆ·æ–°å¤©æ°”"æŒ‰é’®
        function setupWeatherRefreshBtn() {
            if (!document.getElementById('weather-refresh-btn')) {
                const btn = document.createElement('button');
                btn.id = 'weather-refresh-btn';
                btn.className = 'ml-4 px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded shadow';
                btn.textContent = 'èŠ±10é‡‘å¸åˆ·æ–°å¤©æ°”';
                document.getElementById('weather-name').parentNode.appendChild(btn);
                btn.onclick = function() {
                    if (gameState.money < 10) {
                        showNotification('é‡‘å¸ä¸è¶³ï¼Œæ— æ³•åˆ·æ–°å¤©æ°”', 'error');
                        return;
                    }
                    gameState.money -= 10;
                    
                    // æ˜¾ç¤ºåˆ·æ–°åŠ¨ç”»
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ·æ–°ä¸­...';
                    btn.disabled = true;
                    
                    setTimeout(() => {
                        autoRefreshWeather();
                        updateUI();
                        showNotification('å·²åˆ·æ–°å¤©æ°”', 'success');
                        btn.innerHTML = 'èŠ±10é‡‘å¸åˆ·æ–°å¤©æ°”';
                        btn.disabled = false;
                    }, 1000);
                };
            }
        }

        // åœ¨initGameå’Œæ¯æ—¥åˆ·æ–°æ—¶è°ƒç”¨ autoRefreshWeather å’Œ setupWeatherRefreshBtn
        // ä¾‹å¦‚initGameæœ€ååŠ ï¼š
        setupWeatherRefreshBtn();

        // éšæœºäº‹ä»¶ç³»ç»Ÿè‡ªåŠ¨è§¦å‘
        setInterval(function() {
            // ä»…åœ¨æœ‰ä½œç‰©æ—¶æ‰è§¦å‘
            const plantedPlots = gameState.farmData.filter(p => p.state === 'planted');
            if (plantedPlots.length === 0) return;
            // äº‹ä»¶å†·å´
            const now = Date.now();
            if (now - (gameState.lastEventTime || 0) < gameState.eventCooldown) return;
            if (Math.random() < gameState.eventChance) {
                // éšæœºé€‰ä¸€ä¸ªäº‹ä»¶
                const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
                // éšæœºå½±å“éƒ¨åˆ†åœ°å—
                const affectedCount = Math.max(1, Math.floor(Math.random() * plantedPlots.length));
                const affectedIndexes = [];
                while (affectedIndexes.length < affectedCount) {
                    const idx = Math.floor(Math.random() * gameState.farmData.length);
                    if (!affectedIndexes.includes(idx) && gameState.farmData[idx].state === 'planted') {
                        affectedIndexes.push(idx);
                    }
                }
                // è®°å½•äº‹ä»¶
                const eventObj = {
                    ...event,
                    affectedPlots: affectedIndexes,
                    startTime: now
                };
                gameState.activeEvents.push(eventObj);
                gameState.lastEventTime = now;
                // å¼¹çª—æç¤º
                showNotification(`éšæœºäº‹ä»¶ï¼š${event.icon} ${event.name} - ${event.description}`,'info');
                // åº”ç”¨äº‹ä»¶æ•ˆæœ
                affectedIndexes.forEach(i => {
                    const plot = gameState.farmData[i];
                    switch(event.effect){
                        case 'growth_boost':
                            plot.growthSpeedMultiplier = 1.5; break;
                        case 'instant_growth':
                            plot.progress = plot.growthTime * 60; plot.growth = 'completed'; break;
                        case 'quality_boost':
                            plot.qualityBoost = true; break;
                        case 'time_speed':
                            plot.timeSpeedMultiplier = 3; break;
                        case 'pest_damage':
                            plot.pest = true; break;
                        case 'disease_damage':
                            plot.disease = true; break;
                        case 'frost_damage':
                            plot.growthSpeedMultiplier = 0.5; break;
                        case 'weed_competition':
                            plot.growthSpeedMultiplier = 0.7; break;
                        case 'random_effect':
                            if (Math.random()<0.5) plot.pest = true; else plot.growthSpeedMultiplier = 2; break;
                    }
                });
                renderFarm();
                saveGameData();
                // å®šæ—¶ç§»é™¤äº‹ä»¶
                setTimeout(()=>{
                    // ç§»é™¤äº‹ä»¶æ•ˆæœ
                    affectedIndexes.forEach(i => {
                        const plot = gameState.farmData[i];
                        delete plot.growthSpeedMultiplier;
                        delete plot.timeSpeedMultiplier;
                        delete plot.qualityBoost;
                        delete plot.disease;
                        // ç—…è™«å®³éœ€ç©å®¶æ‰‹åŠ¨å¤„ç†
                    });
                    // ç§»é™¤äº‹ä»¶
                    gameState.activeEvents = gameState.activeEvents.filter(e=>e!==eventObj);
                    renderFarm();
                    saveGameData();
                }, event.duration*1000 || 20000);
            }
        }, 30000);

        // æ¸²æŸ“é“å…·å•†åº—å’Œé“å…·æ•°é‡
        function renderItemShop() {
            const shop = document.getElementById('item-shop');
            if (!shop) return;
            const items = [
                { id: 'pesticide', name: 'å†œè¯', price: 10, desc: 'æ¸…é™¤è™«å®³', icon: 'ğŸ§ª' },
                { id: 'medicine', name: 'è¯å‰‚', price: 15, desc: 'æ²»æ„ˆç—…å®³', icon: 'ğŸ’Š' },
                { id: 'weedkiller', name: 'é™¤è‰å‰‚', price: 8, desc: 'æ¸…é™¤æ‚è‰', icon: 'ğŸŒ¿' },
                { id: 'insulation', name: 'ä¿æ¸©å¸ƒ', price: 12, desc: 'æŠµå¾¡éœœå†»', icon: 'ğŸ§£' }
            ];
            shop.innerHTML = items.map(item => `
                <div class="flex items-center gap-2">
                    <span class="text-2xl">${item.icon}</span>
                    <span class="font-bold">${item.name}</span>
                    <span class="text-xs text-gray-500">${item.desc}</span>
                    <span class="ml-auto text-green-700">åº“å­˜: ${gameState.items[item.id]||0}</span>
                    <button class="buy-item bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded" data-item-id="${item.id}">è´­ä¹°(${item.price}é‡‘å¸)</button>
                </div>
            `).join('');
            shop.querySelectorAll('.buy-item').forEach(btn => {
                btn.onclick = function() {
                    const id = this.getAttribute('data-item-id');
                    const item = items.find(i=>i.id===id);
                    if (gameState.money < item.price) {
                        showNotification('é‡‘å¸ä¸è¶³ï¼Œæ— æ³•è´­ä¹°','error'); return;
                    }
                    gameState.money -= item.price;
                    gameState.items[id] = (gameState.items[id]||0)+1;
                    renderItemShop();
                    updateUI();
                    saveGameData();
                    showNotification(`è´­ä¹°${item.name}æˆåŠŸï¼`,'success');
                };
            });
        }

        // æ¸²æŸ“è£…é¥°å•†åº—å’Œæˆ‘çš„è£…é¥°
        function renderDecorShop() {
          const shop = document.getElementById('decor-shop');
          if (!shop) return;
          const decors = [
            { id: 'fence', name: 'å›´æ ', price: 30, desc: 'ç¾åŒ–å†œåœº', icon: 'ğŸªµ' },
            { id: 'fountain', name: 'å–·æ³‰', price: 80, desc: 'æå‡å¹¸ç¦å€¼', icon: 'â›²' },
            { id: 'scarecrow', name: 'ç¨»è‰äºº', price: 50, desc: 'å‡å°‘è™«å®³æ¦‚ç‡', icon: 'ğŸª†' },
            { id: 'flowerbed', name: 'èŠ±å›', price: 40, desc: 'ç¾åŒ–å†œåœº', icon: 'ğŸŒ¸' }
          ];
          shop.innerHTML = decors.map(decor => `
            <div class="flex items-center gap-2">
              <span class="text-2xl">${decor.icon}</span>
              <span class="font-bold">${decor.name}</span>
              <span class="text-xs text-gray-500">${decor.desc}</span>
              <span class="ml-auto text-green-700">åº“å­˜: ${gameState.decors[decor.id]||0}</span>
              <button class="buy-decor bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded" data-decor-id="${decor.id}">è´­ä¹°(${decor.price}é‡‘å¸)</button>
            </div>
          `).join('');
          shop.querySelectorAll('.buy-decor').forEach(btn => {
            btn.onclick = function() {
              const id = this.getAttribute('data-decor-id');
              const decor = decors.find(d=>d.id===id);
              if (gameState.money < decor.price) {
                showNotification('é‡‘å¸ä¸è¶³ï¼Œæ— æ³•è´­ä¹°','error'); return;
              }
              gameState.money -= decor.price;
              gameState.decors[id] = (gameState.decors[id]||0)+1;
              renderDecorShop();
              renderMyDecors();
              updateUI();
              saveGameData();
              showNotification(`è´­ä¹°${decor.name}æˆåŠŸï¼`,'success');
            };
          });
        }
        function renderMyDecors() {
          const box = document.getElementById('my-decors');
          if (!box) return;
          const decors = [
            { id: 'fence', name: 'å›´æ ', icon: 'ğŸªµ' },
            { id: 'fountain', name: 'å–·æ³‰', icon: 'â›²' },
            { id: 'scarecrow', name: 'ç¨»è‰äºº', icon: 'ğŸª†' },
            { id: 'flowerbed', name: 'èŠ±å›', icon: 'ğŸŒ¸' }
          ];
          
          // æ·»åŠ åœŸåœ°æ”¹è‰¯çŠ¶æ€æ˜¾ç¤º
          let landImprovementHtml = '<div class="mb-4"><h3 class="font-bold text-lg mb-2 flex items-center"><i class="fas fa-seedling mr-2 text-green-500"></i>åœŸåœ°æ”¹è‰¯çŠ¶æ€</h3>';
          
          // ç»Ÿè®¡å„ç­‰çº§åœŸåœ°æ•°é‡
          const landStats = { 0: 0, 1: 0, 2: 0, 3: 0 };
          for (let i = 0; i < gameState.plots; i++) {
            const level = getLandImprovementLevel(i);
            landStats[level]++;
          }
          
          // æ˜¾ç¤ºåœŸåœ°æ”¹è‰¯ç»Ÿè®¡
          landImprovementHtml += '<div class="grid grid-cols-2 gap-2 text-sm">';
          landImprovementLevels.forEach(levelData => {
            const count = landStats[levelData.level];
            landImprovementHtml += `
              <div class="flex items-center gap-1 p-2 ${levelData.color} rounded">
                <span class="text-lg">${levelData.icon}</span>
                <span class="font-semibold">${levelData.name}: ${count}å—</span>
              </div>
            `;
          });
          landImprovementHtml += '</div></div>';
          
          box.innerHTML = landImprovementHtml + decors.map(decor => `
            <div class="flex items-center gap-2">
              <span class="text-2xl">${decor.icon}</span>
              <span class="font-bold">${decor.name}</span>
              <span class="ml-auto text-green-700">æ•°é‡: ${gameState.decors[decor.id]||0}</span>
            </div>
          `).join('');
        }

        // æ¸²æŸ“åŠ¨ç‰©å•†åº—å’Œæˆ‘çš„åŠ¨ç‰©
        function renderAnimalShop() {
          const shop = document.getElementById('animal-shop');
          if (!shop) return;
          const animals = [
            { id: 'chicken', name: 'é¸¡', price: 60, desc: 'äº§è›‹', icon: 'ğŸ”', rarity: 'common' },
            { id: 'cow', name: 'ç‰›', price: 200, desc: 'äº§å¥¶', icon: 'ğŸ„', rarity: 'common' },
            { id: 'sheep', name: 'ç¾Š', price: 120, desc: 'äº§ç¾Šæ¯›', icon: 'ğŸ‘', rarity: 'common' },
            { id: 'pig', name: 'çŒª', price: 150, desc: 'äº§çŒªè‚‰', icon: 'ğŸ·', rarity: 'uncommon' },
            { id: 'duck', name: 'é¸­å­', price: 80, desc: 'äº§é¸­è›‹', icon: 'ğŸ¦†', rarity: 'common' },
            { id: 'goat', name: 'å±±ç¾Š', price: 180, desc: 'äº§ç¾Šå¥¶', icon: 'ğŸ', rarity: 'uncommon' },
            { id: 'rabbit', name: 'å…”å­', price: 100, desc: 'äº§å…”æ¯›', icon: 'ğŸ°', rarity: 'rare' },
            { id: 'horse', name: 'é©¬', price: 500, desc: 'äº§è‚¥æ–™', icon: 'ğŸ', rarity: 'epic' }
          ];
          
          // æ ¹æ®ç¨€æœ‰åº¦æ·»åŠ é¢œè‰²
          const rarityColors = {
            common: 'bg-gray-100',
            uncommon: 'bg-green-100', 
            rare: 'bg-blue-100',
            epic: 'bg-purple-100'
          };
          
          shop.innerHTML = animals.map(animal => `
            <div class="flex items-center gap-2 p-2 rounded ${rarityColors[animal.rarity]} border-l-4 ${animal.rarity === 'epic' ? 'border-purple-500' : animal.rarity === 'rare' ? 'border-blue-500' : animal.rarity === 'uncommon' ? 'border-green-500' : 'border-gray-500'}">
              <span class="text-2xl">${animal.icon}</span>
              <div class="flex-1">
                <div class="font-bold">${animal.name}</div>
                <div class="text-xs text-gray-500">${animal.desc}</div>
              </div>
              <div class="text-right">
                <div class="text-sm text-green-700">åº“å­˜: ${gameState.animals[animal.id]||0}</div>
                <button class="buy-animal bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm" data-animal-id="${animal.id}">è´­ä¹°(${animal.price}é‡‘å¸)</button>
              </div>
            </div>
          `).join('');
          
          shop.querySelectorAll('.buy-animal').forEach(btn => {
            btn.onclick = function() {
              const id = this.getAttribute('data-animal-id');
              const animal = animals.find(a=>a.id===id);
              if (gameState.money < animal.price) {
                showNotification('é‡‘å¸ä¸è¶³ï¼Œæ— æ³•è´­ä¹°','error'); return;
              }
              gameState.money -= animal.price;
              gameState.animals[id] = (gameState.animals[id]||0)+1;
              renderAnimalShop();
              renderMyAnimals();
              updateRanchStats();
              updateUI();
              saveGameData();
              showNotification(`è´­ä¹°${animal.name}æˆåŠŸï¼`,'success');
            };
          });
        }
        function renderMyAnimals() {
          const box = document.getElementById('my-animals');
          if (!box) return;
          const animals = [
            { id: 'chicken', name: 'é¸¡', icon: 'ğŸ”', rarity: 'common' },
            { id: 'cow', name: 'ç‰›', icon: 'ğŸ„', rarity: 'common' },
            { id: 'sheep', name: 'ç¾Š', icon: 'ğŸ‘', rarity: 'common' },
            { id: 'pig', name: 'çŒª', icon: 'ğŸ·', rarity: 'uncommon' },
            { id: 'duck', name: 'é¸­å­', icon: 'ğŸ¦†', rarity: 'common' },
            { id: 'goat', name: 'å±±ç¾Š', icon: 'ğŸ', rarity: 'uncommon' },
            { id: 'rabbit', name: 'å…”å­', icon: 'ğŸ°', rarity: 'rare' },
            { id: 'horse', name: 'é©¬', icon: 'ğŸ', rarity: 'epic' }
          ];
          const rarityColors = {
            common: 'bg-gray-50',
            uncommon: 'bg-green-50', 
            rare: 'bg-blue-50',
            epic: 'bg-purple-50'
          };
          box.innerHTML = animals.map(animal => {
            const health = gameState.animalHealth[animal.id]||0;
            const count = gameState.animals[animal.id]||0;
            const needsFeeding = count > 0 && health < 100;
            const feedCost = Math.ceil(count * 0.1); // æ¯åªåŠ¨ç‰©æ¶ˆè€—0.1ä¸ªé¥²æ–™ï¼Œå‘ä¸Šå–æ•´
            
            return `<div class="flex items-center gap-3 p-3 rounded-lg ${rarityColors[animal.rarity]} border-l-4 ${animal.rarity === 'epic' ? 'border-purple-500' : animal.rarity === 'rare' ? 'border-blue-500' : animal.rarity === 'uncommon' ? 'border-green-500' : 'border-gray-500'} shadow-sm">
              <span class="text-3xl">${animal.icon}</span>
              <div class="flex-1">
                <div class="font-bold text-lg">${animal.name}</div>
                <div class="text-sm text-gray-500">æ•°é‡: ${count}</div>
                <div class="flex items-center gap-2 mt-1">
                  <span class="text-xs text-gray-400">å¥åº·åº¦</span>
                  <div class="w-24 bg-gray-200 rounded-full h-3">
                    <div class="${health > 50 ? 'bg-green-500' : health > 20 ? 'bg-yellow-500' : 'bg-red-500'} h-3 rounded-full transition-all duration-300" style="width: ${health}%"></div>
                  </div>
                  <span class="text-xs font-semibold ${health > 50 ? 'text-green-700' : health > 20 ? 'text-yellow-600' : 'text-red-600'}">${health}%</span>
                </div>
              </div>
              <div class="flex flex-col gap-1">
                ${count > 0 ? `
                  <button class="feed-individual-btn px-3 py-1 rounded text-xs font-semibold transition-all duration-200 ${needsFeeding ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}" 
                    data-animal-id="${animal.id}" 
                    data-feed-cost="${feedCost}"
                    ${!needsFeeding ? 'disabled' : ''}>
                    ${needsFeeding ? `å–‚å…» (${feedCost}é¥²æ–™)` : 'å¥åº·æ»¡å€¼'}
                  </button>
                ` : `
                  <div class="px-3 py-1 text-xs text-gray-400">æš‚æ— åŠ¨ç‰©</div>
                `}
              </div>
            </div>`;
          }).join('');
          
          // ä¸ºæ¯ä¸ªåŠ¨ç‰©çš„å–‚å…»æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
          box.querySelectorAll('.feed-individual-btn').forEach(btn => {
            btn.onclick = function() {
              const animalId = this.getAttribute('data-animal-id');
              const feedCost = parseInt(this.getAttribute('data-feed-cost'));
              
              if ((gameState.animalFeed || 0) < feedCost) {
                showNotification(`é¥²æ–™ä¸è¶³ï¼éœ€è¦ ${feedCost} ä¸ªé¥²æ–™`, 'error');
                return;
              }
              
              const animalName = animals.find(a => a.id === animalId)?.name;
              const currentHealth = gameState.animalHealth[animalId] || 0;
              
              if (currentHealth >= 100) {
                showNotification(`${animalName}å¥åº·åº¦å·²æ»¡ï¼Œæ— éœ€å–‚å…»`, 'info');
                return;
              }
              
              // æ‰§è¡Œå–‚å…»
              gameState.animalFeed -= feedCost;
              gameState.animalHealth[animalId] = 100;
              
              // æ›´æ–°UI
              renderMyAnimals();
              updateRanchStats();
              saveGameData();
              
              showNotification(`${animalName}å–‚å…»æˆåŠŸï¼å¥åº·åº¦æ¢å¤åˆ°100%`, 'success');
            };
          });
          
          renderRanchAnimals(); // ä¿æŒç‰§åœºåŠ¨ç‰©å±•ç¤ºåŒæ­¥
        }

        // æ¸²æŸ“å¹¸ç¦å€¼ã€åŠ¨ç‰©å¥åº·ã€åŠ¨ç‰©å‰¯äº§å“
        function renderHappiness() {
          // å¹¸ç¦å€¼=å–·æ³‰*10+èŠ±å›*5
          gameState.happiness = (gameState.decors.fountain||0)*10 + (gameState.decors.flowerbed||0)*5;
          document.getElementById('happiness-value').textContent = gameState.happiness;
        }
        function renderAnimalHealth() {
          const list = document.getElementById('animal-health-list');
          if (!list) return;
          const animals = [
            { id: 'chicken', name: 'é¸¡', icon: 'ğŸ”', rarity: 'common' },
            { id: 'cow', name: 'ç‰›', icon: 'ğŸ„', rarity: 'common' },
            { id: 'sheep', name: 'ç¾Š', icon: 'ğŸ‘', rarity: 'common' },
            { id: 'pig', name: 'çŒª', icon: 'ğŸ·', rarity: 'uncommon' },
            { id: 'duck', name: 'é¸­å­', icon: 'ğŸ¦†', rarity: 'common' },
            { id: 'goat', name: 'å±±ç¾Š', icon: 'ğŸ', rarity: 'uncommon' },
            { id: 'rabbit', name: 'å…”å­', icon: 'ğŸ°', rarity: 'rare' },
            { id: 'horse', name: 'é©¬', icon: 'ğŸ', rarity: 'epic' }
          ];
          
          const rarityColors = {
            common: 'bg-gray-50',
            uncommon: 'bg-green-50', 
            rare: 'bg-blue-50',
            epic: 'bg-purple-50'
          };
          
          list.innerHTML = animals.map(a => `
            <div class="flex items-center gap-3 p-3 rounded-lg ${rarityColors[a.rarity]} border-l-4 ${a.rarity === 'epic' ? 'border-purple-500' : a.rarity === 'rare' ? 'border-blue-500' : a.rarity === 'uncommon' ? 'border-green-500' : 'border-gray-500'} shadow-sm">
              <span class="text-3xl">${a.icon}</span>
              <div class="flex-1">
                <div class="font-bold text-lg">${a.name}</div>
                <div class="text-sm text-gray-500">æ•°é‡: ${gameState.animals[a.id]||0}</div>
              </div>
              <div class="text-right">
                <div class="text-sm font-semibold ${(gameState.animalHealth[a.id]||0) > 50 ? 'text-green-700' : (gameState.animalHealth[a.id]||0) > 20 ? 'text-yellow-600' : 'text-red-600'}">
                  å¥åº·åº¦: ${gameState.animalHealth[a.id]||0}%
                </div>
                <div class="w-24 bg-gray-200 rounded-full h-3 mt-2">
                  <div class="bg-green-500 h-3 rounded-full transition-all duration-300" style="width: ${gameState.animalHealth[a.id]||0}%"></div>
                </div>
              </div>
            </div>
          `).join('');
          document.getElementById('feed-count').textContent = gameState.animalFeed||0;
        }
        function renderAnimalProducts() {
          const box = document.getElementById('animal-products-list');
          if (!box) return;
          const products = [
            { id: 'egg', name: 'é¸¡è›‹', icon: 'ğŸ¥š', price: 8, rarity: 'common' },
            { id: 'milk', name: 'ç‰›å¥¶', icon: 'ğŸ¥›', price: 20, rarity: 'common' },
            { id: 'wool', name: 'ç¾Šæ¯›', icon: 'ğŸ§¶', price: 15, rarity: 'common' },
            { id: 'pork', name: 'çŒªè‚‰', icon: 'ğŸ¥©', price: 25, rarity: 'uncommon' },
            { id: 'duck_egg', name: 'é¸­è›‹', icon: 'ğŸ¥š', price: 12, rarity: 'common' },
            { id: 'goat_milk', name: 'ç¾Šå¥¶', icon: 'ğŸ¥›', price: 30, rarity: 'uncommon' },
            { id: 'rabbit_fur', name: 'å…”æ¯›', icon: 'ğŸ§¶', price: 40, rarity: 'rare' },
            { id: 'horse_manure', name: 'é©¬ç²ª', icon: 'ğŸ’©', price: 5, rarity: 'common' }
          ];
          
          const rarityColors = {
            common: 'bg-gray-50',
            uncommon: 'bg-green-50', 
            rare: 'bg-blue-50',
            epic: 'bg-purple-50'
          };
          
          box.innerHTML = products.map(p => `
            <div class="flex items-center gap-3 p-3 rounded-lg ${rarityColors[p.rarity]} border-l-4 ${p.rarity === 'rare' ? 'border-blue-500' : p.rarity === 'uncommon' ? 'border-green-500' : 'border-gray-500'} shadow-sm">
              <span class="text-3xl">${p.icon}</span>
              <div class="flex-1">
                <div class="font-bold text-lg">${p.name}</div>
                <div class="text-sm text-gray-500">å”®ä»·: ${p.price}é‡‘å¸</div>
              </div>
              <div class="text-right">
                <div class="text-sm font-semibold text-green-700">æ•°é‡: ${gameState.animalProducts[p.id]||0}</div>
                <button class="sell-product bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition" data-product-id="${p.id}" data-price="${p.price}">å‡ºå”®</button>
              </div>
            </div>
          `).join('');
          
          box.querySelectorAll('.sell-product').forEach(btn => {
            btn.onclick = function() {
              const id = this.getAttribute('data-product-id');
              const price = parseInt(this.getAttribute('data-price'));
              if ((gameState.animalProducts[id]||0) <= 0) {
                showNotification('æ²¡æœ‰å¯å‡ºå”®çš„å‰¯äº§å“','error'); return;
              }
              gameState.animalProducts[id]--;
              gameState.money += price;
              renderAnimalProducts();
              updateUI();
              saveGameData();
              
              // æ ¹æ®äº§å“ç±»å‹æ˜¾ç¤ºä¸åŒçš„å‡ºå”®æ¶ˆæ¯
              const productNames = {
                'egg': 'é¸¡è›‹', 'milk': 'ç‰›å¥¶', 'wool': 'ç¾Šæ¯›', 'pork': 'çŒªè‚‰',
                'duck_egg': 'é¸­è›‹', 'goat_milk': 'ç¾Šå¥¶', 'rabbit_fur': 'å…”æ¯›', 'horse_manure': 'é©¬ç²ª'
              };
              showNotification(`å‡ºå”®${productNames[id]}æˆåŠŸï¼+${price}é‡‘å¸`,'success');
            };
          });
        }

        // å–‚å…»åŠ¨ç‰©æŒ‰é’®é€»è¾‘
        setTimeout(()=>{
          const feedBtn = document.getElementById('feed-animals-btn');
          if(feedBtn){
            feedBtn.onclick = function(){
              if((gameState.animalFeed||0)<=0){
                showNotification('é¥²æ–™ä¸è¶³','error');return;
              }
              
              // æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨ç‰©éœ€è¦å–‚å…»ï¼ˆå¥åº·åº¦ä¸æ»¡100%ï¼‰
              const animalIds = ['chicken','cow','sheep','pig','duck','goat','rabbit','horse'];
              let totalAnimalsNeedingFeed = 0;
              let animalsToFeed = [];
              
              animalIds.forEach(id => {
                const animalCount = gameState.animals[id] || 0;
                const health = gameState.animalHealth[id] || 0;
                if(animalCount > 0 && health < 100) {
                  totalAnimalsNeedingFeed += animalCount;
                  animalsToFeed.push({id, count: animalCount, name: getAnimalName(id)});
                }
              });
              
              if(totalAnimalsNeedingFeed === 0) {
                showNotification('æ‰€æœ‰åŠ¨ç‰©å¥åº·åº¦éƒ½æ˜¯æ»¡çš„ï¼Œæ— éœ€å–‚å…»ï¼','info');
                return;
              }
              
              // è®¡ç®—éœ€è¦çš„é¥²æ–™æ•°é‡ï¼ˆæ¯åªåŠ¨ç‰©0.1ä¸ªé¥²æ–™ï¼Œå‘ä¸Šå–æ•´ï¼‰
              const feedNeeded = Math.ceil(totalAnimalsNeedingFeed * 0.1);
              
              if((gameState.animalFeed||0) < feedNeeded) {
                showNotification(`é¥²æ–™ä¸è¶³ï¼éœ€è¦ ${feedNeeded} ä¸ªé¥²æ–™ï¼Œå½“å‰åªæœ‰ ${gameState.animalFeed||0} ä¸ª`, 'error');
                return;
              }
              
              // æ‰§è¡Œå–‚å…»
              animalsToFeed.forEach(animal => {
                gameState.animalHealth[animal.id] = 100;
              });
              
              gameState.animalFeed -= feedNeeded;
              renderAnimalHealth();
              renderMyAnimals(); // æ–°å¢ï¼šå–‚å®ŒåŠ¨ç‰©ååˆ·æ–°æˆ‘çš„åŠ¨ç‰©å¡ç‰‡
              updateRanchStats();
              saveGameData();
              showNotification(`å…¨éƒ¨åŠ¨ç‰©å–‚å…»å®Œæˆï¼å…±å–‚å…» ${totalAnimalsNeedingFeed} åªåŠ¨ç‰©ï¼Œæ¶ˆè€— ${feedNeeded} ä¸ªé¥²æ–™`, 'success');
            };
          }
        },0);
        
        // è·å–åŠ¨ç‰©åç§°çš„è¾…åŠ©å‡½æ•°
        function getAnimalName(id) {
          const animalNames = {
            'chicken': 'é¸¡', 'cow': 'ç‰›', 'sheep': 'ç¾Š', 'pig': 'çŒª',
            'duck': 'é¸­å­', 'goat': 'å±±ç¾Š', 'rabbit': 'å…”å­', 'horse': 'é©¬'
          };
          return animalNames[id] || id;
        }

        // å®šæ—¶å™¨ï¼šåŠ¨ç‰©äº§å‡ºä¸å¥åº·åº¦å˜åŒ–
        setInterval(()=>{
          // å¹¸ç¦å€¼å½±å“äº§å‡ºæ•ˆç‡
          const happinessBonus = 1 + (gameState.happiness||0)/100;
          
          // è·å–å½“å‰å¤©æ°”å¯¹åŠ¨ç‰©çš„å½±å“
          const currentWeatherEffect = ranchEnvironment.weatherEffects[gameState.weather];
          const weatherBonus = currentWeatherEffect ? currentWeatherEffect.animalEffects.productionBonus : 1.0;
          const healthDecayModifier = currentWeatherEffect ? currentWeatherEffect.animalEffects.healthDecayModifier : 1.0;
          
          // åŠ¨ç‰©äº§å‡ºé…ç½®
          const animalProduction = {
            chicken: { product: 'egg', chance: 0.2, healthDecay: 2 },
            cow: { product: 'milk', chance: 0.1, healthDecay: 1 },
            sheep: { product: 'wool', chance: 0.12, healthDecay: 1 },
            pig: { product: 'pork', chance: 0.08, healthDecay: 1.5 },
            duck: { product: 'duck_egg', chance: 0.15, healthDecay: 1.5 },
            goat: { product: 'goat_milk', chance: 0.09, healthDecay: 1 },
            rabbit: { product: 'rabbit_fur', chance: 0.06, healthDecay: 0.5 },
            horse: { product: 'horse_manure', chance: 0.25, healthDecay: 0.5 }
          };
          
          // åŠ¨ç‰©äº§å‡ºå’Œå¥åº·åº¦å˜åŒ–
          Object.keys(animalProduction).forEach(animalId => {
            if(gameState.animals[animalId] > 0 && (gameState.animalHealth[animalId]||0) > 0){
              const config = animalProduction[animalId];
              
              // è®¡ç®—æœ€ç»ˆäº§å‡ºæ¦‚ç‡ï¼ˆå¹¸ç¦å€¼ Ã— å¤©æ°”å½±å“ï¼‰
              const finalChance = config.chance * happinessBonus * weatherBonus;
              
              // åŠ¨ç‰©äº§å‡º
              if(Math.random() < finalChance) {
                let productAmount = gameState.animals[animalId];
                
                // å½©è™¹å¤©æ°”çš„å“è´¨åŠ æˆ
                if (currentWeatherEffect && currentWeatherEffect.animalEffects.qualityBonus) {
                  productAmount = Math.floor(productAmount * currentWeatherEffect.animalEffects.qualityBonus);
                }
                
                gameState.animalProducts[config.product] += productAmount;
              }
              
              // å¥åº·åº¦è¡°å‡ï¼ˆå—å¤©æ°”å½±å“ï¼‰
              const finalHealthDecay = config.healthDecay * healthDecayModifier;
              gameState.animalHealth[animalId] = Math.max(0, gameState.animalHealth[animalId] - finalHealthDecay);
              
              // ç‰¹æ®Šå¤©æ°”æ•ˆæœ
              if (currentWeatherEffect) {
                const effects = currentWeatherEffect.animalEffects;
                
                // å°é£å¯èƒ½é€ æˆåŠ¨ç‰©å—ä¼¤
                if (effects.injuryRisk && Math.random() < effects.injuryRisk) {
                  gameState.animalHealth[animalId] = Math.max(0, gameState.animalHealth[animalId] - 20);
                  showNotification(`å°é£ä¸­${getAnimalName(animalId)}å—ä¼¤äº†ï¼å¥åº·åº¦ä¸‹é™`, 'error');
                }
                
                // å½©è™¹å¤©æ°”çš„å¥åº·æ¢å¤æ•ˆæœ
                if (gameState.weather === 'rainbow' && Math.random() < 0.3) {
                  gameState.animalHealth[animalId] = Math.min(100, gameState.animalHealth[animalId] + 5);
                }
                
                // å¹²æ—±å¤©æ°”çš„é¢å¤–æ°´åˆ†éœ€æ±‚
                if (effects.waterNeed && effects.waterNeed > 1) {
                  if (Math.random() < 0.2) {
                    gameState.animalHealth[animalId] = Math.max(0, gameState.animalHealth[animalId] - 3);
                  }
                }
              }
            }
          });
          
          // æ˜¾ç¤ºå¤©æ°”å¯¹åŠ¨ç‰©çš„å½±å“æç¤º
          if (currentWeatherEffect && Math.random() < 0.1) {
            const effects = currentWeatherEffect.animalEffects;
            if (effects.benefits.length > 0) {
              const randomBenefit = effects.benefits[Math.floor(Math.random() * effects.benefits.length)];
              showNotification(`${currentWeatherEffect.title}ï¼š${randomBenefit}`, 'success');
            }
            if (effects.drawbacks.length > 0 && Math.random() < 0.5) {
              const randomDrawback = effects.drawbacks[Math.floor(Math.random() * effects.drawbacks.length)];
              showNotification(`${currentWeatherEffect.title}ï¼š${randomDrawback}`, 'warning');
            }
          }
          
          renderAnimalProducts();
          renderAnimalHealth();
          updateRanchStats();
          updateRanchWeather(); // æ›´æ–°ç‰§åœºå¤©æ°”æ˜¾ç¤º
          saveGameData();
        },60000); // æ¯åˆ†é’Ÿäº§å‡ºä¸€æ¬¡

        // å•†åº—æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
        function setupShopTabSwitching() {
            const tabButtons = document.querySelectorAll('.shop-tab-btn');
            const shopContents = document.querySelectorAll('.shop-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    
                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
                    shopContents.forEach(content => {
                        content.classList.remove('active');
                        content.style.display = 'none';
                    });
                    
                    // æ¿€æ´»å½“å‰æŒ‰é’®
                    this.classList.add('active');
                    
                    // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹åŒºåŸŸ
                    const targetContent = document.querySelector(`[id="${category === 'seeds' ? 'shop-items' : category === 'items' ? 'item-shop' : category === 'decor' ? 'decor-shop' : 'animal-shop'}"]`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                        targetContent.style.display = 'block';
                    }
                    
                    // æ ¹æ®ç±»åˆ«é‡æ–°æ¸²æŸ“å¯¹åº”çš„å•†åº—å†…å®¹
                    switch(category) {
                        case 'seeds':
                            renderShop();
                            break;
                        case 'items':
                            renderItemShop();
                            break;
                        case 'decor':
                            renderDecorShop();
                            break;
                        case 'animals':
                            renderAnimalShop();
                            break;
                    }
                });
            });
        }

        // ç‰§åœºç®¡ç†åŠŸèƒ½
        function setupRanchManagement() {
            // è´­ä¹°é¥²æ–™æŒ‰é’®
            const buyFeedBtn = document.getElementById('buy-feed-btn');
            if (buyFeedBtn) {
                buyFeedBtn.onclick = function() {
                    if (gameState.money < 10) {
                        showNotification('é‡‘å¸ä¸è¶³ï¼Œæ— æ³•è´­ä¹°é¥²æ–™','error');
                        return;
                    }
                    gameState.money -= 10;
                    gameState.animalFeed = (gameState.animalFeed || 0) + 1;
                    updateRanchStats();
                    updateUI();
                    saveGameData();
                    showNotification('è´­ä¹°é¥²æ–™æˆåŠŸï¼','success');
                };
            }

            // ä¸€é”®å‡ºå”®æ‰€æœ‰å‰¯äº§å“æŒ‰é’®
            const sellAllProductsBtn = document.getElementById('sell-all-products-btn');
            if (sellAllProductsBtn) {
                sellAllProductsBtn.onclick = function() {
                    let totalEarnings = 0;
                    const products = [
                        { id: 'egg', name: 'é¸¡è›‹', price: 8 },
                        { id: 'milk', name: 'ç‰›å¥¶', price: 20 },
                        { id: 'wool', name: 'ç¾Šæ¯›', price: 15 },
                        { id: 'pork', name: 'çŒªè‚‰', price: 25 },
                        { id: 'duck_egg', name: 'é¸­è›‹', price: 12 },
                        { id: 'goat_milk', name: 'ç¾Šå¥¶', price: 30 },
                        { id: 'rabbit_fur', name: 'å…”æ¯›', price: 40 },
                        { id: 'horse_manure', name: 'é©¬ç²ª', price: 5 }
                    ];
                    
                    products.forEach(product => {
                        const quantity = gameState.animalProducts[product.id] || 0;
                        if (quantity > 0) {
                            totalEarnings += quantity * product.price;
                            gameState.animalProducts[product.id] = 0;
                        }
                    });
                    
                    if (totalEarnings > 0) {
                        gameState.money += totalEarnings;
                        renderAnimalProducts();
                        updateUI();
                        saveGameData();
                        showNotification(`ä¸€é”®å‡ºå”®æˆåŠŸï¼è·å¾— ${totalEarnings} é‡‘å¸`,'success');
                    } else {
                        showNotification('æ²¡æœ‰å¯å‡ºå”®çš„å‰¯äº§å“','info');
                    }
                };
            }

            // åˆå§‹åŒ–ç‰§åœºç»Ÿè®¡
            updateRanchStats();
        }

        // æ›´æ–°ç‰§åœºç»Ÿè®¡
        function updateRanchStats() {
            const totalAnimalsElement = document.getElementById('total-animals');
            const avgHealthElement = document.getElementById('avg-health');
            const feedCountElement = document.getElementById('feed-count');
            
            if (totalAnimalsElement && avgHealthElement) {
                // è®¡ç®—æ€»åŠ¨ç‰©æ•°
                const totalAnimals = Object.values(gameState.animals).reduce((sum, count) => sum + (count || 0), 0);
                totalAnimalsElement.textContent = totalAnimals;
                
                // è®¡ç®—å¹³å‡å¥åº·åº¦
                const animalIds = ['chicken', 'cow', 'sheep', 'pig', 'duck', 'goat', 'rabbit', 'horse'];
                let totalHealth = 0;
                let animalCount = 0;
                
                animalIds.forEach(id => {
                    const count = gameState.animals[id] || 0;
                    if (count > 0) {
                        totalHealth += (gameState.animalHealth[id] || 0) * count;
                        animalCount += count;
                    }
                });
                
                const avgHealth = animalCount > 0 ? Math.round(totalHealth / animalCount) : 100;
                avgHealthElement.textContent = avgHealth + '%';
                
                // æ ¹æ®å¥åº·åº¦è®¾ç½®é¢œè‰²
                if (avgHealth > 70) {
                    avgHealthElement.className = 'text-2xl font-bold text-green-600';
                } else if (avgHealth > 40) {
                    avgHealthElement.className = 'text-2xl font-bold text-yellow-600';
                } else {
                    avgHealthElement.className = 'text-2xl font-bold text-red-600';
                }
            }
            
            // æ›´æ–°é¥²æ–™åº“å­˜æ˜¾ç¤º
            if (feedCountElement) {
                feedCountElement.textContent = gameState.animalFeed || 0;
            }
        }

        // æ¸²æŸ“ç‰§åœºåŠ¨ç‰©å›¾æ ‡
        function renderRanchAnimals() {
            const box = document.getElementById('ranch-animal-icons');
            if (!box) return;
            
            // ä¸ºç‰§åœºå®¹å™¨æ·»åŠ å¤§æ°”æ•ˆæœ
            box.className = 'ranch-atmosphere grid grid-cols-4 gap-6 p-8 bg-gradient-to-br from-green-100 to-green-200 rounded-lg border-2 border-green-300 shadow-lg relative overflow-hidden';
            
            const animals = [
                { id: 'chicken', name: 'é¸¡', icon: 'ğŸ”', animations: ['animal-walk', 'animal-bounce'] },
                { id: 'cow', name: 'ç‰›', icon: 'ğŸ„', animations: ['animal-sway', 'animal-breathe'] },
                { id: 'sheep', name: 'ç¾Š', icon: 'ğŸ‘', animations: ['animal-bounce', 'animal-sway'] },
                { id: 'pig', name: 'çŒª', icon: 'ğŸ·', animations: ['animal-walk', 'animal-breathe'] },
                { id: 'duck', name: 'é¸­å­', icon: 'ğŸ¦†', animations: ['animal-walk', 'animal-bounce'] },
                { id: 'goat', name: 'å±±ç¾Š', icon: 'ğŸ', animations: ['animal-bounce', 'animal-sway'] },
                { id: 'rabbit', name: 'å…”å­', icon: 'ğŸ°', animations: ['animal-bounce', 'animal-walk'] },
                { id: 'horse', name: 'é©¬', icon: 'ğŸ', animations: ['animal-walk', 'animal-sway'] }
            ];
            
            let animalElements = [];
            
            animals.forEach(animal => {
                const count = gameState.animals[animal.id] || 0;
                const health = gameState.animalHealth[animal.id] || 0;
                
                if (count > 0) {
                    // ä¸ºæ¯ç§åŠ¨ç‰©åˆ›å»ºå¤šä¸ªä¸ªä½“ï¼ˆæœ€å¤šæ˜¾ç¤º6ä¸ªï¼‰
                    const displayCount = Math.min(count, 6);
                    
                    for (let i = 0; i < displayCount; i++) {
                        // éšæœºé€‰æ‹©åŠ¨ç”»æ•ˆæœ
                        const randomAnimation = animal.animations[Math.floor(Math.random() * animal.animations.length)];
                        
                        // æ ¹æ®å¥åº·åº¦å†³å®šåŠ¨ç”»å’Œæ ·å¼
                        let healthClass = '';
                        if (health > 70) {
                            healthClass = 'animal-healthy';
                        } else if (health < 30) {
                            healthClass = 'animal-sick';
                        }
                        
                        // éšæœºå»¶è¿ŸåŠ¨ç”»ï¼Œè®©åŠ¨ç‰©ä»¬ä¸åŒæ­¥
                        const animationDelay = Math.random() * 3;
                        
                        animalElements.push(`
                            <div class="ranch-animal ${randomAnimation} ${healthClass} flex flex-col items-center justify-center p-2 rounded-lg bg-white bg-opacity-50 backdrop-blur-sm hover:bg-opacity-80 transition-all duration-300" 
                                 style="animation-delay: ${animationDelay}s;" 
                                 title="${animal.name} - å¥åº·åº¦: ${health}%">
                                <span class="text-3xl mb-1 animal-blink" style="animation-delay: ${animationDelay + 1}s;">${animal.icon}</span>
                                <span class="text-xs font-bold text-green-800">${animal.name}</span>
                                ${i === 0 && count > displayCount ? `<span class="text-xs text-gray-600">+${count - displayCount}åª</span>` : ''}
                            </div>
                        `);
                    }
                }
            });
            
            if (animalElements.length === 0) {
                box.innerHTML = `
                    <div class="col-span-4 text-center py-12">
                        <div class="text-6xl mb-4 opacity-50">ğŸŒ¾</div>
                        <div class="text-gray-500 italic text-lg">ç©ºæ—·çš„ç‰§åœºç­‰å¾…ç€åŠ¨ç‰©ä»¬çš„åˆ°æ¥...</div>
                        <div class="text-sm text-gray-400 mt-2">å»å•†åº—è´­ä¹°ä¸€äº›åŠ¨ç‰©å§ï¼</div>
                    </div>
                `;
            } else {
                // æ·»åŠ ç¯å¢ƒè£…é¥°
                const environmentElements = [
                    '<div class="ranch-decoration absolute top-2 left-2 text-2xl opacity-60 grass-sway">ğŸŒ¾</div>',
                    '<div class="ranch-decoration absolute top-2 right-2 text-2xl opacity-60 cloud-float">â˜ï¸</div>',
                    '<div class="ranch-decoration absolute bottom-2 left-2 text-xl opacity-50 grass-sway" style="animation-delay: 2s;">ğŸŒ»</div>',
                    '<div class="ranch-decoration absolute bottom-2 right-2 text-xl opacity-50 grass-sway" style="animation-delay: 1s;">ğŸ¦‹</div>'
                ];
                
                box.innerHTML = animalElements.join('') + environmentElements.join('');
            }
        }
        
        // å®šæœŸæ›´æ–°åŠ¨ç‰©åŠ¨ç”»ï¼ˆæ¯10ç§’éšæœºæ”¹å˜åŠ¨ç‰©çš„åŠ¨ç”»ï¼‰
        setInterval(() => {
            const animalElements = document.querySelectorAll('.ranch-animal');
            animalElements.forEach(element => {
                const animations = ['animal-walk', 'animal-bounce', 'animal-sway', 'animal-breathe'];
                const currentClasses = element.className.split(' ');
                
                // ç§»é™¤æ—§çš„åŠ¨ç”»ç±»
                animations.forEach(anim => {
                    element.classList.remove(anim);
                });
                
                // æ·»åŠ æ–°çš„éšæœºåŠ¨ç”»
                const newAnimation = animations[Math.floor(Math.random() * animations.length)];
                element.classList.add(newAnimation);
                
                // éšæœºæ”¹å˜åŠ¨ç”»å»¶è¿Ÿ
                element.style.animationDelay = Math.random() * 3 + 's';
            });
        }, 10000); // æ¯10ç§’æ›´æ–°ä¸€æ¬¡åŠ¨ç”»
        
        // ç‰§åœºç¯å¢ƒç³»ç»Ÿ
        const ranchEnvironment = {
            soundEnabled: false,
            timeOfDay: 'day',
            season: 'spring',
            
            // æ—¶é—´ç³»ç»Ÿ
            timeSystem: {
                day: { icon: 'ğŸ•', title: 'ç™½å¤©', mood: 'ğŸ˜Š åŠ¨ç‰©ä»¬å¾ˆæ´»è·ƒ' },
                evening: { icon: 'ğŸŒ…', title: 'å‚æ™š', mood: 'ğŸ˜Œ åŠ¨ç‰©ä»¬åœ¨ä¼‘æ¯' },
                night: { icon: 'ğŸŒ™', title: 'å¤œæ™š', mood: 'ğŸ˜´ åŠ¨ç‰©ä»¬åœ¨ç¡è§‰' }
            },
            
            // å­£èŠ‚ç³»ç»Ÿ
            seasons: {
                spring: { icon: 'ğŸŒ¸', title: 'æ˜¥å­£' },
                summer: { icon: 'â˜€ï¸', title: 'å¤å­£' },
                autumn: { icon: 'ğŸ‚', title: 'ç§‹å­£' },
                winter: { icon: 'â„ï¸', title: 'å†¬å­£' }
            },
            
            // åŠ¨ç‰©å«å£°
            animalSounds: {
                chicken: ['å’¯å’¯', 'å’¯å’¯å’¯'],
                cow: ['å“~', 'å“å“'],
                sheep: ['å’©~', 'å’©å’©'],
                pig: ['å“¼å“¼', 'å“¼å“¼å“¼'],
                duck: ['å˜å˜', 'å˜å˜å˜'],
                goat: ['å’©å’©', 'å’©~'],
                rabbit: ['...', '(æ— å£°)'],
                horse: ['å˜¶~', 'å˜¶å˜¶']
            },
            
            // å¤©æ°”å¯¹åŠ¨ç‰©çš„å½±å“ï¼ˆä¸ä¸»å¤©æ°”ç³»ç»Ÿç»Ÿä¸€ï¼‰
            weatherEffects: {
                sunny: {
                    icon: 'â˜€ï¸',
                    title: 'æ™´å¤©',
                    effect: 'sunny-effect',
                    animalEffects: {
                        benefits: ['äº§å‡ºæ•ˆç‡+20%', 'å¥åº·åº¦ç¼“æ…¢æ¢å¤', 'åŠ¨ç‰©å¿ƒæƒ…æ„‰æ‚¦'],
                        drawbacks: ['æ°´åˆ†æ¶ˆè€—å¢åŠ ', 'éœ€è¦æ›´å¤šé¥®æ°´', 'ä¸­æš‘é£é™©'],
                        productionBonus: 1.2,
                        healthDecayModifier: 0.8, // å¥åº·åº¦è¡°å‡å‡å°‘
                        waterNeed: 1.5 // éœ€è¦æ›´å¤šæ°´åˆ†
                    }
                },
                rainy: {
                    icon: 'ğŸŒ§ï¸',
                    title: 'é›¨å¤©',
                    effect: 'rainy-effect',
                    animalEffects: {
                        benefits: ['è‡ªåŠ¨è¡¥å……æ°´åˆ†', 'æ¸…æ´ç¯å¢ƒ', 'é™ä½ç–¾ç—…é£é™©'],
                        drawbacks: ['äº§å‡ºæ•ˆç‡-10%', 'å®¹æ˜“æ„Ÿå†’', 'æ³¥æ³ç¯å¢ƒ'],
                        productionBonus: 0.9,
                        healthDecayModifier: 1.1, // å¥åº·åº¦è¡°å‡å¢åŠ 
                        diseaseResistance: 1.2 // ç–¾ç—…æŠ—æ€§æé«˜
                    }
                },
                stormy: {
                    icon: 'â›ˆï¸',
                    title: 'æš´é›¨',
                    effect: 'stormy-effect',
                    animalEffects: {
                        benefits: ['å……è¶³æ°´æº', 'ç¯å¢ƒæ¸…æ´'],
                        drawbacks: ['äº§å‡ºåœæ­¢', 'å¥åº·åº¦å¿«é€Ÿä¸‹é™', 'åŠ¨ç‰©ææ…Œ'],
                        productionBonus: 0,
                        healthDecayModifier: 2.0, // å¥åº·åº¦è¡°å‡ç¿»å€
                        stressLevel: 'high'
                    }
                },
                drought: {
                    icon: 'ğŸ”¥',
                    title: 'å¹²æ—±',
                    effect: 'drought-effect',
                    animalEffects: {
                        benefits: ['å¹²ç‡¥ç¯å¢ƒå‡å°‘ç»†èŒ'],
                        drawbacks: ['ä¸¥é‡ç¼ºæ°´', 'äº§å‡ºå‡åŠ', 'å¥åº·åº¦å¿«é€Ÿä¸‹é™'],
                        productionBonus: 0.5,
                        healthDecayModifier: 2.5, // å¥åº·åº¦è¡°å‡å¤§å¹…å¢åŠ 
                        waterNeed: 3.0 // éœ€è¦å¤§é‡æ°´åˆ†
                    }
                },
                typhoon: {
                    icon: 'ğŸŒ€',
                    title: 'å°é£',
                    effect: 'typhoon-effect',
                    animalEffects: {
                        benefits: ['å°é£è¿‡åç©ºæ°”æ¸…æ–°'],
                        drawbacks: ['åŠ¨ç‰©å—æƒŠ', 'äº§å‡ºåœæ­¢', 'å¯èƒ½å—ä¼¤'],
                        productionBonus: 0,
                        healthDecayModifier: 1.8,
                        injuryRisk: 0.1 // 10%å—ä¼¤é£é™©
                    }
                },
                rainbow: {
                    icon: 'ğŸŒˆ',
                    title: 'å½©è™¹å¤©',
                    effect: 'rainbow-effect',
                    animalEffects: {
                        benefits: ['åŠ¨ç‰©å¿ƒæƒ…æä½³', 'äº§å‡ºå“è´¨æå‡', 'å¥åº·åº¦æ¢å¤'],
                        drawbacks: [],
                        productionBonus: 1.5,
                        healthDecayModifier: 0.5, // å¥åº·åº¦è¡°å‡å¤§å¹…å‡å°‘
                        qualityBonus: 1.5 // äº§å“å“è´¨æå‡
                    }
                },
                sandstorm: {
                    icon: 'ğŸŒªï¸',
                    title: 'æ²™å°˜æš´',
                    effect: 'sandstorm-effect',
                    animalEffects: {
                        benefits: [],
                        drawbacks: ['å‘¼å¸å›°éš¾', 'äº§å‡ºåœæ­¢', 'å¥åº·åº¦ä¸‹é™', 'è§†é‡å—é˜»'],
                        productionBonus: 0,
                        healthDecayModifier: 2.2,
                        respiratoryIssues: true
                    }
                }
            }
        };
        
        // åˆå§‹åŒ–ç‰§åœºç¯å¢ƒæ§åˆ¶
        function initRanchEnvironment() {
            const soundBtn = document.getElementById('ranch-sound-btn');
            
            if (soundBtn) {
                soundBtn.onclick = function() {
                    ranchEnvironment.soundEnabled = !ranchEnvironment.soundEnabled;
                    const soundIcon = document.getElementById('sound-icon');
                    const soundText = document.getElementById('sound-text');
                    
                    if (ranchEnvironment.soundEnabled) {
                        soundIcon.textContent = 'ğŸ”Š';
                        soundText.textContent = 'éŸ³æ•ˆå¼€';
                        soundBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                        soundBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                        showNotification('ç‰§åœºéŸ³æ•ˆå·²å¼€å¯ï¼', 'success');
                        playRanchSound();
                    } else {
                        soundIcon.textContent = 'ğŸ”‡';
                        soundText.textContent = 'éŸ³æ•ˆå…³';
                        soundBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                        soundBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                        showNotification('ç‰§åœºéŸ³æ•ˆå·²å…³é—­', 'info');
                    }
                };
            }
            
            // å¯åŠ¨æ—¶é—´å¾ªç¯
            startTimeSystem();
            
            // åˆå§‹åŒ–å¤©æ°”æ˜¾ç¤º
            updateRanchWeather();
        }
        
        // æ›´æ–°ç‰§åœºå¤©æ°”æ˜¾ç¤ºï¼ˆä¸ä¸»å¤©æ°”ç³»ç»ŸåŒæ­¥ï¼‰
        function updateRanchWeather() {
            const weatherEffect = document.getElementById('ranch-weather-effect');
            
            const currentWeather = ranchEnvironment.weatherEffects[gameState.weather];
            if (currentWeather) {
                if (weatherEffect) {
                    weatherEffect.className = `absolute inset-0 pointer-events-none z-5 ${currentWeather.effect}`;
                }
            }
        }
        
        // æ’­æ”¾ç‰§åœºéŸ³æ•ˆ
        function playRanchSound() {
            if (!ranchEnvironment.soundEnabled) return;
            
            const animals = ['chicken', 'cow', 'sheep', 'pig', 'duck', 'goat', 'rabbit', 'horse'];
            const availableAnimals = animals.filter(animal => (gameState.animals[animal] || 0) > 0);
            
            if (availableAnimals.length > 0) {
                const randomAnimal = availableAnimals[Math.floor(Math.random() * availableAnimals.length)];
                const sounds = ranchEnvironment.animalSounds[randomAnimal];
                const randomSound = sounds[Math.floor(Math.random() * sounds.length)];
                
                // æ˜¾ç¤ºéŸ³æ•ˆæç¤º
                const soundNotification = document.createElement('div');
                soundNotification.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-semibold z-50 animate-pulse';
                soundNotification.innerHTML = `ğŸ”Š ${getAnimalName(randomAnimal)}: ${randomSound}`;
                document.body.appendChild(soundNotification);
                
                setTimeout(() => {
                    soundNotification.remove();
                }, 2000);
            }
        }
        
        // æ—¶é—´ç³»ç»Ÿ
        function startTimeSystem() {
            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´
            setInterval(() => {
                updateTimeOfDay();
                updateSeason();
                updateRanchStatus();
                
                // éšæœºæ’­æ”¾åŠ¨ç‰©éŸ³æ•ˆ
                if (Math.random() < 0.3) {
                    playRanchSound();
                }
            }, 30000);
        }
        
        function updateTimeOfDay() {
            const times = Object.keys(ranchEnvironment.timeSystem);
            const currentIndex = times.indexOf(ranchEnvironment.timeOfDay);
            const nextIndex = (currentIndex + 1) % times.length;
            
            ranchEnvironment.timeOfDay = times[nextIndex];
            
            const timeElement = document.getElementById('ranch-time');
            const moodElement = document.getElementById('ranch-mood');
            
            if (timeElement && moodElement) {
                const timeData = ranchEnvironment.timeSystem[ranchEnvironment.timeOfDay];
                timeElement.innerHTML = `${timeData.icon} ç°åœ¨æ˜¯${timeData.title}`;
                moodElement.textContent = timeData.mood;
            }
        }
        
        function updateSeason() {
            // æ¯2åˆ†é’Ÿæ¢ä¸€æ¬¡å­£èŠ‚ï¼ˆæ¼”ç¤ºç”¨ï¼‰
            if (Math.random() < 0.1) {
                const seasons = Object.keys(ranchEnvironment.seasons);
                const currentIndex = seasons.indexOf(ranchEnvironment.season);
                const nextIndex = (currentIndex + 1) % seasons.length;
                
                ranchEnvironment.season = seasons[nextIndex];
                
                const seasonElement = document.getElementById('ranch-season');
                if (seasonElement) {
                    const seasonData = ranchEnvironment.seasons[ranchEnvironment.season];
                    seasonElement.innerHTML = `${seasonData.icon} ${seasonData.title}`;
                }
            }
        }
        
        function updateRanchStatus() {
            const titleElement = document.getElementById('ranch-title');
            if (titleElement) {
                const totalAnimals = Object.values(gameState.animals).reduce((sum, count) => sum + (count || 0), 0);
                const avgHealth = calculateAverageHealth();
                const currentWeather = ranchEnvironment.weatherEffects[gameState.weather];
                
                let title = 'ç‰§åœºæ‚ é—²æ—¶å…‰';
                if (totalAnimals === 0) {
                    title = 'ç©ºæ—·çš„ç‰§åœº';
                } else if (currentWeather && currentWeather.animalEffects.drawbacks.length > 0) {
                    title = `${currentWeather.title}ä¸­çš„ç‰§åœº`;
                } else if (avgHealth > 80) {
                    title = 'ç¹è£çš„ç‰§åœº';
                } else if (avgHealth < 40) {
                    title = 'éœ€è¦å…³çˆ±çš„ç‰§åœº';
                }
                
                titleElement.textContent = title;
            }
        }
        
        function calculateAverageHealth() {
            const animalIds = ['chicken', 'cow', 'sheep', 'pig', 'duck', 'goat', 'rabbit', 'horse'];
            let totalHealth = 0;
            let animalCount = 0;
            
            animalIds.forEach(id => {
                const count = gameState.animals[id] || 0;
                if (count > 0) {
                    totalHealth += (gameState.animalHealth[id] || 0) * count;
                    animalCount += count;
                }
            });
            
            return animalCount > 0 ? Math.round(totalHealth / animalCount) : 100;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç‰§åœºç¯å¢ƒ
        setTimeout(() => {
            initRanchEnvironment();
        }, 1000);

        // é€šè¿‡IDè·å–ç§å­
        function getSeedById(id) {
            return seeds.find(seed => seed.id === id);
        }

        // è·å–åœŸåœ°æ”¹è‰¯ç­‰çº§
        function getLandImprovementLevel(plotIndex) {
            if (!gameState.regionLandImprovements[gameState.currentRegion]) {
                return 0;
            }
            return gameState.regionLandImprovements[gameState.currentRegion][plotIndex] || 0;
        }

        // è®¾ç½®åœŸåœ°æ”¹è‰¯ç­‰çº§
        function setLandImprovementLevel(plotIndex, level) {
            if (!gameState.regionLandImprovements[gameState.currentRegion]) {
                gameState.regionLandImprovements[gameState.currentRegion] = {};
            }
            gameState.regionLandImprovements[gameState.currentRegion][plotIndex] = level;
        }

        // è·å–åœŸåœ°æ”¹è‰¯æ•°æ®
        function getLandImprovementData(level) {
            return landImprovementLevels.find(l => l.level === level) || landImprovementLevels[0];
        }

        // å‡çº§åœŸåœ°æ”¹è‰¯
        function upgradeLandImprovement(plotIndex) {
            const currentLevel = getLandImprovementLevel(plotIndex);
            const nextLevel = currentLevel + 1;
            
            if (nextLevel >= landImprovementLevels.length) {
                showNotification('åœŸåœ°å·²è¾¾åˆ°æœ€é«˜ç­‰çº§ï¼', 'info');
                return;
            }
            
            const nextLevelData = getLandImprovementData(nextLevel);
            if (gameState.money < nextLevelData.cost) {
                showNotification(`é‡‘å¸ä¸è¶³ï¼éœ€è¦ ${nextLevelData.cost} é‡‘å¸`, 'error');
                return;
            }
            
            gameState.money -= nextLevelData.cost;
            setLandImprovementLevel(plotIndex, nextLevel);
            
            showNotification(`åœŸåœ°æ”¹è‰¯æˆåŠŸï¼å‡çº§åˆ° ${nextLevelData.name}`, 'success');
            updateUI();
            renderFarm();
            saveGameData();
        }

        // è·å–æ°´æœå“è´¨æ•°æ®
        function getFruitQualityData(level) {
            return fruitQualities.find(q => q.level === level) || fruitQualities[0];
        }

        // æ ¹æ®åœŸåœ°ç­‰çº§ç¡®å®šæ°´æœå“è´¨
        function determineFruitQuality(plotIndex) {
            const landLevel = getLandImprovementLevel(plotIndex);
            const random = Math.random();
            
            if (landLevel === 0) {
                // æ™®é€šåœŸåœ°ï¼šåªèƒ½å‡ºæ™®é€šå“è´¨æ°´æœ
                return 0;
            } else if (landLevel === 1) {
                // è‚¥æ²ƒåœŸåœ°ï¼šèƒ½å‡ºæ™®é€šå’Œä¼˜è‰¯å“è´¨æ°´æœï¼ŒæŒ‰100%æ¦‚ç‡å¹³å‡åˆ†é…
                return random < 0.5 ? 0 : 1;
            } else if (landLevel === 2) {
                // ä¼˜è´¨åœŸåœ°ï¼šå¯ä»¥å‡ºæ™®é€šã€ä¼˜è‰¯ã€ç²¾å“æ°´æœï¼ŒæŒ‰100%æ¦‚ç‡å¹³å‡åˆ†é…
                if (random < 0.33) return 0;
                else if (random < 0.67) return 1;
                else return 2;
            } else if (landLevel === 3) {
                // å®Œç¾åœŸåœ°ï¼šä¸å‡ºæ™®é€šæ°´æœï¼Œå‡ºä¼˜è‰¯ã€ç²¾å“å’Œå®Œç¾æ°´æœï¼ŒæŒ‰100%æ¦‚ç‡å¹³å‡åˆ†é…
                if (random < 0.33) return 1;
                else if (random < 0.67) return 2;
                else return 3;
            }
            return 0;
        }

        // æ·»åŠ å“è´¨æ°´æœåˆ°åº“å­˜
        function addQualityFruitToInventory(seedId, quality, count = 1) {
            if (!gameState.qualityInventory[seedId]) {
                gameState.qualityInventory[seedId] = { 0: 0, 1: 0, 2: 0, 3: 0 };
            }
            gameState.qualityInventory[seedId][quality] = (gameState.qualityInventory[seedId][quality] || 0) + count;
        }

        // è·å–å“è´¨æ°´æœåº“å­˜æ•°é‡
        function getQualityFruitCount(seedId, quality) {
            if (!gameState.qualityInventory[seedId]) {
                return 0;
            }
            return gameState.qualityInventory[seedId][quality] || 0;
        }

        // ç§»é™¤å“è´¨æ°´æœåº“å­˜
        function removeQualityFruitFromInventory(seedId, quality, count = 1) {
            if (!gameState.qualityInventory[seedId] || !gameState.qualityInventory[seedId][quality]) {
                return false;
            }
            if (gameState.qualityInventory[seedId][quality] < count) {
                return false;
            }
            gameState.qualityInventory[seedId][quality] -= count;
            return true;
        }

        // å‡ºå”®å“è´¨æ°´æœ
        function sellQualityFruit(seedId, quality, qty = 1, pricePerUnit) {
            const availableCount = getQualityFruitCount(seedId, quality);
            if (availableCount <= 0) {
                showNotification('åº“å­˜ä¸è¶³ï¼', 'error');
                return;
            }
            
            qty = Math.max(1, Math.min(qty, availableCount));
            
            if (removeQualityFruitFromInventory(seedId, quality, qty)) {
                const totalPrice = pricePerUnit * qty;
                gameState.money += totalPrice;
                
                const seed = getSeedById(seedId);
                const qualityData = getFruitQualityData(quality);
                
                updateUI();
                renderInventory();
                showNotification(`å”®å‡º ${qualityData.name}${seed.name} Ã—${qty}! +${totalPrice}é‡‘å¸`, 'success');
                
                // æ›´æ–°ä»»åŠ¡è¿›åº¦
                updateTaskProgress('sell', totalPrice);
                
                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            } else {
                showNotification('å‡ºå”®å¤±è´¥ï¼', 'error');
            }
        }
    </script>
</body>
</html>
