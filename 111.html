<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>开心农场</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .crop-plot {
            transition: all 0.3s ease;
        }
        .crop-plot:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }
        .progress-bar {
            transition: width 0.5s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .notification {
            animation: slideIn 0.5s forwards, stay 2s 0.5s forwards, slideOut 0.5s 2.5s forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes stay {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        /* 添加保存指示器样式 */
        .save-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 100;
        }
        .save-indicator.show {
            opacity: 1;
        }
        /* 地区背景样式 */
        body.bg-north_china {
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            background-image: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-south_china {
            background: linear-gradient(135deg, #f9f6e7 0%, #f7e8aa 100%);
            background-image: url('https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-east_china {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            background-image: url('https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-west_china {
            background: linear-gradient(135deg, #fceabb 0%, #f8b500 100%);
            background-image: url('https://images.unsplash.com/photo-1502082553048-f009c37129b9?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-japan {
            background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
            background-image: url('https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-us_midwest {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            background-image: url('https://images.unsplash.com/photo-1465101178521-c1a9136a3b99?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-europe {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            background-image: url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        
        /* 天气效果样式 */
        .weather-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        /* 晴天效果 - 阳光照射 */
        .weather-sunny::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 0, 0.1) 0%, transparent 70%);
            animation: sunnyGlow 3s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes sunnyGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        
        /* 雨天效果 - 雨滴动画 */
        .weather-rainy::before {
            content: '🌧️';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2rem;
            animation: rainFall 1s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes rainFall {
            0% { transform: translateY(-100px); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
        }
        
        /* 暴雨效果 - 密集雨滴和闪电 */
        .weather-stormy::before {
            content: '⛈️';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2.5rem;
            animation: stormRain 0.8s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        .weather-stormy::after {
            content: '⚡';
            position: fixed;
            top: 20%;
            left: 30%;
            font-size: 4rem;
            animation: lightning 2s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes stormRain {
            0% { transform: translateY(-100px); opacity: 0; }
            5% { opacity: 1; }
            95% { opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
        }
        
        @keyframes lightning {
            0%, 90% { opacity: 0; }
            95% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* 干旱效果 - 热浪扭曲 */
        .weather-drought::before {
            content: '🔥';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2rem;
            animation: heatWave 2s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes heatWave {
            0%, 100% { 
                opacity: 0.3; 
                transform: scale(1) rotate(0deg); 
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.1) rotate(5deg); 
            }
        }
        
        /* 台风效果 - 旋转风 */
        .weather-typhoon::before {
            content: '🌀';
            position: fixed;
            top: 20%;
            left: 20%;
            font-size: 3rem;
            animation: typhoonSpin 1.5s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        .weather-typhoon::after {
            content: '💨';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 1.5rem;
            animation: windBlow 1s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes typhoonSpin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        @keyframes windBlow {
            0% { transform: translateX(-100px) translateY(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100vw) translateY(50px); opacity: 0; }
        }
        
        /* 彩虹天效果 - 彩虹色彩 */
        .weather-rainbow::before {
            content: '🌈';
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 4rem;
            animation: rainbowGlow 3s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes rainbowGlow {
            0%, 100% { 
                opacity: 0.6; 
                transform: translateX(-50%) scale(1); 
            }
            50% { 
                opacity: 1; 
                transform: translateX(-50%) scale(1.1); 
            }
        }
        
        /* 沙尘暴效果 - 沙尘飞舞 */
        .weather-sandstorm::before {
            content: '🌪️';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2rem;
            animation: sandstormSwirl 2s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes sandstormSwirl {
            0% { 
                transform: translateX(-50px) translateY(0) rotate(0deg); 
                opacity: 0.3; 
            }
            50% { 
                transform: translateX(50px) translateY(50px) rotate(180deg); 
                opacity: 0.7; 
            }
            100% { 
                transform: translateX(-50px) translateY(100px) rotate(360deg); 
                opacity: 0.3; 
            }
        }
        /* 卡片和按钮美化 */
        .card-strong {
            background: rgba(255,255,255,0.92);
            border-radius: 1.25rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
            border: 1.5px solid rgba(255,255,255,0.18);
            transition: box-shadow 0.3s, transform 0.2s;
        }
        .card-strong:hover {
            box-shadow: 0 16px 48px 0 rgba(31, 38, 135, 0.25);
            transform: translateY(-2px) scale(1.01);
        }
        .btn-strong {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            color: #fff;
            font-weight: bold;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px 0 rgba(67,233,123,0.15);
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
        }
        .btn-strong:hover {
            background: linear-gradient(90deg, #38f9d7 0%, #43e97b 100%);
            box-shadow: 0 4px 16px 0 rgba(67,233,123,0.25);
            transform: scale(1.05);
        }

        /* 商店标签按钮样式 */
        .shop-tab-btn {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            color: #374151;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }

        .shop-tab-btn:hover {
            background: linear-gradient(135deg, #d1d5db, #9ca3af);
            transform: translateY(-1px);
        }

        .shop-tab-btn.active {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* 商店内容区域样式 */
        .shop-content {
            transition: all 0.3s ease;
        }

        .shop-content.active {
            display: block !important;
        }
        .title-strong {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 2px;
            color: #1a4d2e;
            text-shadow: 0 2px 8px rgba(67,233,123,0.15);
        }
        .subtitle-strong {
            font-size: 1.25rem;
            font-weight: 700;
            color: #388e3c;
        }
        /* 登录弹窗美化 */
        #login-modal input[type="text"], #login-modal input[type="password"] {
            font-size: 1.1rem;
            border-radius: 1rem;
            border: 1.5px solid #b2dfdb;
            box-shadow: 0 2px 8px 0 rgba(67,233,123,0.08);
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            transition: border 0.2s, box-shadow 0.2s;
        }
        #login-modal input[type="text"]:focus, #login-modal input[type="password"]:focus {
            border: 2px solid #43e97b;
            box-shadow: 0 4px 16px 0 rgba(67,233,123,0.15);
        }
        #login-modal .register-btn {
            border-radius: 50%;
            font-size: 0.95rem;
            font-weight: bold;
            box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.10);
            transition: box-shadow 0.2s, transform 0.15s, background 0.2s;
            padding: 0;
            margin-bottom: 0;
            min-width: 0;
            flex: 1 1 0;
            margin-right: 0;
            width: 48px;
            height: 48px;
            justify-content: center;
            align-items: center;
            display: flex;
        }
        #login-modal .register-btn:not(:last-child) {
            margin-right: 0.5rem;
        }
        #login-modal .register-btn i {
            font-size: 1.5rem;
            margin: 0;
        }
        #login-modal .register-btn:hover {
            box-shadow: 0 8px 24px 0 rgba(67,233,123,0.18);
            transform: translateY(-2px) scale(1.08);
            filter: brightness(1.05);
        }
        #login-modal .w-full.flex.flex-row.items-center.justify-between.gap-2.mt-2 {
            gap: 0.7rem;
        }
        #login-modal .w-full.flex.items-center.my-4 {
            margin: 1.2rem 0 1.1rem 0;
        }
        #login-modal hr {
            margin: 1.2rem 0 1.1rem 0;
        }
        #login-modal input::placeholder {
            color: #bdbdbd;
            font-size: 1rem;
        }
        #login-btn {
            border-radius: 1.2rem;
            font-size: 1.1rem;
            font-weight: bold;
            box-shadow: 0 2px 8px 0 rgba(67,233,123,0.10);
            transition: box-shadow 0.2s, background 0.2s, transform 0.1s;
        }
        #login-btn:hover {
            background: #43e97b;
            box-shadow: 0 8px 24px 0 rgba(67,233,123,0.18);
            transform: scale(1.04);
        }
        /* 退出登录按钮样式加强 */
        #logout-btn {
            border-radius: 1.5rem;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.10);
            transition: box-shadow 0.2s, background 0.2s, transform 0.1s;
        }
        #logout-btn:hover {
            background: #e0f2f1;
            box-shadow: 0 8px 24px 0 rgba(67,233,123,0.18);
            transform: scale(1.04);
        }
        
        /* 随机事件动画样式 */
        .event-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 1000;
            animation: eventPopup 3s ease-in-out forwards;
            text-align: center;
            min-width: 300px;
        }
        
        @keyframes eventPopup {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        
        /* 金雨动画 */
        .rainbow-rain {
            position: relative;
            overflow: hidden;
        }
        .rainbow-rain::before {
            content: '🌧️';
            position: absolute;
            top: -20px;
            left: 0;
            width: 100%;
            height: 100%;
            animation: goldenRain 2s linear infinite;
            font-size: 2rem;
            color: #ffd700;
        }
        
        @keyframes goldenRain {
            0% { transform: translateY(-100px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }
        
        /* 精灵闪烁动画 */
        .fairy-sparkle {
            animation: fairySparkle 1.5s ease-in-out;
        }
        
        @keyframes fairySparkle {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.2); filter: brightness(1.5) hue-rotate(60deg); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        
        /* 营养发光动画 */
        .nutrient-glow {
            animation: nutrientGlow 2s ease-in-out infinite;
        }
        
        @keyframes nutrientGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(0, 255, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.8); }
        }
        
        /* 时钟旋转动画 */
        .clock-spin {
            animation: clockSpin 1s linear infinite;
        }
        
        @keyframes clockSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* 虫害爬行动画 */
        .pest-crawl {
            animation: pestCrawl 1s ease-in-out;
        }
        
        .pest-crawl::after {
            content: '🐛';
            position: absolute;
            top: 0;
            left: 0;
            animation: bugCrawl 2s linear infinite;
        }
        
        @keyframes pestCrawl {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(0.9); filter: brightness(0.7); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        
        @keyframes bugCrawl {
            0% { transform: translateX(-20px) translateY(0); }
            25% { transform: translateX(0) translateY(-5px); }
            50% { transform: translateX(20px) translateY(0); }
            75% { transform: translateX(0) translateY(5px); }
            100% { transform: translateX(-20px) translateY(0); }
        }
        
        /* 病害扩散动画 */
        .disease-spread {
            animation: diseaseSpread 2s ease-in-out;
        }
        
        @keyframes diseaseSpread {
            0% { filter: brightness(1) saturate(1); }
            50% { filter: brightness(0.8) saturate(0.5) hue-rotate(180deg); }
            100% { filter: brightness(1) saturate(1); }
        }
        
        /* 霜冻冻结动画 */
        .frost-freeze {
            animation: frostFreeze 1.5s ease-in-out;
        }
        
        .frost-freeze::after {
            content: '❄️';
            position: absolute;
            top: 0;
            left: 0;
            animation: frostFall 2s linear infinite;
        }
        
        @keyframes frostFreeze {
            0% { filter: brightness(1) saturate(1); }
            100% { filter: brightness(0.7) saturate(0.3) hue-rotate(180deg); }
        }
        
        @keyframes frostFall {
            0% { transform: translateY(-10px) rotate(0deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(10px) rotate(180deg); opacity: 0; }
        }
        
        /* 杂草生长动画 */
        .weed-grow {
            animation: weedGrow 2s ease-in-out;
        }
        
        .weed-grow::after {
            content: '🌿';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            animation: weedSprout 1.5s ease-out;
        }
        
        @keyframes weedGrow {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        
        @keyframes weedSprout {
            0% { transform: translateX(-50%) scale(0); opacity: 0; }
            50% { transform: translateX(-50%) scale(1.2); opacity: 1; }
            100% { transform: translateX(-50%) scale(1); opacity: 0.8; }
        }
        
        /* 迷雾旋转动画 */
        .fog-swirl {
            animation: fogSwirl 3s ease-in-out infinite;
        }
        
        @keyframes fogSwirl {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        /* 土壤变化动画 */
        .soil-shift {
            animation: soilShift 2s ease-in-out;
        }
        
        @keyframes soilShift {
            0% { filter: brightness(1) saturate(1); }
            50% { filter: brightness(1.2) saturate(1.3) hue-rotate(30deg); }
            100% { filter: brightness(1) saturate(1); }
        }
        
        /* 事件影响指示器 */
        .event-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            animation: eventIndicator 2s ease-in-out infinite;
            z-index: 10;
        }
        
        @keyframes eventIndicator {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        @keyframes lightning {
            0%, 90% { opacity: 0; }
            95% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* 动物区域视图样式 */
        .animal-area-view {
            display: none;
            transition: all 0.3s ease;
        }
        
        .animal-area-view.active {
            display: block;
        }
        
        /* 动物区域按钮样式 */
        .animal-area-btn {
            transition: all 0.3s ease;
        }
        
        .animal-area-btn.active {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* 牧场动物动画效果 */
        .ranch-animal {
            position: relative;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ranch-animal:hover {
            transform: scale(1.2);
            filter: brightness(1.2);
        }
        
        /* 动物移动动画 */
        .animal-walk {
            animation: walkAround 8s linear infinite;
        }
        
        @keyframes walkAround {
            0% { transform: translateX(0px) translateY(0px); }
            25% { transform: translateX(20px) translateY(-10px); }
            50% { transform: translateX(-15px) translateY(5px); }
            75% { transform: translateX(10px) translateY(-5px); }
            100% { transform: translateX(0px) translateY(0px); }
        }
        
        /* 动物跳跃动画 */
        .animal-bounce {
            animation: bounceUp 2s ease-in-out infinite;
        }
        
        @keyframes bounceUp {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        /* 动物摇摆动画 */
        .animal-sway {
            animation: sway 3s ease-in-out infinite;
        }
        
        @keyframes sway {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
        }
        
        /* 动物呼吸动画 */
        .animal-breathe {
            animation: breathe 4s ease-in-out infinite;
        }
        
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* 动物眨眼动画 */
        .animal-blink {
            animation: blink 5s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 90%, 100% { opacity: 1; }
            95% { opacity: 0.3; }
        }
        
        /* 牧场环境动画 */
        .ranch-environment {
            position: relative;
            overflow: hidden;
        }
        
        /* 草地摇摆效果 */
        .grass-sway {
            animation: grassWave 6s ease-in-out infinite;
        }
        
        @keyframes grassWave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(1deg); }
            75% { transform: rotate(-1deg); }
        }
        
        /* 云朵飘动效果 */
        .cloud-float {
            animation: cloudMove 20s linear infinite;
        }
        
        @keyframes cloudMove {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(100px); }
        }
        
        /* 动物健康状态动画 */
        .animal-healthy {
            animation: healthyGlow 3s ease-in-out infinite;
        }
        
        @keyframes healthyGlow {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 5px rgba(0, 255, 0, 0.3)); }
            50% { filter: brightness(1.1) drop-shadow(0 0 10px rgba(0, 255, 0, 0.5)); }
        }
        
        .animal-sick {
            animation: sickShake 2s ease-in-out infinite;
        }
        
        @keyframes sickShake {
            0%, 100% { transform: translateX(0px); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        
        /* 牧场大气效果 */
        .ranch-atmosphere {
            position: relative;
        }
        
        .ranch-atmosphere::before {
            content: '🌾';
            position: absolute;
            top: 10%;
            left: 10%;
            font-size: 1.5rem;
            animation: grassWave 4s ease-in-out infinite;
            opacity: 0.6;
        }
        
        .ranch-atmosphere::after {
            content: '☁️';
            position: absolute;
            top: 5%;
            right: 20%;
            font-size: 2rem;
            animation: cloudMove 15s linear infinite;
            opacity: 0.7;
        }
        
        /* 天气效果增强 */
        .sunny-effect {
            background: radial-gradient(circle at 80% 20%, rgba(255, 255, 0, 0.1) 0%, transparent 50%);
            animation: sunnyShine 4s ease-in-out infinite;
        }
        
        @keyframes sunnyShine {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        .cloudy-effect {
            background: linear-gradient(135deg, rgba(200, 200, 200, 0.2) 0%, rgba(150, 150, 150, 0.1) 100%);
        }
        
        .rainy-effect {
            background: linear-gradient(135deg, rgba(0, 100, 200, 0.1) 0%, rgba(0, 50, 150, 0.05) 100%);
            animation: rainEffect 1s linear infinite;
        }
        
        .rainy-effect::before {
            content: '💧';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 1rem;
            animation: rainDrop 2s linear infinite;
            opacity: 0.6;
        }
        
        @keyframes rainDrop {
            0% { transform: translateY(-20px); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(100px); opacity: 0; }
        }
        
        .snowy-effect {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(200, 200, 255, 0.1) 100%);
        }
        
        .snowy-effect::before {
            content: '❄️';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 1.5rem;
            animation: snowFall 3s linear infinite;
            opacity: 0.8;
        }
        
        @keyframes snowFall {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(100px) rotate(360deg); opacity: 0; }
        }
        
        /* 牧场互动效果 */
        .ranch-animal:hover::after {
            content: '💕';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 1rem;
            animation: loveFloat 1s ease-out forwards;
        }
        
        @keyframes loveFloat {
            0% { transform: translateY(0px); opacity: 1; }
            100% { transform: translateY(-20px); opacity: 0; }
        }
        
        /* 动物健康状态指示器 */
        .health-indicator {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            border-radius: 2px;
            background: #ddd;
        }
        
        .health-indicator::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .health-high::after {
            background: #10b981;
        }
        
        .health-medium::after {
            background: #f59e0b;
        }
        
        .health-low::after {
            background: #ef4444;
        }
        
        @keyframes snowFall {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(100px) rotate(360deg); opacity: 0; }
        }
        
        /* 干旱效果 */
        .drought-effect {
            background: linear-gradient(135deg, rgba(255, 100, 0, 0.2) 0%, rgba(255, 150, 0, 0.1) 100%);
            animation: heatWave 3s ease-in-out infinite;
        }
        
        @keyframes heatWave {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(10deg); }
        }
        
        /* 台风效果 */
        .typhoon-effect {
            background: linear-gradient(135deg, rgba(50, 50, 100, 0.3) 0%, rgba(100, 100, 150, 0.2) 100%);
            animation: typhoonSpin 2s linear infinite;
        }
        
        .typhoon-effect::before {
            content: '🌪️';
            position: absolute;
            top: 20%;
            left: 30%;
            font-size: 3rem;
            animation: typhoonMove 4s linear infinite;
            opacity: 0.7;
        }
        
        @keyframes typhoonSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes typhoonMove {
            0% { transform: translateX(0px) rotate(0deg); }
            25% { transform: translateX(50px) rotate(90deg); }
            50% { transform: translateX(0px) rotate(180deg); }
            75% { transform: translateX(-50px) rotate(270deg); }
            100% { transform: translateX(0px) rotate(360deg); }
        }
        
        /* 彩虹天效果 */
        .rainbow-effect {
            background: linear-gradient(135deg, 
                rgba(255, 0, 0, 0.1) 0%, 
                rgba(255, 165, 0, 0.1) 16.66%, 
                rgba(255, 255, 0, 0.1) 33.33%, 
                rgba(0, 255, 0, 0.1) 50%, 
                rgba(0, 0, 255, 0.1) 66.66%, 
                rgba(75, 0, 130, 0.1) 83.33%, 
                rgba(238, 130, 238, 0.1) 100%);
            animation: rainbowShimmer 4s ease-in-out infinite;
        }
        
        @keyframes rainbowShimmer {
            0%, 100% { opacity: 0.8; filter: brightness(1); }
            50% { opacity: 1; filter: brightness(1.2); }
        }
        
        /* 沙尘暴效果 */
        .sandstorm-effect {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.3) 0%, rgba(160, 82, 45, 0.2) 100%);
            animation: sandstormBlow 2s ease-in-out infinite;
        }
        
        .sandstorm-effect::before {
            content: '🌪️';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2rem;
            animation: sandSwirl 3s linear infinite;
            opacity: 0.6;
            color: #8B4513;
        }
        
        @keyframes sandstormBlow {
            0%, 100% { filter: blur(0px); }
            50% { filter: blur(1px); }
        }
        
        @keyframes sandSwirl {
            0% { transform: translateX(-20px) rotate(0deg); }
            25% { transform: translateX(20px) rotate(90deg); }
            50% { transform: translateX(-10px) rotate(180deg); }
            75% { transform: translateX(10px) rotate(270deg); }
            100% { transform: translateX(-20px) rotate(360deg); }
        }
        
        /* 暴雨效果增强 */
        .stormy-effect {
            background: linear-gradient(135deg, rgba(25, 25, 112, 0.3) 0%, rgba(0, 0, 139, 0.2) 100%);
            animation: stormyWeather 1s ease-in-out infinite;
        }
        
        .stormy-effect::before {
            content: '⚡';
            position: absolute;
            top: 10%;
            right: 20%;
            font-size: 4rem;
            animation: lightning 2s ease-in-out infinite;
            opacity: 0;
        }
        
        @keyframes stormyWeather {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(0.7); }
        }
        
        /* 成就系统弹窗样式 */
        #achievement-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 90vw;
            max-height: 90vh;
            width: 500px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        #achievement-modal.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }
        
        #achievement-overlay.show {
            display: block;
        }
        
        /* 成就按钮悬停效果 */
        #achievement-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* 成就项目样式 */
        .achievement-item {
            transition: all 0.3s ease;
        }
        
        .achievement-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .achievement-item.completed {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
        }
        
        .achievement-item.completed .achievement-icon {
            animation: achievementGlow 2s ease-in-out infinite;
        }
        
        @keyframes achievementGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2) drop-shadow(0 0 10px rgba(16, 185, 129, 0.5)); }
        }
    </style>
</head>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>开心农场</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .crop-plot {
            transition: all 0.3s ease;
        }
        .crop-plot:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }
        .progress-bar {
            transition: width 0.5s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .notification {
            animation: slideIn 0.5s forwards, stay 2s 0.5s forwards, slideOut 0.5s 2.5s forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes stay {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        /* 添加保存指示器样式 */
        .save-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 100;
        }
        .save-indicator.show {
            opacity: 1;
        }
        /* 地区背景样式 */
        body.bg-north_china {
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            background-image: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-south_china {
            background: linear-gradient(135deg, #f9f6e7 0%, #f7e8aa 100%);
            background-image: url('https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-east_china {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            background-image: url('https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-west_china {
            background: linear-gradient(135deg, #fceabb 0%, #f8b500 100%);
            background-image: url('https://images.unsplash.com/photo-1502082553048-f009c37129b9?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-japan {
            background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
            background-image: url('https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-us_midwest {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            background-image: url('https://images.unsplash.com/photo-1465101178521-c1a9136a3b99?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-europe {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            background-image: url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        
        /* 天气效果样式 */
        .weather-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        /* 晴天效果 - 阳光照射 */
        .weather-sunny::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 0, 0.1) 0%, transparent 70%);
            animation: sunnyGlow 3s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes sunnyGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        
        /* 雨天效果 - 雨滴动画 */
        .weather-rainy::before {
            content: '🌧️';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2rem;
            animation: rainFall 1s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes rainFall {
            0% { transform: translateY(-100px); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
        }
        
        /* 暴雨效果 - 密集雨滴和闪电 */
        .weather-stormy::before {
            content: '⛈️';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2.5rem;
            animation: stormRain 0.8s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        .weather-stormy::after {
            content: '⚡';
            position: fixed;
            top: 20%;
            left: 30%;
            font-size: 4rem;
            animation: lightning 2s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes stormRain {
            0% { transform: translateY(-100px); opacity: 0; }
            5% { opacity: 1; }
            95% { opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
        }
        
        @keyframes lightning {
            0%, 90% { opacity: 0; }
            95% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* 干旱效果 - 热浪扭曲 */
        .weather-drought::before {
            content: '🔥';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2rem;
            animation: heatWave 2s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes heatWave {
            0%, 100% { 
                opacity: 0.3; 
                transform: scale(1) rotate(0deg); 
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.1) rotate(5deg); 
            }
        }
        
        /* 台风效果 - 旋转风 */
        .weather-typhoon::before {
            content: '🌀';
            position: fixed;
            top: 20%;
            left: 20%;
            font-size: 3rem;
            animation: typhoonSpin 1.5s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        .weather-typhoon::after {
            content: '💨';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 1.5rem;
            animation: windBlow 1s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes typhoonSpin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        @keyframes windBlow {
            0% { transform: translateX(-100px) translateY(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100vw) translateY(50px); opacity: 0; }
        }
        
        /* 彩虹天效果 - 彩虹色彩 */
        .weather-rainbow::before {
            content: '🌈';
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 4rem;
            animation: rainbowGlow 3s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes rainbowGlow {
            0%, 100% { 
                opacity: 0.6; 
                transform: translateX(-50%) scale(1); 
            }
            50% { 
                opacity: 1; 
                transform: translateX(-50%) scale(1.1); 
            }
        }
        
        /* 沙尘暴效果 - 沙尘飞舞 */
        .weather-sandstorm::before {
            content: '🌪️';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2rem;
            animation: sandstormSwirl 2s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        @keyframes sandstormSwirl {
            0% { 
                transform: translateX(-50px) translateY(0) rotate(0deg); 
                opacity: 0.3; 
            }
            50% { 
                transform: translateX(50px) translateY(50px) rotate(180deg); 
                opacity: 0.7; 
            }
            100% { 
                transform: translateX(-50px) translateY(100px) rotate(360deg); 
                opacity: 0.3; 
            }
        }
        /* 卡片和按钮美化 */
        .card-strong {
            background: rgba(255,255,255,0.92);
            border-radius: 1.25rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
            border: 1.5px solid rgba(255,255,255,0.18);
            transition: box-shadow 0.3s, transform 0.2s;
        }
        .card-strong:hover {
            box-shadow: 0 16px 48px 0 rgba(31, 38, 135, 0.25);
            transform: translateY(-2px) scale(1.01);
        }
        .btn-strong {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            color: #fff;
            font-weight: bold;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px 0 rgba(67,233,123,0.15);
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
        }
        .btn-strong:hover {
            background: linear-gradient(90deg, #38f9d7 0%, #43e97b 100%);
            box-shadow: 0 4px 16px 0 rgba(67,233,123,0.25);
            transform: scale(1.05);
        }

        /* 商店标签按钮样式 */
        .shop-tab-btn {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            color: #374151;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }

        .shop-tab-btn:hover {
            background: linear-gradient(135deg, #d1d5db, #9ca3af);
            transform: translateY(-1px);
        }

        .shop-tab-btn.active {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* 商店内容区域样式 */
        .shop-content {
            transition: all 0.3s ease;
        }

        .shop-content.active {
            display: block !important;
        }
        .title-strong {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 2px;
            color: #1a4d2e;
            text-shadow: 0 2px 8px rgba(67,233,123,0.15);
        }
        .subtitle-strong {
            font-size: 1.25rem;
            font-weight: 700;
            color: #388e3c;
        }
        /* 登录弹窗美化 */
        #login-modal input[type="text"], #login-modal input[type="password"] {
            font-size: 1.1rem;
            border-radius: 1rem;
            border: 1.5px solid #b2dfdb;
            box-shadow: 0 2px 8px 0 rgba(67,233,123,0.08);
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            transition: border 0.2s, box-shadow 0.2s;
        }
        #login-modal input[type="text"]:focus, #login-modal input[type="password"]:focus {
            border: 2px solid #43e97b;
            box-shadow: 0 4px 16px 0 rgba(67,233,123,0.15);
        }
        #login-modal .register-btn {
            border-radius: 50%;
            font-size: 0.95rem;
            font-weight: bold;
            box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.10);
            transition: box-shadow 0.2s, transform 0.15s, background 0.2s;
            padding: 0;
            margin-bottom: 0;
            min-width: 0;
            flex: 1 1 0;
            margin-right: 0;
            width: 48px;
            height: 48px;
            justify-content: center;
            align-items: center;
            display: flex;
        }
        #login-modal .register-btn:not(:last-child) {
            margin-right: 0.5rem;
        }
        #login-modal .register-btn i {
            font-size: 1.5rem;
            margin: 0;
        }
        #login-modal .register-btn:hover {
            box-shadow: 0 8px 24px 0 rgba(67,233,123,0.18);
            transform: translateY(-2px) scale(1.08);
            filter: brightness(1.05);
        }
        #login-modal .w-full.flex.flex-row.items-center.justify-between.gap-2.mt-2 {
            gap: 0.7rem;
        }
        #login-modal .w-full.flex.items-center.my-4 {
            margin: 1.2rem 0 1.1rem 0;
        }
        #login-modal hr {
            margin: 1.2rem 0 1.1rem 0;
        }
        #login-modal input::placeholder {
            color: #bdbdbd;
            font-size: 1rem;
        }
        #login-btn {
            border-radius: 1.2rem;
            font-size: 1.1rem;
            font-weight: bold;
            box-shadow: 0 2px 8px 0 rgba(67,233,123,0.10);
            transition: box-shadow 0.2s, background 0.2s, transform 0.1s;
        }
        #login-btn:hover {
            background: #43e97b;
            box-shadow: 0 8px 24px 0 rgba(67,233,123,0.18);
            transform: scale(1.04);
        }
        /* 退出登录按钮样式加强 */
        #logout-btn {
            border-radius: 1.5rem;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.10);
            transition: box-shadow 0.2s, background 0.2s, transform 0.1s;
        }
        #logout-btn:hover {
            background: #e0f2f1;
            box-shadow: 0 8px 24px 0 rgba(67,233,123,0.18);
            transform: scale(1.04);
        }
        
        /* 随机事件动画样式 */
        .event-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 1000;
            animation: eventPopup 3s ease-in-out forwards;
            text-align: center;
            min-width: 300px;
        }
        
        @keyframes eventPopup {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        
        /* 金雨动画 */
        .rainbow-rain {
            position: relative;
            overflow: hidden;
        }
        .rainbow-rain::before {
            content: '🌧️';
            position: absolute;
            top: -20px;
            left: 0;
            width: 100%;
            height: 100%;
            animation: goldenRain 2s linear infinite;
            font-size: 2rem;
            color: #ffd700;
        }
        
        @keyframes goldenRain {
            0% { transform: translateY(-100px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }
        
        /* 精灵闪烁动画 */
        .fairy-sparkle {
            animation: fairySparkle 1.5s ease-in-out;
        }
        
        @keyframes fairySparkle {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.2); filter: brightness(1.5) hue-rotate(60deg); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        
        /* 营养发光动画 */
        .nutrient-glow {
            animation: nutrientGlow 2s ease-in-out infinite;
        }
        
        @keyframes nutrientGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(0, 255, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.8); }
        }
        
        /* 时钟旋转动画 */
        .clock-spin {
            animation: clockSpin 1s linear infinite;
        }
        
        @keyframes clockSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* 虫害爬行动画 */
        .pest-crawl {
            animation: pestCrawl 1s ease-in-out;
        }
        
        .pest-crawl::after {
            content: '🐛';
            position: absolute;
            top: 0;
            left: 0;
            animation: bugCrawl 2s linear infinite;
        }
        
        @keyframes pestCrawl {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(0.9); filter: brightness(0.7); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        
        @keyframes bugCrawl {
            0% { transform: translateX(-20px) translateY(0); }
            25% { transform: translateX(0) translateY(-5px); }
            50% { transform: translateX(20px) translateY(0); }
            75% { transform: translateX(0) translateY(5px); }
            100% { transform: translateX(-20px) translateY(0); }
        }
        
        /* 病害扩散动画 */
        .disease-spread {
            animation: diseaseSpread 2s ease-in-out;
        }
        
        @keyframes diseaseSpread {
            0% { filter: brightness(1) saturate(1); }
            50% { filter: brightness(0.8) saturate(0.5) hue-rotate(180deg); }
            100% { filter: brightness(1) saturate(1); }
        }
        
        /* 霜冻冻结动画 */
        .frost-freeze {
            animation: frostFreeze 1.5s ease-in-out;
        }
        
        .frost-freeze::after {
            content: '❄️';
            position: absolute;
            top: 0;
            left: 0;
            animation: frostFall 2s linear infinite;
        }
        
        @keyframes frostFreeze {
            0% { filter: brightness(1) saturate(1); }
            100% { filter: brightness(0.7) saturate(0.3) hue-rotate(180deg); }
        }
        
        @keyframes frostFall {
            0% { transform: translateY(-10px) rotate(0deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(10px) rotate(180deg); opacity: 0; }
        }
        
        /* 杂草生长动画 */
        .weed-grow {
            animation: weedGrow 2s ease-in-out;
        }
        
        .weed-grow::after {
            content: '🌿';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            animation: weedSprout 1.5s ease-out;
        }
        
        @keyframes weedGrow {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        
        @keyframes weedSprout {
            0% { transform: translateX(-50%) scale(0); opacity: 0; }
            50% { transform: translateX(-50%) scale(1.2); opacity: 1; }
            100% { transform: translateX(-50%) scale(1); opacity: 0.8; }
        }
        
        /* 迷雾旋转动画 */
        .fog-swirl {
            animation: fogSwirl 3s ease-in-out infinite;
        }
        
        @keyframes fogSwirl {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        /* 土壤变化动画 */
        .soil-shift {
            animation: soilShift 2s ease-in-out;
        }
        
        @keyframes soilShift {
            0% { filter: brightness(1) saturate(1); }
            50% { filter: brightness(1.2) saturate(1.3) hue-rotate(30deg); }
            100% { filter: brightness(1) saturate(1); }
        }
        
        /* 事件影响指示器 */
        .event-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            animation: eventIndicator 2s ease-in-out infinite;
            z-index: 10;
        }
        
        @keyframes eventIndicator {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        @keyframes lightning {
            0%, 90% { opacity: 0; }
            95% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* 动物区域视图样式 */
        .animal-area-view {
            display: none;
            transition: all 0.3s ease;
        }
        
        .animal-area-view.active {
            display: block;
        }
        
        /* 动物区域按钮样式 */
        .animal-area-btn {
            transition: all 0.3s ease;
        }
        
        .animal-area-btn.active {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* 牧场动物动画效果 */
        .ranch-animal {
            position: relative;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ranch-animal:hover {
            transform: scale(1.2);
            filter: brightness(1.2);
        }
        
        /* 动物移动动画 */
        .animal-walk {
            animation: walkAround 8s linear infinite;
        }
        
        @keyframes walkAround {
            0% { transform: translateX(0px) translateY(0px); }
            25% { transform: translateX(20px) translateY(-10px); }
            50% { transform: translateX(-15px) translateY(5px); }
            75% { transform: translateX(10px) translateY(-5px); }
            100% { transform: translateX(0px) translateY(0px); }
        }
        
        /* 动物跳跃动画 */
        .animal-bounce {
            animation: bounceUp 2s ease-in-out infinite;
        }
        
        @keyframes bounceUp {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        /* 动物摇摆动画 */
        .animal-sway {
            animation: sway 3s ease-in-out infinite;
        }
        
        @keyframes sway {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
        }
        
        /* 动物呼吸动画 */
        .animal-breathe {
            animation: breathe 4s ease-in-out infinite;
        }
        
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* 动物眨眼动画 */
        .animal-blink {
            animation: blink 5s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 90%, 100% { opacity: 1; }
            95% { opacity: 0.3; }
        }
        
        /* 牧场环境动画 */
        .ranch-environment {
            position: relative;
            overflow: hidden;
        }
        
        /* 草地摇摆效果 */
        .grass-sway {
            animation: grassWave 6s ease-in-out infinite;
        }
        
        @keyframes grassWave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(1deg); }
            75% { transform: rotate(-1deg); }
        }
        
        /* 云朵飘动效果 */
        .cloud-float {
            animation: cloudMove 20s linear infinite;
        }
        
        @keyframes cloudMove {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(100px); }
        }
        
        /* 动物健康状态动画 */
        .animal-healthy {
            animation: healthyGlow 3s ease-in-out infinite;
        }
        
        @keyframes healthyGlow {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 5px rgba(0, 255, 0, 0.3)); }
            50% { filter: brightness(1.1) drop-shadow(0 0 10px rgba(0, 255, 0, 0.5)); }
        }
        
        .animal-sick {
            animation: sickShake 2s ease-in-out infinite;
        }
        
        @keyframes sickShake {
            0%, 100% { transform: translateX(0px); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        
        /* 牧场大气效果 */
        .ranch-atmosphere {
            position: relative;
        }
        
        .ranch-atmosphere::before {
            content: '🌾';
            position: absolute;
            top: 10%;
            left: 10%;
            font-size: 1.5rem;
            animation: grassWave 4s ease-in-out infinite;
            opacity: 0.6;
        }
        
        .ranch-atmosphere::after {
            content: '☁️';
            position: absolute;
            top: 5%;
            right: 20%;
            font-size: 2rem;
            animation: cloudMove 15s linear infinite;
            opacity: 0.7;
        }
        
        /* 天气效果增强 */
        .sunny-effect {
            background: radial-gradient(circle at 80% 20%, rgba(255, 255, 0, 0.1) 0%, transparent 50%);
            animation: sunnyShine 4s ease-in-out infinite;
        }
        
        @keyframes sunnyShine {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        .cloudy-effect {
            background: linear-gradient(135deg, rgba(200, 200, 200, 0.2) 0%, rgba(150, 150, 150, 0.1) 100%);
        }
        
        .rainy-effect {
            background: linear-gradient(135deg, rgba(0, 100, 200, 0.1) 0%, rgba(0, 50, 150, 0.05) 100%);
            animation: rainEffect 1s linear infinite;
        }
        
        .rainy-effect::before {
            content: '💧';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 1rem;
            animation: rainDrop 2s linear infinite;
            opacity: 0.6;
        }
        
        @keyframes rainDrop {
            0% { transform: translateY(-20px); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(100px); opacity: 0; }
        }
        
        .snowy-effect {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(200, 200, 255, 0.1) 100%);
        }
        
        .snowy-effect::before {
            content: '❄️';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 1.5rem;
            animation: snowFall 3s linear infinite;
            opacity: 0.8;
        }
        
        @keyframes snowFall {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(100px) rotate(360deg); opacity: 0; }
        }
        
        /* 牧场互动效果 */
        .ranch-animal:hover::after {
            content: '💕';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 1rem;
            animation: loveFloat 1s ease-out forwards;
        }
        
        @keyframes loveFloat {
            0% { transform: translateY(0px); opacity: 1; }
            100% { transform: translateY(-20px); opacity: 0; }
        }
        
        /* 动物健康状态指示器 */
        .health-indicator {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            border-radius: 2px;
            background: #ddd;
        }
        
        .health-indicator::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .health-high::after {
            background: #10b981;
        }
        
        .health-medium::after {
            background: #f59e0b;
        }
        
        .health-low::after {
            background: #ef4444;
        }
        
        @keyframes snowFall {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(100px) rotate(360deg); opacity: 0; }
        }
        
        /* 干旱效果 */
        .drought-effect {
            background: linear-gradient(135deg, rgba(255, 100, 0, 0.2) 0%, rgba(255, 150, 0, 0.1) 100%);
            animation: heatWave 3s ease-in-out infinite;
        }
        
        @keyframes heatWave {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(10deg); }
        }
        
        /* 台风效果 */
        .typhoon-effect {
            background: linear-gradient(135deg, rgba(50, 50, 100, 0.3) 0%, rgba(100, 100, 150, 0.2) 100%);
            animation: typhoonSpin 2s linear infinite;
        }
        
        .typhoon-effect::before {
            content: '🌪️';
            position: absolute;
            top: 20%;
            left: 30%;
            font-size: 3rem;
            animation: typhoonMove 4s linear infinite;
            opacity: 0.7;
        }
        
        @keyframes typhoonSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes typhoonMove {
            0% { transform: translateX(0px) rotate(0deg); }
            25% { transform: translateX(50px) rotate(90deg); }
            50% { transform: translateX(0px) rotate(180deg); }
            75% { transform: translateX(-50px) rotate(270deg); }
            100% { transform: translateX(0px) rotate(360deg); }
        }
        
        /* 彩虹天效果 */
        .rainbow-effect {
            background: linear-gradient(135deg, 
                rgba(255, 0, 0, 0.1) 0%, 
                rgba(255, 165, 0, 0.1) 16.66%, 
                rgba(255, 255, 0, 0.1) 33.33%, 
                rgba(0, 255, 0, 0.1) 50%, 
                rgba(0, 0, 255, 0.1) 66.66%, 
                rgba(75, 0, 130, 0.1) 83.33%, 
                rgba(238, 130, 238, 0.1) 100%);
            animation: rainbowShimmer 4s ease-in-out infinite;
        }
        
        @keyframes rainbowShimmer {
            0%, 100% { opacity: 0.8; filter: brightness(1); }
            50% { opacity: 1; filter: brightness(1.2); }
        }
        
        /* 沙尘暴效果 */
        .sandstorm-effect {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.3) 0%, rgba(160, 82, 45, 0.2) 100%);
            animation: sandstormBlow 2s ease-in-out infinite;
        }
        
        .sandstorm-effect::before {
            content: '🌪️';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2rem;
            animation: sandSwirl 3s linear infinite;
            opacity: 0.6;
            color: #8B4513;
        }
        
        @keyframes sandstormBlow {
            0%, 100% { filter: blur(0px); }
            50% { filter: blur(1px); }
        }
        
        @keyframes sandSwirl {
            0% { transform: translateX(-20px) rotate(0deg); }
            25% { transform: translateX(20px) rotate(90deg); }
            50% { transform: translateX(-10px) rotate(180deg); }
            75% { transform: translateX(10px) rotate(270deg); }
            100% { transform: translateX(-20px) rotate(360deg); }
        }
        
        /* 暴雨效果增强 */
        .stormy-effect {
            background: linear-gradient(135deg, rgba(25, 25, 112, 0.3) 0%, rgba(0, 0, 139, 0.2) 100%);
            animation: stormyWeather 1s ease-in-out infinite;
        }
        
        .stormy-effect::before {
            content: '⚡';
            position: absolute;
            top: 10%;
            right: 20%;
            font-size: 4rem;
            animation: lightning 2s ease-in-out infinite;
            opacity: 0;
        }
        
        @keyframes stormyWeather {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(0.7); }
        }
        
        /* 成就系统弹窗样式 */
        #achievement-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 90vw;
            max-height: 90vh;
            width: 500px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        #achievement-modal.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }
        
        #achievement-overlay.show {
            display: block;
        }
        
        /* 成就按钮悬停效果 */
        #achievement-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* 成就项目样式 */
        .achievement-item {
            transition: all 0.3s ease;
        }
        
        .achievement-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .achievement-item.completed {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
        }
        
        .achievement-item.completed .achievement-icon {
            animation: achievementGlow 2s ease-in-out infinite;
        }
        
        @keyframes achievementGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2) drop-shadow(0 0 10px rgba(16, 185, 129, 0.5)); }
        }
    </style>
</head>
<body class="bg-green-50 min-h-screen" id="main-body">
    <!-- 退出登录按钮 -->
    <button id="logout-btn" class="fixed top-4 left-4 bg-white border border-gray-300 shadow px-4 py-2 rounded-lg text-green-700 font-bold hover:bg-green-100" style="z-index: 9999;">
      <i class="fas fa-sign-out-alt mr-2"></i>退出登录
    </button>
    <!-- 登录弹窗 -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl p-10 flex flex-col items-center w-80">
        <h2 id="login-title-main" class="text-2xl font-bold mb-6 text-green-700">登录开心农场</h2>
        <!-- 登录表单 -->
        <form id="login-form" class="w-full flex flex-col items-center mb-2">
          <input id="login-account" type="text" placeholder="账号" class="w-full mb-3 px-3 py-2 border rounded-lg focus:outline-none" required />
          <input id="login-password" type="password" placeholder="密码" class="w-full mb-3 px-3 py-2 border rounded-lg focus:outline-none" required />
          <button type="button" id="login-btn" class="w-full mb-2 py-2 rounded-2xl bg-green-500 hover:bg-green-600 text-white font-bold text-lg shadow transition">登录</button>
        </form>
        <div id="login-divider" class="w-full flex items-center my-2">
          <div class="flex-1 h-px bg-gray-300"></div>
          <span class="mx-3 text-gray-400 text-sm select-none">或使用以下方式注册</span>
          <div class="flex-1 h-px bg-gray-300"></div>
        </div>
        <!-- 注册方式按钮区域 -->
        <div id="register-choice" class="w-full flex flex-row items-center justify-between gap-2 mt-2 mb-2">
          <button type="button" class="register-way-btn flex-1 flex flex-col items-center justify-center bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-full shadow transition text-xs" data-type="qq" style="min-width:0;max-width:48px;max-height:48px;">
            <i class="fab fa-qq" style="font-size:1.5rem;"></i>
          </button>
          <button type="button" class="register-way-btn flex-1 flex flex-col items-center justify-center bg-green-500 hover:bg-green-600 text-white py-3 rounded-full shadow transition text-xs" data-type="wx" style="min-width:0;max-width:48px;max-height:48px;">
            <i class="fab fa-weixin" style="font-size:1.5rem;"></i>
          </button>
          <button type="button" class="register-way-btn flex-1 flex flex-col items-center justify-center bg-black hover:bg-gray-800 text-white py-3 rounded-full shadow transition text-xs" data-type="douyin" style="min-width:0;max-width:48px;max-height:48px;">
            <i class="fab fa-tiktok" style="font-size:1.5rem;"></i>
          </button>
          <button type="button" class="register-way-btn flex-1 flex flex-col items-center justify-center bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-full shadow transition text-xs" data-type="account" style="min-width:0;max-width:48px;max-height:48px;">
            <i class="fas fa-user" style="font-size:1.5rem;"></i>
          </button>
        </div>
        <!-- 独立注册表单 -->
        <form id="register-form" class="w-full flex flex-col items-center" style="display:none;">
          <div class="flex flex-col items-center mb-4">
            <span id="register-icon" class="text-3xl mb-2"></span>
            <span id="register-title" class="text-lg font-bold"></span>
          </div>
          <input id="register-account" type="text" placeholder="账号" class="w-full mb-3 px-3 py-2 border rounded-lg focus:outline-none" required />
          <input id="register-password" type="password" placeholder="密码" class="w-full mb-3 px-3 py-2 border rounded-lg focus:outline-none" required />
          <div class="flex w-full justify-between">
            <button type="button" id="register-back-choice" class="px-4 py-2 rounded-lg bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold mr-2">返回</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-white font-semibold">注册</button>
          </div>
        </form>
      </div>
    </div>
    <!-- 管理员面板弹窗 -->
    <div id="admin-panel" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50" style="display:none;">
      <div class="bg-white rounded-2xl shadow-2xl p-8 w-[95vw] max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
        <h2 class="text-2xl font-bold mb-4 text-green-700">管理员面板</h2>
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-2">当前游戏数据</h3>
          <div class="grid grid-cols-2 gap-4 mb-2">
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-1">金币</label>
              <input id="admin-money" type="number" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-1">经验</label>
              <input id="admin-xp" type="number" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-1">等级</label>
              <input id="admin-level" type="number" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-1">天气</label>
              <div class="flex items-center gap-2">
              <select id="admin-weather" class="w-full border rounded px-2 py-1">
                <option value="sunny">晴天</option>
                <option value="rainy">雨天</option>
                <option value="cloudy">阴天</option>
                <option value="stormy">暴风雨</option>
                  <option value="typhoon">台风</option>
                  <option value="rainbow">彩虹天</option>
              </select>
                <span class="text-xs text-gray-500 ml-2">仅本地前端生效</span>
              </div>
            </div>
          </div>
          <button id="admin-save" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-bold mt-2">保存修改</button>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2">所有用户信息</h3>
          <div id="admin-users-list" class="overflow-x-auto text-sm"></div>
        </div>
        <!-- 随机事件管理 -->
        <div class="mt-8">
          <h3 class="text-lg font-semibold mb-2">随机事件管理</h3>
          <div id="admin-events-list" class="grid grid-cols-1 gap-2"></div>
        </div>
        <button id="admin-close" class="mt-6 bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded font-bold self-end">关闭</button>
      </div>
    </div>
    <!-- 管理员按钮，仅管理员可见 -->
    <button id="admin-open-btn" class="fixed top-4 right-4 z-50 bg-green-600 hover:bg-green-700 text-white font-bold px-5 py-2 rounded-xl shadow-lg" style="display:none;">管理员</button>
    <!-- 立即完成生长按钮，仅管理员可见 -->
    <button id="admin-grow-btn" class="fixed top-16 right-4 z-50 bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-5 py-2 rounded-xl shadow-lg" style="display:none;">立即完成生长</button>
    <div class="container mx-auto px-4 py-8">
        <!-- 地区切换区域（更大更显眼） -->
        <div class="mb-8 flex items-center justify-center">
            <div class="bg-green-200 rounded-xl px-6 py-4 flex items-center shadow-lg border-2 border-green-400">
                <label for="region-select" class="mr-4 text-2xl font-extrabold text-green-900 title-strong">🌏 选择地区：</label>
                <select id="region-select" class="border-2 border-green-500 rounded-lg px-6 py-3 text-xl font-bold text-green-900 bg-white shadow focus:outline-none focus:ring-2 focus:ring-green-400 transition">
                    <!-- 选项通过JS动态生成 -->
                </select>
            </div>
        </div>
        <!-- 游戏标题和状态栏 -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 card-strong p-6">
            <h1 class="title-strong mb-4 md:mb-0">🎮 开心农场 🚜</h1>
            <div class="flex space-x-4">
                <div class="bg-white rounded-lg p-3 shadow flex items-center">
                    <div id="weather-icon" class="text-xl mr-1">☀️</div>
                    <div>
                        <p class="font-semibold text-green-700 text-sm">天气: <span id="weather-name">晴天</span></p>
                        <p class="text-xs text-gray-600" id="weather-effects">生长+0% 售价+0%</p>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow">
                    <p class="font-semibold text-green-700"><i class="fas fa-coins text-yellow-500 mr-1"></i> 金币: <span id="money">100</span></p>
                </div>
                <div class="bg-white rounded-lg p-3 shadow">
                    <p class="font-semibold text-green-700"><i class="fas fa-star text-yellow-400 mr-1"></i> 等级: <span id="level">1</span></p>
                </div>
                <div class="bg-white rounded-lg p-3 shadow">
                    <p class="font-semibold text-green-700"><i class="fas fa-chart-line text-blue-500 mr-1"></i> 经验: <span id="xp">0</span>/<span id="maxXp">100</span></p>
                </div>
                <!-- 成就系统按钮 -->
                <div id="achievement-btn" class="bg-white rounded-lg p-3 shadow cursor-pointer hover:bg-gray-50 transition">
                    <p class="font-semibold text-green-700 text-sm mb-1"><i class="fas fa-trophy text-yellow-500 mr-1"></i> 成就</p>
                    <div class="text-xs text-gray-600">
                        查看成就进度
                    </div>
                </div>
                <!-- 事件状态显示 -->
                <div id="events-panel" class="bg-white rounded-lg p-3 shadow" style="display: none;">
                    <p class="font-semibold text-green-700 text-sm mb-1"><i class="fas fa-magic text-purple-500 mr-1"></i> 活跃事件</p>
                    <div id="active-events-list" class="text-xs text-gray-600">
                        <!-- 事件列表将在这里动态显示 -->
                    </div>
                </div>
            </div>
        </header>

        <!-- 游戏内容区域 -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左侧主区：农田+牧场 -->
            <div class="lg:col-span-2 flex flex-col gap-6">
            <!-- 农场区域 -->
                <div class="card-strong p-8">
                <h2 class="text-3xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                    <i class="fas fa-tractor mr-3"></i> 我的农场
                </h2>
                <div class="flex justify-between items-center mb-4">
                    <p class="text-gray-600">你有 <span id="plots-count">4</span> 块农田 (最大: 12)</p>
                    <button id="expand-farm" class="btn-strong px-6 py-2 text-lg transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-plus mr-2"></i> 扩展农田 (200金币)
                    </button>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="farm-grid">
                    <!-- 农田地块将通过JavaScript动态生成 -->
                </div>
            </div>
                <!-- 牧场区域 -->
                <div class="card-strong p-8">
                    <h2 class="text-3xl subtitle-strong mb-6 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-warehouse mr-3"></i> 我的牧场
                    </h2>
                    <!-- 牧场统计和管理 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                            <div class="text-3xl font-bold text-blue-600" id="total-animals">0</div>
                            <div class="text-sm text-gray-600">总动物数</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg border-2 border-green-200">
                            <div class="text-3xl font-bold text-green-600" id="avg-health">100%</div>
                            <div class="text-sm text-gray-600">平均健康度</div>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg border-2 border-yellow-200">
                            <div class="text-3xl font-bold text-yellow-600" id="feed-count">0</div>
                            <div class="text-sm text-gray-600">饲料库存</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                            <div class="text-3xl font-bold text-purple-600" id="happiness-value">0</div>
                            <div class="text-sm text-gray-600">幸福值</div>
                        </div>
                    </div>
                    <!-- 牧场管理按钮 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <button id="buy-feed-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-semibold text-lg transition">
                            <i class="fas fa-shopping-cart mr-2"></i> 购买饲料 (10金币/包)
                        </button>
                        <button id="feed-animals-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold text-lg transition">
                            <i class="fas fa-apple-alt mr-2"></i> 喂养全部动物
                        </button>
                        <button id="sell-all-products-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold text-lg transition">
                            <i class="fas fa-coins mr-2"></i> 一键出售所有副产品
                        </button>
                    </div>
                    <!-- 动物区域选择 -->
                    <div class="mb-6">
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button class="animal-area-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold active" data-area="all">
                                <span class="text-xl mr-2">🌾</span> 全部区域
                            </button>
                            <button class="animal-area-btn bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-semibold" data-area="chicken">
                                <span class="text-xl mr-2">🥚</span> 鸡圈
                            </button>
                            <button class="animal-area-btn bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg font-semibold" data-area="cow">
                                <span class="text-xl mr-2">🥛</span> 牛棚
                            </button>
                            <button class="animal-area-btn bg-white hover:bg-gray-100 text-gray-800 px-4 py-2 rounded-lg font-semibold border-2 border-gray-300" data-area="sheep">
                                <span class="text-xl mr-2">🧶</span> 羊圈
                            </button>
                            <button class="animal-area-btn bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg font-semibold" data-area="pig">
                                <span class="text-xl mr-2">🥩</span> 猪圈
                            </button>
                            <button class="animal-area-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold" data-area="duck">
                                <span class="text-xl mr-2">🥚</span> 鸭园
                            </button>
                            <button class="animal-area-btn bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold" data-area="goat">
                                <span class="text-xl mr-2">🥛</span> 山羊圈
                            </button>
                            <button class="animal-area-btn bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold" data-area="rabbit">
                                <span class="text-xl mr-2">🧶</span> 兔园
                            </button>
                            <button class="animal-area-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold" data-area="horse">
                                <span class="text-xl mr-2">💩</span> 马厩
                            </button>
                        </div>
                    </div>
                    
                    <!-- 动物区域内容 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 全部区域视图 -->
                        <div id="all-areas-view" class="animal-area-view active bg-green-50 rounded-lg p-6 shadow-lg relative overflow-hidden min-h-[400px] w-full col-span-2">
                            <div class="absolute inset-0 pointer-events-none select-none" style="background: repeating-linear-gradient(135deg, #d1fae5 0 10px, #bbf7d0 10px 20px);"></div>
                            
                            <!-- 牧场控制面板 -->
                            <div class="absolute top-4 right-4 z-20 flex gap-2">
                                <button id="ranch-sound-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-200 flex items-center gap-1">
                                    <span id="sound-icon">🔊</span>
                                    <span id="sound-text">音效</span>
                                </button>
                            </div>
                            
                            <!-- 天气效果层 -->
                            <div id="ranch-weather-effect" class="absolute inset-0 pointer-events-none z-5"></div>
                            
                            <!-- 动物活动区域 -->
                            <div class="relative z-10 w-full flex flex-wrap justify-center gap-6">
                                <div id="ranch-animal-icons" class="flex flex-wrap gap-4"></div>
                            </div>
                            
                            <!-- 牧场标题和状态 -->
                            <div class="relative z-10 mt-4 text-center">
                                <div class="text-green-700 font-bold text-lg flex items-center justify-center">
                                    <span class="mr-2">🐾</span>
                                    <span id="ranch-title">牧场悠闲时光</span>
                                </div>
                                <div class="text-sm text-green-600 mt-1 flex items-center justify-center gap-4">
                                    <span id="ranch-time">🕐 现在是白天</span>
                                    <span id="ranch-season">🌸 春季</span>
                                    <span id="ranch-mood">😊 动物们很开心</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 鸡圈 -->
                        <div id="chicken-area-view" class="animal-area-view bg-yellow-50 rounded-lg p-6 shadow-lg relative overflow-hidden min-h-[400px] w-full col-span-2">
                            <div class="absolute inset-0 pointer-events-none select-none" style="background: repeating-linear-gradient(135deg, #fef3c7 0 10px, #fde68a 10px 20px);"></div>
                            <div class="relative z-10">
                                <h3 class="text-2xl font-bold text-yellow-800 mb-4 flex items-center">
                                    <span class="text-3xl mr-2">🥚</span> 鸡圈
                                </h3>
                                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                                    <div class="bg-yellow-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-yellow-700" id="chicken-count">0</div>
                                        <div class="text-xs text-yellow-600">数量</div>
                                    </div>
                                    <div class="bg-green-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-green-700" id="chicken-health">100%</div>
                                        <div class="text-xs text-green-600">健康度</div>
                                    </div>
                                    <div class="bg-blue-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-blue-700" id="chicken-eggs">0</div>
                                        <div class="text-xs text-blue-600">鸡蛋</div>
                                    </div>
                                </div>
                                <div id="chicken-animals" class="flex flex-wrap gap-4"></div>
                            </div>
                        </div>
                        
                        <!-- 牛棚 -->
                        <div id="cow-area-view" class="animal-area-view bg-amber-50 rounded-lg p-6 shadow-lg relative overflow-hidden min-h-[400px] w-full col-span-2">
                            <div class="absolute inset-0 pointer-events-none select-none" style="background: repeating-linear-gradient(135deg, #fef3c7 0 10px, #fde68a 10px 20px);"></div>
                            <div class="relative z-10">
                                <h3 class="text-2xl font-bold text-amber-800 mb-4 flex items-center">
                                    <span class="text-3xl mr-2">🥛</span> 牛棚
                                </h3>
                                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                                    <div class="bg-amber-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-amber-700" id="cow-count">0</div>
                                        <div class="text-xs text-amber-600">数量</div>
                                    </div>
                                    <div class="bg-green-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-green-700" id="cow-health">100%</div>
                                        <div class="text-xs text-green-600">健康度</div>
                                    </div>
                                    <div class="bg-blue-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-blue-700" id="cow-milk">0</div>
                                        <div class="text-xs text-blue-600">牛奶</div>
                                    </div>
                                </div>
                                <div id="cow-animals" class="flex flex-wrap gap-4"></div>
                            </div>
                        </div>
                        
                        <!-- 羊圈 -->
                        <div id="sheep-area-view" class="animal-area-view bg-white rounded-lg p-6 shadow-lg relative overflow-hidden min-h-[400px] w-full col-span-2 border-2 border-gray-300">
                            <div class="absolute inset-0 pointer-events-none select-none" style="background: repeating-linear-gradient(135deg, #f9fafb 0 10px, #e5e7eb 10px 20px);"></div>
                            <div class="relative z-10">
                                <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                                    <span class="text-3xl mr-2">🧶</span> 羊圈
                                </h3>
                                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                                    <div class="bg-gray-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-gray-700" id="sheep-count">0</div>
                                        <div class="text-xs text-gray-600">数量</div>
                                    </div>
                                    <div class="bg-green-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-green-700" id="sheep-health">100%</div>
                                        <div class="text-xs text-green-600">健康度</div>
                                    </div>
                                    <div class="bg-blue-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-blue-700" id="sheep-wool">0</div>
                                        <div class="text-xs text-blue-600">羊毛</div>
                                    </div>
                                </div>
                                <div id="sheep-animals" class="flex flex-wrap gap-4"></div>
                            </div>
                        </div>
                        
                        <!-- 猪圈 -->
                        <div id="pig-area-view" class="animal-area-view bg-pink-50 rounded-lg p-6 shadow-lg relative overflow-hidden min-h-[400px] w-full col-span-2">
                            <div class="absolute inset-0 pointer-events-none select-none" style="background: repeating-linear-gradient(135deg, #fdf2f8 0 10px, #fce7f3 10px 20px);"></div>
                            <div class="relative z-10">
                                <h3 class="text-2xl font-bold text-pink-800 mb-4 flex items-center">
                                    <span class="text-3xl mr-2">🥩</span> 猪圈
                                </h3>
                                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                                    <div class="bg-pink-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-pink-700" id="pig-count">0</div>
                                        <div class="text-xs text-pink-600">数量</div>
                                    </div>
                                    <div class="bg-green-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-green-700" id="pig-health">100%</div>
                                        <div class="text-xs text-green-600">健康度</div>
                                    </div>
                                    <div class="bg-blue-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-blue-700" id="pig-pork">0</div>
                                        <div class="text-xs text-blue-600">猪肉</div>
                                    </div>
                                </div>
                                <div id="pig-animals" class="flex flex-wrap gap-4"></div>
                            </div>
                        </div>
                        
                        <!-- 鸭园 -->
                        <div id="duck-area-view" class="animal-area-view bg-blue-50 rounded-lg p-6 shadow-lg relative overflow-hidden min-h-[400px] w-full col-span-2">
                            <div class="absolute inset-0 pointer-events-none select-none" style="background: repeating-linear-gradient(135deg, #dbeafe 0 10px, #bfdbfe 10px 20px);"></div>
                            <div class="relative z-10">
                                <h3 class="text-2xl font-bold text-blue-800 mb-4 flex items-center">
                                    <span class="text-3xl mr-2">🥚</span> 鸭园
                                </h3>
                                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                                    <div class="bg-blue-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-blue-700" id="duck-count">0</div>
                                        <div class="text-xs text-blue-600">数量</div>
                                    </div>
                                    <div class="bg-green-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-green-700" id="duck-health">100%</div>
                                        <div class="text-xs text-green-600">健康度</div>
                                    </div>
                                    <div class="bg-blue-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-blue-700" id="duck-duck_egg">0</div>
                                        <div class="text-xs text-blue-600">鸭蛋</div>
                                    </div>
                                </div>
                                <div id="duck-animals" class="flex flex-wrap gap-4"></div>
                            </div>
                        </div>
                        
                        <!-- 山羊圈 -->
                        <div id="goat-area-view" class="animal-area-view bg-orange-50 rounded-lg p-6 shadow-lg relative overflow-hidden min-h-[400px] w-full col-span-2">
                            <div class="absolute inset-0 pointer-events-none select-none" style="background: repeating-linear-gradient(135deg, #fed7aa 0 10px, #fdba74 10px 20px);"></div>
                            <div class="relative z-10">
                                <h3 class="text-2xl font-bold text-orange-800 mb-4 flex items-center">
                                    <span class="text-3xl mr-2">🥛</span> 山羊圈
                                </h3>
                                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                                    <div class="bg-orange-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-orange-700" id="goat-count">0</div>
                                        <div class="text-xs text-orange-600">数量</div>
                                    </div>
                                    <div class="bg-green-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-green-700" id="goat-health">100%</div>
                                        <div class="text-xs text-green-600">健康度</div>
                                    </div>
                                    <div class="bg-blue-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-blue-700" id="goat-goat_milk">0</div>
                                        <div class="text-xs text-blue-600">羊奶</div>
                                    </div>
                                </div>
                                <div id="goat-animals" class="flex flex-wrap gap-4"></div>
                            </div>
                        </div>
                        
                        <!-- 兔园 -->
                        <div id="rabbit-area-view" class="animal-area-view bg-purple-50 rounded-lg p-6 shadow-lg relative overflow-hidden min-h-[400px] w-full col-span-2">
                            <div class="absolute inset-0 pointer-events-none select-none" style="background: repeating-linear-gradient(135deg, #f3e8ff 0 10px, #e9d5ff 10px 20px);"></div>
                            <div class="relative z-10">
                                <h3 class="text-2xl font-bold text-purple-800 mb-4 flex items-center">
                                    <span class="text-3xl mr-2">🧶</span> 兔园
                                </h3>
                                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                                    <div class="bg-purple-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-purple-700" id="rabbit-count">0</div>
                                        <div class="text-xs text-purple-600">数量</div>
                                    </div>
                                    <div class="bg-green-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-green-700" id="rabbit-health">100%</div>
                                        <div class="text-xs text-green-600">健康度</div>
                                    </div>
                                    <div class="bg-blue-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-blue-700" id="rabbit-rabbit_fur">0</div>
                                        <div class="text-xs text-blue-600">兔毛</div>
                                    </div>
                                </div>
                                <div id="rabbit-animals" class="flex flex-wrap gap-4"></div>
                            </div>
                        </div>
                        
                        <!-- 马厩 -->
                        <div id="horse-area-view" class="animal-area-view bg-red-50 rounded-lg p-6 shadow-lg relative overflow-hidden min-h-[400px] w-full col-span-2">
                            <div class="absolute inset-0 pointer-events-none select-none" style="background: repeating-linear-gradient(135deg, #fee2e2 0 10px, #fecaca 10px 20px);"></div>
                            <div class="relative z-10">
                                <h3 class="text-2xl font-bold text-red-800 mb-4 flex items-center">
                                    <span class="text-3xl mr-2">💩</span> 马厩
                                </h3>
                                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                                    <div class="bg-red-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-red-700" id="horse-count">0</div>
                                        <div class="text-xs text-red-600">数量</div>
                                    </div>
                                    <div class="bg-green-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-green-700" id="horse-health">100%</div>
                                        <div class="text-xs text-green-600">健康度</div>
                                    </div>
                                    <div class="bg-blue-100 rounded-lg p-2">
                                        <div class="text-lg font-bold text-blue-700" id="horse-horse_manure">0</div>
                                        <div class="text-xs text-blue-600">马粪</div>
                                    </div>
                                </div>
                                <div id="horse-animals" class="flex flex-wrap gap-4"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 右侧侧边栏 -->
            <div class="space-y-6">
                <!-- 统一商店 -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-store mr-3"></i> 综合商店
                    </h2>
                    <!-- 商店分类选择 -->
                    <div class="flex space-x-2 mb-4">
                        <button class="shop-tab-btn btn-strong px-4 py-2 text-sm active" data-category="seeds">
                            <i class="fas fa-seedling mr-2"></i> 种子
                        </button>
                        <button class="shop-tab-btn btn-strong px-4 py-2 text-sm" data-category="items">
                            <i class="fas fa-toolbox mr-2"></i> 道具
                        </button>
                        <button class="shop-tab-btn btn-strong px-4 py-2 text-sm" data-category="decor">
                            <i class="fas fa-tree mr-2"></i> 装饰
                        </button>
                        <button class="shop-tab-btn btn-strong px-4 py-2 text-sm" data-category="animals">
                            <i class="fas fa-dog mr-2"></i> 动物
                        </button>
                    </div>
                    <!-- 种子商店内容 -->
                    <div id="shop-items" class="shop-content active">
                        <!-- 种子将通过JavaScript动态生成 -->
                    </div>
                    <!-- 道具商店内容 -->
                    <div id="item-shop" class="shop-content space-y-3" style="display: none;">
                        <!-- 道具将通过JavaScript动态生成 -->
                </div>
                    <!-- 我的道具显示 -->
                    <div id="my-items" class="mt-4 p-4 bg-gray-50 rounded-lg" style="display: none;">
                        <h3 class="font-bold text-lg mb-3 flex items-center">
                            <i class="fas fa-toolbox mr-2"></i> 我的道具
                        </h3>
                        <div id="my-items-list" class="space-y-2">
                            <!-- 道具列表将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    <!-- 植物保护状态 -->
                    <div id="plant-protection-status" class="mt-4 p-4 bg-green-50 rounded-lg" style="display: none;">
                        <h3 class="font-bold text-lg mb-3 flex items-center">
                            <i class="fas fa-seedling mr-2 text-green-500"></i> 植物保护状态
                        </h3>
                        <div id="plant-protection-list" class="space-y-2">
                            <!-- 保护设施状态将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    <!-- 装饰商店内容 -->
                    <div id="decor-shop" class="shop-content space-y-3" style="display: none;">
                        <!-- 装饰将通过JavaScript动态生成 -->
                    </div>
                    <!-- 动物商店内容 -->
                    <div id="animal-shop" class="shop-content space-y-3" style="display: none;">
                        <!-- 动物将通过JavaScript动态生成 -->
                    </div>
                </div>
                <!-- 库存区域 -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-box-open mr-3"></i> 我的库存
                    </h2>
                    <div id="inventory-items">
                        <!-- 作物/水果列表 -->
                        <div id="crop-inventory-list">
                            <!-- 由JS渲染作物/水果库存 -->
                    </div>
                        <!-- 动物产品列表 -->
                        <div id="animal-inventory-list" class="mt-6">
                            <!-- 由JS渲染动物产品库存 -->
                </div>
                    </div>
                </div>
                <!-- 任务区域 -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-tasks mr-3"></i> 每日任务
                    </h2>
                    <div id="tasks-list">
                        <p class="text-gray-500 italic">今日任务将在这里显示</p>
                    </div>
                </div>
                
                <!-- 成就系统 -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-trophy mr-3"></i> 成就系统
                    </h2>
                    <div id="achievements-list">
                        <p class="text-gray-500 italic">成就将在这里显示</p>
                    </div>
                </div>
                
                <!-- 农场活动 -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-calendar-alt mr-3"></i> 农场活动
                    </h2>
                    <div id="farm-events">
                        <p class="text-gray-500 italic">农场活动将在这里显示</p>
                    </div>
                </div>
                
                <!-- 农场商店 -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-store mr-3"></i> 农场商店
                    </h2>
                    <div id="farm-shop">
                        <p class="text-gray-500 italic">农场商店将在这里显示</p>
                    </div>
                </div>
                
                <!-- 测试按钮 -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-flask mr-3"></i> 功能测试
                    </h2>
                    <div class="space-y-2">
                        <button onclick="testAchievements()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                            测试成就系统
                        </button>
                        <button onclick="testFarmEvents()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                            测试农场活动
                        </button>
                        <button onclick="testFarmShop()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                            测试农场商店
                        </button>
                    </div>
                </div>
                <!-- 升级区域 -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-wrench mr-3"></i> 农场升级
                    </h2>
                    <div class="space-y-4" id="upgrades">
                        <!-- 升级项将通过JavaScript动态生成 -->
                    </div>
                </div>
                <!-- 我的装饰 -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-gift mr-3"></i> 我的装饰
                    </h2>
                    <div id="my-decors" class="space-y-3"></div>
                </div>
                <!-- 我的动物 -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-paw mr-3"></i> 我的动物
                    </h2>
                    <div id="my-animals" class="space-y-3"></div>
                    <!-- 动物天气状态 -->
                    <div id="animal-weather-status" class="mt-4"></div>
                </div>
            </div>
        </main>

        <!-- 成就系统弹窗 -->
        <div id="achievement-modal" class="bg-white rounded-xl shadow-2xl">
            <div class="flex justify-between items-center p-6 border-b-2 border-green-200">
                <h2 class="text-2xl font-bold text-green-700 flex items-center">
                    <i class="fas fa-trophy text-yellow-500 mr-2"></i> 成就系统
                </h2>
                <button id="close-achievement-modal" class="text-gray-500 hover:text-gray-700 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 max-h-96 overflow-y-auto">
                <div id="achievement-modal-content">
                    <!-- 成就内容将在这里动态显示 -->
                </div>
            </div>
        </div>

        <!-- 弹窗遮罩层 -->
        <div id="achievement-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

        <!-- 通知区域 -->
        <div id="notifications" class="fixed bottom-4 right-4 space-y-2 w-64"></div>

        <!-- 保存指示器 -->
        <div id="save-indicator" class="save-indicator">
            <i class="fas fa-save mr-2"></i> 游戏数据已保存
        </div>
    </div>

    <script>
        // 游戏状态
        const gameState = {
            money: 100,
            level: 1,
            xp: 0,
            maxXp: 100,
            plots: 4, // 当前区域农田数量
            maxPlots: 12,
            regionPlots: {}, // 各区域独立农田数量
            inventory: {}, // 改为按品质存储: {seedId: {quality0: count, quality1: count, ...}}
            qualityInventory: {}, // 新的品质库存系统 {seedId: {0: count, 1: count, 2: count, 3: count}}
            upgrades: {
                watering: 0,
                quality: 0,
                greenhouse: 0
            },
            currentSelectedSeed: null,
            purchasedSeeds: {},
            weather: 'sunny',
            dailyStreak: 0,
            lastPlayed: null,
            completedTasks: 0,
            achievements: [],
            currentRegion: 'north_china', // 新增字段，默认中国东北
            tasks: [],
            farmData: [], // 当前区域农田数据（视图）
            regionFarmData: {}, // 各区域独立农田数据
            // 随机事件相关字段
            activeEvents: [], // 当前激活的事件
            lastEventTime: 0, // 上次触发事件的时间
            eventCooldown: 30000, // 事件冷却时间（30秒）
            eventChance: 0.1, // 每秒触发事件的概率（10%）
            items: { pesticide: 0, medicine: 0, weedkiller: 0, insulation: 0, animal_feed: 0, vitamin_pill: 0, stress_relief_pill: 0, water_supplement: 0, healing_ointment: 0, happiness_treat: 0, weather_protection: 0, growth_hormone: 0 }, // 新增道具背包，包含动物道具
            decors: {},
            animals: { chicken: 0, cow: 0, sheep: 0, pig: 0, duck: 0, goat: 0, rabbit: 0, horse: 0 }, // 扩展动物库存
            animalAreas: { chicken: 'chicken', cow: 'cow', sheep: 'sheep', pig: 'pig', duck: 'duck', goat: 'goat', rabbit: 'rabbit', horse: 'horse' }, // 动物区域映射
            animalHealth: { chicken: 100, cow: 100, sheep: 100, pig: 100, duck: 100, goat: 100, rabbit: 100, horse: 100 }, // 健康度
            animalFeed: 5, // 饲料库存
            animalProducts: { egg: 0, milk: 0, wool: 0, pork: 0, duck_egg: 0, goat_milk: 0, rabbit_fur: 0, horse_manure: 0 }, // 副产品库存
            happiness: 0, // 幸福值
            // 动物应对天气系统
            animalShelter: { chicken: false, cow: false, sheep: false, pig: false, duck: false, goat: false, rabbit: false, horse: false }, // 动物庇护状态
            animalWaterSupply: { chicken: 100, cow: 100, sheep: 100, pig: 100, duck: 100, goat: 100, rabbit: 100, horse: 100 }, // 动物水分供应
            animalStress: { chicken: 0, cow: 0, sheep: 0, pig: 0, duck: 0, goat: 0, rabbit: 0, horse: 0 }, // 动物压力值
            animalInjuries: { chicken: [], cow: [], sheep: [], pig: [], duck: [], goat: [], rabbit: [], horse: [] }, // 动物伤病记录
            weatherProtection: { shelter: 0, waterSystem: 0, medicalKit: 0, coolingSystem: 0 }, // 天气防护设施
            // 土地改良系统
            landImprovements: {}, // 各区域土地改良等级 {regionId: {plotIndex: level}}
            regionLandImprovements: {}, // 各区域独立土地改良数据
            
            // 新玩法数据
            achievements: {}, // 成就系统
            farmEvents: [], // 农场活动
            farmShop: { // 农场商店
                specialSeeds: {},
                rareAnimals: {},
                farmTools: {},
                seasonalItems: {}
            },
            dailyTasks: [], // 每日任务
            seasonalEvents: [], // 季节活动
            farmLevel: 1, // 农场等级
            farmExp: 0, // 农场经验
            farmPoints: 0, // 农场积分
            farmReputation: 0, // 农场声望
            farmVisitors: 0, // 农场访客数
            farmTourism: false, // 农场旅游模式
            farmFestivals: [], // 农场节日
            farmCompetitions: [], // 农场竞赛
            farmCooperation: [], // 农场合作
            farmResearch: {}, // 农场研究
            farmAutomation: {}, // 农场自动化
            farmSecurity: {}, // 农场安保
            farmEnvironment: {}, // 农场环境
            farmInnovation: {} // 农场创新
        };

        // 地区数据（更细分且不重复）
        const regions = [
            { id: 'north_china', name: '中国东北' },
            { id: 'south_china', name: '中国华南' },
            { id: 'east_china', name: '中国华东' },
            { id: 'west_china', name: '中国西部' },
            { id: 'japan', name: '日本' },
            { id: 'us_midwest', name: '美国中部' },
            { id: 'europe', name: '欧洲' }
        ];
        // 植物种类不重复，每个区域独有，5-6种
        const seeds = [
            // 中国东北
            { id: 'soybean', name: '大豆', price: 10, growTime: 30, sellPrice: 20, xp: 5, icon: '🌱', color: 'bg-lime-100', regions: ['north_china'] },
            { id: 'millet', name: '小米', price: 12, growTime: 36, sellPrice: 22, xp: 6, icon: '🌾', color: 'bg-yellow-200', regions: ['north_china'] },
            { id: 'sorghum', name: '高粱', price: 15, growTime: 45, sellPrice: 30, xp: 8, icon: '🌾', color: 'bg-red-200', regions: ['north_china'] },
            { id: 'potato', name: '土豆', price: 20, growTime: 60, sellPrice: 45, xp: 12, icon: '🥔', color: 'bg-amber-100', regions: ['north_china'] },
            { id: 'corn', name: '玉米', price: 18, growTime: 54, sellPrice: 38, xp: 10, icon: '🌽', color: 'bg-yellow-100', regions: ['north_china'] },
            // 中国华南
            { id: 'lychee', name: '荔枝', price: 22, growTime: 66, sellPrice: 50, xp: 13, icon: '🥭', color: 'bg-pink-100', regions: ['south_china'] },
            { id: 'banana', name: '香蕉', price: 25, growTime: 75, sellPrice: 60, xp: 15, icon: '🍌', color: 'bg-yellow-200', regions: ['south_china'] },
            { id: 'sugarcane', name: '甘蔗', price: 20, growTime: 60, sellPrice: 48, xp: 12, icon: '🎋', color: 'bg-green-200', regions: ['south_china'] },
            { id: 'pineapple', name: '菠萝', price: 28, growTime: 84, sellPrice: 70, xp: 18, icon: '🍍', color: 'bg-amber-200', regions: ['south_china'] },
            { id: 'dragonfruit', name: '火龙果', price: 35, growTime: 105, sellPrice: 90, xp: 22, icon: '🐉', color: 'bg-pink-200', regions: ['south_china'] },
            // 中国华东
            { id: 'rice', name: '水稻', price: 15, growTime: 45, sellPrice: 32, xp: 9, icon: '🌾', color: 'bg-green-200', regions: ['east_china'] },
            { id: 'peanut', name: '花生', price: 18, growTime: 54, sellPrice: 38, xp: 10, icon: '🥜', color: 'bg-yellow-300', regions: ['east_china'] },
            { id: 'rapeseed', name: '油菜', price: 16, growTime: 48, sellPrice: 34, xp: 9, icon: '🌻', color: 'bg-yellow-100', regions: ['east_china'] },
            { id: 'lotus', name: '莲藕', price: 22, growTime: 66, sellPrice: 50, xp: 13, icon: '🌸', color: 'bg-pink-100', regions: ['east_china'] },
            { id: 'tea', name: '茶叶', price: 30, growTime: 90, sellPrice: 80, xp: 20, icon: '🍃', color: 'bg-green-100', regions: ['east_china'] },
            // 中国西部
            { id: 'walnut', name: '核桃', price: 25, growTime: 75, sellPrice: 60, xp: 15, icon: '🌰', color: 'bg-amber-200', regions: ['west_china'] },
            { id: 'apple', name: '苹果', price: 20, growTime: 60, sellPrice: 48, xp: 12, icon: '🍎', color: 'bg-red-100', regions: ['west_china'] },
            { id: 'grape', name: '葡萄', price: 28, growTime: 84, sellPrice: 70, xp: 18, icon: '🍇', color: 'bg-purple-100', regions: ['west_china'] },
            { id: 'apricot', name: '杏', price: 18, growTime: 54, sellPrice: 38, xp: 10, icon: '🍑', color: 'bg-orange-100', regions: ['west_china'] },
            { id: 'melon', name: '哈密瓜', price: 35, growTime: 105, sellPrice: 90, xp: 22, icon: '🍈', color: 'bg-green-100', regions: ['west_china'] },
            // 日本
            { id: 'wasabi', name: '芥末', price: 30, growTime: 90, sellPrice: 80, xp: 20, icon: '🌱', color: 'bg-lime-100', regions: ['japan'] },
            { id: 'sakura', name: '樱花', price: 40, growTime: 120, sellPrice: 100, xp: 25, icon: '🌸', color: 'bg-pink-200', regions: ['japan'] },
            { id: 'sweet_potato', name: '红薯', price: 18, growTime: 54, sellPrice: 38, xp: 10, icon: '🍠', color: 'bg-orange-200', regions: ['japan'] },
            { id: 'daikon', name: '大根', price: 22, growTime: 66, sellPrice: 50, xp: 13, icon: '🥕', color: 'bg-orange-100', regions: ['japan'] },
            { id: 'mikan', name: '蜜柑', price: 28, growTime: 84, sellPrice: 70, xp: 18, icon: '🍊', color: 'bg-yellow-100', regions: ['japan'] },
            // 美国中部
            { id: 'blueberry', name: '蓝莓', price: 25, growTime: 75, sellPrice: 60, xp: 15, icon: '🫐', color: 'bg-indigo-100', regions: ['us_midwest'] },
            { id: 'pumpkin', name: '南瓜', price: 20, growTime: 60, sellPrice: 48, xp: 12, icon: '🎃', color: 'bg-orange-200', regions: ['us_midwest'] },
            { id: 'wheat', name: '小麦', price: 15, growTime: 45, sellPrice: 32, xp: 9, icon: '🌾', color: 'bg-yellow-100', regions: ['us_midwest'] },
            { id: 'cranberry', name: '蔓越莓', price: 28, growTime: 84, sellPrice: 70, xp: 18, icon: '🍒', color: 'bg-red-200', regions: ['us_midwest'] },
            { id: 'sunflower', name: '向日葵', price: 18, growTime: 54, sellPrice: 38, xp: 10, icon: '🌻', color: 'bg-yellow-200', regions: ['us_midwest'] },
            // 欧洲
            { id: 'carrot', name: '胡萝卜', price: 15, growTime: 45, sellPrice: 32, xp: 9, icon: '🥕', color: 'bg-orange-100', regions: ['europe'] },
            { id: 'strawberry', name: '草莓', price: 22, growTime: 66, sellPrice: 50, xp: 13, icon: '🍓', color: 'bg-red-100', regions: ['europe'] },
            { id: 'lettuce', name: '生菜', price: 18, growTime: 54, sellPrice: 38, xp: 10, icon: '🥬', color: 'bg-green-100', regions: ['europe'] },
            { id: 'asparagus', name: '芦笋', price: 28, growTime: 84, sellPrice: 70, xp: 18, icon: '🥦', color: 'bg-green-200', regions: ['europe'] },
            { id: 'grapefruit', name: '葡萄柚', price: 35, growTime: 105, sellPrice: 90, xp: 22, icon: '🍇', color: 'bg-purple-100', regions: ['europe'] }
        ];

        // 升级数据
        const upgrades = [
            { id: 'watering', name: '浇水效率', description: '减少作物生长时间10%', cost: 150, maxLevel: 3 },
            { id: 'quality', name: '作物品质', description: '提高作物售价15%', cost: 250, maxLevel: 3 },
            { id: 'greenhouse', name: '温室大棚', description: '减少天气影响50%', cost: 400, maxLevel: 1 }
        ];

        // 土地改良等级定义
        const landImprovementLevels = [
            { level: 0, name: '普通土地', icon: '🟫', color: 'bg-amber-100', growthBonus: 1.0, yieldBonus: 1.0, description: '基础土地，无特殊效果' },
            { level: 1, name: '肥沃土地', icon: '🟤', color: 'bg-yellow-200', growthBonus: 1.15, yieldBonus: 1.1, cost: 100, description: '施肥改良，生长速度+15%，产量+10%' },
            { level: 2, name: '优质土地', icon: '🟢', color: 'bg-green-200', growthBonus: 1.3, yieldBonus: 1.25, cost: 200, description: '深度改良，生长速度+30%，产量+25%' },
            { level: 3, name: '完美土地', icon: '✨', color: 'bg-purple-200', growthBonus: 1.5, yieldBonus: 1.5, cost: 400, description: '极致改良，生长速度+50%，产量+50%' }
        ];

        // 水果品质系统
        const fruitQualities = [
            { 
                level: 0, 
                name: '普通', 
                icon: '🟫', 
                color: 'bg-gray-100 border-gray-300', 
                priceMultiplier: 1.0, 
                description: '普通品质的水果',
                landRequirement: 0 // 对应土地等级
            },
            { 
                level: 1, 
                name: '优良', 
                icon: '🟤', 
                color: 'bg-green-100 border-green-300', 
                priceMultiplier: 1.3, 
                description: '优良品质的水果，售价+30%',
                landRequirement: 1
            },
            { 
                level: 2, 
                name: '精品', 
                icon: '🟢', 
                color: 'bg-blue-100 border-blue-300', 
                priceMultiplier: 1.6, 
                description: '精品品质的水果，售价+60%',
                landRequirement: 2
            },
            { 
                level: 3, 
                name: '完美', 
                icon: '✨', 
                color: 'bg-purple-100 border-purple-300', 
                priceMultiplier: 2.0, 
                description: '完美品质的水果，售价+100%',
                landRequirement: 3
            }
        ];


        
        // 任务数据
        const tasks = [
            { id: 'harvest_5', name: '收获5个作物', goal: 5, reward: 50, desc: '收获任意5个作物' },
            { id: 'plant_3', name: '种植3次', goal: 3, reward: 30, desc: '种植3次任意种子' },
            { id: 'sell_100', name: '销售100金币', goal: 100, reward: 20, desc: '累计销售作物价值达到100金币' },
            { id: 'upgrade_1', name: '完成1次升级', goal: 1, reward: 40, desc: '购买任意1次农场升级' },
            { id: 'expand_1', name: '扩展1块农田', goal: 1, reward: 60, desc: '扩展1块农田' }
        ];

        // 天气系统
        const weatherTypes = [
            { 
                id: 'sunny', 
                name: '晴天', 
                icon: '☀️', 
                effect: { growth: 1.2, needWater: true, yieldPenaltyIfNoWater: true },
                description: '阳光充足，作物生长加快20%，但需要及时浇水'
            },
            { 
                id: 'rainy', 
                name: '雨天', 
                icon: '🌧️', 
                effect: { growth: 1.0, needWater: false, pestChance: 0.1 },
                description: '雨水滋润，无需浇水，但有10%概率出现病虫害'
            },
            { 
                id: 'stormy', 
                name: '暴雨', 
                icon: '⛈️', 
                effect: { destroyLowFarm: true, fishDouble: true },
                description: '暴雨来袭，未升级排水的农田可能被破坏'
            },
            { 
                id: 'drought', 
                name: '干旱', 
                icon: '🔥', 
                effect: { growth: 0, needWater: true, witherIfNoWater: true },
                description: '极度干旱，作物停止生长，3天不浇水会枯死'
            },
            { 
                id: 'typhoon', 
                name: '台风', 
                icon: '🌀', 
                effect: { blowFruitTree: true, rareSeedDrop: true },
                description: '台风过境，未加固的果树可能倒伏'
            },
            { 
                id: 'rainbow', 
                name: '彩虹天', 
                icon: '🌈', 
                effect: { yieldBonus: 0.5 },
                description: '彩虹天赐福，作物售价提升50%'
            },
            { 
                id: 'sandstorm', 
                name: '沙尘暴', 
                icon: '🌪️', 
                effect: { disableCollect: true },
                description: '沙尘暴肆虐，无法收获作物'
            }
        ];

        // 随机事件系统
        const randomEvents = [
            // 正面事件
            { 
                id: 'golden_rain', 
                name: '金雨降临', 
                icon: '🌧️', 
                color: 'text-yellow-500',
                effect: 'growth_boost',
                duration: 30, // 30秒
                description: '作物生长速度提升50%',
                animation: 'rainbow-rain'
            },
            { 
                id: 'fairy_blessing', 
                name: '精灵祝福', 
                icon: '🧚', 
                color: 'text-pink-500',
                effect: 'instant_growth',
                duration: 0, // 立即生效
                description: '所有作物立即成熟',
                animation: 'fairy-sparkle'
            },
            { 
                id: 'nutrient_boost', 
                name: '营养爆发', 
                icon: '💚', 
                color: 'text-green-500',
                effect: 'quality_boost',
                duration: 60, // 60秒
                description: '作物品质提升，售价翻倍',
                animation: 'nutrient-glow'
            },
            { 
                id: 'time_acceleration', 
                name: '时间加速', 
                icon: '⏰', 
                color: 'text-blue-500',
                effect: 'time_speed',
                duration: 45, // 45秒
                description: '时间流逝加快3倍',
                animation: 'clock-spin'
            },
            
            // 负面事件
            { 
                id: 'pest_invasion', 
                name: '虫害入侵', 
                icon: '🐛', 
                color: 'text-red-500',
                effect: 'pest_damage',
                duration: 20, // 20秒
                description: '作物受到虫害，生长停滞',
                animation: 'pest-crawl'
            },
            { 
                id: 'disease_outbreak', 
                name: '病害爆发', 
                icon: '🦠', 
                color: 'text-purple-500',
                effect: 'disease_damage',
                duration: 25, // 25秒
                description: '作物感染病害，产量减半',
                animation: 'disease-spread'
            },
            { 
                id: 'frost_damage', 
                name: '霜冻伤害', 
                icon: '❄️', 
                color: 'text-cyan-500',
                effect: 'frost_damage',
                duration: 15, // 15秒
                description: '作物受到霜冻，生长缓慢',
                animation: 'frost-freeze'
            },
            { 
                id: 'weed_infestation', 
                name: '杂草丛生', 
                icon: '🌿', 
                color: 'text-brown-500',
                effect: 'weed_competition',
                duration: 35, // 35秒
                description: '杂草抢夺养分，生长减速',
                animation: 'weed-grow'
            },
            
            // 中性事件
            { 
                id: 'mysterious_fog', 
                name: '神秘迷雾', 
                icon: '🌫️', 
                color: 'text-gray-500',
                effect: 'random_effect',
                duration: 40, // 40秒
                description: '迷雾笼罩，随机效果',
                animation: 'fog-swirl'
            },
            { 
                id: 'soil_change', 
                name: '土壤变化', 
                icon: '🌱', 
                color: 'text-orange-500',
                effect: 'soil_alteration',
                duration: 50, // 50秒
                description: '土壤性质改变，影响未知',
                animation: 'soil-shift'
            }
        ];

        // 成就系统
        const achievements = [
            { id: 'first_harvest', name: '初次收获', reward: 20, condition: (state) => state.completedTasks >= 1, unlocked: false },
            { id: 'farmer_10', name: '10级农场主', reward: 100, condition: (state) => state.level >= 10, unlocked: false },
            { id: 'millionaire', name: '百万富翁', reward: 200, condition: (state) => state.money >= 1000, unlocked: false },
            { id: 'seed_collector', name: '种子收集者', reward: 80, condition: (state) => Object.keys(state.purchasedSeeds).length >= 3, unlocked: false },
            { id: 'plot_master', name: '农田大师', reward: 150, condition: (state) => state.plots >= 8, unlocked: false }
        ];

        // DOM元素
        const elements = {
            money: document.getElementById('money'),
            level: document.getElementById('level'),
            xp: document.getElementById('xp'),
            maxXp: document.getElementById('maxXp'),
            plotsCount: document.getElementById('plots-count'),
            farmGrid: document.getElementById('farm-grid'),
            shopItems: document.getElementById('shop-items'),
            inventoryItems: document.getElementById('inventory-items'),
            tasksList: document.getElementById('tasks-list'),
            upgrades: document.getElementById('upgrades'),
            expandFarmBtn: document.getElementById('expand-farm'),
            notifications: document.getElementById('notifications'),
            saveIndicator: document.getElementById('save-indicator')
        };

        // 当前登录账号
        let currentUserAccount = null;
        // 保存游戏数据到本地存储（支持多账号）
        function saveGameData() {
            try {
                // 保存游戏状态
                if(currentUserAccount && currentUserAccount !== 'dyyssb'){
                    localStorage.setItem('happyFarmGameState_' + currentUserAccount, JSON.stringify(gameState));
                } else {
                localStorage.setItem('happyFarmGameState', JSON.stringify(gameState));
                }
                // 如果是普通用户，更新happyFarmUsers中的数据
                const userInfo = JSON.parse(localStorage.getItem('happyFarmUserInfo')||'{}');
                if(userInfo && userInfo.account && userInfo.account !== 'dyyssb'){
                    let users = JSON.parse(localStorage.getItem('happyFarmUsers')||'[]');
                    users = users.map(u => u.account === userInfo.account ? {
                        ...u,
                        lastPlayed: new Date().toLocaleString(),
                        money: gameState.money,
                        xp: gameState.xp,
                        level: gameState.level
                    } : u);
                    localStorage.setItem('happyFarmUsers', JSON.stringify(users));
                }
                // 显示保存指示器
                elements.saveIndicator.classList.add('show');
                setTimeout(() => {
                    elements.saveIndicator.classList.remove('show');
                }, 2000);
                return true;
            } catch (error) {
                console.error('保存游戏数据失败:', error);
                return false;
            }
        }
        // 从本地存储加载游戏数据（支持多账号）
        function loadGameData() {
            try {
                let savedState = null;
                if(currentUserAccount && currentUserAccount !== 'dyyssb'){
                    savedState = localStorage.getItem('happyFarmGameState_' + currentUserAccount);
                } else {
                    savedState = localStorage.getItem('happyFarmGameState');
                }
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    Object.assign(gameState, parsedState);
                    if (!gameState.purchasedSeeds) {
                        gameState.purchasedSeeds = {};
                    }
                    showNotification('游戏数据已加载', 'info');
                    return true;
                }
            } catch (error) {
                console.error('加载游戏数据失败:', error);
            }
            return false;
        }
        // 设置自动保存定时器
        function setupAutoSave() {
            // 每5分钟自动保存一次
            setInterval(() => {
                saveGameData();
            }, 5 * 60 * 1000);

            // 页面卸载时保存
            window.addEventListener('beforeunload', () => {
                saveGameData();
            });
        }

        // 初始化游戏（多账号支持）
        function initGame() {
            // 识别当前账号
            if(!currentUserAccount){
                if(localStorage.getItem('happyFarmLoggedIn') === 'admin'){
                    currentUserAccount = 'dyyssb';
                } else {
                    const userInfo = JSON.parse(localStorage.getItem('happyFarmUserInfo')||'{}');
                    currentUserAccount = userInfo.account || null;
                }
            }
            renderRegionSelect();
            // 从本地存储加载游戏数据
            loadGameData();
            // 初始化regionFarmData结构
            if (!gameState.regionFarmData) gameState.regionFarmData = {};
            if (!gameState.regionPlots) gameState.regionPlots = {};
            
            // 初始化品质库存系统
            if (!gameState.qualityInventory) {
                gameState.qualityInventory = {};
            }
            
            // 初始化当前区域农田
            if (!gameState.regionFarmData[gameState.currentRegion]) {
                if (typeof gameState.regionPlots[gameState.currentRegion] !== 'number') {
                    gameState.regionPlots[gameState.currentRegion] = 4;
                }
                gameState.regionFarmData[gameState.currentRegion] = [];
                for (let i = 0; i < gameState.regionPlots[gameState.currentRegion]; i++) {
                    gameState.regionFarmData[gameState.currentRegion].push({
                        state: 'empty',
                        seedId: null,
                        growth: null,
                        progress: 0,
                        growthTime: 0,
                        plantedAt: null,
                        lastWateredAt: null, // 新增：上次浇水时间戳
                        pest: false,         // 新增：是否有病虫害
                        witherCountdown: 0,  // 新增：干旱天未浇水天数
                        reinforced: false,   // 新增：是否加固（果树）
                        drainageUpgraded: false // 新增：是否升级排水系统
                    });
                }
            }
            gameState.farmData = gameState.regionFarmData[gameState.currentRegion];

            // 检查上次游玩时间
            checkDailyLogin();

            // 获取当前日期
            const today = new Date().toDateString();
            
            // 只有在新的一天或者没有任务时才生成新任务
            if (!gameState.lastTasksGenerated || gameState.lastTasksGenerated !== today || gameState.tasks.length === 0) {
                // 生成今日天气
                generateWeather();
                
                // 生成每日任务
                generateDailyTasks();
                
                // 记录任务生成日期
                gameState.lastTasksGenerated = today;
                saveGameData();
            }

            renderShop();
            renderFarm();
            renderUpgrades();
            renderWeather();
            renderTasks();
            updateUI();
            renderItemShop(); // 确保道具商店渲染
            renderMyItems(); // 确保我的道具渲染
            renderDecorShop(); // 确保装饰商店渲染
            renderPlantProtectionStatus(); // 确保植物保护状态渲染
            renderAnimalShop(); // 确保动物商店渲染
            renderInventory(); // 确保库存显示正确渲染

            // 确保天气效果在初始化时应用
            applyWeatherEffect(gameState.weather);

            // 检查扩展农田按钮
            checkExpandFarmButton();

            // 设置自动保存
            setupAutoSave();

            // 检查管理员按钮
            if(localStorage.getItem('happyFarmLoggedIn') === 'admin'){
                document.getElementById('admin-open-btn').style.display = 'block';
                document.getElementById('admin-grow-btn').style.display = 'block';
            } else {
                document.getElementById('admin-open-btn').style.display = 'none';
                document.getElementById('admin-grow-btn').style.display = 'none';
            }

            // 2. 新增"花费金币刷新天气"按钮
            setupWeatherRefreshBtn();

            // 渲染我的装饰和我的动物
            renderMyDecors();
            renderMyAnimals();

            // 渲染幸福值、动物健康、动物副产品
            renderHappiness();
            renderAnimalHealth();
            renderAnimalProducts();

            // 设置商店标签切换事件
            setupShopTabSwitching();
            
            // 设置牧场管理功能
            setupRanchManagement();
            
            // 设置动物区域切换功能
            setupAnimalAreaSwitching();
            
            // 设置新玩法功能
            setupNewGameplayFeatures();
        }

        // 切换地区背景
        function updateRegionBackground() {
            const body = document.getElementById('main-body');
            body.className = '';
            body.classList.add('min-h-screen');
            body.classList.add('bg-' + gameState.currentRegion);
        }
        // 切换地区时保存/切换农田数据
        function switchRegionFarmData(newRegion) {
            // 保存当前区域农田数据和田数量
            if (gameState.currentRegion) {
                if (!gameState.regionFarmData) gameState.regionFarmData = {};
                gameState.regionFarmData[gameState.currentRegion] = JSON.parse(JSON.stringify(gameState.farmData));
                if (!gameState.regionPlots) gameState.regionPlots = {};
                gameState.regionPlots[gameState.currentRegion] = gameState.plots;
            }
            // 切换到新区域
            gameState.currentRegion = newRegion;
            // 读取新区域农田数量
            if (!gameState.regionPlots) gameState.regionPlots = {};
            if (typeof gameState.regionPlots[newRegion] !== 'number') {
                gameState.regionPlots[newRegion] = 4;
            }
            gameState.plots = gameState.regionPlots[newRegion];
            // 读取新区域农田数据
            if (!gameState.regionFarmData) gameState.regionFarmData = {};
            if (!gameState.regionFarmData[newRegion]) {
                // 初始化新区域农田
                gameState.regionFarmData[newRegion] = [];
                for (let i = 0; i < gameState.plots; i++) {
                    gameState.regionFarmData[newRegion].push({
                        state: 'empty',
                        seedId: null,
                        growth: null,
                        progress: 0,
                        growthTime: 0,
                        plantedAt: null,
                        lastWateredAt: null, // 新增：上次浇水时间戳
                        pest: false,         // 新增：是否有病虫害
                        witherCountdown: 0,  // 新增：干旱天未浇水天数
                        reinforced: false,   // 新增：是否加固（果树）
                        drainageUpgraded: false // 新增：是否升级排水系统
                    });
                }
            }
            gameState.farmData = gameState.regionFarmData[newRegion];
        }
        // 渲染地区下拉菜单
        function renderRegionSelect() {
            const select = document.getElementById('region-select');
            select.innerHTML = regions.map(region =>
                `<option value="${region.id}" ${region.id === gameState.currentRegion ? 'selected' : ''}>${region.name}</option>`
            ).join('');
            select.onchange = function() {
                switchRegionFarmData(this.value);
                saveGameData();
                renderShop();
                renderItemShop();
                renderDecorShop();
                renderAnimalShop();
                renderFarm();
                renderInventory();
                updateRegionBackground();
            };
            // 初始化时也切换背景
            updateRegionBackground();
        }

        // 渲染商店（只显示当前地区的种子）
        function renderShop() {
            const regionSeeds = seeds.filter(seed => seed.regions.includes(gameState.currentRegion));
            elements.shopItems.innerHTML = regionSeeds.map(seed => `
                <div class="seed-item flex flex-col p-4 rounded-2xl ${seed.color} cursor-pointer shadow-lg hover:shadow-2xl transition card-strong" data-seed-id="${seed.id}">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-medium">${seed.icon} ${seed.name}</div>
                            <div class="text-sm text-gray-600">售价: ${seed.sellPrice}金币 | 经验: ${seed.xp}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold">${seed.price}金币</div>
                            <div class="text-xs text-gray-600">${seed.growTime}分钟</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">库存: ${gameState.purchasedSeeds[seed.id] || 0}</span>
                        <button class="buy-btn btn-strong px-4 py-2 text-base" data-seed-id="${seed.id}">
                            <i class="fas fa-shopping-cart mr-2"></i> 购买
                        </button>
                    </div>
                </div>
            `).join('');

            // 添加购买按钮事件
            document.querySelectorAll('.buy-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const seedId = this.getAttribute('data-seed-id');
                    buySeed(seedId);
                });
            });

            // 添加种子选择事件
            document.querySelectorAll('.seed-item').forEach(item => {
                item.addEventListener('click', function() {
                    const seedId = this.getAttribute('data-seed-id');
                    selectSeed(seedId);
                });
            });
        }

        // 购买种子
        function buySeed(seedId) {
            const seed = getSeedById(seedId);

            if (gameState.money >= seed.price) {
                gameState.money -= seed.price;

                if (!gameState.purchasedSeeds[seedId]) {
                    gameState.purchasedSeeds[seedId] = 0;
                }
                gameState.purchasedSeeds[seedId]++;

                updateUI();
                renderShop();
                showNotification(`成功购买 ${seed.name} 种子!`, 'success');

                // 保存游戏数据
                saveGameData();
            } else {
                showNotification('金币不足!', 'error');
            }
        }

        // 选择种子时，判断是否属于本地区
        function selectSeed(seedId) {
            const seed = getSeedById(seedId);
            if (!seed.regions.includes(gameState.currentRegion)) {
                showNotification('该种子不属于当前地区!', 'error');
                return;
            }

            // 检查是否已购买该种子
            if (!gameState.purchasedSeeds[seedId] || gameState.purchasedSeeds[seedId] <= 0) {
                showNotification('请先购买该种子!', 'error');
                return;
            }

            gameState.currentSelectedSeed = seedId;

            // 更新UI显示选中的种子
            document.querySelectorAll('.seed-item').forEach(item => {
                if (item.getAttribute('data-seed-id') === seedId) {
                    item.classList.add('ring-2', 'ring-green-500');
                } else {
                    item.classList.remove('ring-2', 'ring-green-500');
                }
            });

            showNotification(`已选择: ${seed.name}种子`, 'info');
        }

        // 渲染农田（只允许种植本地区的种子）
        function renderFarm() {
            elements.farmGrid.innerHTML = '';
            
            // 确保farmData数组长度与plots一致
            while (gameState.farmData.length < gameState.plots) {
                gameState.farmData.push({
                    state: 'empty', // empty, planted, wasteland
                    seedId: null,
                    growth: null, // null, growing, completed
                    progress: 0,
                    growthTime: 0
                });
            }

            for (let i = 0; i < gameState.plots; i++) {
                const plotData = gameState.farmData[i];
                const plot = document.createElement('div');
                
                // 获取土地改良等级和数据
                const landLevel = getLandImprovementLevel(i);
                const landData = getLandImprovementData(landLevel);
                
                // 根据土地等级设置背景色
                plot.className = `crop-plot ${landData.color} border-2 border-yellow-200 rounded-2xl aspect-square flex flex-col items-center justify-center p-4 cursor-pointer shadow-md hover:shadow-xl transition`;
                
                // 添加土地改良等级指示器
                const landIndicator = document.createElement('div');
                landIndicator.className = 'absolute top-1 left-1 text-xs px-1 py-0.5 bg-black bg-opacity-50 text-white rounded';
                landIndicator.innerHTML = `${landData.icon} ${landData.name}`;
                landIndicator.style.fontSize = '10px';
                plot.style.position = 'relative';
                plot.appendChild(landIndicator);
                
                // 根据地块状态设置不同的显示
                if (plotData.state === 'empty') {
                    // 空闲农田 - 根据土地等级显示不同图标
                    const landIcon = landData.icon;
                    plot.innerHTML += `
                        <div class="text-5xl mb-2">${landIcon}</div>
                        <p class="text-base text-center text-gray-600 font-semibold">空闲农田</p>
                        <div class="w-full bg-gray-200 rounded-full h-2 hidden">
                            <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    `;
                    
                    // 添加土地改良按钮
                    if (landLevel < landImprovementLevels.length - 1) {
                        const nextLevelData = getLandImprovementData(landLevel + 1);
                        const upgradeBtn = document.createElement('button');
                        upgradeBtn.className = 'land-upgrade-btn bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs mt-1';
                        upgradeBtn.textContent = `升级土地 (${nextLevelData.cost}金币)`;
                        upgradeBtn.setAttribute('data-plot-index', i);
                        upgradeBtn.onclick = function(e) {
                            e.stopPropagation();
                            upgradeLandImprovement(i);
                        };
                        plot.appendChild(upgradeBtn);
                    }
                } else if (plotData.state === 'wasteland') {
                    // 荒地 - 保持荒地图标
                    plot.innerHTML += `
                        <div class="text-5xl mb-2">🌵</div>
                        <p class="text-base text-center font-semibold text-red-800">荒地(需修复)</p>
                        <button class="repair-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm mt-1" data-plot-index="${i}">
                            修复 (50金币)
                        </button>
                    `;
                    plot.querySelector('.repair-btn').addEventListener('click', function() {
                        repairPlot(i);
                    });
                } else if (plotData.state === 'planted') {
                    // 已种植
                    const seed = getSeedById(plotData.seedId);
                    if (seed) {
                        plot.setAttribute('data-planted', seed.id);
                        // 计算生长进度和成熟状态，应用土地改良加成
                        if (plotData.plantedAt && plotData.growthTime) {
                            const now = Date.now();
                            const elapsed = (now - plotData.plantedAt) / 1000; // 秒
                            if (plotData.growthTime) {
                                // 应用土地改良的生长速度加成
                                const totalSeconds = (plotData.growthTime * 60) / landData.growthBonus;
                                plotData.progress = elapsed;
                                if (plotData.progress >= totalSeconds) {
                                    plotData.growth = 'completed';
                                    plotData.progress = totalSeconds;
                                } else {
                                    plotData.growth = 'growing';
                                }
                            }
                        }
                        plot.setAttribute('data-growth', plotData.growth);
                        if (plotData.growth === 'completed') {
                            // 成熟的作物
                            plot.innerHTML += `
                                <div class="text-5xl mb-2">${seed.icon}</div>
                                <p class="text-base text-center font-semibold text-green-800">${seed.name}</p>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="progress-bar bg-yellow-500 h-2 rounded-full" style="width: 100%"></div>
                                </div>
                                <p class="text-base text-gray-500 mt-1">可以收获了!</p>
                            `;
                            plot.classList.add('animate-pulse');
                        } else {
                            // 检查植物保护设施
                            checkPlantProtection(i, plotData);
                            
                            // 生长中的作物
                            const totalSeconds = (plotData.growthTime * 60) / landData.growthBonus;
                            let percent = plotData.progress / totalSeconds * 100;
                            if (percent >= 100) {
                                // 没成熟时进度条满了也循环动画
                                percent = (Date.now() % 2000) / 2000 * 100;
                            }
                            plot.innerHTML += `
                                <div class="text-5xl mb-2">${seed.icon}</div>
                                <p class="text-base text-center font-semibold text-green-800">${seed.name}</p>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: ${percent}%"></div>
                                </div>
                                <p class="text-base text-gray-500 mt-1">成长中...</p>
                            `;
                            // 新增：插入浇水按钮和状态
                            let statusHtml = '';
                            if (plotData.pest) {
                                statusHtml += '<span class="text-red-600 font-bold">病虫害</span> ';
                                statusHtml += `<button class='pesticide-btn bg-green-700 hover:bg-green-800 text-white px-2 py-1 rounded text-xs mt-1' data-plot-index='${i}'>用农药(10金币)</button> `;
                                if ((gameState.decors.pest_control || 0) === 0) {
                                    statusHtml += '<span class="text-blue-600 text-xs">(建议购买虫害防治系统)</span> ';
                                    statusHtml += `<button class='buy-protection-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs mt-1' data-facility='pest_control' data-cost='160'>购买虫害防治系统(160金币)</button> `;
                                }
                            }
                            if (plotData.witherCountdown >= 3) statusHtml += '<span class="text-gray-700 font-bold">已枯死</span> ';
                            if (gameState.weather === 'drought' && (!plotData.lastWateredAt || Date.now() - plotData.lastWateredAt > 24*60*60*1000)) {
                                statusHtml += '<span class="text-yellow-700 font-bold">需浇水</span> ';
                                if ((gameState.decors.irrigation_system || 0) === 0) {
                                    statusHtml += '<span class="text-blue-600 text-xs">(建议购买灌溉系统)</span> ';
                                    statusHtml += `<button class='buy-protection-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs mt-1' data-facility='irrigation_system' data-cost='180'>购买灌溉系统(180金币)</button> `;
                                }
                            }
                            if (gameState.weather === 'sunny' && (!plotData.lastWateredAt || Date.now() - plotData.lastWateredAt > 24*60*60*1000)) {
                                statusHtml += '<span class="text-yellow-700 font-bold">需浇水</span> ';
                                if ((gameState.decors.shade_net || 0) === 0) {
                                    statusHtml += '<span class="text-blue-600 text-xs">(建议购买遮阳网)</span> ';
                                    statusHtml += `<button class='buy-protection-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs mt-1' data-facility='shade_net' data-cost='120'>购买遮阳网(120金币)</button> `;
                                }
                            }
                            
                            // 显示保护设施状态
                            if (plotData.weatherProtection) {
                                statusHtml += '<span class="text-green-600 font-bold">🌿 温室保护</span> ';
                            }
                            if (plotData.shadeProtection) {
                                statusHtml += '<span class="text-green-600 font-bold">🌿 遮阳保护</span> ';
                            }
                            if (plotData.windProtection) {
                                statusHtml += '<span class="text-green-600 font-bold">🌿 防风保护</span> ';
                            }
                            if (plotData.frostProtection) {
                                statusHtml += '<span class="text-green-600 font-bold">🌿 防霜保护</span> ';
                            }
                            let wateredToday = false;
                            if (plotData.lastWateredAt) {
                                const last = new Date(plotData.lastWateredAt);
                                const now = new Date();
                                wateredToday = last.getFullYear() === now.getFullYear() && last.getMonth() === now.getMonth() && last.getDate() === now.getDate();
                            }
                            if (wateredToday) {
                                statusHtml += `<button class='water-btn bg-gray-400 text-white px-2 py-1 rounded text-xs mt-1' data-plot-index='${i}' disabled>已浇水</button>`;
                            } else {
                                statusHtml += `<button class='water-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs mt-1' data-plot-index='${i}'>浇水</button>`;
                            }
                            plot.innerHTML += `<div class='mt-2 text-center'>${statusHtml}</div>`;
                        }
                    } else {
                        // 如果找不到种子数据，重置为空闲
                        plotData.state = 'empty';
                        plotData.seedId = null;
                        plotData.growth = null;
                        plot.innerHTML += `
                            <div class="text-5xl mb-2">🌱</div>
                            <p class="text-base text-center text-gray-600 font-semibold">空闲农田</p>
                            <div class="w-full bg-gray-200 rounded-full h-2 hidden">
                                <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        `;
                    }
                }
                
                // 添加事件影响指示器
                const activeEvent = gameState.activeEvents.find(event => 
                    event.affectedPlots.includes(i)
                );
                
                if (activeEvent) {
                    const eventIndicator = document.createElement('div');
                    eventIndicator.className = `event-indicator ${activeEvent.color}`;
                    eventIndicator.innerHTML = activeEvent.icon;
                    eventIndicator.title = `${activeEvent.name}: ${activeEvent.description}`;
                    plot.appendChild(eventIndicator);
                    
                    // 添加事件动画类
                    plot.classList.add(activeEvent.animation);
                }
                
                plot.setAttribute('data-plot-index', i);
                plot.addEventListener('click', () => handlePlotClick(i));
                elements.farmGrid.appendChild(plot);
            }
            
            // 保存游戏数据
            saveGameData();
            // 修正：渲染后立即绑定浇水按钮事件
            setTimeout(() => {
                // 绑定农药按钮事件
                document.querySelectorAll('.pesticide-btn').forEach(btn => {
                    btn.onclick = function(e) {
                        e.stopPropagation();
                        const idx = parseInt(this.getAttribute('data-plot-index'));
                        const plot = gameState.farmData[idx];
                        if (gameState.money < 10) {
                            showNotification('金币不足，无法使用农药', 'error');
                            return;
                        }
                        gameState.money -= 10;
                        plot.pest = false;
                        renderFarm();
                        saveGameData();
                        showNotification('病虫害已清除！', 'success');
                    };
                });
                
                // 绑定浇水按钮事件
                document.querySelectorAll('.water-btn').forEach(btn => {
                    if (btn.disabled) return;
                    btn.onclick = function(e) {
                        e.stopPropagation();
                        const idx = parseInt(this.getAttribute('data-plot-index'));
                        const plot = gameState.farmData[idx];
                        plot.lastWateredAt = Date.now();
                        plot.witherCountdown = 0;
                        renderFarm();
                        saveGameData();
                        showNotification('浇水成功！', 'success');
                    };
                });
                
                // 绑定保护设施购买按钮事件
                document.querySelectorAll('.buy-protection-btn').forEach(btn => {
                    btn.onclick = function(e) {
                        e.stopPropagation();
                        const facility = this.getAttribute('data-facility');
                        const cost = parseInt(this.getAttribute('data-cost'));
                        
                        if (gameState.money < cost) {
                            showNotification('金币不足，无法购买保护设施', 'error');
                            return;
                        }
                        
                        // 购买保护设施
                        gameState.money -= cost;
                        gameState.decors[facility] = (gameState.decors[facility] || 0) + 1;
                        
                        // 切换到装饰商店显示购买结果
                        const decorTab = document.querySelector('.shop-tab-btn[data-category="decor"]');
                        if (decorTab) {
                            decorTab.click();
                        }
                        
                        renderDecorShop();
                        renderMyDecors();
                        renderFarm();
                        updateUI();
                        saveGameData();
                        
                        const facilityNames = {
                            'irrigation_system': '灌溉系统',
                            'greenhouse': '温室大棚',
                            'shade_net': '遮阳网',
                            'wind_break': '防风林',
                            'frost_protection': '防霜设施',
                            'pest_control': '虫害防治系统'
                        };
                        
                        showNotification(`购买${facilityNames[facility]}成功！植物将得到保护`, 'success');
                    };
                });
            }, 0);
        }
        
        // 植物保护系统
        function checkPlantProtection(plotIndex, plotData) {
            const currentWeather = gameState.weather;
            let protectionApplied = false;
            let protectionMessage = '';
            
            // 检查灌溉系统（干旱天气）
            if (currentWeather === 'drought' && (gameState.decors.irrigation_system || 0) > 0) {
                // 自动浇水
                plotData.lastWateredAt = Date.now();
                plotData.witherCountdown = 0;
                protectionApplied = true;
                protectionMessage = '灌溉系统自动浇水';
            }
            
            // 检查温室大棚（恶劣天气）
            if ((currentWeather === 'drought' || currentWeather === 'stormy' || currentWeather === 'typhoon' || currentWeather === 'sandstorm') && 
                (gameState.decors.greenhouse || 0) > 0) {
                // 减少天气影响
                plotData.weatherProtection = true;
                protectionApplied = true;
                protectionMessage += protectionMessage ? '，温室大棚保护' : '温室大棚保护';
            }
            
            // 检查遮阳网（炎热天气）
            if ((currentWeather === 'drought' || currentWeather === 'sunny') && (gameState.decors.shade_net || 0) > 0) {
                // 减少水分蒸发
                plotData.shadeProtection = true;
                protectionApplied = true;
                protectionMessage += protectionMessage ? '，遮阳网保护' : '遮阳网保护';
            }
            
            // 检查防风林（强风天气）
            if ((currentWeather === 'typhoon' || currentWeather === 'stormy') && (gameState.decors.wind_break || 0) > 0) {
                // 减少风害
                plotData.windProtection = true;
                protectionApplied = true;
                protectionMessage += protectionMessage ? '，防风林保护' : '防风林保护';
            }
            
            // 检查防霜设施（寒冷天气）
            if (currentWeather === 'frost' && (gameState.decors.frost_protection || 0) > 0) {
                // 防止霜冻
                plotData.frostProtection = true;
                protectionApplied = true;
                protectionMessage += protectionMessage ? '，防霜设施保护' : '防霜设施保护';
            }
            
            // 检查虫害防治系统
            if (plotData.pest && (gameState.decors.pest_control || 0) > 0) {
                // 自动清除虫害
                plotData.pest = false;
                protectionApplied = true;
                protectionMessage += protectionMessage ? '，虫害防治系统清除虫害' : '虫害防治系统清除虫害';
            }
            
            if (protectionApplied) {
                showNotification(`植物保护设施激活：${protectionMessage}`, 'success');
            }
            
            return protectionApplied;
        }
        
        // 继续植物生长
        function continuePlantGrowth(plotIndex, plot) {
            // 该函数不再需要定时器逻辑，保留空实现或直接移除
        }

        // 处理农田点击
        function handlePlotClick(plotIndex) {
            const plot = document.querySelector(`[data-plot-index="${plotIndex}"]`);

            // 检查地块是否空闲
            if (!plot.hasAttribute('data-planted')) {
                // 如果有选中的种子，则种植
                if (gameState.currentSelectedSeed) {
                    const seed = getSeedById(gameState.currentSelectedSeed);

                    // 直接种植，不消耗金币
                    plantSeed(plotIndex, seed);
                    updateUI();

                    // 保存游戏数据
                    saveGameData();
                } else {
                    showNotification('请先选择一个种子!', 'error');
                }
            } else {
                // 检查作物是否成熟
                if (plot.getAttribute('data-growth') === 'completed') {
                    harvestCrop(plotIndex);
                }
            }
        }

        // 种植种子
        function plantSeed(plotIndex, seed) {
            const plot = document.querySelector(`[data-plot-index="${plotIndex}"]`);
            const plotData = gameState.farmData[plotIndex];

            // 有10%的概率种植失败，变成荒地
            if (Math.random() < 0.1) {
                // 更新游戏状态中的农田数据
                plotData.state = 'wasteland';
                plotData.seedId = null;
                plotData.growth = null;
                plotData.progress = 0;
                plotData.growthTime = 0;
                
                // 更新DOM
                plot.setAttribute('data-state', 'wasteland');
                plot.innerHTML = `
                    <div class="text-5xl mb-2">🌵</div>
                    <p class="text-base text-center font-semibold text-red-800">荒地(需修复)</p>
                    <button class="repair-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm mt-1" data-plot-index="${plotIndex}">
                        修复 (50金币)
                    </button>
                `;
                plot.querySelector('.repair-btn').addEventListener('click', function() {
                    repairPlot(plotIndex);
                });
                showNotification('种植失败! 农田变成了荒地!', 'error');
                
                // 保存游戏数据
                saveGameData();
                return;
            }

            // 获取当前天气
            const weather = weatherTypes.find(w => w.id === gameState.weather);

            // 应用浇水效率升级和天气影响
            let growthTime = seed.growTime *
                           (1 - (gameState.upgrades.watering * 0.1)) *
                           (1 / weather.effect.growth);

            // 应用温室升级减少天气影响
            if (gameState.upgrades.greenhouse > 0) {
                const weatherImpactReduction = 0.5; // 温室减少50%天气影响
                const adjustedGrowthEffect = weather.effect.growth + (1 - weather.effect.growth) * weatherImpactReduction;
                growthTime = seed.growTime * (1 - (gameState.upgrades.watering * 0.1)) * (1 / adjustedGrowthEffect);
            }
            
            // 应用植物保护设施效果
            let protectionBonus = 1.0;
            if ((gameState.decors.greenhouse || 0) > 0) {
                protectionBonus *= 1.2; // 温室大棚提升20%生长速度
            }
            if ((gameState.decors.irrigation_system || 0) > 0) {
                protectionBonus *= 1.1; // 灌溉系统提升10%生长速度
            }
            if ((gameState.decors.shade_net || 0) > 0) {
                protectionBonus *= 1.05; // 遮阳网提升5%生长速度
            }
            
            growthTime = growthTime / protectionBonus;

            // 更新游戏状态中的农田数据
            plotData.state = 'planted';
            plotData.seedId = seed.id;
            plotData.growth = 'growing';
            plotData.progress = 0;
            plotData.growthTime = growthTime;
            plotData.plantedAt = Date.now(); // 新增，记录种植时间戳
            
            // 更新DOM
            plot.setAttribute('data-planted', seed.id);
            plot.setAttribute('data-state', 'planted');
            plot.setAttribute('data-growth', 'growing');
            plot.innerHTML = `
                <div class="text-5xl mb-2">${seed.icon}</div>
                <p class="text-base text-center font-semibold text-green-800">${seed.name}</p>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                    <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-base text-gray-500 mt-1">成长中...</p>
            `;

            // 开始生长计时器
            continuePlantGrowth(plotIndex, plot);

            // 更新种子库存
            gameState.purchasedSeeds[seed.id]--;
            if (gameState.purchasedSeeds[seed.id] <= 0) {
                delete gameState.purchasedSeeds[seed.id];
                gameState.currentSelectedSeed = null;
                // Clear selected seed UI
                document.querySelectorAll('.seed-item').forEach(item => {
                    item.classList.remove('ring-2', 'ring-green-500');
                });
            }
            
            // 更新UI显示种子数量
            updateUI();
            renderShop();
            
            showNotification(`已种植 ${seed.name}!`, 'success');

            // 更新任务进度
            updateTaskProgress('plant');

            // 保存游戏数据
            saveGameData();
        }

        // 收获作物
        function harvestCrop(plotIndex) {
            const plot = document.querySelector(`[data-plot-index="${plotIndex}"]`);
            const plotData = gameState.farmData[plotIndex];
            // 确保地块状态正确
            if (plotData.state !== 'planted' || plotData.growth !== 'completed') {
                showNotification('收获失败：作物未成熟或状态异常', 'error');
                return;
            }
            // 干旱枯死无法收获
            if (plotData.witherCountdown >= 3) {
                showNotification('作物已枯死，无法收获', 'error');
                return;
            }
            const seedId = plotData.seedId;
            const seed = getSeedById(seedId);
            if (!seed) {
                // 如果找不到种子数据，重置为空闲
                plotData.state = 'empty';
                plotData.seedId = null;
                plotData.growth = null;
                plotData.progress = 0;
                plotData.growthTime = 0;
                saveGameData();
                renderFarm();
                showNotification('收获失败：作物数据异常', 'error');
                return;
            }
            // 获取当前天气
            const weather = weatherTypes.find(w => w.id === gameState.weather);

            // 获取土地改良等级和加成
            const landLevel = getLandImprovementLevel(plotIndex);
            const landData = getLandImprovementData(landLevel);
            
            // 应用质量升级、土地改良和天气影响
            let sellPrice = Math.floor(seed.sellPrice * (1 + (gameState.upgrades.quality * 0.15)) * landData.yieldBonus);

            // 根据天气类型应用不同的价格影响
            if (weather) {
                if (weather.id === 'rainbow') {
                    // 彩虹天：产量加成50%
                    sellPrice = Math.floor(sellPrice * 1.5);
                } else if (weather.id === 'sunny') {
                    // 晴天：正常价格，但未浇水减产
                    if (!plotData.lastWateredAt || Date.now() - plotData.lastWateredAt > 24*60*60*1000) {
                        sellPrice = Math.floor(sellPrice * 0.5);
                    }
                } else if (weather.id === 'rainy') {
                    // 雨天：正常价格
                    sellPrice = sellPrice;
                } else if (weather.id === 'stormy') {
                    // 暴雨：价格降低20%
                    sellPrice = Math.floor(sellPrice * 0.8);
                } else if (weather.id === 'drought') {
                    // 干旱：价格降低30%
                    sellPrice = Math.floor(sellPrice * 0.7);
                } else if (weather.id === 'typhoon') {
                    // 台风：价格降低25%
                    sellPrice = Math.floor(sellPrice * 0.75);
                } else if (weather.id === 'sandstorm') {
                    // 沙尘暴：价格降低40%
                    sellPrice = Math.floor(sellPrice * 0.6);
                }
            }
            
            // 应用植物保护设施的价格加成
            let protectionPriceBonus = 1.0;
            if ((gameState.decors.greenhouse || 0) > 0) {
                protectionPriceBonus *= 1.15; // 温室大棚提升15%价格
            }
            if ((gameState.decors.irrigation_system || 0) > 0) {
                protectionPriceBonus *= 1.1; // 灌溉系统提升10%价格
            }
            if ((gameState.decors.shade_net || 0) > 0) {
                protectionPriceBonus *= 1.05; // 遮阳网提升5%价格
            }
            if ((gameState.decors.wind_break || 0) > 0) {
                protectionPriceBonus *= 1.08; // 防风林提升8%价格
            }
            if ((gameState.decors.frost_protection || 0) > 0) {
                protectionPriceBonus *= 1.12; // 防霜设施提升12%价格
            }
            
            sellPrice = Math.floor(sellPrice * protectionPriceBonus);
            
            // 应用事件影响
            if (plotData.qualityMultiplier) {
                sellPrice = Math.floor(sellPrice * plotData.qualityMultiplier);
            }
            if (plotData.disease) {
                sellPrice = Math.floor(sellPrice * 0.5);
            }
            if (plotData.soilEffect) {
                sellPrice = Math.floor(sellPrice * plotData.soilEffect.quality);
            }
            
            // 病虫害减产
            if (plotData.pest) {
                sellPrice = Math.floor(sellPrice * 0.7);
            }
            // 更新游戏状态（只获得经验，不获得金币）
            gameState.xp += seed.xp;
            // 更新任务进度
            updateTaskProgress('harvest');

            // 根据土地品质确定水果品质并更新库存
            const fruitQuality = determineFruitQuality(plotIndex);
            const qualityData = getFruitQualityData(fruitQuality);
            addQualityFruitToInventory(seedId, fruitQuality, 1);
            
            // 同时保持旧库存系统兼容性（暂时）
            if (!gameState.inventory[seedId]) {
                gameState.inventory[seedId] = 0;
            }
            gameState.inventory[seedId]++;

            // 清除病虫害
            plotData.pest = false;
            // 重置地块数据
            plotData.state = 'empty';
            plotData.seedId = null;
            plotData.growth = null;
            plotData.progress = 0;
            plotData.growthTime = 0;
            plotData.lastWateredAt = null;
            plotData.witherCountdown = 0;
            // 重置DOM - 使用土地等级对应的图标
            plot.removeAttribute('data-planted');
            plot.removeAttribute('data-growth');
            plot.classList.remove('animate-pulse');
            plot.innerHTML = `
                <div class="text-5xl mb-2">${landData.icon}</div>
                <p class="text-base text-center text-gray-600 font-semibold">空闲农田</p>
                <div class="w-full bg-gray-200 rounded-full h-2 hidden">
                    <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
            `;
            // 重新添加事件监听
            plot.addEventListener('click', () => handlePlotClick(plotIndex));
            // 更新UI
            updateUI();
            renderInventory();
            // 保存游戏数据
            saveGameData();
            
            // 更新收获统计并检查成就
            gameState.totalHarvested = (gameState.totalHarvested || 0) + 1;
            checkAchievements();
            
            showNotification(`收获 ${qualityData.name}${seed.name}! +${seed.xp}经验，仓库+1`, 'success');
        }

        // 修复荒地
        function repairPlot(plotIndex) {
            const plot = document.querySelector(`[data-plot-index="${plotIndex}"]`);

            if (gameState.money >= 50) {
                gameState.money -= 50;
                
                // 更新游戏状态中的农田数据
                const plotData = gameState.farmData[plotIndex];
                plotData.state = 'empty';
                plotData.seedId = null;
                plotData.growth = null;
                plotData.progress = 0;
                plotData.growthTime = 0;
                
                // 更新DOM - 使用土地等级对应的图标
                plot.removeAttribute('data-state');
                const currentLandLevel = getLandImprovementLevel(plotIndex);
                const currentLandData = getLandImprovementData(currentLandLevel);
                plot.innerHTML = `
                    <div class="text-5xl mb-2">${currentLandData.icon}</div>
                    <p class="text-base text-center text-gray-600 font-semibold">空闲农田</p>
                    <div class="w-full bg-gray-200 rounded-full h-2 hidden">
                        <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                `;
                plot.addEventListener('click', () => handlePlotClick(plotIndex));
                updateUI();
                showNotification('农田修复成功!', 'success');

                // 保存游戏数据
                saveGameData();
            } else {
                showNotification('金币不足!', 'error');
            }
        }

        // 渲染库存（显示所有作物，按品质分类）
        function renderInventory() {
            // 作物/水果列表
            const cropBox = document.getElementById('crop-inventory-list');
            // 动物产品列表
            const animalBox = document.getElementById('animal-inventory-list');

            // 渲染按品质分类的作物/水果
            const qualityInventory = gameState.qualityInventory || {};
            const hasQualityInventory = Object.keys(qualityInventory).length > 0;
            
            if (!hasQualityInventory) {
                cropBox.innerHTML = '<div class="text-gray-500 italic">这里会显示你收获的作物</div>';
            } else {
                let inventoryHtml = '<div class="font-bold text-lg mb-4 flex items-center"><i class="fas fa-apple-alt mr-2 text-green-500"></i>作物/水果 (按品质分类)</div>';
                
                // 遍历每种作物
                Object.entries(qualityInventory).forEach(([seedId, qualityData]) => {
                const seed = getSeedById(seedId);
                    if (!seed) return;
                    
                    // 为每种品质创建单独的条目
                    fruitQualities.forEach(quality => {
                        const count = qualityData[quality.level] || 0;
                        if (count > 0) {
                            const baseSellPrice = Math.floor(seed.sellPrice * (1 + (gameState.upgrades.quality * 0.15)));
                            const qualityPrice = Math.floor(baseSellPrice * quality.priceMultiplier);
                            
                            // 应用天气影响
                const weather = weatherTypes.find(w => w.id === gameState.weather);
                            let adjustedPrice = qualityPrice;
                            if (weather) {
                                if (weather.id === 'rainbow') adjustedPrice = Math.floor(qualityPrice * 1.5);
                                else if (weather.id === 'stormy') adjustedPrice = Math.floor(qualityPrice * 0.8);
                                else if (weather.id === 'drought') adjustedPrice = Math.floor(qualityPrice * 0.7);
                                else if (weather.id === 'typhoon') adjustedPrice = Math.floor(qualityPrice * 0.75);
                                else if (weather.id === 'sandstorm') adjustedPrice = Math.floor(qualityPrice * 0.6);
                            }
                            
                            inventoryHtml += `
                                <div class="flex justify-between items-center p-3 border rounded-lg mb-2 ${quality.color}">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${seed.icon}</span>
                                        <div>
                                            <div class="font-semibold text-lg flex items-center">
                                                <span class="mr-2">${quality.icon}</span>
                                                <span>${quality.name}${seed.name}</span>
                                                <span class="ml-2 text-sm text-gray-600">× ${count}</span>
                        </div>
                                            <div class="text-xs text-gray-500">${quality.description}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" min="1" max="${count}" value="1" class="quality-sell-qty-input w-14 px-1 py-0.5 border rounded text-center mr-1" data-seed-id="${seedId}" data-quality="${quality.level}" />
                                        <button class="quality-sell-btn btn-strong px-4 py-2 text-base" data-seed-id="${seedId}" data-quality="${quality.level}" data-price="${adjustedPrice}">
                            出售 (${adjustedPrice}金币)
                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                });
                
                cropBox.innerHTML = inventoryHtml;
            }
            // 渲染动物产品
            const animalProducts = [
                { id: 'egg', name: '鸡蛋', icon: '🥚', price: 8, card: 'border-l-4 border-gray-200 bg-gray-50' },
                { id: 'milk', name: '牛奶', icon: '🥛', price: 20, card: 'border-l-4 border-blue-200 bg-blue-50' },
                { id: 'wool', name: '羊毛', icon: '🧶', price: 15, card: 'border-l-4 border-gray-200 bg-gray-50' },
                { id: 'pork', name: '猪肉', icon: '🥩', price: 25, card: 'border-l-4 border-green-200 bg-green-50' },
                { id: 'duck_egg', name: '鸭蛋', icon: '🥚', price: 12, card: 'border-l-4 border-gray-200 bg-gray-50' },
                { id: 'goat_milk', name: '羊奶', icon: '🥛', price: 30, card: 'border-l-4 border-green-200 bg-green-50' },
                { id: 'rabbit_fur', name: '兔毛', icon: '🧶', price: 40, card: 'border-l-4 border-blue-200 bg-blue-50' },
                { id: 'horse_manure', name: '马粪', icon: '💩', price: 5, card: 'border-l-4 border-gray-200 bg-gray-50' }
            ];
            let hasAnimalProduct = false;
            animalBox.innerHTML = '<div class="font-bold text-xl mb-4 flex items-center"><i class="fas fa-gift mr-2 text-green-600"></i>动物副产品</div>' +
                animalProducts.map(p => {
                    const count = gameState.animalProducts[p.id] || 0;
                    if (count > 0) hasAnimalProduct = true;
                    return `
                        <div class="flex justify-between items-center rounded-xl shadow-sm px-5 py-4 mb-4 ${p.card}">
                            <div class="flex items-center">
                                <span class="text-4xl mr-4">${p.icon}</span>
                                <div>
                                    <div class="font-bold text-xl">${p.name}</div>
                                    <div class="text-gray-500 text-base">售价: ${p.price}金币</div>
                                </div>
                            </div>
                            <div class="flex flex-col items-end">
                                <div class="font-bold text-green-700 text-lg mb-2">数量: <span>${count}</span></div>
                                <button class="sell-animal-btn bg-yellow-400 hover:bg-yellow-500 text-white font-bold px-6 py-2 rounded-lg text-lg" data-product-id="${p.id}" data-price="${p.price}" ${count === 0 ? 'disabled style=\'opacity:0.5;cursor:not-allowed;\'' : ''}>出售</button>
                            </div>
                    </div>
                `;
            }).join('');
            if (!hasAnimalProduct) {
                animalBox.innerHTML += '<div class="text-gray-500 italic">这里会显示你获得的动物产品</div>';
            }
            // 绑定动物产品出售按钮
            document.querySelectorAll('.sell-animal-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-product-id');
                    const price = parseInt(this.getAttribute('data-price'));
                    if ((gameState.animalProducts[id]||0) < 1) return;
                    gameState.animalProducts[id] -= 1;
                    gameState.money += price;
                    renderInventory();
                    updateUI();
                    saveGameData();
                    const productNames = {
                        'egg': '鸡蛋', 'milk': '牛奶', 'wool': '羊毛', 'pork': '猪肉',
                        'duck_egg': '鸭蛋', 'goat_milk': '羊奶', 'rabbit_fur': '兔毛', 'horse_manure': '马粪'
                    };
                    showNotification(`出售${productNames[id]} ×1成功！+${price}金币`,'success');
                });
            });
            
            // 绑定品质作物出售按钮
            document.querySelectorAll('.quality-sell-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const seedId = this.getAttribute('data-seed-id');
                    const quality = parseInt(this.getAttribute('data-quality'));
                    const price = parseInt(this.getAttribute('data-price'));
                    const qtyInput = document.querySelector(`.quality-sell-qty-input[data-seed-id="${seedId}"][data-quality="${quality}"]`);
                    const qty = parseInt(qtyInput.value) || 1;
                    sellQualityFruit(seedId, quality, qty, price);
                });
            });
            
            // 绑定作物出售按钮（旧系统兼容）
            document.querySelectorAll('.sell-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const seedId = this.getAttribute('data-seed-id');
                    const qtyInput = document.querySelector(`.sell-qty-input[data-seed-id="${seedId}"]`);
                    const qty = parseInt(qtyInput.value) || 1;
                    sellCrops(seedId, qty);
                });
            });
        }

        // 出售作物，支持数量
        function sellCrops(seedId, qty = 1) {
            if (gameState.inventory[seedId] && gameState.inventory[seedId] > 0) {
                qty = Math.max(1, Math.min(qty, gameState.inventory[seedId]));
                const seed = getSeedById(seedId);
                const sellPrice = Math.floor(seed.sellPrice * (1 + (gameState.upgrades.quality * 0.15)));
                const weather = weatherTypes.find(w => w.id === gameState.weather);
                let adjustedPrice = sellPrice;
                
                // 根据天气类型应用不同的价格影响
                if (weather) {
                    if (weather.id === 'rainbow') {
                        // 彩虹天：产量加成50%
                        adjustedPrice = Math.floor(sellPrice * 1.5);
                    } else if (weather.id === 'sunny') {
                        // 晴天：正常价格
                        adjustedPrice = sellPrice;
                    } else if (weather.id === 'rainy') {
                        // 雨天：正常价格
                        adjustedPrice = sellPrice;
                    } else if (weather.id === 'stormy') {
                        // 暴雨：价格降低20%
                        adjustedPrice = Math.floor(sellPrice * 0.8);
                    } else if (weather.id === 'drought') {
                        // 干旱：价格降低30%
                        adjustedPrice = Math.floor(sellPrice * 0.7);
                    } else if (weather.id === 'typhoon') {
                        // 台风：价格降低25%
                        adjustedPrice = Math.floor(sellPrice * 0.75);
                    } else if (weather.id === 'sandstorm') {
                        // 沙尘暴：价格降低40%
                        adjustedPrice = Math.floor(sellPrice * 0.6);
                } else {
                        // 默认正常价格
                        adjustedPrice = sellPrice;
                }
                }
                
                gameState.money += adjustedPrice * qty;
                gameState.inventory[seedId] -= qty;
                if (gameState.inventory[seedId] <= 0) {
                    delete gameState.inventory[seedId];
                }
                updateUI();
                renderInventory();
                showNotification(`售出 ${seed.name} ×${qty}! +${adjustedPrice * qty}金币`, 'success');
                // 更新任务进度
                updateTaskProgress('sell', adjustedPrice * qty);
                // 保存游戏数据
                saveGameData();
            }
        }

        // 渲染升级
        function renderUpgrades() {
            elements.upgrades.innerHTML = upgrades.map(upgrade => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                    <div>
                        <h3 class="font-semibold">${upgrade.name} (${gameState.upgrades[upgrade.id]}/${upgrade.maxLevel})</h3>
                        <p class="text-sm text-gray-600">${upgrade.description}</p>
                    </div>
                    <button class="upgrade-btn ${gameState.upgrades[upgrade.id] >= upgrade.maxLevel ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'} text-white px-3 py-1 rounded-lg"
                            data-upgrade="${upgrade.id}"
                            data-cost="${upgrades.find(u => u.id === upgrade.id).cost * (gameState.upgrades[upgrade.id] + 1)}"
                            ${gameState.upgrades[upgrade.id] >= upgrade.maxLevel ? 'disabled' : ''}>
                        <i class="fas fa-arrow-up mr-1"></i> ${upgrades.find(u => u.id === upgrade.id).cost * (gameState.upgrades[upgrade.id] + 1)}金币
                    </button>
                </div>
            `).join('');

            // 添加升级按钮事件
            document.querySelectorAll('.upgrade-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const upgradeId = this.getAttribute('data-upgrade');
                    const cost = parseInt(this.getAttribute('data-cost'));

                    purchaseUpgrade(upgradeId, cost);
                });
            });
        }
                // 购买升级
        function purchaseUpgrade(upgradeId, cost) {
            if (gameState.upgrades[upgradeId] >= upgrades.find(u => u.id === upgradeId).maxLevel) return;
            if (gameState.money >= cost && cost > 0) {
                gameState.money -= cost;
                gameState.upgrades[upgradeId]++;
                updateUI();
                renderUpgrades();

                showNotification(`升级 ${upgrades.find(u => u.id === upgradeId).name} 成功!`, 'success');

                // 更新任务进度
                updateTaskProgress('upgrade');

                // 保存游戏数据
                saveGameData();
            } else {
                showNotification('金币不足!', 'error');
            }
        }

        // 扩展农场
        elements.expandFarmBtn.addEventListener('click', function() {
            if (gameState.money >= 200 && gameState.plots < gameState.maxPlots) {
                gameState.money -= 200;
                // 只扩展当前区域
                if (!gameState.regionPlots) gameState.regionPlots = {};
                if (!gameState.regionFarmData) gameState.regionFarmData = {};
                if (typeof gameState.regionPlots[gameState.currentRegion] !== 'number') {
                    gameState.regionPlots[gameState.currentRegion] = 4;
                }
                gameState.regionPlots[gameState.currentRegion]++;
                gameState.plots = gameState.regionPlots[gameState.currentRegion];
                if (!gameState.regionFarmData[gameState.currentRegion]) {
                    gameState.regionFarmData[gameState.currentRegion] = [];
                }
                while (gameState.regionFarmData[gameState.currentRegion].length < gameState.plots) {
                    gameState.regionFarmData[gameState.currentRegion].push({
                        state: 'empty',
                        seedId: null,
                        growth: null,
                        progress: 0,
                        growthTime: 0
                    });
                }
                gameState.farmData = gameState.regionFarmData[gameState.currentRegion];
                updateUI();
                renderFarm();
                checkExpandFarmButton();

                showNotification('农场扩展成功!', 'success');

                // 更新任务进度
                updateTaskProgress('expand');
                
                // 检查土地扩展成就
                checkAchievements();

                // 保存游戏数据
                saveGameData();
            }
        });

        // 检查是否可以扩展农场
        function checkExpandFarmButton() {
            if (gameState.plots >= gameState.maxPlots) {
                elements.expandFarmBtn.disabled = true;
                elements.expandFarmBtn.textContent = '已达到最大农田数量';
            } else {
                elements.expandFarmBtn.disabled = gameState.money < 200;
            }
        }

        // 检查是否升级
        function checkLevelUp() {
            if (gameState.xp >= gameState.maxXp) {
                gameState.level++;
                gameState.xp = gameState.xp - gameState.maxXp;
                gameState.maxXp = Math.floor(gameState.maxXp * 1.5);

                showNotification(`升级到 ${gameState.level} 级!`, 'info');

                // 每2级解锁一个新种子
                if (gameState.level % 2 === 0 && gameState.level / 2 <= seeds.length) {
                    const newSeedIndex = Math.floor(gameState.level / 2) - 1;
                    if (newSeedIndex < seeds.length && !gameState.purchasedSeeds[seeds[newSeedIndex].id]) {
                        showNotification(`解锁新种子: ${seeds[newSeedIndex].name}!`, 'info');
                    }
                }

                updateUI();

                // 保存游戏数据
                saveGameData();
            }
        }

        // 更新UI
        function updateUI() {
            elements.money.textContent = gameState.money;
            elements.level.textContent = gameState.level;
            elements.xp.textContent = gameState.xp;
            elements.maxXp.textContent = gameState.maxXp;
            elements.plotsCount.textContent = gameState.plots;

            // 更新商店种子可用性
            document.querySelectorAll('.seed-item').forEach(item => {
                const seedId = item.getAttribute('data-seed-id');
                const seed = getSeedById(seedId);

                if (gameState.money < seed.price) {
                    item.classList.add('opacity-50');
                } else {
                    item.classList.remove('opacity-50');
                }
                
                // 更新种子数量显示
                const inventorySpan = item.querySelector('span.text-sm');
                if (inventorySpan) {
                    inventorySpan.textContent = `库存: ${gameState.purchasedSeeds[seedId] || 0}`;
                }
            });

            // 检查扩展农田按钮
            checkExpandFarmButton();
        }

        // 通过ID获取种子
        function getSeedById(id) {
            return seeds.find(seed => seed.id === id);
        }

        // 获取土地改良等级
        function getLandImprovementLevel(plotIndex) {
            if (!gameState.regionLandImprovements[gameState.currentRegion]) {
                return 0;
            }
            return gameState.regionLandImprovements[gameState.currentRegion][plotIndex] || 0;
        }

        // 设置土地改良等级
        function setLandImprovementLevel(plotIndex, level) {
            if (!gameState.regionLandImprovements[gameState.currentRegion]) {
                gameState.regionLandImprovements[gameState.currentRegion] = {};
            }
            gameState.regionLandImprovements[gameState.currentRegion][plotIndex] = level;
        }

        // 获取土地改良数据
        function getLandImprovementData(level) {
            return landImprovementLevels.find(l => l.level === level) || landImprovementLevels[0];
        }

        // 升级土地改良
        function upgradeLandImprovement(plotIndex) {
            const currentLevel = getLandImprovementLevel(plotIndex);
            const nextLevel = currentLevel + 1;
            
            if (nextLevel >= landImprovementLevels.length) {
                showNotification('土地已达到最高等级！', 'info');
                return;
            }
            
            const nextLevelData = getLandImprovementData(nextLevel);
            if (gameState.money < nextLevelData.cost) {
                showNotification(`金币不足！需要 ${nextLevelData.cost} 金币`, 'error');
                return;
            }
            
            gameState.money -= nextLevelData.cost;
            setLandImprovementLevel(plotIndex, nextLevel);
            
            showNotification(`土地改良成功！升级到 ${nextLevelData.name}`, 'success');
            updateUI();
            renderFarm();
            saveGameData();
        }

        // 生成每日天气
        function generateWeather() {
            const weatherWeights = [0.5, 0.25, 0.15, 0.1]; // 晴天、雨天、阴天、暴风雨的概率权重
            const random = Math.random();
            let cumulativeWeight = 0;

            for (let i = 0; i < weatherTypes.length; i++) {
                cumulativeWeight += weatherWeights[i];
                if (random <= cumulativeWeight) {
                    gameState.weather = weatherTypes[i].id;
                    break;
                }
            }
            
            // 注意：不在这里保存游戏数据，避免重复保存
            // 保存操作已移至initGame函数中
        }

        // 渲染天气信息
        function renderWeather() {
            const weatherIcon = document.getElementById('weather-icon');
            const weatherName = document.getElementById('weather-name');
            const weatherEffects = document.getElementById('weather-effects');
            let icon = '☀️', name = '晴天', effects = '生长+0% 售价+0%';
            switch(gameState.weather){
                case 'sunny':
                    icon = '☀️'; name = '晴天'; effects = '生长+0% 售价+0%'; break;
                case 'rainy':
                    icon = '🌧️'; name = '雨天'; effects = '生长+10% 售价-5%'; break;
                case 'cloudy':
                    icon = '☁️'; name = '阴天'; effects = '生长-5% 售价+0%'; break;
                case 'stormy':
                    icon = '⛈️'; name = '暴风雨'; effects = '生长-20% 售价-10%'; break;
                case 'typhoon':
                    icon = '🌀'; name = '台风'; effects = '作物易倒伏，生长-50%'; break;
                case 'rainbow':
                    icon = '🌈'; name = '彩虹天'; effects = '生长+20% 售价+10%'; break;
            }
            weatherIcon.textContent = icon;
            weatherName.textContent = name;
            weatherEffects.textContent = effects;
            
            // 同时更新牧场天气显示
            updateRanchWeather();
        }
        
        // 成就系统弹窗控制
        function initAchievementModal() {
            const achievementBtn = document.getElementById('achievement-btn');
            const achievementModal = document.getElementById('achievement-modal');
            const achievementOverlay = document.getElementById('achievement-overlay');
            const closeBtn = document.getElementById('close-achievement-modal');
            
            // 成就按钮点击事件
            achievementBtn.addEventListener('click', function() {
                showAchievementModal();
            });
            
            // 关闭按钮点击事件
            closeBtn.addEventListener('click', function() {
                hideAchievementModal();
            });
            
            // 遮罩层点击事件
            achievementOverlay.addEventListener('click', function() {
                hideAchievementModal();
            });
            
            // ESC键关闭弹窗
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideAchievementModal();
                }
            });
        }
        
        // 显示成就弹窗
        function showAchievementModal() {
            const achievementModal = document.getElementById('achievement-modal');
            const achievementOverlay = document.getElementById('achievement-overlay');
            
            // 渲染成就内容
            renderAchievementModal();
            
            // 显示弹窗和遮罩
            achievementModal.classList.add('show');
            achievementOverlay.classList.add('show');
            
            // 禁用背景滚动
            document.body.style.overflow = 'hidden';
        }
        
        // 隐藏成就弹窗
        function hideAchievementModal() {
            const achievementModal = document.getElementById('achievement-modal');
            const achievementOverlay = document.getElementById('achievement-overlay');
            
            // 隐藏弹窗和遮罩
            achievementModal.classList.remove('show');
            achievementOverlay.classList.remove('show');
            
            // 恢复背景滚动
            document.body.style.overflow = '';
        }
        

        
        // 应用天气视觉效果
        function applyWeatherEffect(weatherId) {
            const body = document.getElementById('main-body');
            
            // 移除所有天气效果类
            body.classList.remove('weather-sunny', 'weather-rainy', 'weather-stormy', 
                                'weather-drought', 'weather-typhoon', 'weather-rainbow', 'weather-sandstorm');
            
            // 添加当前天气效果类
            body.classList.add(`weather-${weatherId}`);
            
            // 更新牧场天气显示
            updateRanchWeather();
            
            // 显示天气对动物的影响提示
            const currentWeatherEffect = ranchEnvironment.weatherEffects[weatherId];
            if (currentWeatherEffect) {
                const effects = currentWeatherEffect.animalEffects;
                let message = `天气变为${currentWeatherEffect.title}！`;
                
                if (effects.benefits.length > 0) {
                    message += `\n动物好处：${effects.benefits.join('、')}`;
                }
                if (effects.drawbacks.length > 0) {
                    message += `\n动物坏处：${effects.drawbacks.join('、')}`;
                }
                
                const notificationType = effects.drawbacks.length > effects.benefits.length ? 'warning' : 'info';
                showNotification(message, notificationType);
                
                // 立即处理动物天气应对
                handleAnimalWeatherResponse();
                renderAnimalWeatherStatus();
            }
        }

        // 生成每日任务
        function generateDailyTasks() {
            const shuffled = [...tasks].sort(() => 0.5 - Math.random());
            gameState.tasks = shuffled.slice(0, 3).map(task => ({
                ...task,
                progress: 0,
                completed: false
            }));
            
            // 注意：不在这里保存游戏数据，避免重复保存
            // 保存操作已移至initGame函数中
        }

        // 渲染任务列表
        function renderTasks() {
            const tasksList = document.getElementById('tasks-list');

            if (gameState.tasks.length === 0) {
                tasksList.innerHTML = '<p class="text-gray-500 italic">今日没有任务</p>';
                return;
            }

            tasksList.innerHTML = gameState.tasks.map(task => `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium">${task.name}</h3>
                        <span class="text-sm ${task.completed ? 'text-green-600' : 'text-gray-600'}">
                            ${task.progress}/${task.goal}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${task.desc}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="progress-bar bg-blue-500 h-2 rounded-full"
                             style="width: ${Math.min(task.progress / task.goal * 100, 100)}%">
                        </div>
                    </div>
                    <div class="mt-2 text-sm text-right">
                        <span class="text-yellow-600">奖励: ${task.reward}金币</span>
                        ${task.completed ?
                          '<span class="ml-2 text-green-600">✓ 已完成</span>' :
                          '<button class="ml-2 claim-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs" ' +
                          'data-task-id="${task.id}" ${task.completed ? "hidden" : ""}>完成任务</button>'}
                    </div>
                </div>
            `).join('');

            // 添加领取奖励按钮事件
            document.querySelectorAll('.claim-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    claimTaskReward(taskId);
                });
            });
        }

        // 完成特定类型的任务进度
        function updateTaskProgress(type, amount = 1) {
            let updated = false;

            gameState.tasks.forEach(task => {
                if (!task.completed && (
                    (type === 'harvest' && task.id.startsWith('harvest')) ||
                    (type === 'plant' && task.id.startsWith('plant')) ||
                    (type === 'sell' && task.id.startsWith('sell')) ||
                    (type === 'upgrade' && task.id.startsWith('upgrade')) ||
                    (type === 'expand' && task.id.startsWith('expand'))
                )) {
                    task.progress += amount;
                    if (task.progress >= task.goal) {
                        task.completed = true;
                        showNotification(`任务完成: ${task.name}`, 'info');
                    }
                    updated = true;
                }
            });

            if (updated) {
                renderTasks();

                // 保存游戏数据
                saveGameData();
            }
        }

        // 领取任务奖励
        function claimTaskReward(taskId) {
            const task = gameState.tasks.find(t => t.id === taskId);
            if (task && task.completed) {
                gameState.money += task.reward;
                gameState.completedTasks++;

                // 移除已领取的任务
                gameState.tasks = gameState.tasks.filter(t => t.id !== taskId);

                updateUI();
                renderTasks();
                checkAchievements();

                showNotification(`已领取任务奖励 +${task.reward}金币`, 'success');

                // 保存游戏数据
                saveGameData();
            }
        }

        // 检查成就
        function checkAchievements() {
            let newAchievements = false;

            achievements.forEach(achievement => {
                if (!gameState.achievements.includes(achievement.id) &&
                    achievement.condition(gameState)) {

                    gameState.achievements.push(achievement.id);
                    gameState.money += achievement.reward;
                    newAchievements = true;

                    showNotification(`解锁成就: ${achievement.name}! +${achievement.reward}金币`, 'info');
                }
            });

            if (newAchievements) {
                updateUI();

                // 保存游戏数据
                saveGameData();
            }
        }

        // 检查连续登录
        function checkDailyLogin() {
            const today = new Date().toDateString();
            const lastPlayed = gameState.lastPlayed;

            if (!lastPlayed) {
                // 首次游玩
                gameState.dailyStreak = 1;
            } else if (lastPlayed !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (lastPlayed === yesterday.toDateString()) {
                    gameState.dailyStreak++;
                } else {
                    gameState.dailyStreak = 1;
                }
            }

            gameState.lastPlayed = today;

            // 每日登录奖励
            if (lastPlayed !== today) {
                const reward = 10 * gameState.dailyStreak;
                gameState.money += reward;

                showNotification(`连续登录 ${gameState.dailyStreak} 天! +${reward}金币`, 'info');
                updateUI();

                // 保存游戏数据
                saveGameData();
            }
        }

        // 显示通知
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification p-3 rounded-lg shadow-lg text-white fade-in ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'}`;
            notification.innerHTML = `<p>${message}</p>`;

            elements.notifications.appendChild(notification);

            // 3秒后移除通知
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // 登录逻辑
        function checkLogin() {
            const loginModal = document.getElementById('login-modal');
            const logoutBtn = document.getElementById('logout-btn');
            const isLoggedIn = localStorage.getItem('happyFarmLoggedIn');
            if (!isLoggedIn) {
                loginModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                // 确保退出登录按钮在登录弹窗时也可见
                logoutBtn.style.display = 'block';
                logoutBtn.style.zIndex = '9999';
            } else {
                loginModal.style.display = 'none';
                document.body.style.overflow = '';
                // 确保退出登录按钮在游戏界面时也可见
                logoutBtn.style.display = 'block';
                logoutBtn.style.zIndex = '9999';
            }
        }
        // 退出登录逻辑
        function setupLogoutBtn() {
            const logoutBtn = document.getElementById('logout-btn');
            // 始终显示退出登录按钮（即使在登录弹窗时也可见）
            logoutBtn.style.display = 'block';
            logoutBtn.style.zIndex = '9999';
            
            // 移除之前的事件监听器，避免重复绑定
            logoutBtn.removeEventListener('click', handleLogout);
            // 添加新的事件监听器
            logoutBtn.addEventListener('click', handleLogout);
        }
        
        // 退出登录处理函数
        function handleLogout() {
            console.log('退出登录按钮被点击');
                localStorage.removeItem('happyFarmLoggedIn');
            localStorage.removeItem('happyFarmUserInfo');
            currentUserAccount = null;
                location.reload();
        }
        // DOM加载完成后立即设置退出登录按钮
        document.addEventListener('DOMContentLoaded', function() {
            setupLogoutBtn();
        });
        
        // 页面加载时先检查登录
        window.onload = function() {
            // 立即设置退出登录按钮
            setupLogoutBtn();
            setupLoginRegisterSwitch();
            checkLogin();
            if (localStorage.getItem('happyFarmLoggedIn')) {
                initGame();
            }
            // 管理员按钮显示逻辑
            if(localStorage.getItem('happyFarmLoggedIn') === 'admin'){
                document.getElementById('admin-open-btn').style.display = 'block';
                document.getElementById('admin-grow-btn').style.display = 'block';
            } else {
                document.getElementById('admin-open-btn').style.display = 'none';
                document.getElementById('admin-grow-btn').style.display = 'none';
            }
            document.getElementById('admin-open-btn').onclick = function() {
                showAdminPanel();
            };
            document.getElementById('admin-grow-btn').onclick = function() {
                // 立即完成所有农田作物生长
                if(Array.isArray(gameState.farmData)){
                    for(let i=0;i<gameState.farmData.length;i++){
                        if(gameState.farmData[i].state === 'planted' && gameState.farmData[i].growth !== 'completed'){
                            gameState.farmData[i].growth = 'completed';
                            // 立即成熟，直接把种植时间戳往前推到成熟
                            gameState.farmData[i].progress = gameState.farmData[i].growthTime * 60;
                            gameState.farmData[i].plantedAt = Date.now() - gameState.farmData[i].growthTime * 60 * 1000;
                        }
                    }
                    renderFarm();
                    saveGameData();
                    showNotification('所有作物已成熟！', 'success');
                }
            };

            // 新增：全局定时器，每秒刷新所有地区所有农田的生长进度
            setInterval(function() {
                // 刷新所有地区的农田数据
                if (gameState.regionFarmData) {
                    for (const regionId in gameState.regionFarmData) {
                        const farmArr = gameState.regionFarmData[regionId];
                        if (Array.isArray(farmArr)) {
                            for (let i = 0; i < farmArr.length; i++) {
                                const plotData = farmArr[i];
                                if (plotData.state === 'planted' && plotData.plantedAt && plotData.growthTime) {
                                    const now = Date.now();
                                    const elapsed = (now - plotData.plantedAt) / 1000;
                                    
                                    // 计算事件影响
                                    let timeMultiplier = 1;
                                    if (plotData.timeSpeedMultiplier) {
                                        timeMultiplier = plotData.timeSpeedMultiplier;
                                    }
                                    if (plotData.growthSpeedMultiplier) {
                                        timeMultiplier *= plotData.growthSpeedMultiplier;
                                    }
                                    
                                    // 应用时间倍数
                                    const adjustedElapsed = elapsed * timeMultiplier;
                                    plotData.progress = adjustedElapsed;
                                    
                                    if (plotData.growthTime) {
                                        const totalSeconds = plotData.growthTime * 60; // growTime 单位变为分钟
                                        if (plotData.progress >= totalSeconds) {
                                            plotData.growth = 'completed';
                                            plotData.progress = totalSeconds;
                                        } else {
                                            plotData.growth = 'growing';
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                // 只刷新当前地区的农田显示
                renderFarm();
            }, 1000);
        };

        // 管理员面板逻辑
        function showAdminPanel() {
            const adminPanel = document.getElementById('admin-panel');
            adminPanel.style.display = 'flex';
            // 显示当前游戏数据
            document.getElementById('admin-money').value = gameState.money;
            document.getElementById('admin-xp').value = gameState.xp;
            document.getElementById('admin-level').value = gameState.level;
            document.getElementById('admin-weather').value = gameState.weather;
            // 实时天气切换
            const adminWeather = document.getElementById('admin-weather');
            adminWeather.onchange = function() {
                gameState.weather = this.value;
                updateUI();
                renderWeather();
                saveGameData();
                showNotification('天气已切换', 'success');
            };
            // 显示所有用户信息
            const users = JSON.parse(localStorage.getItem('happyFarmUsers') || '[]');
            const typeMap = { account: '账号密码', qq: 'QQ', wx: '微信', douyin: '抖音' };
            let html = '<table class="min-w-full border text-center"><thead><tr><th class="border px-2">账号</th><th class="border px-2">注册方式</th><th class="border px-2">最近游玩</th><th class="border px-2">金币</th><th class="border px-2">经验</th><th class="border px-2">等级</th></tr></thead><tbody>';
            users.forEach(u => {
                html += `<tr><td class="border px-2">${u.account}</td><td class="border px-2">${typeMap[u.type]||u.type}</td><td class="border px-2">${u.lastPlayed||''}</td><td class="border px-2">${u.money||''}</td><td class="border px-2">${u.xp||''}</td><td class="border px-2">${u.level||''}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('admin-users-list').innerHTML = html;
            // 保存按钮
            document.getElementById('admin-save').onclick = function() {
                gameState.money = parseInt(document.getElementById('admin-money').value)||0;
                gameState.xp = parseInt(document.getElementById('admin-xp').value)||0;
                gameState.level = parseInt(document.getElementById('admin-level').value)||1;
                gameState.weather = document.getElementById('admin-weather').value;
                updateUI();
                renderWeather();
                saveGameData();
                showNotification('数据已保存', 'success');
            };
            // 重置按钮
            if (!document.getElementById('admin-reset')) {
                const resetBtn = document.createElement('button');
                resetBtn.id = 'admin-reset';
                resetBtn.className = 'bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-bold mt-2 ml-2';
                resetBtn.textContent = '重置管理员数据';
                document.getElementById('admin-save').after(resetBtn);
                resetBtn.onclick = function() {
                    // 彻底重置管理员自己的数据
                    const def = getDefaultGameState();
                    for (const k in def) gameState[k] = def[k];
                    // 初始化所有区域农田
                    for (const region of regions) {
                        gameState.regionFarmData[region.id] = [];
                        for (let i = 0; i < gameState.plots; i++) {
                            gameState.regionFarmData[region.id].push({
                                state: 'empty',
                                seedId: null,
                                growth: null,
                                progress: 0,
                                growthTime: 0
                            });
                        }
                    }
                    gameState.farmData = gameState.regionFarmData[gameState.currentRegion];
                    saveGameData();
                    updateUI();
                    renderFarm();
                    renderWeather();
                    renderShop();
                    renderInventory();
                    renderUpgrades();
                    renderTasks();
                    checkExpandFarmButton();
                    showNotification('管理员数据已重置', 'success');
                    // 刷新面板数据
                    showAdminPanel();
                };
            }
            // 关闭按钮
            document.getElementById('admin-close').onclick = function() {
                adminPanel.style.display = 'none';
            };
            // 随机事件管理
            const eventsList = document.getElementById('admin-events-list');
            if (eventsList) {
                eventsList.innerHTML = randomEvents.map(event => `
                    <div class="flex items-center gap-2 p-2 border rounded-lg">
                        <span class="text-2xl">${event.icon}</span>
                        <span class="font-bold">${event.name}</span>
                        <span class="text-xs text-gray-500">${event.description}</span>
                        <button class="admin-trigger-event bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded ml-auto" data-event-id="${event.id}">触发</button>
                    </div>
                `).join('');
                // 绑定触发事件按钮
                eventsList.querySelectorAll('.admin-trigger-event').forEach(btn => {
                    btn.onclick = function() {
                        const eventId = this.getAttribute('data-event-id');
                        const event = randomEvents.find(e => e.id === eventId);
                        if (!event) return;
                        // 随机影响部分地块
                        const plantedPlots = gameState.farmData.filter(p => p.state === 'planted');
                        if (plantedPlots.length === 0) {
                            showNotification('当前没有已种植作物，无法触发事件', 'error');
                            return;
                        }
                        const affectedCount = Math.max(1, Math.floor(Math.random() * plantedPlots.length));
                        const affectedIndexes = [];
                        while (affectedIndexes.length < affectedCount) {
                            const idx = Math.floor(Math.random() * gameState.farmData.length);
                            if (!affectedIndexes.includes(idx) && gameState.farmData[idx].state === 'planted') {
                                affectedIndexes.push(idx);
                            }
                        }
                        const now = Date.now();
                        const eventObj = {
                            ...event,
                            affectedPlots: affectedIndexes,
                            startTime: now
                        };
                        gameState.activeEvents.push(eventObj);
                        gameState.lastEventTime = now;
                        showNotification(`管理员触发事件：${event.icon} ${event.name} - ${event.description}`,'info');
                        // 应用事件效果
                        affectedIndexes.forEach(i => {
                            const plot = gameState.farmData[i];
                            switch(event.effect){
                                case 'growth_boost':
                                    plot.growthSpeedMultiplier = 1.5; break;
                                case 'instant_growth':
                                    plot.progress = plot.growthTime * 60; plot.growth = 'completed'; break;
                                case 'quality_boost':
                                    plot.qualityBoost = true; break;
                                case 'time_speed':
                                    plot.timeSpeedMultiplier = 3; break;
                                case 'pest_damage':
                                    plot.pest = true; break;
                                case 'disease_damage':
                                    plot.disease = true; break;
                                case 'frost_damage':
                                    plot.growthSpeedMultiplier = 0.5; break;
                                case 'weed_competition':
                                    plot.growthSpeedMultiplier = 0.7; break;
                                case 'random_effect':
                                    if (Math.random()<0.5) plot.pest = true; else plot.growthSpeedMultiplier = 2; break;
                            }
                        });
                        renderFarm();
                        saveGameData();
                        // 定时移除事件
                        setTimeout(()=>{
                            affectedIndexes.forEach(i => {
                                const plot = gameState.farmData[i];
                                delete plot.growthSpeedMultiplier;
                                delete plot.timeSpeedMultiplier;
                                delete plot.qualityBoost;
                                delete plot.disease;
                            });
                            gameState.activeEvents = gameState.activeEvents.filter(e=>e!==eventObj);
                            renderFarm();
                            saveGameData();
                        }, event.duration*1000 || 20000);
                    };
                });
            }
        }

        // 登录/注册弹窗切换逻辑
        function setupLoginRegisterSwitch() {
            // 注册方式按钮->具体注册表单
            document.querySelectorAll('.register-way-btn').forEach(btn => {
                btn.onclick = function() {
                    const type = this.getAttribute('data-type');
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('register-choice').style.display = 'none';
                    document.getElementById('register-form').style.display = 'flex';
                    document.getElementById('login-divider').style.visibility = 'hidden';
                    // 设置icon和标题
                    let icon = '', title = '';
                    if(type==='qq'){
                        icon = '<i class="fab fa-qq"></i>';
                        title = 'QQ注册';
                    } else if(type==='wx'){
                        icon = '<i class="fab fa-weixin"></i>';
                        title = '微信注册';
                    } else if(type==='douyin'){
                        icon = '<i class="fab fa-tiktok"></i>';
                        title = '抖音注册';
                    } else {
                        icon = '<i class="fas fa-user"></i>';
                        title = '账号密码注册';
                    }
                    document.getElementById('register-icon').innerHTML = icon;
                    document.getElementById('register-title').textContent = title;
                    document.getElementById('register-form').setAttribute('data-type', type);
                };
            });
            // 注册表单->返回登录主界面
            document.getElementById('register-back-choice').onclick = function() {
                document.getElementById('register-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'flex';
                document.getElementById('register-choice').style.display = 'flex';
                document.getElementById('login-divider').style.visibility = 'visible';
            };
        }

        // 注册表单提交逻辑（独立）
        document.getElementById('register-form').onsubmit = function(e) {
            e.preventDefault();
            const type = this.getAttribute('data-type');
            const account = document.getElementById('register-account').value;
            const password = document.getElementById('register-password').value;
            if(!account || !password){
                showNotification('请输入账号和密码', 'error');
                return;
            }
            if(account === 'dyyssb'){
                showNotification('该账号为管理员专用，不能注册！', 'error');
                return;
            }
            let users = JSON.parse(localStorage.getItem('happyFarmUsers') || '[]');
            if(users.find(u => u.account === account)){
                showNotification('该账号已被注册！', 'error');
                return;
            }
            const userInfo = {
                type,
                account,
                password,
                lastPlayed: new Date().toLocaleString(),
                money: 100,
                xp: 0,
                level: 1
            };
            users.push(userInfo);
            localStorage.setItem('happyFarmUsers', JSON.stringify(users));
            localStorage.setItem('happyFarmUserInfo', JSON.stringify(userInfo));
            localStorage.setItem('happyFarmLoggedIn', type);
            currentUserAccount = userInfo.account;
            document.getElementById('login-modal').style.display = 'none';
            document.body.style.overflow = '';
            showNotification('注册并登录成功！', 'success');
            document.getElementById('admin-open-btn').style.display = 'none';
            document.getElementById('admin-grow-btn').style.display = 'none';
            initGame();
        };

        // 获取初始游戏状态
        function getDefaultGameState() {
            return {
                money: 100,
                level: 1,
                xp: 0,
                maxXp: 100,
                plots: 4,
                maxPlots: 12,
                regionPlots: {},
                inventory: {},
                qualityInventory: {},
                upgrades: { watering: 0, quality: 0, greenhouse: 0 },
                currentSelectedSeed: null,
                purchasedSeeds: {},
                weather: 'sunny',
                dailyStreak: 0,
                lastPlayed: null,
                completedTasks: 0,
                achievements: [],
                currentRegion: 'north_china',
                tasks: [],
                regionFarmData: {},
                farmData: [],
            };
        }

        // 每日刷新天气影响
        function dailyWeatherAffect() {
            const weather = weatherTypes.find(w => w.id === gameState.weather);
            if (!weather) return;
            // 遍历所有地区所有农田
            for (const regionId in gameState.regionFarmData) {
                const farmArr = gameState.regionFarmData[regionId];
                if (!Array.isArray(farmArr)) continue;
                for (let i = 0; i < farmArr.length; i++) {
                    const plot = farmArr[i];
                    // 只处理已种植作物
                    if (plot.state !== 'planted') continue;
                    // 晴天：未浇水则记为未浇水
                    if (weather.id === 'sunny') {
                        // nothing, 收获时判断
                    }
                    // 雨天：10%概率病虫害
                    if (weather.id === 'rainy') {
                        let scarecrowCount = gameState.decors.scarecrow||0;
                        let pestChance = 0.1 * (1 - Math.min(scarecrowCount*0.1,0.5));
                        if (Math.random() < pestChance) plot.pest = true;
                    }
                    // 暴雨：未升级排水的农田变荒地
                    if (weather.id === 'stormy') {
                        if (!plot.drainageUpgraded) {
                            plot.state = 'wasteland';
                            plot.seedId = null;
                            plot.growth = null;
                            plot.progress = 0;
                            plot.growthTime = 0;
                            plot.plantedAt = null;
                            plot.lastWateredAt = null;
                            plot.pest = false;
                            plot.witherCountdown = 0;
                        }
                    }
                    // 干旱：未浇水天数+1，3天未浇水枯死
                    if (weather.id === 'drought') {
                        const now = Date.now();
                        if (!plot.lastWateredAt || now - plot.lastWateredAt > 24*60*60*1000) {
                            plot.witherCountdown = (plot.witherCountdown || 0) + 1;
                        } else {
                            plot.witherCountdown = 0;
                        }
                        if (plot.witherCountdown >= 3) {
                            plot.state = 'wasteland';
                            plot.seedId = null;
                            plot.growth = null;
                            plot.progress = 0;
                            plot.growthTime = 0;
                            plot.plantedAt = null;
                            plot.lastWateredAt = null;
                            plot.pest = false;
                            plot.witherCountdown = 0;
                        }
                    }
                    // 台风：未加固果树倒伏
                    if (weather.id === 'typhoon') {
                        const fruitTreeIds = ['apple','banana','grape','apricot','melon','mikan','walnut','sakura'];
                        if (fruitTreeIds.includes(plot.seedId) && !plot.reinforced) {
                            plot.state = 'wasteland';
                            plot.seedId = null;
                            plot.growth = null;
                            plot.progress = 0;
                            plot.growthTime = 0;
                            plot.plantedAt = null;
                            plot.lastWateredAt = null;
                            plot.pest = false;
                            plot.witherCountdown = 0;
                        }
                    }
                }
            }
        }

        // 在initGame和generateDailyTasks后调用
        dailyWeatherAffect();

        // 3. 浇水按钮交互
        setTimeout(() => {
            document.querySelectorAll('.water-btn').forEach(btn => {
                if (btn.disabled) return;
                btn.onclick = function(e) {
                    e.stopPropagation();
                    const idx = parseInt(this.getAttribute('data-plot-index'));
                    const plot = gameState.farmData[idx];
                    plot.lastWateredAt = Date.now();
                    plot.witherCountdown = 0;
                    renderFarm();
                    saveGameData();
                    showNotification('浇水成功！', 'success');
                };
            });
        }, 0);

        // 1. 每天自动刷新天气
        function autoRefreshWeather() {
            // 按权重概率生成天气，权重越高越常见
            const weatherPool = [
                { id: 'sunny', weight: 30 },
                { id: 'rainy', weight: 20 },
                { id: 'stormy', weight: 8 },
                { id: 'drought', weight: 6 },
                { id: 'typhoon', weight: 4 },
                { id: 'rainbow', weight: 2 },
                { id: 'sandstorm', weight: 2 }
            ];
            let total = weatherPool.reduce((sum, w) => sum + w.weight, 0);
            let r = Math.random() * total;
            let newWeather = 'sunny';
            for (let w of weatherPool) {
                if (r < w.weight) {
                    newWeather = w.id;
                    break;
                }
                r -= w.weight;
            }
            
            // 如果天气发生变化，显示特殊效果
            if (newWeather !== gameState.weather) {
                const oldWeather = weatherTypes.find(w => w.id === gameState.weather);
                const newWeatherObj = weatherTypes.find(w => w.id === newWeather);
                
                // 显示天气变化动画
                showWeatherChangeAnimation(oldWeather, newWeatherObj);
            }
            
            gameState.weather = newWeather;
            saveGameData();
            renderWeather();
            dailyWeatherAffect();
            renderFarm();
            
            // 同时更新牧场天气显示
            updateRanchWeather();
        }
        
        // 显示天气变化动画
        function showWeatherChangeAnimation(oldWeather, newWeather) {
            // 创建天气变化通知
            const notification = document.createElement('div');
            notification.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-80 text-white p-6 rounded-lg text-center z-[10000]';
            notification.innerHTML = `
                <div class="text-4xl mb-4">${oldWeather ? oldWeather.icon : '🌤️'} → ${newWeather.icon}</div>
                <div class="text-xl mb-2">${oldWeather ? oldWeather.name : '未知'} → ${newWeather.name}</div>
                <div class="text-sm opacity-75">天气正在变化...</div>
            `;
            
            document.body.appendChild(notification);
            
            // 3秒后移除通知
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // 2. 新增"花费金币刷新天气"按钮
        function setupWeatherRefreshBtn() {
            if (!document.getElementById('weather-refresh-btn')) {
                const btn = document.createElement('button');
                btn.id = 'weather-refresh-btn';
                btn.className = 'ml-4 px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded shadow';
                btn.textContent = '花10金币刷新天气';
                document.getElementById('weather-name').parentNode.appendChild(btn);
                btn.onclick = function() {
                    if (gameState.money < 10) {
                        showNotification('金币不足，无法刷新天气', 'error');
                        return;
                    }
                    gameState.money -= 10;
                    
                    // 显示刷新动画
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刷新中...';
                    btn.disabled = true;
                    
                    setTimeout(() => {
                        autoRefreshWeather();
                        updateUI();
                        showNotification('已刷新天气', 'success');
                        btn.innerHTML = '花10金币刷新天气';
                        btn.disabled = false;
                    }, 1000);
                };
            }
        }

        // 在initGame和每日刷新时调用 autoRefreshWeather 和 setupWeatherRefreshBtn
        // 例如initGame最后加：
        setupWeatherRefreshBtn();

        // 随机事件系统自动触发
        setInterval(function() {
            // 仅在有作物时才触发
            const plantedPlots = gameState.farmData.filter(p => p.state === 'planted');
            if (plantedPlots.length === 0) return;
            // 事件冷却
            const now = Date.now();
            if (now - (gameState.lastEventTime || 0) < gameState.eventCooldown) return;
            if (Math.random() < gameState.eventChance) {
                // 随机选一个事件
                const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
                // 随机影响部分地块
                const affectedCount = Math.max(1, Math.floor(Math.random() * plantedPlots.length));
                const affectedIndexes = [];
                while (affectedIndexes.length < affectedCount) {
                    const idx = Math.floor(Math.random() * gameState.farmData.length);
                    if (!affectedIndexes.includes(idx) && gameState.farmData[idx].state === 'planted') {
                        affectedIndexes.push(idx);
                    }
                }
                // 记录事件
                const eventObj = {
                    ...event,
                    affectedPlots: affectedIndexes,
                    startTime: now
                };
                gameState.activeEvents.push(eventObj);
                gameState.lastEventTime = now;
                // 弹窗提示
                showNotification(`随机事件：${event.icon} ${event.name} - ${event.description}`,'info');
                // 应用事件效果
                affectedIndexes.forEach(i => {
                    const plot = gameState.farmData[i];
                    switch(event.effect){
                        case 'growth_boost':
                            plot.growthSpeedMultiplier = 1.5; break;
                        case 'instant_growth':
                            plot.progress = plot.growthTime * 60; plot.growth = 'completed'; break;
                        case 'quality_boost':
                            plot.qualityBoost = true; break;
                        case 'time_speed':
                            plot.timeSpeedMultiplier = 3; break;
                        case 'pest_damage':
                            plot.pest = true; break;
                        case 'disease_damage':
                            plot.disease = true; break;
                        case 'frost_damage':
                            plot.growthSpeedMultiplier = 0.5; break;
                        case 'weed_competition':
                            plot.growthSpeedMultiplier = 0.7; break;
                        case 'random_effect':
                            if (Math.random()<0.5) plot.pest = true; else plot.growthSpeedMultiplier = 2; break;
                    }
                });
                renderFarm();
                saveGameData();
                // 定时移除事件
                setTimeout(()=>{
                    // 移除事件效果
                    affectedIndexes.forEach(i => {
                        const plot = gameState.farmData[i];
                        delete plot.growthSpeedMultiplier;
                        delete plot.timeSpeedMultiplier;
                        delete plot.qualityBoost;
                        delete plot.disease;
                        // 病虫害需玩家手动处理
                    });
                    // 移除事件
                    gameState.activeEvents = gameState.activeEvents.filter(e=>e!==eventObj);
                    renderFarm();
                    saveGameData();
                }, event.duration*1000 || 20000);
            }
        }, 30000);

        // 渲染植物保护状态
        function renderPlantProtectionStatus() {
            const box = document.getElementById('plant-protection-list');
            if (!box) return;
            
            const protectionFacilities = [
                { id: 'irrigation_system', name: '灌溉系统', icon: '💧', desc: '自动为植物浇水，抵御干旱', effect: '干旱天气自动浇水', price: 180 },
                { id: 'greenhouse', name: '温室大棚', icon: '🏠', desc: '保护植物免受恶劣天气影响', effect: '减少天气影响，提升生长速度', price: 250 },
                { id: 'shade_net', name: '遮阳网', icon: '🌿', desc: '在炎热天气为植物遮阳', effect: '减少水分蒸发，提升生长速度', price: 120 },
                { id: 'wind_break', name: '防风林', icon: '🌳', desc: '保护植物免受强风影响', effect: '减少风害，提升收获价格', price: 150 },
                { id: 'frost_protection', name: '防霜设施', icon: '❄️', desc: '保护植物免受霜冻伤害', effect: '防止霜冻，提升收获价格', price: 200 },
                { id: 'pest_control', name: '虫害防治系统', icon: '🕷️', desc: '自动防治植物病虫害', effect: '自动清除虫害', price: 160 }
            ];
            
            const currentWeather = gameState.weather;
            let weatherEffectHtml = '';
            
            // 显示当前天气对植物的影响
            if (currentWeather === 'drought') {
                weatherEffectHtml = '<div class="mb-3 p-2 bg-red-50 border-l-4 border-red-500"><div class="text-sm text-red-700"><strong>当前天气：干旱</strong></div><div class="text-xs text-red-600">植物需要频繁浇水，建议使用灌溉系统</div></div>';
            } else if (currentWeather === 'sunny') {
                weatherEffectHtml = '<div class="mb-3 p-2 bg-yellow-50 border-l-4 border-yellow-500"><div class="text-sm text-yellow-700"><strong>当前天气：晴天</strong></div><div class="text-xs text-yellow-600">植物需要适量浇水，建议使用遮阳网</div></div>';
            } else if (currentWeather === 'stormy' || currentWeather === 'typhoon') {
                weatherEffectHtml = '<div class="mb-3 p-2 bg-blue-50 border-l-4 border-blue-500"><div class="text-sm text-blue-700"><strong>当前天气：强风</strong></div><div class="text-xs text-blue-600">植物可能受到风害，建议使用防风林</div></div>';
            }
            
            box.innerHTML = weatherEffectHtml + protectionFacilities.map(facility => {
                const count = gameState.decors[facility.id] || 0;
                const isActive = count > 0;
                const canBuy = gameState.money >= facility.price;
                return `
                    <div class="flex items-center gap-2 p-2 rounded ${isActive ? 'bg-green-50 border-l-4 border-green-500' : 'bg-gray-50'} shadow-sm">
                        <span class="text-2xl">${facility.icon}</span>
                        <div class="flex-1">
                            <div class="font-bold">${facility.name}</div>
                            <div class="text-xs text-gray-500">${facility.desc}</div>
                            <div class="text-xs text-green-600">${facility.effect}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-green-700">数量: ${count}</div>
                            ${isActive ? '<div class="text-xs text-green-600 font-semibold">已激活</div>' : ''}
                            <button class="buy-plant-protection bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-sm mt-1" data-facility-id="${facility.id}" data-facility-price="${facility.price}" ${canBuy ? '' : 'disabled style=\'opacity:0.5;cursor:not-allowed;\''}>购买(${facility.price}金币)</button>
                        </div>
                    </div>
                `;
            }).join('');
            // 绑定购买按钮事件
            setTimeout(()=>{
                document.querySelectorAll('.buy-plant-protection').forEach(btn => {
                    btn.onclick = function(e) {
                        const id = this.getAttribute('data-facility-id');
                        const price = parseInt(this.getAttribute('data-facility-price'));
                        if (gameState.money < price) {
                            showNotification('金币不足，无法购买','error');
                            return;
                        }
                        gameState.money -= price;
                        gameState.decors[id] = (gameState.decors[id]||0)+1;
                        renderPlantProtectionStatus();
                        renderDecorShop();
                        renderMyDecors();
                        updateUI();
                        saveGameData();
                        showNotification(`购买${protectionFacilities.find(f=>f.id===id).name}成功！`,'success');
                    };
                });
            },0);
        }
        
        // 渲染我的道具
        function renderMyItems() {
            const box = document.getElementById('my-items-list');
            if (!box) return;
            
            const items = [
                { id: 'pesticide', name: '农药', icon: '🧪', desc: '清除虫害' },
                { id: 'medicine', name: '药剂', icon: '💊', desc: '治愈病害' },
                { id: 'weedkiller', name: '除草剂', icon: '🌿', desc: '清除杂草' },
                { id: 'insulation', name: '保温布', icon: '🧣', desc: '抵御霜冻' },
                // 动物相关道具
                { id: 'animal_feed', name: '高级饲料', icon: '🌾', desc: '提升动物健康度和产出', animalItem: true },
                { id: 'vitamin_pill', name: '维生素丸', icon: '💊', desc: '快速恢复动物健康', animalItem: true },
                { id: 'stress_relief_pill', name: '安抚药丸', icon: '😌', desc: '降低动物压力值', animalItem: true },
                { id: 'water_supplement', name: '水分补充剂', icon: '💧', desc: '快速补充动物水分', animalItem: true },
                { id: 'healing_ointment', name: '治疗药膏', icon: '🩹', desc: '治疗动物伤病', animalItem: true },
                { id: 'happiness_treat', name: '幸福零食', icon: '🍪', desc: '提升动物幸福值', animalItem: true },
                { id: 'weather_protection', name: '天气防护剂', icon: '🛡️', desc: '临时抵御恶劣天气影响', animalItem: true },
                { id: 'growth_hormone', name: '生长激素', icon: '📈', desc: '提升动物产出效率', animalItem: true }
            ];
            
            box.innerHTML = items.map(item => {
                const count = gameState.items[item.id] || 0;
                return `
                    <div class="flex items-center gap-2 p-2 rounded ${item.animalItem ? 'bg-blue-50 border-l-4 border-blue-500' : 'bg-gray-50'} shadow-sm">
                        <span class="text-2xl">${item.icon}</span>
                        <div class="flex-1">
                            <div class="font-bold">${item.name}</div>
                            <div class="text-xs text-gray-500">${item.desc}</div>
                            ${item.animalItem ? '<div class="text-xs text-blue-600 font-semibold">动物专用道具</div>' : ''}
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-green-700">库存: ${count}</div>
                            ${item.animalItem ? '<div class="text-xs text-blue-600">可在动物管理中使用</div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 渲染道具商店和道具数量
        function renderItemShop() {
            const shop = document.getElementById('item-shop');
            if (!shop) return;
            const items = [
                { id: 'pesticide', name: '农药', price: 10, desc: '清除虫害', icon: '🧪' },
                { id: 'medicine', name: '药剂', price: 15, desc: '治愈病害', icon: '💊' },
                { id: 'weedkiller', name: '除草剂', price: 8, desc: '清除杂草', icon: '🌿' },
                { id: 'insulation', name: '保温布', price: 12, desc: '抵御霜冻', icon: '🧣' },
                // 动物相关道具
                { id: 'animal_feed', name: '高级饲料', price: 25, desc: '提升动物健康度和产出', icon: '🌾', animalItem: true },
                { id: 'vitamin_pill', name: '维生素丸', price: 30, desc: '快速恢复动物健康', icon: '💊', animalItem: true },
                { id: 'stress_relief_pill', name: '安抚药丸', price: 20, desc: '降低动物压力值', icon: '😌', animalItem: true },
                { id: 'water_supplement', name: '水分补充剂', price: 18, desc: '快速补充动物水分', icon: '💧', animalItem: true },
                { id: 'healing_ointment', name: '治疗药膏', price: 35, desc: '治疗动物伤病', icon: '🩹', animalItem: true },
                { id: 'happiness_treat', name: '幸福零食', price: 15, desc: '提升动物幸福值', icon: '🍪', animalItem: true },
                { id: 'weather_protection', name: '天气防护剂', price: 40, desc: '临时抵御恶劣天气影响', icon: '🛡️', animalItem: true },
                { id: 'growth_hormone', name: '生长激素', price: 50, desc: '提升动物产出效率', icon: '📈', animalItem: true }
            ];
            shop.innerHTML = items.map(item => `
                <div class="flex items-center gap-2 p-2 rounded ${item.animalItem ? 'bg-blue-50 border-l-4 border-blue-500' : 'bg-gray-50'} shadow-sm">
                    <span class="text-2xl">${item.icon}</span>
                    <div class="flex-1">
                        <div class="font-bold">${item.name}</div>
                        <div class="text-xs text-gray-500">${item.desc}</div>
                        ${item.animalItem ? '<div class="text-xs text-blue-600 font-semibold">动物专用道具</div>' : ''}
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-green-700">库存: ${gameState.items[item.id]||0}</div>
                        <button class="buy-item ${item.animalItem ? 'bg-blue-500 hover:bg-blue-600' : 'bg-green-500 hover:bg-green-600'} text-white px-2 py-1 rounded text-sm" data-item-id="${item.id}">购买(${item.price}金币)</button>
                    </div>
                </div>
            `).join('');
            shop.querySelectorAll('.buy-item').forEach(btn => {
                btn.onclick = function() {
                    const id = this.getAttribute('data-item-id');
                    const item = items.find(i=>i.id===id);
                    if (gameState.money < item.price) {
                        showNotification('金币不足，无法购买','error'); return;
                    }
                    gameState.money -= item.price;
                    gameState.items[id] = (gameState.items[id]||0)+1;
                    renderItemShop();
                    renderMyItems();
                    updateUI();
                    saveGameData();
                    showNotification(`购买${item.name}成功！`,'success');
                };
            });
        }

        // 渲染装饰商店和我的装饰
        function renderDecorShop() {
          const shop = document.getElementById('decor-shop');
          if (!shop) return;
          const decors = [
            // 天气应对设施
            { id: 'shelter', name: '动物庇护所', price: 150, desc: '为动物提供庇护，减少恶劣天气影响', icon: '🏠', weatherProtection: true },
            { id: 'water_system', name: '自动饮水系统', price: 120, desc: '自动为动物补充水分', icon: '💧', weatherProtection: true },
            { id: 'cooling_system', name: '降温系统', price: 100, desc: '在炎热天气为动物降温', icon: '❄️', weatherProtection: true },
            { id: 'medical_kit', name: '医疗箱', price: 200, desc: '治疗动物伤病，恢复健康', icon: '🏥', weatherProtection: true },
            { id: 'stress_relief', name: '安抚设施', price: 80, desc: '安抚动物，降低压力值', icon: '🎵', weatherProtection: true },
            { id: 'activity_zone', name: '活动区', price: 90, desc: '提升动物幸福值', icon: '🎪', weatherProtection: true },
            // 植物保护设施
            { id: 'irrigation_system', name: '灌溉系统', price: 180, desc: '自动为植物浇水，抵御干旱', icon: '💧', plantProtection: true },
            { id: 'greenhouse', name: '温室大棚', price: 250, desc: '保护植物免受恶劣天气影响', icon: '🏠', plantProtection: true },
            { id: 'shade_net', name: '遮阳网', price: 120, desc: '在炎热天气为植物遮阳', icon: '🌿', plantProtection: true },
            { id: 'wind_break', name: '防风林', price: 150, desc: '保护植物免受强风影响', icon: '🌳', plantProtection: true },
            { id: 'frost_protection', name: '防霜设施', price: 200, desc: '保护植物免受霜冻伤害', icon: '❄️', plantProtection: true },
            { id: 'pest_control', name: '虫害防治系统', price: 160, desc: '自动防治植物病虫害', icon: '🕷️', plantProtection: true }
          ];
                      shop.innerHTML = decors.map(decor => `
              <div class="flex items-center gap-2 p-2 rounded ${decor.weatherProtection ? 'bg-blue-50 border-l-4 border-blue-500' : decor.plantProtection ? 'bg-green-50 border-l-4 border-green-500' : 'bg-gray-50'} shadow-sm">
                <span class="text-2xl">${decor.icon}</span>
                <div class="flex-1">
                  <div class="font-bold">${decor.name}</div>
                  <div class="text-xs text-gray-500">${decor.desc}</div>
                  ${decor.weatherProtection ? '<div class="text-xs text-blue-600 font-semibold">天气应对设施</div>' : ''}
                  ${decor.plantProtection ? '<div class="text-xs text-green-600 font-semibold">植物保护设施</div>' : ''}
                </div>
                <div class="text-right">
                  <div class="text-sm text-green-700">库存: ${gameState.decors[decor.id]||0}</div>
                  <button class="buy-decor ${decor.weatherProtection ? 'bg-blue-500 hover:bg-blue-600' : decor.plantProtection ? 'bg-green-500 hover:bg-green-600' : 'bg-green-500 hover:bg-green-600'} text-white px-2 py-1 rounded text-sm" data-decor-id="${decor.id}">购买(${decor.price}金币)</button>
                </div>
              </div>
            `).join('');
          shop.querySelectorAll('.buy-decor').forEach(btn => {
            btn.onclick = function() {
              const id = this.getAttribute('data-decor-id');
              const decor = decors.find(d=>d.id===id);
              if (gameState.money < decor.price) {
                showNotification('金币不足，无法购买','error'); return;
              }
              gameState.money -= decor.price;
              gameState.decors[id] = (gameState.decors[id]||0)+1;
              renderDecorShop();
              renderMyDecors();
              renderPlantProtectionStatus();
              updateUI();
              saveGameData();
              showNotification(`购买${decor.name}成功！`,'success');
            };
          });
        }
        function renderMyDecors() {
          const box = document.getElementById('my-decors');
          if (!box) return;
          const decors = [
            // 天气应对设施
            { id: 'shelter', name: '动物庇护所', icon: '🏠', weatherProtection: true },
            { id: 'water_system', name: '自动饮水系统', icon: '💧', weatherProtection: true },
            { id: 'cooling_system', name: '降温系统', icon: '❄️', weatherProtection: true },
            { id: 'medical_kit', name: '医疗箱', icon: '🏥', weatherProtection: true },
            { id: 'stress_relief', name: '安抚设施', icon: '🎵', weatherProtection: true },
            { id: 'activity_zone', name: '活动区', icon: '🎪', weatherProtection: true },
            // 植物保护设施
            { id: 'irrigation_system', name: '灌溉系统', icon: '💧', plantProtection: true },
            { id: 'greenhouse', name: '温室大棚', icon: '🏠', plantProtection: true },
            { id: 'shade_net', name: '遮阳网', icon: '🌿', plantProtection: true },
            { id: 'wind_break', name: '防风林', icon: '🌳', plantProtection: true },
            { id: 'frost_protection', name: '防霜设施', icon: '❄️', plantProtection: true },
            { id: 'pest_control', name: '虫害防治系统', icon: '🕷️', plantProtection: true }
          ];
          
          // 添加土地改良状态显示
          let landImprovementHtml = '<div class="mb-4"><h3 class="font-bold text-lg mb-2 flex items-center"><i class="fas fa-seedling mr-2 text-green-500"></i>土地改良状态</h3>';
          
          // 统计各等级土地数量
          const landStats = { 0: 0, 1: 0, 2: 0, 3: 0 };
          for (let i = 0; i < gameState.plots; i++) {
            const level = getLandImprovementLevel(i);
            landStats[level]++;
          }
          
          // 显示土地改良统计
          landImprovementHtml += '<div class="grid grid-cols-2 gap-2 text-sm">';
          landImprovementLevels.forEach(levelData => {
            const count = landStats[levelData.level];
            landImprovementHtml += `
              <div class="flex items-center gap-1 p-2 ${levelData.color} rounded">
                <span class="text-lg">${levelData.icon}</span>
                <span class="font-semibold">${levelData.name}: ${count}块</span>
              </div>
            `;
          });
          landImprovementHtml += '</div></div>';
          
          box.innerHTML = landImprovementHtml + decors.map(decor => `
            <div class="flex items-center gap-2 p-2 rounded ${decor.weatherProtection ? 'bg-blue-50 border-l-4 border-blue-500' : decor.plantProtection ? 'bg-green-50 border-l-4 border-green-500' : 'bg-gray-50'} shadow-sm">
              <span class="text-2xl">${decor.icon}</span>
              <div class="flex-1">
                <div class="font-bold">${decor.name}</div>
                ${decor.weatherProtection ? '<div class="text-xs text-blue-600 font-semibold">天气应对设施</div>' : ''}
                ${decor.plantProtection ? '<div class="text-xs text-green-600 font-semibold">植物保护设施</div>' : ''}
              </div>
              <div class="text-right">
                <div class="text-sm text-green-700">数量: ${gameState.decors[decor.id]||0}</div>
                ${decor.weatherProtection ? '<div class="text-xs text-blue-600">已激活</div>' : ''}
                ${decor.plantProtection ? '<div class="text-xs text-green-600">已激活</div>' : ''}
              </div>
            </div>
          `).join('');
        }

        // 渲染动物商店和我的动物
        function renderAnimalShop() {
          const shop = document.getElementById('animal-shop');
          if (!shop) return;
          const animals = [
            { id: 'chicken', name: '鸡', price: 60, desc: '产蛋', icon: '🐔', rarity: 'common' },
            { id: 'cow', name: '牛', price: 200, desc: '产奶', icon: '🐄', rarity: 'common' },
            { id: 'sheep', name: '羊', price: 120, desc: '产羊毛', icon: '🐑', rarity: 'common' },
            { id: 'pig', name: '猪', price: 150, desc: '产猪肉', icon: '🐷', rarity: 'uncommon' },
            { id: 'duck', name: '鸭子', price: 80, desc: '产鸭蛋', icon: '🦆', rarity: 'common' },
            { id: 'goat', name: '山羊', price: 180, desc: '产羊奶', icon: '🐐', rarity: 'uncommon' },
            { id: 'rabbit', name: '兔子', price: 100, desc: '产兔毛', icon: '🐰', rarity: 'rare' },
            { id: 'horse', name: '马', price: 500, desc: '产肥料', icon: '🐎', rarity: 'epic' }
          ];
          
          // 根据稀有度添加颜色
          const rarityColors = {
            common: 'bg-gray-100',
            uncommon: 'bg-green-100', 
            rare: 'bg-blue-100',
            epic: 'bg-purple-100'
          };
          
          shop.innerHTML = animals.map(animal => `
            <div class="flex items-center gap-2 p-2 rounded ${rarityColors[animal.rarity]} border-l-4 ${animal.rarity === 'epic' ? 'border-purple-500' : animal.rarity === 'rare' ? 'border-blue-500' : animal.rarity === 'uncommon' ? 'border-green-500' : 'border-gray-500'}">
              <span class="text-2xl">${animal.icon}</span>
              <div class="flex-1">
                <div class="font-bold">${animal.name}</div>
                <div class="text-xs text-gray-500">${animal.desc}</div>
              </div>
              <div class="text-right">
                <div class="text-sm text-green-700">库存: ${gameState.animals[animal.id]||0}</div>
                <button class="buy-animal bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm" data-animal-id="${animal.id}">购买(${animal.price}金币)</button>
              </div>
            </div>
          `).join('');
          
          shop.querySelectorAll('.buy-animal').forEach(btn => {
            btn.onclick = function() {
              const id = this.getAttribute('data-animal-id');
              const animal = animals.find(a=>a.id===id);
              if (gameState.money < animal.price) {
                showNotification('金币不足，无法购买','error'); return;
              }
              gameState.money -= animal.price;
              gameState.animals[id] = (gameState.animals[id]||0)+1;
              renderAnimalShop();
              renderMyAnimals();
              renderAnimalArea(id); // 渲染对应动物区域
              updateRanchStats();
              updateUI();
              saveGameData();
              
              // 检查动物相关成就
              checkAchievements();
              
              showNotification(`购买${animal.name}成功！`,'success');
            };
          });
        }
        function renderMyAnimals() {
          const box = document.getElementById('my-animals');
          if (!box) return;
          const animals = [
            { id: 'chicken', name: '鸡', icon: '🐔', rarity: 'common' },
            { id: 'cow', name: '牛', icon: '🐄', rarity: 'common' },
            { id: 'sheep', name: '羊', icon: '🐑', rarity: 'common' },
            { id: 'pig', name: '猪', icon: '🐷', rarity: 'uncommon' },
            { id: 'duck', name: '鸭子', icon: '🦆', rarity: 'common' },
            { id: 'goat', name: '山羊', icon: '🐐', rarity: 'uncommon' },
            { id: 'rabbit', name: '兔子', icon: '🐰', rarity: 'rare' },
            { id: 'horse', name: '马', icon: '🐎', rarity: 'epic' }
          ];
          const rarityColors = {
            common: 'bg-gray-50',
            uncommon: 'bg-green-50', 
            rare: 'bg-blue-50',
            epic: 'bg-purple-50'
          };
          box.innerHTML = animals.map(animal => {
            const health = gameState.animalHealth[animal.id]||0;
            const count = gameState.animals[animal.id]||0;
            const needsFeeding = count > 0 && health < 100;
            const feedCost = Math.ceil(count * 0.1); // 每只动物消耗0.1个饲料，向上取整
            
            return `<div class="flex items-center gap-3 p-3 rounded-lg ${rarityColors[animal.rarity]} border-l-4 ${animal.rarity === 'epic' ? 'border-purple-500' : animal.rarity === 'rare' ? 'border-blue-500' : animal.rarity === 'uncommon' ? 'border-green-500' : 'border-gray-500'} shadow-sm">
              <span class="text-3xl">${animal.icon}</span>
              <div class="flex-1">
                <div class="font-bold text-lg">${animal.name}</div>
                <div class="text-sm text-gray-500">数量: ${count}</div>
                <div class="flex items-center gap-2 mt-1">
                  <span class="text-xs text-gray-400">健康度</span>
                  <div class="w-24 bg-gray-200 rounded-full h-3">
                    <div class="${health > 50 ? 'bg-green-500' : health > 20 ? 'bg-yellow-500' : 'bg-red-500'} h-3 rounded-full transition-all duration-300" style="width: ${health}%"></div>
                  </div>
                  <span class="text-xs font-semibold ${health > 50 ? 'text-green-700' : health > 20 ? 'text-yellow-600' : 'text-red-600'}">${health}%</span>
                </div>
              </div>
              <div class="flex flex-col gap-1">
                ${count > 0 ? `
                  <button class="feed-individual-btn px-3 py-1 rounded text-xs font-semibold transition-all duration-200 ${needsFeeding ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}" 
                    data-animal-id="${animal.id}" 
                    data-feed-cost="${feedCost}"
                    ${!needsFeeding ? 'disabled' : ''}>
                    ${needsFeeding ? `喂养 (${feedCost}饲料)` : '健康满值'}
                  </button>
                  <button class="use-item-btn px-3 py-1 rounded text-xs font-semibold bg-blue-500 hover:bg-blue-600 text-white transition-all duration-200" 
                    data-animal-id="${animal.id}">
                    使用道具
                  </button>
                ` : `
                  <div class="px-3 py-1 text-xs text-gray-400">暂无动物</div>
                `}
              </div>
            </div>`;
          }).join('');
          
          // 为每个动物的喂养按钮添加点击事件
          box.querySelectorAll('.feed-individual-btn').forEach(btn => {
            btn.onclick = function() {
              const animalId = this.getAttribute('data-animal-id');
              const feedCost = parseInt(this.getAttribute('data-feed-cost'));
              
              if ((gameState.animalFeed || 0) < feedCost) {
                showNotification(`饲料不足！需要 ${feedCost} 个饲料`, 'error');
                return;
              }
              
              const animalName = animals.find(a => a.id === animalId)?.name;
              const currentHealth = gameState.animalHealth[animalId] || 0;
              
              if (currentHealth >= 100) {
                showNotification(`${animalName}健康度已满，无需喂养`, 'info');
                return;
              }
              
              // 执行喂养
              gameState.animalFeed -= feedCost;
              gameState.animalHealth[animalId] = 100;
              
              // 更新UI
              renderMyAnimals();
              renderAnimalArea(animalId); // 更新对应动物区域
              updateRanchStats();
              saveGameData();
              
              showNotification(`${animalName}喂养成功！健康度恢复到100%`, 'success');
            };
          });
          
          // 为每个动物的道具使用按钮添加点击事件
          box.querySelectorAll('.use-item-btn').forEach(btn => {
            btn.onclick = function() {
              const animalId = this.getAttribute('data-animal-id');
              showAnimalItemMenu(animalId);
            };
          });
          
          renderRanchAnimals(); // 保持牧场动物展示同步
          
          // 渲染动物天气状态
          renderAnimalWeatherStatus();
        }

        // 渲染幸福值、动物健康、动物副产品
        function renderHappiness() {
          // 幸福值=喷泉*10+花坛*5
          gameState.happiness = 0;
          document.getElementById('happiness-value').textContent = gameState.happiness;
        }
        function renderAnimalHealth() {
          const list = document.getElementById('animal-health-list');
          if (!list) return;
          const animals = [
            { id: 'chicken', name: '鸡', icon: '🐔', rarity: 'common' },
            { id: 'cow', name: '牛', icon: '🐄', rarity: 'common' },
            { id: 'sheep', name: '羊', icon: '🐑', rarity: 'common' },
            { id: 'pig', name: '猪', icon: '🐷', rarity: 'uncommon' },
            { id: 'duck', name: '鸭子', icon: '🦆', rarity: 'common' },
            { id: 'goat', name: '山羊', icon: '🐐', rarity: 'uncommon' },
            { id: 'rabbit', name: '兔子', icon: '🐰', rarity: 'rare' },
            { id: 'horse', name: '马', icon: '🐎', rarity: 'epic' }
          ];
          
          const rarityColors = {
            common: 'bg-gray-50',
            uncommon: 'bg-green-50', 
            rare: 'bg-blue-50',
            epic: 'bg-purple-50'
          };
          
          list.innerHTML = animals.map(a => `
            <div class="flex items-center gap-3 p-3 rounded-lg ${rarityColors[a.rarity]} border-l-4 ${a.rarity === 'epic' ? 'border-purple-500' : a.rarity === 'rare' ? 'border-blue-500' : a.rarity === 'uncommon' ? 'border-green-500' : 'border-gray-500'} shadow-sm">
              <span class="text-3xl">${a.icon}</span>
              <div class="flex-1">
                <div class="font-bold text-lg">${a.name}</div>
                <div class="text-sm text-gray-500">数量: ${gameState.animals[a.id]||0}</div>
              </div>
              <div class="text-right">
                <div class="text-sm font-semibold ${(gameState.animalHealth[a.id]||0) > 50 ? 'text-green-700' : (gameState.animalHealth[a.id]||0) > 20 ? 'text-yellow-600' : 'text-red-600'}">
                  健康度: ${gameState.animalHealth[a.id]||0}%
                </div>
                <div class="w-24 bg-gray-200 rounded-full h-3 mt-2">
                  <div class="bg-green-500 h-3 rounded-full transition-all duration-300" style="width: ${gameState.animalHealth[a.id]||0}%"></div>
                </div>
              </div>
            </div>
          `).join('');
          document.getElementById('feed-count').textContent = gameState.animalFeed||0;
        }
        function renderAnimalProducts() {
          const box = document.getElementById('animal-products-list');
          if (!box) return;
          const products = [
            { id: 'egg', name: '鸡蛋', icon: '🥚', price: 8, rarity: 'common' },
            { id: 'milk', name: '牛奶', icon: '🥛', price: 20, rarity: 'common' },
            { id: 'wool', name: '羊毛', icon: '🧶', price: 15, rarity: 'common' },
            { id: 'pork', name: '猪肉', icon: '🥩', price: 25, rarity: 'uncommon' },
            { id: 'duck_egg', name: '鸭蛋', icon: '🥚', price: 12, rarity: 'common' },
            { id: 'goat_milk', name: '羊奶', icon: '🥛', price: 30, rarity: 'uncommon' },
            { id: 'rabbit_fur', name: '兔毛', icon: '🧶', price: 40, rarity: 'rare' },
            { id: 'horse_manure', name: '马粪', icon: '💩', price: 5, rarity: 'common' }
          ];
          
          const rarityColors = {
            common: 'bg-gray-50',
            uncommon: 'bg-green-50', 
            rare: 'bg-blue-50',
            epic: 'bg-purple-50'
          };
          
          box.innerHTML = products.map(p => `
            <div class="flex items-center gap-3 p-3 rounded-lg ${rarityColors[p.rarity]} border-l-4 ${p.rarity === 'rare' ? 'border-blue-500' : p.rarity === 'uncommon' ? 'border-green-500' : 'border-gray-500'} shadow-sm">
              <span class="text-3xl">${p.icon}</span>
              <div class="flex-1">
                <div class="font-bold text-lg">${p.name}</div>
                <div class="text-sm text-gray-500">售价: ${p.price}金币</div>
              </div>
              <div class="text-right">
                <div class="text-sm font-semibold text-green-700">数量: ${gameState.animalProducts[p.id]||0}</div>
                <button class="sell-product bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition" data-product-id="${p.id}" data-price="${p.price}">出售</button>
              </div>
            </div>
          `).join('');
          
          box.querySelectorAll('.sell-product').forEach(btn => {
            btn.onclick = function() {
              const id = this.getAttribute('data-product-id');
              const price = parseInt(this.getAttribute('data-price'));
              if ((gameState.animalProducts[id]||0) <= 0) {
                showNotification('没有可出售的副产品','error'); return;
              }
              gameState.animalProducts[id]--;
              gameState.money += price;
              renderAnimalProducts();
              updateUI();
              saveGameData();
              
              // 根据产品类型显示不同的出售消息
              const productNames = {
                'egg': '鸡蛋', 'milk': '牛奶', 'wool': '羊毛', 'pork': '猪肉',
                'duck_egg': '鸭蛋', 'goat_milk': '羊奶', 'rabbit_fur': '兔毛', 'horse_manure': '马粪'
              };
              showNotification(`出售${productNames[id]}成功！+${price}金币`,'success');
            };
          });
        }

        // 喂养动物按钮逻辑
        setTimeout(()=>{
          const feedBtn = document.getElementById('feed-animals-btn');
          if(feedBtn){
            feedBtn.onclick = function(){
              if((gameState.animalFeed||0)<=0){
                showNotification('饲料不足','error');return;
              }
              
              // 检查是否有动物需要喂养（健康度不满100%）
              const animalIds = ['chicken','cow','sheep','pig','duck','goat','rabbit','horse'];
              let totalAnimalsNeedingFeed = 0;
              let animalsToFeed = [];
              
              animalIds.forEach(id => {
                const animalCount = gameState.animals[id] || 0;
                const health = gameState.animalHealth[id] || 0;
                if(animalCount > 0 && health < 100) {
                  totalAnimalsNeedingFeed += animalCount;
                  animalsToFeed.push({id, count: animalCount, name: getAnimalName(id)});
                }
              });
              
              if(totalAnimalsNeedingFeed === 0) {
                showNotification('所有动物健康度都是满的，无需喂养！','info');
                return;
              }
              
              // 计算需要的饲料数量（每只动物0.1个饲料，向上取整）
              const feedNeeded = Math.ceil(totalAnimalsNeedingFeed * 0.1);
              
              if((gameState.animalFeed||0) < feedNeeded) {
                showNotification(`饲料不足！需要 ${feedNeeded} 个饲料，当前只有 ${gameState.animalFeed||0} 个`, 'error');
                return;
              }
              
              // 执行喂养
              animalsToFeed.forEach(animal => {
                gameState.animalHealth[animal.id] = 100;
              });
              
              gameState.animalFeed -= feedNeeded;
              renderAnimalHealth();
              renderMyAnimals(); // 新增：喂完动物后刷新我的动物卡片
              renderAllAnimalAreas(); // 更新所有动物区域
              updateRanchStats();
              saveGameData();
              showNotification(`全部动物喂养完成！共喂养 ${totalAnimalsNeedingFeed} 只动物，消耗 ${feedNeeded} 个饲料`, 'success');
            };
          }
        },0);
        
        // 获取动物副产品图标
        function getAnimalProductIcon(id) {
            const productIcons = {
                chicken: '🥚',
                cow: '🥛',
                sheep: '🧶',
                pig: '🥩',
                duck: '🥚',
                goat: '🥛',
                rabbit: '🧶',
                horse: '💩'
            };
            return productIcons[id] || '🐾';
        }
        
        // 获取动物名称的辅助函数
        function getAnimalName(id) {
          const animalNames = {
            'chicken': '鸡', 'cow': '牛', 'sheep': '羊', 'pig': '猪',
            'duck': '鸭子', 'goat': '山羊', 'rabbit': '兔子', 'horse': '马'
          };
          return animalNames[id] || id;
        }
        
        // 显示动物道具使用菜单
        function showAnimalItemMenu(animalId) {
          const animalName = getAnimalName(animalId);
          const animalItems = [
            { id: 'vitamin_pill', name: '维生素丸', icon: '💊', desc: '快速恢复健康', effect: 'health', value: 50 },
            { id: 'stress_relief_pill', name: '安抚药丸', icon: '😌', desc: '降低压力值', effect: 'stress', value: -30 },
            { id: 'water_supplement', name: '水分补充剂', icon: '💧', desc: '补充水分', effect: 'water', value: 50 },
            { id: 'healing_ointment', name: '治疗药膏', icon: '🩹', desc: '治疗伤病', effect: 'heal', value: 100 },
            { id: 'happiness_treat', name: '幸福零食', icon: '🍪', desc: '提升幸福值', effect: 'happiness', value: 20 },
            { id: 'weather_protection', name: '天气防护剂', icon: '🛡️', desc: '临时防护', effect: 'protection', value: 60 },
            { id: 'growth_hormone', name: '生长激素', icon: '📈', desc: '提升产出', effect: 'production', value: 2 }
          ];
          
          // 检查可用道具
          const availableItems = animalItems.filter(item => (gameState.items[item.id] || 0) > 0);
          
          if (availableItems.length === 0) {
            showNotification('没有可用的动物道具！请先在道具商店购买', 'warning');
            return;
          }
          
          // 创建道具选择菜单
          let menuHtml = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-bold">为${animalName}使用道具</h3>
                  <button class="close-menu-btn text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                </div>
                <div class="space-y-2">
          `;
          
          availableItems.forEach(item => {
            const count = gameState.items[item.id] || 0;
            menuHtml += `
              <button class="use-animal-item-btn w-full text-left p-3 rounded border hover:bg-blue-50 transition-all duration-200" 
                data-item-id="${item.id}" data-animal-id="${animalId}">
                <div class="flex items-center gap-3">
                  <span class="text-2xl">${item.icon}</span>
                  <div class="flex-1">
                    <div class="font-semibold">${item.name}</div>
                    <div class="text-sm text-gray-600">${item.desc}</div>
                  </div>
                  <div class="text-right">
                    <div class="text-sm text-green-600">库存: ${count}</div>
                    <div class="text-xs text-blue-600">点击使用</div>
                  </div>
                </div>
              </button>
            `;
          });
          
          menuHtml += `
                </div>
              </div>
            </div>
          `;
          
          // 添加菜单到页面
          const menuContainer = document.createElement('div');
          menuContainer.innerHTML = menuHtml;
          document.body.appendChild(menuContainer);
          
          // 绑定关闭按钮
          menuContainer.querySelector('.close-menu-btn').onclick = function() {
            document.body.removeChild(menuContainer);
          };
          
          // 绑定道具使用按钮
          menuContainer.querySelectorAll('.use-animal-item-btn').forEach(btn => {
            btn.onclick = function() {
              const itemId = this.getAttribute('data-item-id');
              const targetAnimalId = this.getAttribute('data-animal-id');
              useAnimalItem(itemId, targetAnimalId);
              document.body.removeChild(menuContainer);
            };
          });
        }
        
        // 使用动物道具
        function useAnimalItem(itemId, animalId) {
          const item = {
            'vitamin_pill': { name: '维生素丸', effect: 'health', value: 50 },
            'stress_relief_pill': { name: '安抚药丸', effect: 'stress', value: -30 },
            'water_supplement': { name: '水分补充剂', effect: 'water', value: 50 },
            'healing_ointment': { name: '治疗药膏', effect: 'heal', value: 100 },
            'happiness_treat': { name: '幸福零食', effect: 'happiness', value: 20 },
            'weather_protection': { name: '天气防护剂', effect: 'protection', value: 60 },
            'growth_hormone': { name: '生长激素', effect: 'production', value: 2 }
          }[itemId];
          
          if (!item) return;
          
          // 检查道具库存
          if ((gameState.items[itemId] || 0) <= 0) {
            showNotification('道具库存不足！', 'error');
            return;
          }
          
          // 使用道具
          gameState.items[itemId]--;
          const animalName = getAnimalName(animalId);
          
          // 应用道具效果
          switch (item.effect) {
            case 'health':
              gameState.animalHealth[animalId] = Math.min(100, gameState.animalHealth[animalId] + item.value);
              showNotification(`${animalName}使用${item.name}，健康度+${item.value}！`, 'success');
              break;
            case 'stress':
              gameState.animalStress[animalId] = Math.max(0, gameState.animalStress[animalId] + item.value);
              showNotification(`${animalName}使用${item.name}，压力值${item.value > 0 ? '+' : ''}${item.value}！`, 'success');
              break;
            case 'water':
              gameState.animalWaterSupply[animalId] = Math.min(100, gameState.animalWaterSupply[animalId] + item.value);
              showNotification(`${animalName}使用${item.name}，水分+${item.value}！`, 'success');
              break;
            case 'heal':
              // 清除伤病记录
              gameState.animalInjuries[animalId] = [];
              gameState.animalHealth[animalId] = Math.min(100, gameState.animalHealth[animalId] + item.value);
              showNotification(`${animalName}使用${item.name}，伤病痊愈，健康度+${item.value}！`, 'success');
              break;
            case 'happiness':
              gameState.happiness = Math.min(100, (gameState.happiness || 0) + item.value);
              showNotification(`${animalName}使用${item.name}，幸福值+${item.value}！`, 'success');
              break;
            case 'protection':
              // 临时天气防护效果
              gameState.animalShelter[animalId] = true;
              setTimeout(() => {
                gameState.animalShelter[animalId] = false;
                showNotification(`${animalName}的天气防护效果已结束`, 'info');
              }, item.value * 1000); // 60秒防护
              showNotification(`${animalName}使用${item.name}，获得${item.value}秒天气防护！`, 'success');
              break;
            case 'production':
              // 提升产出效率（临时效果）
              const productionBonus = item.value;
              showNotification(`${animalName}使用${item.name}，产出效率提升${productionBonus}倍！`, 'success');
              break;
          }
          
          // 更新UI
          renderMyAnimals();
          renderHappiness();
          renderItemShop();
          renderMyItems();
          renderAnimalArea(animalId); // 更新对应动物区域
          updateRanchStats();
          updateUI();
          saveGameData();
        }

        // 定时器：动物产出与健康度变化
        setInterval(()=>{
          // 幸福值影响产出效率
          const happinessBonus = 1 + (gameState.happiness||0)/100;
          
          // 获取当前天气对动物的影响
          const currentWeatherEffect = ranchEnvironment.weatherEffects[gameState.weather];
          const weatherBonus = currentWeatherEffect ? currentWeatherEffect.animalEffects.productionBonus : 1.0;
          const healthDecayModifier = currentWeatherEffect ? currentWeatherEffect.animalEffects.healthDecayModifier : 1.0;
          
          // 动物产出配置
          const animalProduction = {
            chicken: { product: 'egg', chance: 0.2, healthDecay: 2 },
            cow: { product: 'milk', chance: 0.1, healthDecay: 1 },
            sheep: { product: 'wool', chance: 0.12, healthDecay: 1 },
            pig: { product: 'pork', chance: 0.08, healthDecay: 1.5 },
            duck: { product: 'duck_egg', chance: 0.15, healthDecay: 1.5 },
            goat: { product: 'goat_milk', chance: 0.09, healthDecay: 1 },
            rabbit: { product: 'rabbit_fur', chance: 0.06, healthDecay: 0.5 },
            horse: { product: 'horse_manure', chance: 0.25, healthDecay: 0.5 }
          };
          
          // 动物产出和健康度变化
          Object.keys(animalProduction).forEach(animalId => {
            if(gameState.animals[animalId] > 0 && (gameState.animalHealth[animalId]||0) > 0){
              const config = animalProduction[animalId];
              
              // 计算最终产出概率（幸福值 × 天气影响）
              const finalChance = config.chance * happinessBonus * weatherBonus;
              
              // 动物产出
              if(Math.random() < finalChance) {
                let productAmount = gameState.animals[animalId];
                
                // 彩虹天气的品质加成
                if (currentWeatherEffect && currentWeatherEffect.animalEffects.qualityBonus) {
                  productAmount = Math.floor(productAmount * currentWeatherEffect.animalEffects.qualityBonus);
                }
                
                gameState.animalProducts[config.product] += productAmount;
              }
              
              // 健康度衰减（受天气影响）
              const finalHealthDecay = config.healthDecay * healthDecayModifier;
              gameState.animalHealth[animalId] = Math.max(0, gameState.animalHealth[animalId] - finalHealthDecay);
              
                        // 特殊天气效果
          if (currentWeatherEffect) {
            const effects = currentWeatherEffect.animalEffects;
            
            // 台风可能造成动物受伤
            if (effects.injuryRisk && Math.random() < effects.injuryRisk) {
              gameState.animalHealth[animalId] = Math.max(0, gameState.animalHealth[animalId] - 20);
              showNotification(`台风中${getAnimalName(animalId)}受伤了！健康度下降`, 'error');
            }
            
            // 彩虹天气的健康恢复效果
            if (gameState.weather === 'rainbow' && Math.random() < 0.3) {
              gameState.animalHealth[animalId] = Math.min(100, gameState.animalHealth[animalId] + 5);
            }
            
            // 干旱天气的额外水分需求
            if (effects.waterNeed && effects.waterNeed > 1) {
              if (Math.random() < 0.2) {
                gameState.animalHealth[animalId] = Math.max(0, gameState.animalHealth[animalId] - 3);
              }
            }
          }
          
          // 设施自动效果
          // 降温系统在炎热天气自动生效
          if ((gameState.weather === 'sunny' || gameState.weather === 'drought') && (gameState.decors.cooling_system || 0) > 0) {
            if (Math.random() < 0.3) {
              gameState.animalStress[animalId] = Math.max(0, gameState.animalStress[animalId] - 3);
              gameState.animalHealth[animalId] = Math.min(100, gameState.animalHealth[animalId] + 2);
            }
          }
          
          // 安抚设施自动降低压力
          if ((gameState.decors.stress_relief || 0) > 0 && gameState.animalStress[animalId] > 30) {
            if (Math.random() < 0.4) {
              gameState.animalStress[animalId] = Math.max(0, gameState.animalStress[animalId] - 5);
            }
          }
          
          // 活动区提升幸福值
          if ((gameState.decors.activity_zone || 0) > 0 && Math.random() < 0.2) {
            gameState.happiness = Math.min(100, gameState.happiness + 1);
            gameState.animalStress[animalId] = Math.max(0, gameState.animalStress[animalId] - 2);
          }
            }
          });
          
          // 显示天气对动物的影响提示
          if (currentWeatherEffect && Math.random() < 0.1) {
            const effects = currentWeatherEffect.animalEffects;
            if (effects.benefits.length > 0) {
              const randomBenefit = effects.benefits[Math.floor(Math.random() * effects.benefits.length)];
              showNotification(`${currentWeatherEffect.title}：${randomBenefit}`, 'success');
            }
            if (effects.drawbacks.length > 0 && Math.random() < 0.5) {
              const randomDrawback = effects.drawbacks[Math.floor(Math.random() * effects.drawbacks.length)];
              showNotification(`${currentWeatherEffect.title}：${randomDrawback}`, 'warning');
            }
          }
          
          // 处理动物天气应对
          handleAnimalWeatherResponse();
          
          renderAnimalProducts();
          renderAnimalHealth();
          renderAllAnimalAreas(); // 更新所有动物区域
          updateRanchStats();
          updateRanchWeather(); // 更新牧场天气显示
          renderAnimalWeatherStatus(); // 更新动物天气状态显示
          saveGameData();
        },60000); // 每分钟产出一次

        // 商店标签切换功能
        function setupShopTabSwitching() {
            const tabButtons = document.querySelectorAll('.shop-tab-btn');
            const shopContents = document.querySelectorAll('.shop-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    
                    // 移除所有按钮的active类
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    // 隐藏所有内容区域
                    shopContents.forEach(content => {
                        content.classList.remove('active');
                        content.style.display = 'none';
                    });
                    
                    // 激活当前按钮
                    this.classList.add('active');
                    
                    // 显示对应的内容区域
                    const targetContent = document.querySelector(`[id="${category === 'seeds' ? 'shop-items' : category === 'items' ? 'item-shop' : category === 'decor' ? 'decor-shop' : 'animal-shop'}"]`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                        targetContent.style.display = 'block';
                    }
                    
                    // 显示/隐藏"我的道具"区域
                    const myItemsBox = document.getElementById('my-items');
                    if (myItemsBox) {
                        if (category === 'items') {
                            myItemsBox.style.display = 'block';
                            renderMyItems();
                        } else {
                            myItemsBox.style.display = 'none';
                        }
                    }
                    
                    // 显示/隐藏"植物保护状态"区域
                    const plantProtectionBox = document.getElementById('plant-protection-status');
                    if (plantProtectionBox) {
                        if (category === 'decor') {
                            plantProtectionBox.style.display = 'block';
                            renderPlantProtectionStatus();
                        } else {
                            plantProtectionBox.style.display = 'none';
                        }
                    }
                    
                    // 根据类别重新渲染对应的商店内容
                    switch(category) {
                        case 'seeds':
                            renderShop();
                            break;
                        case 'items':
                            renderItemShop();
                            break;
                        case 'decor':
                            renderDecorShop();
                            break;
                        case 'animals':
                            renderAnimalShop();
                            break;
                    }
                });
            });
        }

        // 动物区域切换功能
        function setupAnimalAreaSwitching() {
            // 绑定动物区域按钮事件
            document.querySelectorAll('.animal-area-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const area = this.getAttribute('data-area');
                    switchAnimalArea(area);
                });
            });
            
            // 初始化渲染所有动物区域
            renderAllAnimalAreas();
        }
        
        // 切换动物区域
        function switchAnimalArea(area) {
            // 移除所有按钮的active类
            document.querySelectorAll('.animal-area-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 移除所有区域视图的active类
            document.querySelectorAll('.animal-area-view').forEach(view => {
                view.classList.remove('active');
            });
            
            // 激活当前按钮
            const currentBtn = document.querySelector(`[data-area="${area}"]`);
            if (currentBtn) {
                currentBtn.classList.add('active');
            }
            
            // 显示当前区域视图
            const currentView = document.getElementById(`${area}-area-view`);
            if (currentView) {
                currentView.classList.add('active');
            }
            
            // 渲染当前区域的动物
            renderAnimalArea(area);
        }
        
        // 渲染所有动物区域
        function renderAllAnimalAreas() {
            const areas = ['all', 'chicken', 'cow', 'sheep', 'pig', 'duck', 'goat', 'rabbit', 'horse'];
            areas.forEach(area => {
                renderAnimalArea(area);
            });
        }
        
        // 更新动物区域统计信息
        function updateAnimalAreaStats() {
            const areas = ['chicken', 'cow', 'sheep', 'pig', 'duck', 'goat', 'rabbit', 'horse'];
            const products = {
                chicken: 'egg',
                cow: 'milk',
                sheep: 'wool',
                pig: 'pork',
                duck: 'duck_egg',
                goat: 'goat_milk',
                rabbit: 'rabbit_fur',
                horse: 'horse_manure'
            };
            
            areas.forEach(area => {
                const countElement = document.getElementById(`${area}-count`);
                const healthElement = document.getElementById(`${area}-health`);
                const productElement = document.getElementById(`${area}-${products[area]}`);
                
                if (countElement) {
                    countElement.textContent = gameState.animals[area] || 0;
                }
                if (healthElement) {
                    healthElement.textContent = `${gameState.animalHealth[area] || 0}%`;
                }
                if (productElement) {
                    productElement.textContent = gameState.animalProducts[products[area]] || 0;
                }
            });
        }
        
        // 渲染指定区域的动物
        function renderAnimalArea(area) {
            if (area === 'all') {
                renderRanchAnimals(); // 使用原有的全部动物渲染
                return;
            }
            
            const container = document.getElementById(`${area}-animals`);
            if (!container) return;
            
            const animalCount = gameState.animals[area] || 0;
            const health = gameState.animalHealth[area] || 0;
            
            if (animalCount === 0) {
                container.innerHTML = `
                    <div class="w-full text-center py-8">
                        <div class="text-6xl mb-4 opacity-50">${getAnimalProductIcon(area)}</div>
                        <div class="text-xl text-gray-500 font-semibold">${getAnimalName(area)}圈还是空的</div>
                        <div class="text-sm text-gray-400 mt-2">去动物商店购买一些${getAnimalName(area)}吧！</div>
                    </div>
                `;
                return;
            }
            
            // 生成动物图标（最多显示20个，超出显示数字）
            let animalsHtml = '';
            const maxDisplay = 20;
            const displayCount = Math.min(animalCount, maxDisplay);
            
            for (let i = 0; i < displayCount; i++) {
                const healthClass = health > 50 ? 'animal-healthy' : health > 20 ? 'animal-sick' : 'animal-sick';
                const animations = ['animal-walk', 'animal-bounce', 'animal-sway', 'animal-breathe', 'animal-blink'];
                const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
                
                animalsHtml += `
                    <div class="ranch-animal ${randomAnimation} ${healthClass} flex flex-col items-center justify-center p-2 rounded-lg bg-white bg-opacity-50 backdrop-blur-sm hover:bg-opacity-80 transition-all duration-300"
                         title="${getAnimalName(area)} × ${animalCount} - 健康度: ${health}%">
                        <div class="text-4xl mb-1">${getAnimalIcon(area)}</div>
                        <div class="text-xs text-gray-600">${getAnimalName(area)}</div>
                        <div class="text-xs font-semibold ${health > 50 ? 'text-green-600' : health > 20 ? 'text-yellow-600' : 'text-red-600'}">
                            ${health}%
                        </div>
                    </div>
                `;
            }
            
            // 如果动物数量超过显示上限，添加数量指示器
            if (animalCount > maxDisplay) {
                animalsHtml += `
                    <div class="ranch-animal flex flex-col items-center justify-center p-2 rounded-lg bg-blue-100 bg-opacity-80 backdrop-blur-sm border-2 border-blue-300"
                         title="还有 ${animalCount - maxDisplay} 只${getAnimalName(area)}">
                        <div class="text-2xl mb-1">+${animalCount - maxDisplay}</div>
                        <div class="text-xs text-blue-600 font-semibold">更多</div>
                    </div>
                `;
            }
            
            container.innerHTML = animalsHtml;
            
            // 更新区域统计信息
            updateAnimalAreaStats();
        }
        
        // 新玩法功能设置
        function setupNewGameplayFeatures() {
            // 初始化成就系统
            initAchievements();
            
            // 初始化农场活动
            initFarmEvents();
            
            // 初始化农场商店
            initFarmShop();
            
            // 初始化每日任务
            initDailyTasks();
            
            // 渲染新玩法界面
            renderAchievements();
            renderFarmEvents();
            renderFarmShop();
        }
        
        // 成就系统初始化
        function initAchievements() {
            if (!gameState.achievements) {
                gameState.achievements = {};
            }
            
            // 检查成就完成情况
            checkAchievements();
            
            // 初始化成就面板
            initAchievementModal();
        }
        
        // 检查成就完成情况
        function checkAchievements() {
            const achievementData = [
                { id: 'first_harvest', name: '初次收获', icon: '🌾', description: '收获第一个作物', reward: 50, type: 'harvest' },
                { id: 'harvest_master', name: '收获大师', icon: '👨‍🌾', description: '累计收获100个作物', reward: 200, type: 'harvest', requirement: 100 },
                { id: 'rich_farmer', name: '富裕农民', icon: '💰', description: '拥有1000金币', reward: 100, type: 'money', requirement: 1000 },
                { id: 'animal_lover', name: '动物爱好者', icon: '🐾', description: '拥有10只动物', reward: 150, type: 'animal', requirement: 10 },
                { id: 'land_expander', name: '土地扩张者', icon: '🏞️', description: '扩展10块农田', reward: 300, type: 'land', requirement: 10 },
                { id: 'weather_master', name: '天气大师', icon: '🌤️', description: '经历所有天气类型', reward: 250, type: 'weather' },
                { id: 'quality_farmer', name: '品质农民', icon: '⭐', description: '收获10个完美品质作物', reward: 400, type: 'quality', requirement: 10 },
                { id: 'festival_host', name: '节日主办者', icon: '🎉', description: '举办一次农场节日', reward: 500, type: 'festival' },
                { id: 'tourist_attraction', name: '旅游胜地', icon: '🏛️', description: '接待100名访客', reward: 600, type: 'tourism', requirement: 100 },
                { id: 'research_pioneer', name: '研究先驱', icon: '🔬', description: '完成一项农场研究', reward: 350, type: 'research' }
            ];
            
            achievementData.forEach(achievement => {
                if (!gameState.achievements[achievement.id]) {
                    gameState.achievements[achievement.id] = { completed: false, progress: 0 };
                }
                
                // 检查成就是否完成
                if (!gameState.achievements[achievement.id].completed) {
                    let shouldComplete = false;
                    
                    switch (achievement.type) {
                        case 'harvest':
                            if (achievement.id === 'first_harvest') {
                                shouldComplete = (gameState.totalHarvested || 0) >= 1;
                            } else {
                                shouldComplete = (gameState.totalHarvested || 0) >= (achievement.requirement || 0);
                            }
                            break;
                        case 'money':
                            shouldComplete = gameState.money >= (achievement.requirement || 0);
                            break;
                        case 'animal':
                            const totalAnimals = Object.values(gameState.animals).reduce((sum, count) => sum + count, 0);
                            shouldComplete = totalAnimals >= (achievement.requirement || 0);
                            break;
                        case 'land':
                            const totalPlots = Object.values(gameState.regionPlots).reduce((sum, count) => sum + count, 0);
                            shouldComplete = totalPlots >= (achievement.requirement || 0);
                            break;
                        case 'weather':
                            // 检查是否经历过所有天气类型
                            const experiencedWeather = gameState.experiencedWeather || [];
                            shouldComplete = experiencedWeather.length >= 7; // 7种天气类型
                            break;
                        case 'quality':
                            const perfectHarvests = gameState.perfectHarvests || 0;
                            shouldComplete = perfectHarvests >= (achievement.requirement || 0);
                            break;
                        case 'festival':
                            shouldComplete = (gameState.farmFestivals || []).length > 0;
                            break;
                        case 'tourism':
                            shouldComplete = (gameState.farmVisitors || 0) >= (achievement.requirement || 0);
                            break;
                        case 'research':
                            shouldComplete = Object.keys(gameState.farmResearch || {}).length > 0;
                            break;
                    }
                    
                    if (shouldComplete) {
                        completeAchievement(achievement);
                    }
                }
            });
        }
        
        // 完成成就
        function completeAchievement(achievement) {
            if (gameState.achievements[achievement.id].completed) return;
            
            gameState.achievements[achievement.id].completed = true;
            gameState.money += achievement.reward;
            gameState.farmPoints = (gameState.farmPoints || 0) + achievement.reward;
            
            showNotification(`🎉 成就解锁：${achievement.name}！获得${achievement.reward}金币和积分！`, 'success');
            
            // 更新UI
            renderAchievements();
            updateUI();
            saveGameData();
        }
        
        // 渲染成就系统弹窗
        function renderAchievementModal() {
            const container = document.getElementById('achievement-modal-content');
            if (!container) return;
            
            const achievementData = [
                { id: 'first_harvest', name: '初次收获', icon: '🌾', description: '收获第一个作物', reward: 50, type: 'harvest' },
                { id: 'harvest_master', name: '收获大师', icon: '👨‍🌾', description: '累计收获100个作物', reward: 200, type: 'harvest', requirement: 100 },
                { id: 'rich_farmer', name: '富裕农民', icon: '💰', description: '拥有1000金币', reward: 100, type: 'money', requirement: 1000 },
                { id: 'animal_lover', name: '动物爱好者', icon: '🐾', description: '拥有10只动物', reward: 150, type: 'animal', requirement: 10 },
                { id: 'land_expander', name: '土地扩张者', icon: '🏞️', description: '扩展10块农田', reward: 300, type: 'land', requirement: 10 },
                { id: 'weather_master', name: '天气大师', icon: '🌤️', description: '经历所有天气类型', reward: 250, type: 'weather' },
                { id: 'quality_farmer', name: '品质农民', icon: '⭐', description: '收获10个完美品质作物', reward: 400, type: 'quality', requirement: 10 },
                { id: 'festival_host', name: '节日主办者', icon: '🎉', description: '举办一次农场节日', reward: 500, type: 'festival' },
                { id: 'tourist_attraction', name: '旅游胜地', icon: '🏛️', description: '接待100名访客', reward: 600, type: 'tourism', requirement: 100 },
                { id: 'research_pioneer', name: '研究先驱', icon: '🔬', description: '完成一项农场研究', reward: 350, type: 'research' }
            ];
            
            let html = '<div class="space-y-4">';
            achievementData.forEach(achievement => {
                const achievementState = gameState.achievements[achievement.id] || { completed: false, progress: 0 };
                const isCompleted = achievementState.completed;
                
                html += `
                    <div class="achievement-item p-4 rounded-lg border-2 ${isCompleted ? 'completed bg-green-50 border-green-300' : 'bg-gray-50 border-gray-300'}">
                        <div class="flex items-center gap-3">
                            <div class="achievement-icon text-3xl">${achievement.icon}</div>
                            <div class="flex-1">
                                <div class="font-bold text-lg ${isCompleted ? 'text-green-700' : 'text-gray-700'}">${achievement.name}</div>
                                <div class="text-sm text-gray-600 mb-1">${achievement.description}</div>
                                <div class="text-xs text-blue-600 font-semibold">奖励: ${achievement.reward} 金币</div>
                            </div>
                            <div class="text-right">
                                ${isCompleted ? 
                                    '<span class="text-green-600 text-2xl">✓</span>' : 
                                    '<span class="text-gray-400 text-2xl">○</span>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // 渲染成就系统
        function renderAchievements() {
            const container = document.getElementById('achievement-modal-content');
            if (!container) return;
            
            const achievementData = [
                { id: 'first_harvest', name: '初次收获', icon: '🌾', description: '收获第一个作物', reward: 50, type: 'harvest' },
                { id: 'harvest_master', name: '收获大师', icon: '👨‍🌾', description: '累计收获100个作物', reward: 200, type: 'harvest', requirement: 100 },
                { id: 'rich_farmer', name: '富裕农民', icon: '💰', description: '拥有1000金币', reward: 100, type: 'money', requirement: 1000 },
                { id: 'animal_lover', name: '动物爱好者', icon: '🐾', description: '拥有10只动物', reward: 150, type: 'animal', requirement: 10 },
                { id: 'land_expander', name: '土地扩张者', icon: '🏞️', description: '扩展10块农田', reward: 300, type: 'land', requirement: 10 },
                { id: 'weather_master', name: '天气大师', icon: '🌤️', description: '经历所有天气类型', reward: 250, type: 'weather' },
                { id: 'quality_farmer', name: '品质农民', icon: '⭐', description: '收获10个完美品质作物', reward: 400, type: 'quality', requirement: 10 },
                { id: 'festival_host', name: '节日主办者', icon: '🎉', description: '举办一次农场节日', reward: 500, type: 'festival' },
                { id: 'tourist_attraction', name: '旅游胜地', icon: '🏛️', description: '接待100名访客', reward: 600, type: 'tourism', requirement: 100 },
                { id: 'research_pioneer', name: '研究先驱', icon: '🔬', description: '完成一项农场研究', reward: 350, type: 'research' }
            ];
            
            let html = '';
            achievementData.forEach(achievement => {
                const achievementState = gameState.achievements[achievement.id] || { completed: false, progress: 0 };
                const isCompleted = achievementState.completed;
                
                html += `
                    <div class="achievement-item p-3 rounded-lg border-2 ${isCompleted ? 'bg-green-50 border-green-300' : 'bg-gray-50 border-gray-300'} mb-2">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">${achievement.icon}</div>
                            <div class="flex-1">
                                <div class="font-semibold ${isCompleted ? 'text-green-700' : 'text-gray-700'}">${achievement.name}</div>
                                <div class="text-sm text-gray-600">${achievement.description}</div>
                                <div class="text-xs text-blue-600">奖励: ${achievement.reward} 金币</div>
                            </div>
                            <div class="text-right">
                                ${isCompleted ? 
                                    '<span class="text-green-600 text-lg">✓</span>' : 
                                    '<span class="text-gray-400 text-lg">○</span>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 农场活动初始化
        function initFarmEvents() {
            if (!gameState.farmEvents) {
                gameState.farmEvents = [];
            }
            
            // 生成随机农场活动
            generateRandomFarmEvents();
        }
        
        // 生成随机农场活动
        function generateRandomFarmEvents() {
            const eventTypes = [
                { id: 'harvest_festival', name: '收获节', icon: '🌾', description: '收获作物获得双倍金币', duration: 24, reward: 'double_money' },
                { id: 'animal_care_day', name: '动物关爱日', icon: '🐾', description: '动物产出增加50%', duration: 12, reward: 'animal_bonus' },
                { id: 'weather_protection', name: '天气防护', icon: '🛡️', description: '所有作物免受天气影响', duration: 6, reward: 'weather_protection' },
                { id: 'tourist_attraction', name: '游客潮', icon: '👥', description: '农场声望大幅提升', duration: 8, reward: 'reputation_boost' },
                { id: 'research_breakthrough', name: '研究突破', icon: '🔬', description: '解锁新的农场技术', duration: 4, reward: 'new_technology' }
            ];
            
            // 随机选择2-3个活动
            const numEvents = Math.floor(Math.random() * 2) + 2;
            const selectedEvents = [];
            
            for (let i = 0; i < numEvents; i++) {
                const randomEvent = eventTypes[Math.floor(Math.random() * eventTypes.length)];
                if (!selectedEvents.find(e => e.id === randomEvent.id)) {
                    selectedEvents.push({
                        ...randomEvent,
                        startTime: Date.now(),
                        endTime: Date.now() + (randomEvent.duration * 60 * 60 * 1000), // 转换为毫秒
                        active: true
                    });
                }
            }
            
            gameState.farmEvents = selectedEvents;
        }
        
        // 渲染农场活动
        function renderFarmEvents() {
            const container = document.getElementById('farm-events');
            if (!container) return;
            
            if (gameState.farmEvents.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">当前没有农场活动</p>';
                return;
            }
            
            let html = '';
            gameState.farmEvents.forEach(event => {
                const timeLeft = Math.max(0, event.endTime - Date.now());
                const hoursLeft = Math.floor(timeLeft / (60 * 60 * 1000));
                const minutesLeft = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
                
                html += `
                    <div class="farm-event-item p-3 rounded-lg border-2 border-blue-300 bg-blue-50 mb-2">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">${event.icon}</div>
                            <div class="flex-1">
                                <div class="font-semibold text-blue-700">${event.name}</div>
                                <div class="text-sm text-gray-600">${event.description}</div>
                                <div class="text-xs text-red-600">剩余时间: ${hoursLeft}小时${minutesLeft}分钟</div>
                            </div>
                            <div class="text-right">
                                <span class="text-blue-600 text-lg">🎉</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 农场商店初始化
        function initFarmShop() {
            if (!gameState.farmShop) {
                gameState.farmShop = {
                    specialSeeds: {},
                    rareAnimals: {},
                    farmTools: {},
                    seasonalItems: {}
                };
            }
            
            // 生成特殊商品
            generateSpecialShopItems();
        }
        
        // 生成特殊商品
        function generateSpecialShopItems() {
            const specialItems = [
                { id: 'golden_seed', name: '黄金种子', icon: '🌟', price: 500, description: '种植后获得大量金币', type: 'specialSeeds' },
                { id: 'rainbow_animal', name: '彩虹动物', icon: '🌈', price: 1000, description: '稀有动物，产出特殊物品', type: 'rareAnimals' },
                { id: 'auto_harvester', name: '自动收割机', icon: '🤖', price: 800, description: '自动收获成熟的作物', type: 'farmTools' },
                { id: 'seasonal_decoration', name: '季节装饰', icon: '🎨', price: 300, description: '提升农场美观度', type: 'seasonalItems' }
            ];
            
            // 随机选择2-3个特殊商品
            const numItems = Math.floor(Math.random() * 2) + 2;
            const selectedItems = [];
            
            for (let i = 0; i < numItems; i++) {
                const randomItem = specialItems[Math.floor(Math.random() * specialItems.length)];
                if (!selectedItems.find(item => item.id === randomItem.id)) {
                    selectedItems.push(randomItem);
                }
            }
            
            gameState.farmShop.currentItems = selectedItems;
        }
        
        // 渲染农场商店
        function renderFarmShop() {
            const container = document.getElementById('farm-shop');
            if (!container) return;
            
            if (!gameState.farmShop.currentItems || gameState.farmShop.currentItems.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">农场商店暂无特殊商品</p>';
                return;
            }
            
            let html = '';
            gameState.farmShop.currentItems.forEach(item => {
                html += `
                    <div class="farm-shop-item p-3 rounded-lg border-2 border-purple-300 bg-purple-50 mb-2">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">${item.icon}</div>
                            <div class="flex-1">
                                <div class="font-semibold text-purple-700">${item.name}</div>
                                <div class="text-sm text-gray-600">${item.description}</div>
                                <div class="text-xs text-green-600">价格: ${item.price} 金币</div>
                            </div>
                            <button class="buy-farm-item-btn bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm" data-item-id="${item.id}">
                                购买
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 绑定购买按钮事件
            container.querySelectorAll('.buy-farm-item-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-item-id');
                    buyFarmShopItem(itemId);
                });
            });
        }
        
        // 购买农场商店商品
        function buyFarmShopItem(itemId) {
            const item = gameState.farmShop.currentItems.find(item => item.id === itemId);
            if (!item) return;
            
            if (gameState.money < item.price) {
                showNotification('金币不足！', 'error');
                return;
            }
            
            gameState.money -= item.price;
            
            // 根据商品类型执行不同效果
            switch (item.type) {
                case 'specialSeeds':
                    gameState.specialSeeds = gameState.specialSeeds || {};
                    gameState.specialSeeds[itemId] = (gameState.specialSeeds[itemId] || 0) + 1;
                    showNotification(`购买${item.name}成功！可以在种植时使用特殊种子`, 'success');
                    break;
                case 'rareAnimals':
                    gameState.rareAnimals = gameState.rareAnimals || {};
                    gameState.rareAnimals[itemId] = (gameState.rareAnimals[itemId] || 0) + 1;
                    showNotification(`购买${item.name}成功！稀有动物已添加到牧场`, 'success');
                    break;
                case 'farmTools':
                    gameState.farmTools = gameState.farmTools || {};
                    gameState.farmTools[itemId] = (gameState.farmTools[itemId] || 0) + 1;
                    showNotification(`购买${item.name}成功！农场工具已激活`, 'success');
                    break;
                case 'seasonalItems':
                    gameState.seasonalItems = gameState.seasonalItems || {};
                    gameState.seasonalItems[itemId] = (gameState.seasonalItems[itemId] || 0) + 1;
                    showNotification(`购买${item.name}成功！季节装饰已应用`, 'success');
                    break;
            }
            
            // 更新UI
            renderFarmShop();
            updateUI();
            saveGameData();
        }
        
        // 每日任务初始化
        function initDailyTasks() {
            if (!gameState.dailyTasks) {
                gameState.dailyTasks = [];
            }
            
            // 生成每日任务
            generateDailyTasks();
        }
        
        // 生成每日任务
        function generateDailyTasks() {
            const taskTypes = [
                { id: 'harvest_daily', name: '每日收获', icon: '🌾', description: '收获10个作物', requirement: 10, reward: 50 },
                { id: 'plant_daily', name: '每日种植', icon: '🌱', description: '种植5次', requirement: 5, reward: 30 },
                { id: 'animal_care_daily', name: '动物关爱', icon: '🐾', description: '喂养所有动物', requirement: 1, reward: 40 },
                { id: 'sell_daily', name: '每日销售', icon: '💰', description: '销售价值200金币的作物', requirement: 200, reward: 60 },
                { id: 'upgrade_daily', name: '农场升级', icon: '🔧', description: '完成一次升级', requirement: 1, reward: 80 }
            ];
            
            // 随机选择3个任务
            const selectedTasks = [];
            const shuffledTasks = taskTypes.sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < 3; i++) {
                selectedTasks.push({
                    ...shuffledTasks[i],
                    progress: 0,
                    completed: false
                });
            }
            
            gameState.dailyTasks = selectedTasks;
        }
        
        // 牧场管理功能
        function setupRanchManagement() {
            // 购买饲料按钮
            const buyFeedBtn = document.getElementById('buy-feed-btn');
            if (buyFeedBtn) {
                buyFeedBtn.onclick = function() {
                    if (gameState.money < 10) {
                        showNotification('金币不足，无法购买饲料','error');
                        return;
                    }
                    gameState.money -= 10;
                    gameState.animalFeed = (gameState.animalFeed || 0) + 1;
                    updateRanchStats();
                    updateUI();
                    saveGameData();
                    showNotification('购买饲料成功！','success');
                };
            }

            // 一键出售所有副产品按钮
            const sellAllProductsBtn = document.getElementById('sell-all-products-btn');
            if (sellAllProductsBtn) {
                sellAllProductsBtn.onclick = function() {
                    let totalEarnings = 0;
                    const products = [
                        { id: 'egg', name: '鸡蛋', price: 8 },
                        { id: 'milk', name: '牛奶', price: 20 },
                        { id: 'wool', name: '羊毛', price: 15 },
                        { id: 'pork', name: '猪肉', price: 25 },
                        { id: 'duck_egg', name: '鸭蛋', price: 12 },
                        { id: 'goat_milk', name: '羊奶', price: 30 },
                        { id: 'rabbit_fur', name: '兔毛', price: 40 },
                        { id: 'horse_manure', name: '马粪', price: 5 }
                    ];
                    
                    products.forEach(product => {
                        const quantity = gameState.animalProducts[product.id] || 0;
                        if (quantity > 0) {
                            totalEarnings += quantity * product.price;
                            gameState.animalProducts[product.id] = 0;
                        }
                    });
                    
                    if (totalEarnings > 0) {
                        gameState.money += totalEarnings;
                        renderAnimalProducts();
                        updateUI();
                        saveGameData();
                        showNotification(`一键出售成功！获得 ${totalEarnings} 金币`,'success');
                    } else {
                        showNotification('没有可出售的副产品','info');
                    }
                };
            }

            // 初始化牧场统计
            updateRanchStats();
        }

        // 更新牧场统计
        function updateRanchStats() {
            const totalAnimalsElement = document.getElementById('total-animals');
            const avgHealthElement = document.getElementById('avg-health');
            const feedCountElement = document.getElementById('feed-count');
            
            if (totalAnimalsElement && avgHealthElement) {
                // 计算总动物数
                const totalAnimals = Object.values(gameState.animals).reduce((sum, count) => sum + (count || 0), 0);
                totalAnimalsElement.textContent = totalAnimals;
                
                // 计算平均健康度
                const animalIds = ['chicken', 'cow', 'sheep', 'pig', 'duck', 'goat', 'rabbit', 'horse'];
                let totalHealth = 0;
                let animalCount = 0;
                
                animalIds.forEach(id => {
                    const count = gameState.animals[id] || 0;
                    if (count > 0) {
                        totalHealth += (gameState.animalHealth[id] || 0) * count;
                        animalCount += count;
                    }
                });
                
                const avgHealth = animalCount > 0 ? Math.round(totalHealth / animalCount) : 100;
                avgHealthElement.textContent = avgHealth + '%';
                
                // 根据健康度设置颜色
                if (avgHealth > 70) {
                    avgHealthElement.className = 'text-2xl font-bold text-green-600';
                } else if (avgHealth > 40) {
                    avgHealthElement.className = 'text-2xl font-bold text-yellow-600';
                } else {
                    avgHealthElement.className = 'text-2xl font-bold text-red-600';
                }
            }
            
            // 更新饲料库存显示
            if (feedCountElement) {
                feedCountElement.textContent = gameState.animalFeed || 0;
            }
        }

        // 渲染牧场动物图标
        function renderRanchAnimals() {
            const box = document.getElementById('ranch-animal-icons');
            if (!box) return;
            
            // 为牧场容器添加大气效果
            box.className = 'ranch-atmosphere grid grid-cols-4 gap-6 p-8 bg-gradient-to-br from-green-100 to-green-200 rounded-lg border-2 border-green-300 shadow-lg relative overflow-hidden';
            
            const animals = [
                { id: 'chicken', name: '鸡', icon: '🐔', animations: ['animal-walk', 'animal-bounce'] },
                { id: 'cow', name: '牛', icon: '🐄', animations: ['animal-sway', 'animal-breathe'] },
                { id: 'sheep', name: '羊', icon: '🐑', animations: ['animal-bounce', 'animal-sway'] },
                { id: 'pig', name: '猪', icon: '🐷', animations: ['animal-walk', 'animal-breathe'] },
                { id: 'duck', name: '鸭子', icon: '🦆', animations: ['animal-walk', 'animal-bounce'] },
                { id: 'goat', name: '山羊', icon: '🐐', animations: ['animal-bounce', 'animal-sway'] },
                { id: 'rabbit', name: '兔子', icon: '🐰', animations: ['animal-bounce', 'animal-walk'] },
                { id: 'horse', name: '马', icon: '🐎', animations: ['animal-walk', 'animal-sway'] }
            ];
            
            let animalElements = [];
            
            animals.forEach(animal => {
                const count = gameState.animals[animal.id] || 0;
                const health = gameState.animalHealth[animal.id] || 0;
                
                if (count > 0) {
                    // 为每种动物创建多个个体（最多显示6个）
                    const displayCount = Math.min(count, 6);
                    
                    for (let i = 0; i < displayCount; i++) {
                        // 随机选择动画效果
                        const randomAnimation = animal.animations[Math.floor(Math.random() * animal.animations.length)];
                        
                        // 根据健康度决定动画和样式
                        let healthClass = '';
                        if (health > 70) {
                            healthClass = 'animal-healthy';
                        } else if (health < 30) {
                            healthClass = 'animal-sick';
                        }
                        
                        // 随机延迟动画，让动物们不同步
                        const animationDelay = Math.random() * 3;
                        
                        animalElements.push(`
                            <div class="ranch-animal ${randomAnimation} ${healthClass} flex flex-col items-center justify-center p-2 rounded-lg bg-white bg-opacity-50 backdrop-blur-sm hover:bg-opacity-80 transition-all duration-300" 
                                 style="animation-delay: ${animationDelay}s;" 
                                 title="${animal.name} - 健康度: ${health}%">
                                <span class="text-3xl mb-1 animal-blink" style="animation-delay: ${animationDelay + 1}s;">${animal.icon}</span>
                                <span class="text-xs font-bold text-green-800">${animal.name}</span>
                                ${i === 0 && count > displayCount ? `<span class="text-xs text-gray-600">+${count - displayCount}只</span>` : ''}
                            </div>
                        `);
                    }
                }
            });
            
            if (animalElements.length === 0) {
                box.innerHTML = `
                    <div class="col-span-4 text-center py-12">
                        <div class="text-6xl mb-4 opacity-50">🌾</div>
                        <div class="text-gray-500 italic text-lg">空旷的牧场等待着动物们的到来...</div>
                        <div class="text-sm text-gray-400 mt-2">去商店购买一些动物吧！</div>
                    </div>
                `;
            } else {
                // 添加环境装饰
                const environmentElements = [
                    '<div class="ranch-decoration absolute top-2 left-2 text-2xl opacity-60 grass-sway">🌾</div>',
                    '<div class="ranch-decoration absolute top-2 right-2 text-2xl opacity-60 cloud-float">☁️</div>',
                    '<div class="ranch-decoration absolute bottom-2 left-2 text-xl opacity-50 grass-sway" style="animation-delay: 2s;">🌻</div>',
                    '<div class="ranch-decoration absolute bottom-2 right-2 text-xl opacity-50 grass-sway" style="animation-delay: 1s;">🦋</div>'
                ];
                
                box.innerHTML = animalElements.join('') + environmentElements.join('');
            }
        }
        
        // 定期更新动物动画（每10秒随机改变动物的动画）
        setInterval(() => {
            const animalElements = document.querySelectorAll('.ranch-animal');
            animalElements.forEach(element => {
                const animations = ['animal-walk', 'animal-bounce', 'animal-sway', 'animal-breathe'];
                const currentClasses = element.className.split(' ');
                
                // 移除旧的动画类
                animations.forEach(anim => {
                    element.classList.remove(anim);
                });
                
                // 添加新的随机动画
                const newAnimation = animations[Math.floor(Math.random() * animations.length)];
                element.classList.add(newAnimation);
                
                // 随机改变动画延迟
                element.style.animationDelay = Math.random() * 3 + 's';
            });
        }, 10000); // 每10秒更新一次动画
        
        // 牧场环境系统
        const ranchEnvironment = {
            soundEnabled: false,
            timeOfDay: 'day',
            season: 'spring',
            
            // 时间系统
            timeSystem: {
                day: { icon: '🕐', title: '白天', mood: '😊 动物们很活跃' },
                evening: { icon: '🌅', title: '傍晚', mood: '😌 动物们在休息' },
                night: { icon: '🌙', title: '夜晚', mood: '😴 动物们在睡觉' }
            },
            
            // 季节系统
            seasons: {
                spring: { icon: '🌸', title: '春季' },
                summer: { icon: '☀️', title: '夏季' },
                autumn: { icon: '🍂', title: '秋季' },
                winter: { icon: '❄️', title: '冬季' }
            },
            
            // 动物叫声
            animalSounds: {
                chicken: ['咯咯', '咯咯咯'],
                cow: ['哞~', '哞哞'],
                sheep: ['咩~', '咩咩'],
                pig: ['哼哼', '哼哼哼'],
                duck: ['嘎嘎', '嘎嘎嘎'],
                goat: ['咩咩', '咩~'],
                rabbit: ['...', '(无声)'],
                horse: ['嘶~', '嘶嘶']
            },
            
            // 天气对动物的影响（与主天气系统统一）
            weatherEffects: {
                sunny: {
                    icon: '☀️',
                    title: '晴天',
                    effect: 'sunny-effect',
                    animalEffects: {
                        benefits: ['产出效率+20%', '健康度缓慢恢复', '动物心情愉悦'],
                        drawbacks: ['水分消耗增加', '需要更多饮水', '中暑风险'],
                        productionBonus: 1.2,
                        healthDecayModifier: 0.8, // 健康度衰减减少
                        waterNeed: 1.5, // 需要更多水分
                        shelterNeed: false, // 不需要庇护
                        specialActions: ['提供遮阳', '增加饮水', '防暑降温']
                    }
                },
                rainy: {
                    icon: '🌧️',
                    title: '雨天',
                    effect: 'rainy-effect',
                    animalEffects: {
                        benefits: ['自动补充水分', '清洁环境', '降低疾病风险'],
                        drawbacks: ['产出效率-10%', '容易感冒', '泥泞环境'],
                        productionBonus: 0.9,
                        healthDecayModifier: 1.1, // 健康度衰减增加
                        diseaseResistance: 1.2, // 疾病抗性提高
                        shelterNeed: true, // 需要庇护
                        specialActions: ['搭建雨棚', '保持干燥', '预防感冒']
                    }
                },
                stormy: {
                    icon: '⛈️',
                    title: '暴雨',
                    effect: 'stormy-effect',
                    animalEffects: {
                        benefits: ['充足水源', '环境清洁'],
                        drawbacks: ['产出停止', '健康度快速下降', '动物恐慌'],
                        productionBonus: 0,
                        healthDecayModifier: 2.0, // 健康度衰减翻倍
                        stressLevel: 'high',
                        shelterNeed: true, // 需要庇护
                        specialActions: ['紧急避难', '安抚动物', '加固设施']
                    }
                },
                drought: {
                    icon: '🔥',
                    title: '干旱',
                    effect: 'drought-effect',
                    animalEffects: {
                        benefits: ['干燥环境减少细菌'],
                        drawbacks: ['严重缺水', '产出减半', '健康度快速下降'],
                        productionBonus: 0.5,
                        healthDecayModifier: 2.5, // 健康度衰减大幅增加
                        waterNeed: 3.0, // 需要大量水分
                        shelterNeed: false, // 不需要庇护
                        specialActions: ['紧急供水', '降温措施', '减少活动']
                    }
                },
                typhoon: {
                    icon: '🌀',
                    title: '台风',
                    effect: 'typhoon-effect',
                    animalEffects: {
                        benefits: ['台风过后空气清新'],
                        drawbacks: ['动物受惊', '产出停止', '可能受伤'],
                        productionBonus: 0,
                        healthDecayModifier: 1.8,
                        injuryRisk: 0.1, // 10%受伤风险
                        shelterNeed: true, // 需要庇护
                        specialActions: ['紧急避难', '加固围栏', '医疗准备']
                    }
                },
                rainbow: {
                    icon: '🌈',
                    title: '彩虹天',
                    effect: 'rainbow-effect',
                    animalEffects: {
                        benefits: ['动物心情极佳', '产出品质提升', '健康度恢复'],
                        drawbacks: [],
                        productionBonus: 1.5,
                        healthDecayModifier: 0.5, // 健康度衰减大幅减少
                        qualityBonus: 1.5, // 产品品质提升
                        shelterNeed: false, // 不需要庇护
                        specialActions: ['户外活动', '增加互动', '享受时光']
                    }
                },
                sandstorm: {
                    icon: '🌪️',
                    title: '沙尘暴',
                    effect: 'sandstorm-effect',
                    animalEffects: {
                        benefits: [],
                        drawbacks: ['呼吸困难', '产出停止', '健康度下降', '视野受阻'],
                        productionBonus: 0,
                        healthDecayModifier: 2.2,
                        respiratoryIssues: true,
                        shelterNeed: true, // 需要庇护
                        specialActions: ['紧急避难', '防护措施', '医疗护理']
                    }
                }
            }
        };
        
        // 初始化牧场环境控制
        function initRanchEnvironment() {
            const soundBtn = document.getElementById('ranch-sound-btn');
            
            if (soundBtn) {
                soundBtn.onclick = function() {
                    ranchEnvironment.soundEnabled = !ranchEnvironment.soundEnabled;
                    const soundIcon = document.getElementById('sound-icon');
                    const soundText = document.getElementById('sound-text');
                    
                    if (ranchEnvironment.soundEnabled) {
                        soundIcon.textContent = '🔊';
                        soundText.textContent = '音效开';
                        soundBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                        soundBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                        showNotification('牧场音效已开启！', 'success');
                        playRanchSound();
                    } else {
                        soundIcon.textContent = '🔇';
                        soundText.textContent = '音效关';
                        soundBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                        soundBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                        showNotification('牧场音效已关闭', 'info');
                    }
                };
            }
            
            // 启动时间循环
            startTimeSystem();
            
            // 初始化天气显示
            updateRanchWeather();
        }
        
        // 更新牧场天气显示（与主天气系统同步）
        function updateRanchWeather() {
            const weatherEffect = document.getElementById('ranch-weather-effect');
            
            const currentWeather = ranchEnvironment.weatherEffects[gameState.weather];
            if (currentWeather) {
                if (weatherEffect) {
                    weatherEffect.className = `absolute inset-0 pointer-events-none z-5 ${currentWeather.effect}`;
                }
            }
        }
        
        // 播放牧场音效
        function playRanchSound() {
            if (!ranchEnvironment.soundEnabled) return;
            
            const animals = ['chicken', 'cow', 'sheep', 'pig', 'duck', 'goat', 'rabbit', 'horse'];
            const availableAnimals = animals.filter(animal => (gameState.animals[animal] || 0) > 0);
            
            if (availableAnimals.length > 0) {
                const randomAnimal = availableAnimals[Math.floor(Math.random() * availableAnimals.length)];
                const sounds = ranchEnvironment.animalSounds[randomAnimal];
                const randomSound = sounds[Math.floor(Math.random() * sounds.length)];
                
                // 显示音效提示
                const soundNotification = document.createElement('div');
                soundNotification.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-semibold z-50 animate-pulse';
                soundNotification.innerHTML = `🔊 ${getAnimalName(randomAnimal)}: ${randomSound}`;
                document.body.appendChild(soundNotification);
                
                setTimeout(() => {
                    soundNotification.remove();
                }, 2000);
            }
        }
        
        // 时间系统
        function startTimeSystem() {
            // 每30秒更新一次时间
            setInterval(() => {
                updateTimeOfDay();
                updateSeason();
                updateRanchStatus();
                
                // 随机播放动物音效
                if (Math.random() < 0.3) {
                    playRanchSound();
                }
            }, 30000);
        }
        
        function updateTimeOfDay() {
            const times = Object.keys(ranchEnvironment.timeSystem);
            const currentIndex = times.indexOf(ranchEnvironment.timeOfDay);
            const nextIndex = (currentIndex + 1) % times.length;
            
            ranchEnvironment.timeOfDay = times[nextIndex];
            
            const timeElement = document.getElementById('ranch-time');
            const moodElement = document.getElementById('ranch-mood');
            
            if (timeElement && moodElement) {
                const timeData = ranchEnvironment.timeSystem[ranchEnvironment.timeOfDay];
                timeElement.innerHTML = `${timeData.icon} 现在是${timeData.title}`;
                moodElement.textContent = timeData.mood;
            }
        }
        
        function updateSeason() {
            // 每2分钟换一次季节（演示用）
            if (Math.random() < 0.1) {
                const seasons = Object.keys(ranchEnvironment.seasons);
                const currentIndex = seasons.indexOf(ranchEnvironment.season);
                const nextIndex = (currentIndex + 1) % seasons.length;
                
                ranchEnvironment.season = seasons[nextIndex];
                
                const seasonElement = document.getElementById('ranch-season');
                if (seasonElement) {
                    const seasonData = ranchEnvironment.seasons[ranchEnvironment.season];
                    seasonElement.innerHTML = `${seasonData.icon} ${seasonData.title}`;
                }
            }
        }
        
        function updateRanchStatus() {
            const titleElement = document.getElementById('ranch-title');
            if (titleElement) {
                const totalAnimals = Object.values(gameState.animals).reduce((sum, count) => sum + (count || 0), 0);
                const avgHealth = calculateAverageHealth();
                const currentWeather = ranchEnvironment.weatherEffects[gameState.weather];
                
                let title = '牧场悠闲时光';
                if (totalAnimals === 0) {
                    title = '空旷的牧场';
                } else if (currentWeather && currentWeather.animalEffects.drawbacks.length > 0) {
                    title = `${currentWeather.title}中的牧场`;
                } else if (avgHealth > 80) {
                    title = '繁荣的牧场';
                } else if (avgHealth < 40) {
                    title = '需要关爱的牧场';
                }
                
                titleElement.textContent = title;
            }
        }
        
        function calculateAverageHealth() {
            const animalIds = ['chicken', 'cow', 'sheep', 'pig', 'duck', 'goat', 'rabbit', 'horse'];
            let totalHealth = 0;
            let animalCount = 0;
            
            animalIds.forEach(id => {
                const count = gameState.animals[id] || 0;
                if (count > 0) {
                    totalHealth += (gameState.animalHealth[id] || 0) * count;
                    animalCount += count;
                }
            });
            
            return animalCount > 0 ? Math.round(totalHealth / animalCount) : 100;
        }
        
        // 动物应对天气系统功能
        function handleAnimalWeatherResponse() {
            const currentWeather = ranchEnvironment.weatherEffects[gameState.weather];
            if (!currentWeather) return;
            
            const animalIds = ['chicken', 'cow', 'sheep', 'pig', 'duck', 'goat', 'rabbit', 'horse'];
            const effects = currentWeather.animalEffects;
            
            animalIds.forEach(animalId => {
                const animalCount = gameState.animals[animalId] || 0;
                if (animalCount === 0) return;
                
                // 处理庇护需求
                if (effects.shelterNeed && !gameState.animalShelter[animalId]) {
                    // 检查是否有庇护所设施
                    const hasShelter = (gameState.decors.shelter || 0) > 0;
                    if (hasShelter) {
                        // 有庇护所，自动提供庇护
                        gameState.animalShelter[animalId] = true;
                        gameState.animalStress[animalId] = Math.max(0, gameState.animalStress[animalId] - 5);
                        showNotification(`${getAnimalName(animalId)}自动获得庇护！`, 'success');
                    } else {
                        // 动物需要庇护但没有庇护
                        gameState.animalHealth[animalId] = Math.max(0, gameState.animalHealth[animalId] - 5);
                        gameState.animalStress[animalId] = Math.min(100, gameState.animalStress[animalId] + 10);
                        showNotification(`${getAnimalName(animalId)}需要庇护！健康度下降`, 'warning');
                    }
                }
                
                // 处理水分需求
                if (effects.waterNeed && effects.waterNeed > 1) {
                    const waterConsumption = effects.waterNeed * 2; // 天气影响水分消耗
                    gameState.animalWaterSupply[animalId] = Math.max(0, gameState.animalWaterSupply[animalId] - waterConsumption);
                    
                    // 检查是否有自动饮水系统
                    const hasWaterSystem = (gameState.decors.water_system || 0) > 0;
                    if (hasWaterSystem && gameState.animalWaterSupply[animalId] < 50) {
                        // 自动补充水分
                        gameState.animalWaterSupply[animalId] = 100;
                        showNotification(`${getAnimalName(animalId)}自动补充水分！`, 'success');
                    } else if (gameState.animalWaterSupply[animalId] < 30) {
                        gameState.animalHealth[animalId] = Math.max(0, gameState.animalHealth[animalId] - 3);
                        showNotification(`${getAnimalName(animalId)}缺水！需要补充水分`, 'warning');
                    }
                }
                
                // 处理压力值
                if (effects.stressLevel === 'high') {
                    gameState.animalStress[animalId] = Math.min(100, gameState.animalStress[animalId] + 15);
                }
                
                // 处理伤病风险
                if (effects.injuryRisk && Math.random() < effects.injuryRisk) {
                    // 检查是否有医疗箱
                    const hasMedicalKit = (gameState.decors.medical_kit || 0) > 0;
                    if (hasMedicalKit) {
                        // 自动治疗
                        showNotification(`${getAnimalName(animalId)}受伤但被医疗箱自动治疗！`, 'success');
                    } else {
                        const injury = {
                            type: 'weather_injury',
                            severity: Math.floor(Math.random() * 3) + 1, // 1-3级严重程度
                            timestamp: Date.now(),
                            weather: gameState.weather
                        };
                        gameState.animalInjuries[animalId].push(injury);
                        gameState.animalHealth[animalId] = Math.max(0, gameState.animalHealth[animalId] - 20);
                        showNotification(`${getAnimalName(animalId)}在${currentWeather.title}中受伤了！`, 'error');
                    }
                }
                
                // 处理呼吸问题（沙尘暴）
                if (effects.respiratoryIssues) {
                    gameState.animalHealth[animalId] = Math.max(0, gameState.animalHealth[animalId] - 2);
                    gameState.animalStress[animalId] = Math.min(100, gameState.animalStress[animalId] + 5);
                }
            });
            
            // 更新动物状态显示
            renderAnimalWeatherStatus();
        }
        
        // 动物天气状态渲染
        function renderAnimalWeatherStatus() {
            const statusBox = document.getElementById('animal-weather-status');
            if (!statusBox) return;
            
            const currentWeather = ranchEnvironment.weatherEffects[gameState.weather];
            if (!currentWeather) return;
            
            const animalIds = ['chicken', 'cow', 'sheep', 'pig', 'duck', 'goat', 'rabbit', 'horse'];
            let statusHtml = `
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                    <h3 class="font-bold text-lg mb-2 flex items-center">
                        <span class="text-2xl mr-2">${currentWeather.icon}</span>
                        ${currentWeather.title}对动物的影响
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-green-600 mb-1">好处：</h4>
                            <ul class="text-sm text-green-700">
                                ${currentWeather.animalEffects.benefits.map(benefit => `<li>• ${benefit}</li>`).join('')}
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold text-red-600 mb-1">坏处：</h4>
                            <ul class="text-sm text-red-700">
                                ${currentWeather.animalEffects.drawbacks.map(drawback => `<li>• ${drawback}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h4 class="font-semibold text-blue-600 mb-1">建议行动：</h4>
                        <div class="flex flex-wrap gap-2">
                            ${currentWeather.animalEffects.specialActions.map(action => {
                                const facility = getWeatherActionFacility(action);
                                const hasFacility = facility ? (gameState.decors[facility.id] || 0) > 0 : false;
                                const facilityCost = facility ? facility.price : 0;
                                
                                if (hasFacility) {
                                    return `<button class="weather-action-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm" data-action="${action}" title="已拥有${facility.name}">${action}</button>`;
                                } else if (facility) {
                                    return `<button class="weather-action-btn bg-gray-400 hover:bg-gray-500 text-white px-3 py-1 rounded text-sm" data-action="${action}" data-facility="${facility.id}" data-cost="${facilityCost}" title="需要购买${facility.name}">${action} (需购买)</button>`;
                                } else {
                                    return `<button class="weather-action-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm" data-action="${action}">${action}</button>`;
                                }
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // 添加动物状态详情
            let animalStatusHtml = '<div class="space-y-2">';
            animalIds.forEach(animalId => {
                const count = gameState.animals[animalId] || 0;
                if (count === 0) return;
                
                const health = gameState.animalHealth[animalId] || 0;
                const stress = gameState.animalStress[animalId] || 0;
                const water = gameState.animalWaterSupply[animalId] || 100;
                const shelter = gameState.animalShelter[animalId] || false;
                const injuries = gameState.animalInjuries[animalId] || [];
                
                let statusClass = 'bg-green-50 border-green-400';
                let statusText = '状态良好';
                
                if (health < 50 || stress > 70 || water < 30) {
                    statusClass = 'bg-red-50 border-red-400';
                    statusText = '需要关注';
                } else if (health < 80 || stress > 40 || water < 60) {
                    statusClass = 'bg-yellow-50 border-yellow-400';
                    statusText = '状态一般';
                }
                
                animalStatusHtml += `
                    <div class="${statusClass} border-l-4 p-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-xl mr-2">${getAnimalIcon(animalId)}</span>
                                <div>
                                    <div class="font-semibold">${getAnimalName(animalId)} ×${count}</div>
                                    <div class="text-sm text-gray-600">${statusText}</div>
                                </div>
                            </div>
                            <div class="text-right text-sm">
                                <div class="flex items-center gap-2">
                                    <span>健康: ${health}%</span>
                                    <span>压力: ${stress}%</span>
                                    <span>水分: ${water}%</span>
                                </div>
                                <div class="flex items-center gap-2 mt-1">
                                    <span>庇护: ${shelter ? '✅' : '❌'}</span>
                                    <span>伤病: ${injuries.length}</span>
                                </div>
                            </div>
                        </div>
                        ${injuries.length > 0 ? `
                            <div class="mt-2 text-xs text-red-600">
                                伤病记录: ${injuries.map(injury => 
                                    `${injury.type}(${injury.severity}级)`
                                ).join(', ')}
                            </div>
                        ` : ''}
                        <div class="mt-2">
                            <button class="weather-item-btn bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs" data-animal-id="${animalId}">
                                使用道具
                            </button>
                        </div>
                    </div>
                `;
            });
            animalStatusHtml += '</div>';
            
            statusBox.innerHTML = statusHtml + animalStatusHtml;
            
            // 绑定天气行动按钮
            document.querySelectorAll('.weather-action-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    const facility = this.getAttribute('data-facility');
                    const cost = this.getAttribute('data-cost');
                    
                    if (facility && cost) {
                        // 需要购买设施
                        if (gameState.money < parseInt(cost)) {
                            showNotification(`金币不足！需要 ${cost} 金币购买设施`, 'error');
                            return;
                        }
                        
                        // 询问是否购买设施
                        if (confirm(`需要购买${getWeatherActionFacility(action).name}才能执行此行动。是否立即购买？(${cost}金币)`)) {
                            // 购买设施
                            gameState.money -= parseInt(cost);
                            gameState.decors[facility] = (gameState.decors[facility] || 0) + 1;
                            
                            // 切换到装饰商店显示购买结果
                            const decorTab = document.querySelector('.shop-tab-btn[data-category="decor"]');
                            if (decorTab) {
                                decorTab.click();
                            }
                            
                            renderDecorShop();
                            renderMyDecors();
                            updateUI();
                            saveGameData();
                            
                            showNotification(`购买${getWeatherActionFacility(action).name}成功！现在可以执行${action}了`, 'success');
                        }
                    } else {
                        // 直接执行行动
                        executeWeatherAction(action);
                    }
                });
            });
            
            // 绑定天气状态面板中的道具使用按钮
            statusBox.querySelectorAll('.weather-item-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const animalId = this.getAttribute('data-animal-id');
                    showAnimalItemMenu(animalId);
                });
            });
        }
        
        // 执行天气应对行动
        function executeWeatherAction(action) {
            const currentWeather = ranchEnvironment.weatherEffects[gameState.weather];
            const facility = getWeatherActionFacility(action);
            
            // 检查是否需要设施
            if (facility) {
                const hasFacility = (gameState.decors[facility.id] || 0) > 0;
                if (!hasFacility) {
                    showNotification(`需要先购买${facility.name}才能执行此行动！`, 'warning');
                    // 切换到装饰商店标签
                    const decorTab = document.querySelector('.shop-tab-btn[data-category="decor"]');
                    if (decorTab) {
                        decorTab.click();
                    }
                    return;
                }
            }
            
            const cost = getWeatherActionCost(action);
            
            if (gameState.money < cost) {
                showNotification(`金币不足！需要 ${cost} 金币`, 'error');
                return;
            }
            
            gameState.money -= cost;
            
            switch(action) {
                case '提供遮阳':
                case '搭建雨棚':
                case '紧急避难':
                    // 为所有动物提供庇护
                    const animalIds = ['chicken', 'cow', 'sheep', 'pig', 'duck', 'goat', 'rabbit', 'horse'];
                    animalIds.forEach(id => {
                        if (gameState.animals[id] > 0) {
                            gameState.animalShelter[id] = true;
                            gameState.animalStress[id] = Math.max(0, gameState.animalStress[id] - 20);
                        }
                    });
                    showNotification('已为所有动物提供庇护！', 'success');
                    break;
                    
                case '增加饮水':
                case '紧急供水':
                    // 补充所有动物的水分
                    animalIds.forEach(id => {
                        if (gameState.animals[id] > 0) {
                            gameState.animalWaterSupply[id] = 100;
                        }
                    });
                    showNotification('已为所有动物补充水分！', 'success');
                    break;
                    
                case '防暑降温':
                case '降温措施':
                    // 降低动物压力值
                    animalIds.forEach(id => {
                        if (gameState.animals[id] > 0) {
                            gameState.animalStress[id] = Math.max(0, gameState.animalStress[id] - 15);
                            gameState.animalHealth[id] = Math.min(100, gameState.animalHealth[id] + 10);
                        }
                    });
                    showNotification('已为动物降温！', 'success');
                    break;
                    
                case '安抚动物':
                    // 大幅降低压力值
                    animalIds.forEach(id => {
                        if (gameState.animals[id] > 0) {
                            gameState.animalStress[id] = Math.max(0, gameState.animalStress[id] - 30);
                        }
                    });
                    showNotification('已安抚所有动物！', 'success');
                    break;
                    
                case '医疗准备':
                case '医疗护理':
                    // 治疗伤病
                    animalIds.forEach(id => {
                        if (gameState.animalInjuries[id].length > 0) {
                            gameState.animalInjuries[id] = [];
                            gameState.animalHealth[id] = Math.min(100, gameState.animalHealth[id] + 20);
                        }
                    });
                    showNotification('已为动物提供医疗护理！', 'success');
                    break;
                    
                case '户外活动':
                case '增加互动':
                case '享受时光':
                    // 提升幸福值
                    gameState.happiness = Math.min(100, gameState.happiness + 10);
                    animalIds.forEach(id => {
                        if (gameState.animals[id] > 0) {
                            gameState.animalStress[id] = Math.max(0, gameState.animalStress[id] - 10);
                        }
                    });
                    showNotification('动物们心情愉悦！', 'success');
                    break;
                    
                default:
                    showNotification('执行了应对措施！', 'info');
            }
            
            updateUI();
            renderAnimalWeatherStatus();
            saveGameData();
        }
        
        // 获取天气行动成本
        function getWeatherActionCost(action) {
            const costMap = {
                '提供遮阳': 50,
                '搭建雨棚': 80,
                '紧急避难': 120,
                '增加饮水': 30,
                '紧急供水': 60,
                '防暑降温': 40,
                '降温措施': 70,
                '安抚动物': 50,
                '医疗准备': 100,
                '医疗护理': 150,
                '户外活动': 20,
                '增加互动': 30,
                '享受时光': 25
            };
            return costMap[action] || 50;
        }
        
        // 获取天气行动对应的设施
        function getWeatherActionFacility(action) {
            const actionFacilityMap = {
                '提供遮阳': { id: 'shelter', name: '动物庇护所', price: 150 },
                '搭建雨棚': { id: 'shelter', name: '动物庇护所', price: 150 },
                '紧急避难': { id: 'shelter', name: '动物庇护所', price: 150 },
                '增加饮水': { id: 'water_system', name: '自动饮水系统', price: 120 },
                '紧急供水': { id: 'water_system', name: '自动饮水系统', price: 120 },
                '防暑降温': { id: 'cooling_system', name: '降温系统', price: 100 },
                '降温措施': { id: 'cooling_system', name: '降温系统', price: 100 },
                '安抚动物': { id: 'stress_relief', name: '安抚设施', price: 80 },
                '医疗准备': { id: 'medical_kit', name: '医疗箱', price: 200 },
                '医疗护理': { id: 'medical_kit', name: '医疗箱', price: 200 },
                '户外活动': { id: 'activity_zone', name: '活动区', price: 90 },
                '增加互动': { id: 'activity_zone', name: '活动区', price: 90 },
                '享受时光': { id: 'activity_zone', name: '活动区', price: 90 }
            };
            return actionFacilityMap[action] || null;
        }
        
        // 获取动物图标
        function getAnimalIcon(animalId) {
            const icons = {
                'chicken': '🐔',
                'cow': '🐄',
                'sheep': '🐑',
                'pig': '🐷',
                'duck': '🦆',
                'goat': '🐐',
                'rabbit': '🐰',
                'horse': '🐎'
            };
            return icons[animalId] || '🐾';
        }
        
        // 页面加载完成后初始化牧场环境
        setTimeout(() => {
            initRanchEnvironment();
        }, 1000);

        // 通过ID获取种子
        function getSeedById(id) {
            return seeds.find(seed => seed.id === id);
        }

        // 获取土地改良等级
        function getLandImprovementLevel(plotIndex) {
            if (!gameState.regionLandImprovements[gameState.currentRegion]) {
                return 0;
            }
            return gameState.regionLandImprovements[gameState.currentRegion][plotIndex] || 0;
        }

        // 设置土地改良等级
        function setLandImprovementLevel(plotIndex, level) {
            if (!gameState.regionLandImprovements[gameState.currentRegion]) {
                gameState.regionLandImprovements[gameState.currentRegion] = {};
            }
            gameState.regionLandImprovements[gameState.currentRegion][plotIndex] = level;
        }

        // 获取土地改良数据
        function getLandImprovementData(level) {
            return landImprovementLevels.find(l => l.level === level) || landImprovementLevels[0];
        }

        // 升级土地改良
        function upgradeLandImprovement(plotIndex) {
            const currentLevel = getLandImprovementLevel(plotIndex);
            const nextLevel = currentLevel + 1;
            
            if (nextLevel >= landImprovementLevels.length) {
                showNotification('土地已达到最高等级！', 'info');
                return;
            }
            
            const nextLevelData = getLandImprovementData(nextLevel);
            if (gameState.money < nextLevelData.cost) {
                showNotification(`金币不足！需要 ${nextLevelData.cost} 金币`, 'error');
                return;
            }
            
            gameState.money -= nextLevelData.cost;
            setLandImprovementLevel(plotIndex, nextLevel);
            
            showNotification(`土地改良成功！升级到 ${nextLevelData.name}`, 'success');
            updateUI();
            renderFarm();
            saveGameData();
        }

        // 获取水果品质数据
        function getFruitQualityData(level) {
            return fruitQualities.find(q => q.level === level) || fruitQualities[0];
        }

        // 根据土地等级确定水果品质
        function determineFruitQuality(plotIndex) {
            const landLevel = getLandImprovementLevel(plotIndex);
            const random = Math.random();
            
            if (landLevel === 0) {
                // 普通土地：只能出普通品质水果
                return 0;
            } else if (landLevel === 1) {
                // 肥沃土地：能出普通和优良品质水果，按100%概率平均分配
                return random < 0.5 ? 0 : 1;
            } else if (landLevel === 2) {
                // 优质土地：可以出普通、优良、精品水果，按100%概率平均分配
                if (random < 0.33) return 0;
                else if (random < 0.67) return 1;
                else return 2;
            } else if (landLevel === 3) {
                // 完美土地：不出普通水果，出优良、精品和完美水果，按100%概率平均分配
                if (random < 0.33) return 1;
                else if (random < 0.67) return 2;
                else return 3;
            }
            return 0;
        }

        // 添加品质水果到库存
        function addQualityFruitToInventory(seedId, quality, count = 1) {
            if (!gameState.qualityInventory[seedId]) {
                gameState.qualityInventory[seedId] = { 0: 0, 1: 0, 2: 0, 3: 0 };
            }
            gameState.qualityInventory[seedId][quality] = (gameState.qualityInventory[seedId][quality] || 0) + count;
        }

        // 获取品质水果库存数量
        function getQualityFruitCount(seedId, quality) {
            if (!gameState.qualityInventory[seedId]) {
                return 0;
            }
            return gameState.qualityInventory[seedId][quality] || 0;
        }

        // 移除品质水果库存
        function removeQualityFruitFromInventory(seedId, quality, count = 1) {
            if (!gameState.qualityInventory[seedId] || !gameState.qualityInventory[seedId][quality]) {
                return false;
            }
            if (gameState.qualityInventory[seedId][quality] < count) {
                return false;
            }
            gameState.qualityInventory[seedId][quality] -= count;
            return true;
        }

        // 出售品质水果
        function sellQualityFruit(seedId, quality, qty = 1, pricePerUnit) {
            const availableCount = getQualityFruitCount(seedId, quality);
            if (availableCount <= 0) {
                showNotification('库存不足！', 'error');
                return;
            }
            
            qty = Math.max(1, Math.min(qty, availableCount));
            
            if (removeQualityFruitFromInventory(seedId, quality, qty)) {
                const totalPrice = pricePerUnit * qty;
                gameState.money += totalPrice;
                
                const seed = getSeedById(seedId);
                const qualityData = getFruitQualityData(quality);
                
                updateUI();
                renderInventory();
                showNotification(`售出 ${qualityData.name}${seed.name} ×${qty}! +${totalPrice}金币`, 'success');
                
                // 更新任务进度
                updateTaskProgress('sell', totalPrice);
                
                // 保存游戏数据
                saveGameData();
            } else {
                showNotification('出售失败！', 'error');
            }
        }
    </script>
</body>
</html>
