<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼€å¿ƒå†œåœº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .crop-plot {
            transition: all 0.3s ease;
        }
        .crop-plot:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }
        .progress-bar {
            transition: width 0.5s linear;
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .notification {
            animation: slideIn 0.5s forwards, stay 2s 0.5s forwards, slideOut 0.5s 2.5s forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes stay {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        /* æ·»åŠ ä¿å­˜æŒ‡ç¤ºå™¨æ ·å¼ */
        .save-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 100;
        }
        .save-indicator.show {
            opacity: 1;
        }
        /* åœ°åŒºèƒŒæ™¯æ ·å¼ */
        body.bg-north_china {
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            background-image: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-south_china {
            background: linear-gradient(135deg, #f9f6e7 0%, #f7e8aa 100%);
            background-image: url('https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-east_china {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            background-image: url('https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-west_china {
            background: linear-gradient(135deg, #fceabb 0%, #f8b500 100%);
            background-image: url('https://images.unsplash.com/photo-1502082553048-f009c37129b9?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-japan {
            background: linear-gradient(135deg, #f8ffae 0%, #43c6ac 100%);
            background-image: url('https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-us_midwest {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            background-image: url('https://images.unsplash.com/photo-1465101178521-c1a9136a3b99?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        body.bg-europe {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            background-image: url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-attachment: fixed;
        }
        /* å¡ç‰‡å’ŒæŒ‰é’®ç¾åŒ– */
        .card-strong {
            background: rgba(255,255,255,0.92);
            border-radius: 1.25rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
            border: 1.5px solid rgba(255,255,255,0.18);
            transition: box-shadow 0.3s, transform 0.2s;
        }
        .card-strong:hover {
            box-shadow: 0 16px 48px 0 rgba(31, 38, 135, 0.25);
            transform: translateY(-2px) scale(1.01);
        }
        .btn-strong {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            color: #fff;
            font-weight: bold;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px 0 rgba(67,233,123,0.15);
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
        }
        .btn-strong:hover {
            background: linear-gradient(90deg, #38f9d7 0%, #43e97b 100%);
            box-shadow: 0 4px 16px 0 rgba(67,233,123,0.25);
            transform: scale(1.05);
        }
        .title-strong {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 2px;
            color: #1a4d2e;
            text-shadow: 0 2px 8px rgba(67,233,123,0.15);
        }
        .subtitle-strong {
            font-size: 1.25rem;
            font-weight: 700;
            color: #388e3c;
        }
        /* ç™»å½•å¼¹çª—ç¾åŒ– */
        #login-modal input[type="text"], #login-modal input[type="password"] {
            font-size: 1.1rem;
            border-radius: 1rem;
            border: 1.5px solid #b2dfdb;
            box-shadow: 0 2px 8px 0 rgba(67,233,123,0.08);
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            transition: border 0.2s, box-shadow 0.2s;
        }
        #login-modal input[type="text"]:focus, #login-modal input[type="password"]:focus {
            border: 2px solid #43e97b;
            box-shadow: 0 4px 16px 0 rgba(67,233,123,0.15);
        }
        #login-modal .register-btn {
            border-radius: 50%;
            font-size: 0.95rem;
            font-weight: bold;
            box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.10);
            transition: box-shadow 0.2s, transform 0.15s, background 0.2s;
            padding: 0;
            margin-bottom: 0;
            min-width: 0;
            flex: 1 1 0;
            margin-right: 0;
            width: 48px;
            height: 48px;
            justify-content: center;
            align-items: center;
            display: flex;
        }
        #login-modal .register-btn:not(:last-child) {
            margin-right: 0.5rem;
        }
        #login-modal .register-btn i {
            font-size: 1.5rem;
            margin: 0;
        }
        #login-modal .register-btn:hover {
            box-shadow: 0 8px 24px 0 rgba(67,233,123,0.18);
            transform: translateY(-2px) scale(1.08);
            filter: brightness(1.05);
        }
        #login-modal .w-full.flex.flex-row.items-center.justify-between.gap-2.mt-2 {
            gap: 0.7rem;
        }
        #login-modal .w-full.flex.items-center.my-4 {
            margin: 1.2rem 0 1.1rem 0;
        }
        #login-modal hr {
            margin: 1.2rem 0 1.1rem 0;
        }
        #login-modal input::placeholder {
            color: #bdbdbd;
            font-size: 1rem;
        }
        #login-btn {
            border-radius: 1.2rem;
            font-size: 1.1rem;
            font-weight: bold;
            box-shadow: 0 2px 8px 0 rgba(67,233,123,0.10);
            transition: box-shadow 0.2s, background 0.2s, transform 0.1s;
        }
        #login-btn:hover {
            background: #43e97b;
            box-shadow: 0 8px 24px 0 rgba(67,233,123,0.18);
            transform: scale(1.04);
        }
        /* é€€å‡ºç™»å½•æŒ‰é’®æ ·å¼åŠ å¼º */
        #logout-btn {
            border-radius: 1.5rem;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.10);
            transition: box-shadow 0.2s, background 0.2s, transform 0.1s;
        }
        #logout-btn:hover {
            background: #e0f2f1;
            box-shadow: 0 8px 24px 0 rgba(67,233,123,0.18);
            transform: scale(1.04);
        }
    </style>
</head>
<body class="bg-green-50 min-h-screen" id="main-body">
    <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
    <button id="logout-btn" class="fixed top-4 left-4 z-50 bg-white border border-gray-300 shadow px-4 py-2 rounded-lg text-green-700 font-bold hover:bg-green-100">
      <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡ºç™»å½•
    </button>
    <!-- ç™»å½•å¼¹çª— -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl p-10 flex flex-col items-center w-80">
        <h2 class="text-2xl font-bold mb-6 text-green-700">æ³¨å†Œå¹¶ç™»å½•å¼€å¿ƒå†œåœº</h2>
        <form id="login-form" class="w-full flex flex-col items-center">
          <input id="login-account" type="text" placeholder="è´¦å·" class="w-full mb-3 px-3 py-2 border rounded-lg focus:outline-none" required />
          <input id="login-password" type="password" placeholder="å¯†ç " class="w-full mb-3 px-3 py-2 border rounded-lg focus:outline-none" required />
          <button type="button" id="login-btn" class="w-full mb-4 py-2 rounded-2xl bg-green-500 hover:bg-green-600 text-white font-bold text-lg shadow transition">ç™»å½•</button>
          <div class="w-full flex items-center my-4">
            <div class="flex-1 h-px bg-gray-300"></div>
            <span class="mx-3 text-gray-400 text-sm select-none">æ³¨å†Œ</span>
            <div class="flex-1 h-px bg-gray-300"></div>
          </div>
          <div class="w-full flex flex-row items-center justify-between gap-2 mt-2">
            <button type="button" class="register-btn flex-1 flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-full shadow transition text-xs" data-type="qq" style="min-width:0;max-width:48px;max-height:48px;">
              <i class="fab fa-qq" style="font-size:1.5rem;"></i>
            </button>
            <button type="button" class="register-btn flex-1 flex items-center justify-center bg-green-500 hover:bg-green-600 text-white py-3 rounded-full shadow transition text-xs" data-type="wx" style="min-width:0;max-width:48px;max-height:48px;">
              <i class="fab fa-weixin" style="font-size:1.5rem;"></i>
            </button>
            <button type="button" class="register-btn flex-1 flex items-center justify-center bg-black hover:bg-gray-800 text-white py-3 rounded-full shadow transition text-xs" data-type="douyin" style="min-width:0;max-width:48px;max-height:48px;">
              <i class="fab fa-tiktok" style="font-size:1.5rem;"></i>
            </button>
            <button type="button" class="register-btn flex-1 flex items-center justify-center bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-full shadow transition text-xs" data-type="account" style="min-width:0;max-width:48px;max-height:48px;">
              <i class="fas fa-user" style="font-size:1.5rem;"></i>
            </button>
          </div>
        </form>
      </div>
    </div>
    <!-- ç®¡ç†å‘˜é¢æ¿å¼¹çª— -->
    <div id="admin-panel" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50" style="display:none;">
      <div class="bg-white rounded-2xl shadow-2xl p-8 w-[95vw] max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
        <h2 class="text-2xl font-bold mb-4 text-green-700">ç®¡ç†å‘˜é¢æ¿</h2>
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-2">å½“å‰æ¸¸æˆæ•°æ®</h3>
          <div class="grid grid-cols-2 gap-4 mb-2">
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-1">é‡‘å¸</label>
              <input id="admin-money" type="number" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-1">ç»éªŒ</label>
              <input id="admin-xp" type="number" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-1">ç­‰çº§</label>
              <input id="admin-level" type="number" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-1">å¤©æ°”</label>
              <select id="admin-weather" class="w-full border rounded px-2 py-1">
                <option value="sunny">æ™´å¤©</option>
                <option value="rainy">é›¨å¤©</option>
                <option value="cloudy">é˜´å¤©</option>
                <option value="stormy">æš´é£é›¨</option>
              </select>
            </div>
          </div>
          <button id="admin-save" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-bold mt-2">ä¿å­˜ä¿®æ”¹</button>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2">æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯</h3>
          <div id="admin-users-list" class="overflow-x-auto text-sm"></div>
        </div>
        <button id="admin-close" class="mt-6 bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded font-bold self-end">å…³é—­</button>
      </div>
    </div>
    <!-- ç®¡ç†å‘˜æŒ‰é’®ï¼Œä»…ç®¡ç†å‘˜å¯è§ -->
    <button id="admin-open-btn" class="fixed top-4 right-4 z-50 bg-green-600 hover:bg-green-700 text-white font-bold px-5 py-2 rounded-xl shadow-lg" style="display:none;">ç®¡ç†å‘˜</button>
    <!-- ç«‹å³å®Œæˆç”Ÿé•¿æŒ‰é’®ï¼Œä»…ç®¡ç†å‘˜å¯è§ -->
    <button id="admin-grow-btn" class="fixed top-16 right-4 z-50 bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-5 py-2 rounded-xl shadow-lg" style="display:none;">ç«‹å³å®Œæˆç”Ÿé•¿</button>
    <div class="container mx-auto px-4 py-8">
        <!-- åœ°åŒºåˆ‡æ¢åŒºåŸŸï¼ˆæ›´å¤§æ›´æ˜¾çœ¼ï¼‰ -->
        <div class="mb-8 flex items-center justify-center">
            <div class="bg-green-200 rounded-xl px-6 py-4 flex items-center shadow-lg border-2 border-green-400">
                <label for="region-select" class="mr-4 text-2xl font-extrabold text-green-900 title-strong">ğŸŒ é€‰æ‹©åœ°åŒºï¼š</label>
                <select id="region-select" class="border-2 border-green-500 rounded-lg px-6 py-3 text-xl font-bold text-green-900 bg-white shadow focus:outline-none focus:ring-2 focus:ring-green-400 transition">
                    <!-- é€‰é¡¹é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </select>
            </div>
        </div>
        <!-- æ¸¸æˆæ ‡é¢˜å’ŒçŠ¶æ€æ  -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 card-strong p-6">
            <h1 class="title-strong mb-4 md:mb-0">ğŸ® å¼€å¿ƒå†œåœº ğŸšœ</h1>
            <div class="flex space-x-4">
                <div class="bg-white rounded-lg p-3 shadow flex items-center">
                    <div id="weather-icon" class="text-xl mr-1">â˜€ï¸</div>
                    <div>
                        <p class="font-semibold text-green-700 text-sm">å¤©æ°”: <span id="weather-name">æ™´å¤©</span></p>
                        <p class="text-xs text-gray-600" id="weather-effects">ç”Ÿé•¿+0% å”®ä»·+0%</p>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow">
                    <p class="font-semibold text-green-700"><i class="fas fa-coins text-yellow-500 mr-1"></i> é‡‘å¸: <span id="money">100</span></p>
                </div>
                <div class="bg-white rounded-lg p-3 shadow">
                    <p class="font-semibold text-green-700"><i class="fas fa-star text-yellow-400 mr-1"></i> ç­‰çº§: <span id="level">1</span></p>
                </div>
                <div class="bg-white rounded-lg p-3 shadow">
                    <p class="font-semibold text-green-700"><i class="fas fa-chart-line text-blue-500 mr-1"></i> ç»éªŒ: <span id="xp">0</span>/<span id="maxXp">100</span></p>
                </div>
            </div>
        </header>

        <!-- æ¸¸æˆå†…å®¹åŒºåŸŸ -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å†œåœºåŒºåŸŸ -->
            <div class="lg:col-span-2 card-strong p-8">
                <h2 class="text-3xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                    <i class="fas fa-tractor mr-3"></i> æˆ‘çš„å†œåœº
                </h2>
                <div class="flex justify-between items-center mb-4">
                    <p class="text-gray-600">ä½ æœ‰ <span id="plots-count">4</span> å—å†œç”° (æœ€å¤§: 12)</p>
                    <button id="expand-farm" class="btn-strong px-6 py-2 text-lg transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-plus mr-2"></i> æ‰©å±•å†œç”° (200é‡‘å¸)
                    </button>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="farm-grid">
                    <!-- å†œç”°åœ°å—å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ä¾§è¾¹æ  -->
            <div class="space-y-6">
                <!-- å•†åº—åŒºåŸŸ -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-store mr-3"></i> ç§å­å•†åº—
                    </h2>
                    <div class="space-y-3" id="shop-items">
                        <!-- ç§å­å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- åº“å­˜åŒºåŸŸ -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-box-open mr-3"></i> æˆ‘çš„åº“å­˜
                    </h2>
                    <div id="inventory-items">
                        <p class="text-gray-500 italic">è¿™é‡Œä¼šæ˜¾ç¤ºä½ æ”¶è·çš„ä½œç‰©</p>
                    </div>
                </div>

                <!-- ä»»åŠ¡åŒºåŸŸ -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-tasks mr-3"></i> æ¯æ—¥ä»»åŠ¡
                    </h2>
                    <div id="tasks-list">
                        <p class="text-gray-500 italic">ä»Šæ—¥ä»»åŠ¡å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                    </div>
                </div>

                <!-- å‡çº§åŒºåŸŸ -->
                <div class="card-strong p-6">
                    <h2 class="text-2xl subtitle-strong mb-4 border-b-2 border-green-200 pb-2 flex items-center">
                        <i class="fas fa-wrench mr-3"></i> å†œåœºå‡çº§
                    </h2>
                    <div class="space-y-4" id="upgrades">
                        <!-- å‡çº§é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </main>

        <!-- é€šçŸ¥åŒºåŸŸ -->
        <div id="notifications" class="fixed bottom-4 right-4 space-y-2 w-64"></div>

        <!-- ä¿å­˜æŒ‡ç¤ºå™¨ -->
        <div id="save-indicator" class="save-indicator">
            <i class="fas fa-save mr-2"></i> æ¸¸æˆæ•°æ®å·²ä¿å­˜
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            money: 100,
            level: 1,
            xp: 0,
            maxXp: 100,
            plots: 4,
            maxPlots: 12,
            inventory: {},
            upgrades: {
                watering: 0,
                quality: 0,
                greenhouse: 0
            },
            currentSelectedSeed: null,
            purchasedSeeds: {},
            weather: 'sunny',
            dailyStreak: 0,
            lastPlayed: null,
            completedTasks: 0,
            achievements: [],
            currentRegion: 'north_china', // æ–°å¢å­—æ®µï¼Œé»˜è®¤ä¸­å›½ä¸œåŒ—
            tasks: [],
            farmData: [] // æ–°å¢å­—æ®µï¼Œå­˜å‚¨å†œç”°æ•°æ®
        };

        // åœ°åŒºæ•°æ®ï¼ˆæ›´ç»†åˆ†ä¸”ä¸é‡å¤ï¼‰
        const regions = [
            { id: 'north_china', name: 'ä¸­å›½ä¸œåŒ—' },
            { id: 'south_china', name: 'ä¸­å›½åå—' },
            { id: 'east_china', name: 'ä¸­å›½åä¸œ' },
            { id: 'west_china', name: 'ä¸­å›½è¥¿éƒ¨' },
            { id: 'japan', name: 'æ—¥æœ¬' },
            { id: 'us_midwest', name: 'ç¾å›½ä¸­éƒ¨' },
            { id: 'europe', name: 'æ¬§æ´²' }
        ];
        // æ¤ç‰©ç§ç±»ä¸é‡å¤ï¼Œæ¯ä¸ªåŒºåŸŸç‹¬æœ‰ï¼Œ5-6ç§
        const seeds = [
            // ä¸­å›½ä¸œåŒ—
            { id: 'soybean', name: 'å¤§è±†', price: 10, growTime: 10, sellPrice: 20, xp: 5, icon: 'ğŸŒ±', color: 'bg-lime-100', regions: ['north_china'] },
            { id: 'millet', name: 'å°ç±³', price: 12, growTime: 12, sellPrice: 22, xp: 6, icon: 'ğŸŒ¾', color: 'bg-yellow-200', regions: ['north_china'] },
            { id: 'sorghum', name: 'é«˜ç²±', price: 15, growTime: 15, sellPrice: 30, xp: 8, icon: 'ğŸŒ¾', color: 'bg-red-200', regions: ['north_china'] },
            { id: 'potato', name: 'åœŸè±†', price: 20, growTime: 20, sellPrice: 45, xp: 12, icon: 'ğŸ¥”', color: 'bg-amber-100', regions: ['north_china'] },
            { id: 'corn', name: 'ç‰ç±³', price: 18, growTime: 18, sellPrice: 38, xp: 10, icon: 'ğŸŒ½', color: 'bg-yellow-100', regions: ['north_china'] },
            // ä¸­å›½åå—
            { id: 'lychee', name: 'è”æ', price: 22, growTime: 22, sellPrice: 50, xp: 13, icon: 'ğŸ¥­', color: 'bg-pink-100', regions: ['south_china'] },
            { id: 'banana', name: 'é¦™è•‰', price: 25, growTime: 25, sellPrice: 60, xp: 15, icon: 'ğŸŒ', color: 'bg-yellow-200', regions: ['south_china'] },
            { id: 'sugarcane', name: 'ç”˜è”—', price: 20, growTime: 20, sellPrice: 48, xp: 12, icon: 'ğŸ‹', color: 'bg-green-200', regions: ['south_china'] },
            { id: 'pineapple', name: 'è è', price: 28, growTime: 28, sellPrice: 70, xp: 18, icon: 'ğŸ', color: 'bg-amber-200', regions: ['south_china'] },
            { id: 'dragonfruit', name: 'ç«é¾™æœ', price: 35, growTime: 35, sellPrice: 90, xp: 22, icon: 'ğŸ‰', color: 'bg-pink-200', regions: ['south_china'] },
            // ä¸­å›½åä¸œ
            { id: 'rice', name: 'æ°´ç¨»', price: 15, growTime: 15, sellPrice: 32, xp: 9, icon: 'ğŸŒ¾', color: 'bg-green-200', regions: ['east_china'] },
            { id: 'peanut', name: 'èŠ±ç”Ÿ', price: 18, growTime: 18, sellPrice: 38, xp: 10, icon: 'ğŸ¥œ', color: 'bg-yellow-300', regions: ['east_china'] },
            { id: 'rapeseed', name: 'æ²¹èœ', price: 16, growTime: 16, sellPrice: 34, xp: 9, icon: 'ğŸŒ»', color: 'bg-yellow-100', regions: ['east_china'] },
            { id: 'lotus', name: 'è²è—•', price: 22, growTime: 22, sellPrice: 50, xp: 13, icon: 'ğŸŒ¸', color: 'bg-pink-100', regions: ['east_china'] },
            { id: 'tea', name: 'èŒ¶å¶', price: 30, growTime: 30, sellPrice: 80, xp: 20, icon: 'ğŸƒ', color: 'bg-green-100', regions: ['east_china'] },
            // ä¸­å›½è¥¿éƒ¨
            { id: 'walnut', name: 'æ ¸æ¡ƒ', price: 25, growTime: 25, sellPrice: 60, xp: 15, icon: 'ğŸŒ°', color: 'bg-amber-200', regions: ['west_china'] },
            { id: 'apple', name: 'è‹¹æœ', price: 20, growTime: 20, sellPrice: 48, xp: 12, icon: 'ğŸ', color: 'bg-red-100', regions: ['west_china'] },
            { id: 'grape', name: 'è‘¡è„', price: 28, growTime: 28, sellPrice: 70, xp: 18, icon: 'ğŸ‡', color: 'bg-purple-100', regions: ['west_china'] },
            { id: 'apricot', name: 'æ', price: 18, growTime: 18, sellPrice: 38, xp: 10, icon: 'ğŸ‘', color: 'bg-orange-100', regions: ['west_china'] },
            { id: 'melon', name: 'å“ˆå¯†ç“œ', price: 35, growTime: 35, sellPrice: 90, xp: 22, icon: 'ğŸˆ', color: 'bg-green-100', regions: ['west_china'] },
            // æ—¥æœ¬
            { id: 'wasabi', name: 'èŠ¥æœ«', price: 30, growTime: 30, sellPrice: 80, xp: 20, icon: 'ğŸŒ±', color: 'bg-lime-100', regions: ['japan'] },
            { id: 'sakura', name: 'æ¨±èŠ±', price: 40, growTime: 40, sellPrice: 100, xp: 25, icon: 'ğŸŒ¸', color: 'bg-pink-200', regions: ['japan'] },
            { id: 'sweet_potato', name: 'çº¢è–¯', price: 18, growTime: 18, sellPrice: 38, xp: 10, icon: 'ğŸ ', color: 'bg-orange-200', regions: ['japan'] },
            { id: 'daikon', name: 'å¤§æ ¹', price: 22, growTime: 22, sellPrice: 50, xp: 13, icon: 'ğŸ¥•', color: 'bg-orange-100', regions: ['japan'] },
            { id: 'mikan', name: 'èœœæŸ‘', price: 28, growTime: 28, sellPrice: 70, xp: 18, icon: 'ğŸŠ', color: 'bg-yellow-100', regions: ['japan'] },
            // ç¾å›½ä¸­éƒ¨
            { id: 'blueberry', name: 'è“è“', price: 25, growTime: 25, sellPrice: 60, xp: 15, icon: 'ğŸ«', color: 'bg-indigo-100', regions: ['us_midwest'] },
            { id: 'pumpkin', name: 'å—ç“œ', price: 20, growTime: 20, sellPrice: 48, xp: 12, icon: 'ğŸƒ', color: 'bg-orange-200', regions: ['us_midwest'] },
            { id: 'wheat', name: 'å°éº¦', price: 15, growTime: 15, sellPrice: 32, xp: 9, icon: 'ğŸŒ¾', color: 'bg-yellow-100', regions: ['us_midwest'] },
            { id: 'cranberry', name: 'è”“è¶Šè“', price: 28, growTime: 28, sellPrice: 70, xp: 18, icon: 'ğŸ’', color: 'bg-red-200', regions: ['us_midwest'] },
            { id: 'sunflower', name: 'å‘æ—¥è‘µ', price: 18, growTime: 18, sellPrice: 38, xp: 10, icon: 'ğŸŒ»', color: 'bg-yellow-200', regions: ['us_midwest'] },
            // æ¬§æ´²
            { id: 'carrot', name: 'èƒ¡èåœ', price: 15, growTime: 15, sellPrice: 32, xp: 9, icon: 'ğŸ¥•', color: 'bg-orange-100', regions: ['europe'] },
            { id: 'strawberry', name: 'è‰è“', price: 22, growTime: 22, sellPrice: 50, xp: 13, icon: 'ğŸ“', color: 'bg-red-100', regions: ['europe'] },
            { id: 'lettuce', name: 'ç”Ÿèœ', price: 18, growTime: 18, sellPrice: 38, xp: 10, icon: 'ğŸ¥¬', color: 'bg-green-100', regions: ['europe'] },
            { id: 'asparagus', name: 'èŠ¦ç¬‹', price: 28, growTime: 28, sellPrice: 70, xp: 18, icon: 'ğŸ¥¦', color: 'bg-green-200', regions: ['europe'] },
            { id: 'grapefruit', name: 'è‘¡è„æŸš', price: 35, growTime: 35, sellPrice: 90, xp: 22, icon: 'ğŸ‡', color: 'bg-purple-100', regions: ['europe'] }
        ];

        // å‡çº§æ•°æ®
        const upgrades = [
            { id: 'watering', name: 'æµ‡æ°´æ•ˆç‡', description: 'å‡å°‘ä½œç‰©ç”Ÿé•¿æ—¶é—´10%', cost: 150, maxLevel: 3 },
            { id: 'quality', name: 'ä½œç‰©å“è´¨', description: 'æé«˜ä½œç‰©å”®ä»·15%', cost: 250, maxLevel: 3 },
            { id: 'greenhouse', name: 'æ¸©å®¤å¤§æ£š', description: 'å‡å°‘å¤©æ°”å½±å“50%', cost: 400, maxLevel: 1 }
        ];

        // ä»»åŠ¡æ•°æ®
        const tasks = [
            { id: 'harvest_5', name: 'æ”¶è·5ä¸ªä½œç‰©', goal: 5, reward: 50, desc: 'æ”¶è·ä»»æ„5ä¸ªä½œç‰©' },
            { id: 'plant_3', name: 'ç§æ¤3æ¬¡', goal: 3, reward: 30, desc: 'ç§æ¤3æ¬¡ä»»æ„ç§å­' },
            { id: 'sell_100', name: 'é”€å”®100é‡‘å¸', goal: 100, reward: 20, desc: 'ç´¯è®¡é”€å”®ä½œç‰©ä»·å€¼è¾¾åˆ°100é‡‘å¸' },
            { id: 'upgrade_1', name: 'å®Œæˆ1æ¬¡å‡çº§', goal: 1, reward: 40, desc: 'è´­ä¹°ä»»æ„1æ¬¡å†œåœºå‡çº§' },
            { id: 'expand_1', name: 'æ‰©å±•1å—å†œç”°', goal: 1, reward: 60, desc: 'æ‰©å±•1å—å†œç”°' }
        ];

        // å¤©æ°”ç³»ç»Ÿ
        const weatherTypes = [
            { id: 'sunny', name: 'æ™´å¤©', icon: 'â˜€ï¸', effect: { growth: 1.0, price: 1.0 } },
            { id: 'rainy', name: 'é›¨å¤©', icon: 'ğŸŒ§ï¸', effect: { growth: 1.2, price: 0.9 } },
            { id: 'cloudy', name: 'é˜´å¤©', icon: 'â˜ï¸', effect: { growth: 0.9, price: 1.1 } },
            { id: 'stormy', name: 'æš´é£é›¨', icon: 'â›ˆï¸', effect: { growth: 0.7, price: 0.7 } }
        ];

        // æˆå°±ç³»ç»Ÿ
        const achievements = [
            { id: 'first_harvest', name: 'åˆæ¬¡æ”¶è·', reward: 20, condition: (state) => state.completedTasks >= 1, unlocked: false },
            { id: 'farmer_10', name: '10çº§å†œåœºä¸»', reward: 100, condition: (state) => state.level >= 10, unlocked: false },
            { id: 'millionaire', name: 'ç™¾ä¸‡å¯Œç¿', reward: 200, condition: (state) => state.money >= 1000, unlocked: false },
            { id: 'seed_collector', name: 'ç§å­æ”¶é›†è€…', reward: 80, condition: (state) => Object.keys(state.purchasedSeeds).length >= 3, unlocked: false },
            { id: 'plot_master', name: 'å†œç”°å¤§å¸ˆ', reward: 150, condition: (state) => state.plots >= 8, unlocked: false }
        ];

        // DOMå…ƒç´ 
        const elements = {
            money: document.getElementById('money'),
            level: document.getElementById('level'),
            xp: document.getElementById('xp'),
            maxXp: document.getElementById('maxXp'),
            plotsCount: document.getElementById('plots-count'),
            farmGrid: document.getElementById('farm-grid'),
            shopItems: document.getElementById('shop-items'),
            inventoryItems: document.getElementById('inventory-items'),
            tasksList: document.getElementById('tasks-list'),
            upgrades: document.getElementById('upgrades'),
            expandFarmBtn: document.getElementById('expand-farm'),
            notifications: document.getElementById('notifications'),
            saveIndicator: document.getElementById('save-indicator')
        };

        // ä¿å­˜æ¸¸æˆæ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveGameData() {
            try {
                // ä¿å­˜æ¸¸æˆçŠ¶æ€
                localStorage.setItem('happyFarmGameState', JSON.stringify(gameState));
                // å¦‚æœæ˜¯æ™®é€šç”¨æˆ·ï¼Œæ›´æ–°happyFarmUsersä¸­çš„æ•°æ®
                const userInfo = JSON.parse(localStorage.getItem('happyFarmUserInfo')||'{}');
                if(userInfo && userInfo.account && userInfo.account !== 'dyyssb'){
                    let users = JSON.parse(localStorage.getItem('happyFarmUsers')||'[]');
                    users = users.map(u => u.account === userInfo.account ? {
                        ...u,
                        lastPlayed: new Date().toLocaleString(),
                        money: gameState.money,
                        xp: gameState.xp,
                        level: gameState.level
                    } : u);
                    localStorage.setItem('happyFarmUsers', JSON.stringify(users));
                }
                // æ˜¾ç¤ºä¿å­˜æŒ‡ç¤ºå™¨
                elements.saveIndicator.classList.add('show');

                // 2ç§’åéšè—ä¿å­˜æŒ‡ç¤ºå™¨
                setTimeout(() => {
                    elements.saveIndicator.classList.remove('show');
                }, 2000);

                return true;
            } catch (error) {
                console.error('ä¿å­˜æ¸¸æˆæ•°æ®å¤±è´¥:', error);
                return false;
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¸¸æˆæ•°æ®
        function loadGameData() {
            try {
                const savedState = localStorage.getItem('happyFarmGameState');

                if (savedState) {
                    const parsedState = JSON.parse(savedState);

                    // åˆå¹¶ä¿å­˜çš„çŠ¶æ€åˆ°å½“å‰çŠ¶æ€
                    Object.assign(gameState, parsedState);

                    // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ç§å­æ•°æ®éœ€è¦æ·»åŠ 
                    if (!gameState.purchasedSeeds) {
                        gameState.purchasedSeeds = {};
                    }

                    // æ˜¾ç¤ºåŠ è½½æˆåŠŸé€šçŸ¥
                    showNotification('æ¸¸æˆæ•°æ®å·²åŠ è½½', 'info');
                    return true;
                }
            } catch (error) {
                console.error('åŠ è½½æ¸¸æˆæ•°æ®å¤±è´¥:', error);
            }

            return false;
        }

        // è®¾ç½®è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
        function setupAutoSave() {
            // æ¯5åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
            setInterval(() => {
                saveGameData();
            }, 5 * 60 * 1000);

            // é¡µé¢å¸è½½æ—¶ä¿å­˜
            window.addEventListener('beforeunload', () => {
                saveGameData();
            });
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            renderRegionSelect();
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¸¸æˆæ•°æ®
            loadGameData();

            // åˆå§‹åŒ–å†œç”°æ•°æ®ç»“æ„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!gameState.farmData) {
                gameState.farmData = {};
                // ä¸ºæ¯ä¸ªåœ°å—åˆå§‹åŒ–æ•°æ®
                for (let i = 0; i < gameState.plots; i++) {
                    gameState.farmData[i] = {
                        state: 'empty',  // 'empty', 'planted', 'wasteland'
                        seedId: null,
                        growth: null,    // null, 'growing', 'completed'
                        progress: 0,
                        growthTime: 0
                    };
                }
                saveGameData();
            }

            // æ£€æŸ¥ä¸Šæ¬¡æ¸¸ç©æ—¶é—´
            checkDailyLogin();

            // è·å–å½“å‰æ—¥æœŸ
            const today = new Date().toDateString();

            // åªæœ‰åœ¨æ–°çš„ä¸€å¤©æˆ–è€…æ²¡æœ‰ä»»åŠ¡æ—¶æ‰ç”Ÿæˆæ–°ä»»åŠ¡
            if (!gameState.lastTasksGenerated || gameState.lastTasksGenerated !== today || gameState.tasks.length === 0) {
                // ç”Ÿæˆä»Šæ—¥å¤©æ°”
                generateWeather();

                // ç”Ÿæˆæ¯æ—¥ä»»åŠ¡
                generateDailyTasks();

                // è®°å½•ä»»åŠ¡ç”Ÿæˆæ—¥æœŸ
                gameState.lastTasksGenerated = today;
                saveGameData();
            }

            renderShop();
            renderFarm();
            renderUpgrades();
            renderWeather();
            renderTasks();
            updateUI();

            // æ£€æŸ¥æ‰©å±•å†œç”°æŒ‰é’®çŠ¶æ€
            checkExpandFarmButton();
            checkAchievements();

            // è®¾ç½®è‡ªåŠ¨ä¿å­˜
            setupAutoSave();
        }

        // æ¸²æŸ“åœ°åŒºä¸‹æ‹‰èœå•
        function renderRegionSelect() {
            const select = document.getElementById('region-select');
            select.innerHTML = regions.map(region =>
                `<option value="${region.id}" ${region.id === gameState.currentRegion ? 'selected' : ''}>${region.name}</option>`
            ).join('');
            select.onchange = function() {
                gameState.currentRegion = this.value;
                saveGameData();
                renderShop();
                renderFarm();
                renderInventory();
                updateRegionBackground();
            };
            // åˆå§‹åŒ–æ—¶ä¹Ÿåˆ‡æ¢èƒŒæ™¯
            updateRegionBackground();
        }
        // åˆ‡æ¢åœ°åŒºèƒŒæ™¯
        function updateRegionBackground() {
            const body = document.getElementById('main-body');
            body.className = '';
            body.classList.add('min-h-screen');
            body.classList.add('bg-' + gameState.currentRegion);
        }

        // æ¸²æŸ“å•†åº—ï¼ˆåªæ˜¾ç¤ºå½“å‰åœ°åŒºçš„ç§å­ï¼‰
        function renderShop() {
            const regionSeeds = seeds.filter(seed => seed.regions.includes(gameState.currentRegion));
            elements.shopItems.innerHTML = regionSeeds.map(seed => `
                <div class="seed-item flex flex-col p-4 rounded-2xl ${seed.color} cursor-pointer shadow-lg hover:shadow-2xl transition card-strong" data-seed-id="${seed.id}">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-medium">${seed.icon} ${seed.name}</div>
                            <div class="text-sm text-gray-600">å”®ä»·: ${seed.sellPrice}é‡‘å¸ | ç»éªŒ: ${seed.xp}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold">${seed.price}é‡‘å¸</div>
                            <div class="text-xs text-gray-600">${seed.growTime}ç§’</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">åº“å­˜: ${gameState.purchasedSeeds[seed.id] || 0}</span>
                        <button class="buy-btn btn-strong px-4 py-2 text-base" data-seed-id="${seed.id}">
                            <i class="fas fa-shopping-cart mr-2"></i> è´­ä¹°
                        </button>
                    </div>
                </div>
            `).join('');

            // æ·»åŠ è´­ä¹°æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.buy-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const seedId = this.getAttribute('data-seed-id');
                    buySeed(seedId);
                });
            });

            // æ·»åŠ ç§å­é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.seed-item').forEach(item => {
                item.addEventListener('click', function() {
                    const seedId = this.getAttribute('data-seed-id');
                    selectSeed(seedId);
                });
            });
        }

        // è´­ä¹°ç§å­
        function buySeed(seedId) {
            const seed = getSeedById(seedId);

            if (gameState.money >= seed.price) {
                gameState.money -= seed.price;

                if (!gameState.purchasedSeeds[seedId]) {
                    gameState.purchasedSeeds[seedId] = 0;
                }
                gameState.purchasedSeeds[seedId]++;

                updateUI();
                renderShop();
                showNotification(`æˆåŠŸè´­ä¹° ${seed.name} ç§å­!`, 'success');

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            } else {
                showNotification('é‡‘å¸ä¸è¶³!', 'error');
            }
        }

        // é€‰æ‹©ç§å­æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å±äºæœ¬åœ°åŒº
        function selectSeed(seedId) {
            const seed = getSeedById(seedId);
            if (!seed.regions.includes(gameState.currentRegion)) {
                showNotification('è¯¥ç§å­ä¸å±äºå½“å‰åœ°åŒº!', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²è´­ä¹°è¯¥ç§å­
            if (!gameState.purchasedSeeds[seedId] || gameState.purchasedSeeds[seedId] <= 0) {
                showNotification('è¯·å…ˆè´­ä¹°è¯¥ç§å­!', 'error');
                return;
            }

            gameState.currentSelectedSeed = seedId;

            // æ›´æ–°UIæ˜¾ç¤ºé€‰ä¸­çš„ç§å­
            document.querySelectorAll('.seed-item').forEach(item => {
                if (item.getAttribute('data-seed-id') === seedId) {
                    item.classList.add('ring-2', 'ring-green-500');
                } else {
                    item.classList.remove('ring-2', 'ring-green-500');
                }
            });

            showNotification(`å·²é€‰æ‹©: ${seed.name}ç§å­`, 'info');
        }

        // æ¸²æŸ“å†œç”°ï¼ˆåªå…è®¸ç§æ¤æœ¬åœ°åŒºçš„ç§å­ï¼‰
        function renderFarm() {
            elements.farmGrid.innerHTML = '';

            // ç¡®ä¿farmDataæ•°ç»„é•¿åº¦ä¸plotsä¸€è‡´
            while (gameState.farmData.length < gameState.plots) {
                gameState.farmData.push({
                    state: 'empty', // empty, planted, wasteland
                    seedId: null,
                    growth: null, // null, growing, completed
                    progress: 0,
                    growthTime: 0
                });
            }

            for (let i = 0; i < gameState.plots; i++) {
                const plotData = gameState.farmData[i];
                const plot = document.createElement('div');
                plot.className = 'crop-plot bg-yellow-50 border-2 border-yellow-200 rounded-2xl aspect-square flex flex-col items-center justify-center p-4 cursor-pointer shadow-md hover:shadow-xl transition';

                // æ ¹æ®åœ°å—çŠ¶æ€è®¾ç½®ä¸åŒçš„æ˜¾ç¤º
                if (plotData.state === 'empty') {
                    // ç©ºé—²å†œç”°
                    plot.innerHTML = `
                        <div class="text-5xl mb-2">ğŸŒ±</div>
                        <p class="text-base text-center text-gray-600 font-semibold">ç©ºé—²å†œç”°</p>
                        <div class="w-full bg-gray-200 rounded-full h-2 hidden">
                            <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    `;
                } else if (plotData.state === 'wasteland') {
                    // è’åœ°
                    plot.innerHTML = `
                        <div class="text-5xl mb-2">ğŸŒµ</div>
                        <p class="text-base text-center font-semibold text-red-800">è’åœ°(éœ€ä¿®å¤)</p>
                        <button class="repair-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm mt-1" data-plot-index="${i}">
                            ä¿®å¤ (50é‡‘å¸)
                        </button>
                    `;
                    plot.querySelector('.repair-btn').addEventListener('click', function() {
                        repairPlot(i);
                    });
                } else if (plotData.state === 'planted') {
                    // å·²ç§æ¤
                    const seed = getSeedById(plotData.seedId);
                    if (seed) {
                        plot.setAttribute('data-planted', seed.id);
                        plot.setAttribute('data-growth', plotData.growth);

                        if (plotData.growth === 'completed') {
                            // æˆç†Ÿçš„ä½œç‰©
                            plot.innerHTML = `
                                <div class="text-5xl mb-2">${seed.icon}</div>
                                <p class="text-base text-center font-semibold text-green-800">${seed.name}</p>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="progress-bar bg-yellow-500 h-2 rounded-full" style="width: 100%"></div>
                                </div>
                                <p class="text-base text-gray-500 mt-1">å¯ä»¥æ”¶è·äº†!</p>
                            `;
                            plot.classList.add('animate-pulse');
                        } else {
                            // ç”Ÿé•¿ä¸­çš„ä½œç‰©
                            plot.innerHTML = `
                                <div class="text-5xl mb-2">${seed.icon}</div>
                                <p class="text-base text-center font-semibold text-green-800">${seed.name}</p>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: ${Math.min(plotData.progress / plotData.growthTime * 100, 100)}%"></div>
                                </div>
                                <p class="text-base text-gray-500 mt-1">æˆé•¿ä¸­...</p>
                            `;

                            // ç»§ç»­ç”Ÿé•¿è®¡æ—¶å™¨
                            continuePlantGrowth(i, plot);
                        }
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°ç§å­æ•°æ®ï¼Œé‡ç½®ä¸ºç©ºé—²
                        plotData.state = 'empty';
                        plotData.seedId = null;
                        plotData.growth = null;
                        plot.innerHTML = `
                            <div class="text-5xl mb-2">ğŸŒ±</div>
                            <p class="text-base text-center text-gray-600 font-semibold">ç©ºé—²å†œç”°</p>
                            <div class="w-full bg-gray-200 rounded-full h-2 hidden">
                                <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        `;
                    }
                }

                plot.setAttribute('data-plot-index', i);
                plot.addEventListener('click', () => handlePlotClick(i));
                elements.farmGrid.appendChild(plot);
            }

            // ä¿å­˜æ¸¸æˆæ•°æ®
            saveGameData();
        }

        // ç»§ç»­æ¤ç‰©ç”Ÿé•¿
        function continuePlantGrowth(plotIndex, plot) {
            const plotData = gameState.farmData[plotIndex];
            if (plotData.state !== 'planted' || plotData.growth === 'completed') return;

            const progressBar = plot.querySelector('.progress-bar');
            const growthInterval = setInterval(() => {
                plotData.progress += 0.5;
                progressBar.style.width = `${Math.min(plotData.progress / plotData.growthTime * 100, 100)}%`;

                if (plotData.progress >= plotData.growthTime) {
                    clearInterval(growthInterval);
                    plotData.growth = 'completed';
                    plot.setAttribute('data-growth', 'completed');
                    plot.querySelector('p').textContent = 'å¯ä»¥æ”¶è·äº†!';
                    progressBar.classList.remove('bg-green-600');
                    progressBar.classList.add('bg-yellow-500');

                    // æ·»åŠ è„‰å†²åŠ¨ç”»è¡¨ç¤ºå¯ä»¥æ”¶è·
                    plot.classList.add('animate-pulse');

                    // ä¿å­˜æ¸¸æˆæ•°æ®
                    saveGameData();
                }
            }, 500);
        }

        // å¤„ç†å†œç”°ç‚¹å‡»
        function handlePlotClick(plotIndex) {
            const plot = document.querySelector(`[data-plot-index="${plotIndex}"]`);

            // æ£€æŸ¥åœ°å—æ˜¯å¦ç©ºé—²
            if (!plot.hasAttribute('data-planted')) {
                // å¦‚æœæœ‰é€‰ä¸­çš„ç§å­ï¼Œåˆ™ç§æ¤
                if (gameState.currentSelectedSeed) {
                    const seed = getSeedById(gameState.currentSelectedSeed);

                    // ç›´æ¥ç§æ¤ï¼Œä¸æ¶ˆè€—é‡‘å¸
                    plantSeed(plotIndex, seed);
                    updateUI();

                    // ä¿å­˜æ¸¸æˆæ•°æ®
                    saveGameData();
                } else {
                    showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç§å­!', 'error');
                }
            } else {
                // æ£€æŸ¥ä½œç‰©æ˜¯å¦æˆç†Ÿ
                if (plot.getAttribute('data-growth') === 'completed') {
                    harvestCrop(plotIndex);
                }
            }
        }

        // ç§æ¤ç§å­
        function plantSeed(plotIndex, seed) {
            const plot = document.querySelector(`[data-plot-index="${plotIndex}"]`);
            const plotData = gameState.farmData[plotIndex];

            // æœ‰10%çš„æ¦‚ç‡ç§æ¤å¤±è´¥ï¼Œå˜æˆè’åœ°
            if (Math.random() < 0.1) {
                // æ›´æ–°æ¸¸æˆçŠ¶æ€ä¸­çš„å†œç”°æ•°æ®
                plotData.state = 'wasteland';
                plotData.seedId = null;
                plotData.growth = null;
                plotData.progress = 0;
                plotData.growthTime = 0;

                // æ›´æ–°DOM
                plot.setAttribute('data-state', 'wasteland');
                plot.innerHTML = `
                    <div class="text-5xl mb-2">ğŸŒµ</div>
                    <p class="text-base text-center font-semibold text-red-800">è’åœ°(éœ€ä¿®å¤)</p>
                    <button class="repair-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm mt-1" data-plot-index="${plotIndex}">
                        ä¿®å¤ (50é‡‘å¸)
                    </button>
                `;
                plot.querySelector('.repair-btn').addEventListener('click', function() {
                    repairPlot(plotIndex);
                });
                showNotification('ç§æ¤å¤±è´¥! å†œç”°å˜æˆäº†è’åœ°!', 'error');

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
                return;
            }

            // è·å–å½“å‰å¤©æ°”
            const weather = weatherTypes.find(w => w.id === gameState.weather);

            // åº”ç”¨æµ‡æ°´æ•ˆç‡å‡çº§å’Œå¤©æ°”å½±å“
            let growthTime = seed.growTime *
                           (1 - (gameState.upgrades.watering * 0.1)) *
                           (1 / weather.effect.growth);

            // åº”ç”¨æ¸©å®¤å‡çº§å‡å°‘å¤©æ°”å½±å“
            if (gameState.upgrades.greenhouse > 0) {
                const weatherImpactReduction = 0.5; // æ¸©å®¤å‡å°‘50%å¤©æ°”å½±å“
                const adjustedGrowthEffect = weather.effect.growth + (1 - weather.effect.growth) * weatherImpactReduction;
                growthTime = seed.growTime * (1 - (gameState.upgrades.watering * 0.1)) * (1 / adjustedGrowthEffect);
            }

            // æ›´æ–°æ¸¸æˆçŠ¶æ€ä¸­çš„å†œç”°æ•°æ®
            plotData.state = 'planted';
            plotData.seedId = seed.id;
            plotData.growth = 'growing';
            plotData.progress = 0;
            plotData.growthTime = growthTime;

            // æ›´æ–°DOM
            plot.setAttribute('data-planted', seed.id);
            plot.setAttribute('data-state', 'planted');
            plot.setAttribute('data-growth', 'growing');
            plot.innerHTML = `
                <div class="text-5xl mb-2">${seed.icon}</div>
                <p class="text-base text-center font-semibold text-green-800">${seed.name}</p>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                    <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-base text-gray-500 mt-1">æˆé•¿ä¸­...</p>
            `;

            // å¼€å§‹ç”Ÿé•¿è®¡æ—¶å™¨
            continuePlantGrowth(plotIndex, plot);

            // æ›´æ–°ç§å­åº“å­˜
            gameState.purchasedSeeds[seed.id]--;
            if (gameState.purchasedSeeds[seed.id] <= 0) {
                delete gameState.purchasedSeeds[seed.id];
                gameState.currentSelectedSeed = null;
                // Clear selected seed UI
                document.querySelectorAll('.seed-item').forEach(item => {
                    item.classList.remove('ring-2', 'ring-green-500');
                });
            }

            // æ›´æ–°UIæ˜¾ç¤ºç§å­æ•°é‡
            updateUI();
            renderShop();

            showNotification(`å·²ç§æ¤ ${seed.name}!`, 'success');

            // æ›´æ–°ä»»åŠ¡è¿›åº¦
            updateTaskProgress('plant');

            // ä¿å­˜æ¸¸æˆæ•°æ®
            saveGameData();
        }

        // æ”¶è·ä½œç‰©
        function harvestCrop(plotIndex) {
            const plot = document.querySelector(`[data-plot-index="${plotIndex}"]`);
            const plotData = gameState.farmData[plotIndex];
            // ç¡®ä¿åœ°å—çŠ¶æ€æ­£ç¡®
            if (plotData.state !== 'planted' || plotData.growth !== 'completed') {
                showNotification('æ”¶è·å¤±è´¥ï¼šä½œç‰©æœªæˆç†Ÿæˆ–çŠ¶æ€å¼‚å¸¸', 'error');
                return;
            }
            const seedId = plotData.seedId;
            const seed = getSeedById(seedId);
            if (!seed) {
                // å¦‚æœæ‰¾ä¸åˆ°ç§å­æ•°æ®ï¼Œé‡ç½®ä¸ºç©ºé—²
                plotData.state = 'empty';
                plotData.seedId = null;
                plotData.growth = null;
                plotData.progress = 0;
                plotData.growthTime = 0;
                saveGameData();
                renderFarm();
                showNotification('æ”¶è·å¤±è´¥ï¼šä½œç‰©æ•°æ®å¼‚å¸¸', 'error');
                return;
            }
            // è·å–å½“å‰å¤©æ°”
            const weather = weatherTypes.find(w => w.id === gameState.weather);
            // åº”ç”¨è´¨é‡å‡çº§å’Œå¤©æ°”å½±å“
            let sellPrice = Math.floor(seed.sellPrice * (1 + (gameState.upgrades.quality * 0.15)));
            if (gameState.upgrades.greenhouse > 0) {
                const weatherImpactReduction = 0.5; // æ¸©å®¤å‡å°‘50%å¤©æ°”å½±å“
                const adjustedPriceEffect = weather.effect.price + (1 - weather.effect.price) * weatherImpactReduction;
                sellPrice = Math.floor(sellPrice * adjustedPriceEffect);
            } else {
                sellPrice = Math.floor(sellPrice * weather.effect.price);
            }
            // æ›´æ–°æ¸¸æˆçŠ¶æ€ï¼ˆåªè·å¾—ç»éªŒï¼Œä¸è·å¾—é‡‘å¸ï¼‰
            gameState.xp += seed.xp;
            // æ›´æ–°ä»»åŠ¡è¿›åº¦
            updateTaskProgress('harvest');
            // æ›´æ–°åº“å­˜
            if (!gameState.inventory[seedId]) {
                gameState.inventory[seedId] = 0;
            }
            gameState.inventory[seedId]++;
            // è°ƒè¯•è¾“å‡º
            console.log('æ”¶è·åä»“åº“:', JSON.parse(JSON.stringify(gameState.inventory)));
            showNotification(`æ”¶è· ${seed.name}! +${seed.xp}ç»éªŒï¼Œä»“åº“+1`, 'success');
            // æ£€æŸ¥æ˜¯å¦å‡çº§
            checkLevelUp();
            // é‡ç½®åœ°å—æ•°æ®
            plotData.state = 'empty';
            plotData.seedId = null;
            plotData.growth = null;
            plotData.progress = 0;
            plotData.growthTime = 0;
            // é‡ç½®DOM
            plot.removeAttribute('data-planted');
            plot.removeAttribute('data-growth');
            plot.classList.remove('animate-pulse');
            plot.innerHTML = `
                <div class="text-5xl mb-2">ğŸŒ±</div>
                <p class="text-base text-center text-gray-600 font-semibold">ç©ºé—²å†œç”°</p>
                <div class="w-full bg-gray-200 rounded-full h-2 hidden">
                    <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
            `;
            // é‡æ–°æ·»åŠ äº‹ä»¶ç›‘å¬
            plot.addEventListener('click', () => handlePlotClick(plotIndex));
            // æ›´æ–°UI
            updateUI();
            renderInventory();
            // ä¿å­˜æ¸¸æˆæ•°æ®
            saveGameData();
        }

        // ä¿®å¤è’åœ°
        function repairPlot(plotIndex) {
            const plot = document.querySelector(`[data-plot-index="${plotIndex}"]`);

            if (gameState.money >= 50) {
                gameState.money -= 50;

                // æ›´æ–°æ¸¸æˆçŠ¶æ€ä¸­çš„å†œç”°æ•°æ®
                const plotData = gameState.farmData[plotIndex];
                plotData.state = 'empty';
                plotData.seedId = null;
                plotData.growth = null;
                plotData.progress = 0;
                plotData.growthTime = 0;

                // æ›´æ–°DOM
                plot.removeAttribute('data-state');
                plot.innerHTML = `
                    <div class="text-5xl mb-2">ğŸŒ±</div>
                    <p class="text-base text-center text-gray-600 font-semibold">ç©ºé—²å†œç”°</p>
                    <div class="w-full bg-gray-200 rounded-full h-2 hidden">
                        <div class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                `;
                plot.addEventListener('click', () => handlePlotClick(plotIndex));
                updateUI();
                showNotification('å†œç”°ä¿®å¤æˆåŠŸ!', 'success');

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            } else {
                showNotification('é‡‘å¸ä¸è¶³!', 'error');
            }
        }

        // æ¸²æŸ“åº“å­˜ï¼ˆåªæ˜¾ç¤ºæœ¬åœ°åŒºçš„ä½œç‰©ï¼‰
        function renderInventory() {
            const regionSeeds = seeds.filter(seed => seed.regions.includes(gameState.currentRegion));
            const regionSeedIds = regionSeeds.map(s => s.id);
            const filteredInventory = Object.entries(gameState.inventory).filter(([seedId]) => regionSeedIds.includes(seedId));
            if (filteredInventory.length === 0) {
                elements.inventoryItems.innerHTML = '<p class="text-gray-500 italic">è¿™é‡Œä¼šæ˜¾ç¤ºä½ æ”¶è·çš„ä½œç‰©</p>';
                return;
            }
            elements.inventoryItems.innerHTML = filteredInventory.map(([seedId, count]) => {
                const seed = getSeedById(seedId);
                const sellPrice = Math.floor(seed.sellPrice * (1 + (gameState.upgrades.quality * 0.15)));
                const weather = weatherTypes.find(w => w.id === gameState.weather);
                let adjustedPrice = sellPrice;
                if (gameState.upgrades.greenhouse > 0) {
                    const weatherImpactReduction = 0.5;
                    const adjustedPriceEffect = weather.effect.price + (1 - weather.effect.price) * weatherImpactReduction;
                    adjustedPrice = Math.floor(sellPrice * adjustedPriceEffect);
                } else {
                    adjustedPrice = Math.floor(sellPrice * weather.effect.price);
                }
                return `
                    <div class="flex justify-between items-center p-3 border-b card-strong mb-2">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${seed.icon}</span>
                            <span class="font-semibold text-lg">${seed.name} Ã— ${count}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" min="1" max="${count}" value="1" class="sell-qty-input w-14 px-1 py-0.5 border rounded text-center mr-1" data-seed-id="${seedId}" />
                            <button class="sell-btn btn-strong px-4 py-2 text-base" data-seed-id="${seedId}">
                                å‡ºå”® (${adjustedPrice}é‡‘å¸)
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            document.querySelectorAll('.sell-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const seedId = this.getAttribute('data-seed-id');
                    const qtyInput = document.querySelector(`.sell-qty-input[data-seed-id='${seedId}']`);
                    let qty = parseInt(qtyInput.value) || 1;
                    sellCrops(seedId, qty);
                });
            });
        }

        // å‡ºå”®ä½œç‰©ï¼Œæ”¯æŒæ•°é‡
        function sellCrops(seedId, qty = 1) {
            if (gameState.inventory[seedId] && gameState.inventory[seedId] > 0) {
                qty = Math.max(1, Math.min(qty, gameState.inventory[seedId]));
                const seed = getSeedById(seedId);
                const sellPrice = Math.floor(seed.sellPrice * (1 + (gameState.upgrades.quality * 0.15)));
                const weather = weatherTypes.find(w => w.id === gameState.weather);
                let adjustedPrice = sellPrice;
                if (gameState.upgrades.greenhouse > 0) {
                    const weatherImpactReduction = 0.5;
                    const adjustedPriceEffect = weather.effect.price + (1 - weather.effect.price) * weatherImpactReduction;
                    adjustedPrice = Math.floor(sellPrice * adjustedPriceEffect);
                } else {
                    adjustedPrice = Math.floor(sellPrice * weather.effect.price);
                }
                gameState.money += adjustedPrice * qty;
                gameState.inventory[seedId] -= qty;
                if (gameState.inventory[seedId] <= 0) {
                    delete gameState.inventory[seedId];
                }
                updateUI();
                renderInventory();
                showNotification(`å”®å‡º ${seed.name} Ã—${qty}! +${adjustedPrice * qty}é‡‘å¸`, 'success');
                // æ›´æ–°ä»»åŠ¡è¿›åº¦
                updateTaskProgress('sell', adjustedPrice * qty);
                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        }

        // æ¸²æŸ“å‡çº§
        function renderUpgrades() {
            elements.upgrades.innerHTML = upgrades.map(upgrade => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                    <div>
                        <h3 class="font-semibold">${upgrade.name} (${gameState.upgrades[upgrade.id]}/${upgrade.maxLevel})</h3>
                        <p class="text-sm text-gray-600">${upgrade.description}</p>
                    </div>
                    <button class="upgrade-btn ${gameState.upgrades[upgrade.id] >= upgrade.maxLevel ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'} text-white px-3 py-1 rounded-lg"
                            data-upgrade="${upgrade.id}"
                            data-cost="${upgrades.find(u => u.id === upgrade.id).cost * (gameState.upgrades[upgrade.id] + 1)}"
                            ${gameState.upgrades[upgrade.id] >= upgrade.maxLevel ? 'disabled' : ''}>
                        <i class="fas fa-arrow-up mr-1"></i> ${upgrades.find(u => u.id === upgrade.id).cost * (gameState.upgrades[upgrade.id] + 1)}é‡‘å¸
                    </button>
                </div>
            `).join('');

            // æ·»åŠ å‡çº§æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.upgrade-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const upgradeId = this.getAttribute('data-upgrade');
                    const cost = parseInt(this.getAttribute('data-cost'));

                    purchaseUpgrade(upgradeId, cost);
                });
            });
        }
                // è´­ä¹°å‡çº§
        function purchaseUpgrade(upgradeId, cost) {
            if (gameState.upgrades[upgradeId] >= upgrades.find(u => u.id === upgradeId).maxLevel) return;
            if (gameState.money >= cost && cost > 0) {
                gameState.money -= cost;
                gameState.upgrades[upgradeId]++;
                updateUI();
                renderUpgrades();

                showNotification(`å‡çº§ ${upgrades.find(u => u.id === upgradeId).name} æˆåŠŸ!`, 'success');

                // æ›´æ–°ä»»åŠ¡è¿›åº¦
                updateTaskProgress('upgrade');

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            } else {
                showNotification('é‡‘å¸ä¸è¶³!', 'error');
            }
        }

        // æ‰©å±•å†œåœº
        elements.expandFarmBtn.addEventListener('click', function() {
            if (gameState.money >= 200 && gameState.plots < gameState.maxPlots) {
                gameState.money -= 200;
                gameState.plots++;
                updateUI();
                renderFarm();
                checkExpandFarmButton();

                showNotification('å†œåœºæ‰©å±•æˆåŠŸ!', 'success');

                // æ›´æ–°ä»»åŠ¡è¿›åº¦
                updateTaskProgress('expand');

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        });

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰©å±•å†œåœº
        function checkExpandFarmButton() {
            if (gameState.plots >= gameState.maxPlots) {
                elements.expandFarmBtn.disabled = true;
                elements.expandFarmBtn.textContent = 'å·²è¾¾åˆ°æœ€å¤§å†œç”°æ•°é‡';
            } else {
                elements.expandFarmBtn.disabled = gameState.money < 200;
            }
        }

        // æ£€æŸ¥æ˜¯å¦å‡çº§
        function checkLevelUp() {
            if (gameState.xp >= gameState.maxXp) {
                gameState.level++;
                gameState.xp = gameState.xp - gameState.maxXp;
                gameState.maxXp = Math.floor(gameState.maxXp * 1.5);

                showNotification(`å‡çº§åˆ° ${gameState.level} çº§!`, 'info');

                // æ¯2çº§è§£é”ä¸€ä¸ªæ–°ç§å­
                if (gameState.level % 2 === 0 && gameState.level / 2 <= seeds.length) {
                    const newSeedIndex = Math.floor(gameState.level / 2) - 1;
                    if (newSeedIndex < seeds.length && !gameState.purchasedSeeds[seeds[newSeedIndex].id]) {
                        showNotification(`è§£é”æ–°ç§å­: ${seeds[newSeedIndex].name}!`, 'info');
                    }
                }

                updateUI();

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            elements.money.textContent = gameState.money;
            elements.level.textContent = gameState.level;
            elements.xp.textContent = gameState.xp;
            elements.maxXp.textContent = gameState.maxXp;
            elements.plotsCount.textContent = gameState.plots;

            // æ›´æ–°å•†åº—ç§å­å¯ç”¨æ€§
            document.querySelectorAll('.seed-item').forEach(item => {
                const seedId = item.getAttribute('data-seed-id');
                const seed = getSeedById(seedId);

                if (gameState.money < seed.price) {
                    item.classList.add('opacity-50');
                } else {
                    item.classList.remove('opacity-50');
                }

                // æ›´æ–°ç§å­æ•°é‡æ˜¾ç¤º
                const inventorySpan = item.querySelector('span.text-sm');
                if (inventorySpan) {
                    inventorySpan.textContent = `åº“å­˜: ${gameState.purchasedSeeds[seedId] || 0}`;
                }
            });

            // æ£€æŸ¥æ‰©å±•å†œç”°æŒ‰é’®
            checkExpandFarmButton();
        }

        // é€šè¿‡IDè·å–ç§å­
        function getSeedById(id) {
            return seeds.find(seed => seed.id === id);
        }

        // ç”Ÿæˆæ¯æ—¥å¤©æ°”
        function generateWeather() {
            const weatherWeights = [0.5, 0.25, 0.15, 0.1]; // æ™´å¤©ã€é›¨å¤©ã€é˜´å¤©ã€æš´é£é›¨çš„æ¦‚ç‡æƒé‡
            const random = Math.random();
            let cumulativeWeight = 0;

            for (let i = 0; i < weatherTypes.length; i++) {
                cumulativeWeight += weatherWeights[i];
                if (random <= cumulativeWeight) {
                    gameState.weather = weatherTypes[i].id;
                    break;
                }
            }

            // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œä¿å­˜æ¸¸æˆæ•°æ®ï¼Œé¿å…é‡å¤ä¿å­˜
            // ä¿å­˜æ“ä½œå·²ç§»è‡³initGameå‡½æ•°ä¸­
        }

        // æ¸²æŸ“å¤©æ°”ä¿¡æ¯
        function renderWeather() {
            const weather = weatherTypes.find(w => w.id === gameState.weather);
            document.getElementById('weather-icon').textContent = weather.icon;
            document.getElementById('weather-name').textContent = weather.name;
            document.getElementById('weather-effects').textContent =
                `ç”Ÿé•¿: ${weather.effect.growth > 1 ? '+' : ''}${Math.round((weather.effect.growth - 1) * 100)}% ` +
                `å”®ä»·: ${weather.effect.price > 1 ? '+' : ''}${Math.round((weather.effect.price - 1) * 100)}%`;
        }

        // ç”Ÿæˆæ¯æ—¥ä»»åŠ¡
        function generateDailyTasks() {
            const shuffled = [...tasks].sort(() => 0.5 - Math.random());
            gameState.tasks = shuffled.slice(0, 3).map(task => ({
                ...task,
                progress: 0,
                completed: false
            }));

            // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œä¿å­˜æ¸¸æˆæ•°æ®ï¼Œé¿å…é‡å¤ä¿å­˜
            // ä¿å­˜æ“ä½œå·²ç§»è‡³initGameå‡½æ•°ä¸­
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks() {
            const tasksList = document.getElementById('tasks-list');

            if (gameState.tasks.length === 0) {
                tasksList.innerHTML = '<p class="text-gray-500 italic">ä»Šæ—¥æ²¡æœ‰ä»»åŠ¡</p>';
                return;
            }

            tasksList.innerHTML = gameState.tasks.map(task => `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium">${task.name}</h3>
                        <span class="text-sm ${task.completed ? 'text-green-600' : 'text-gray-600'}">
                            ${task.progress}/${task.goal}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${task.desc}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="progress-bar bg-blue-500 h-2 rounded-full"
                             style="width: ${Math.min(task.progress / task.goal * 100, 100)}%">
                        </div>
                    </div>
                    <div class="mt-2 text-sm text-right">
                        <span class="text-yellow-600">å¥–åŠ±: ${task.reward}é‡‘å¸</span>
                        ${task.completed ?
                          '<span class="ml-2 text-green-600">âœ“ å·²å®Œæˆ</span>' :
                          '<button class="ml-2 claim-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs" ' +
                          'data-task-id="${task.id}" ${task.completed ? "hidden" : ""}>å®Œæˆä»»åŠ¡</button>'}
                    </div>
                </div>
            `).join('');

            // æ·»åŠ é¢†å–å¥–åŠ±æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.claim-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    claimTaskReward(taskId);
                });
            });
        }

        // å®Œæˆç‰¹å®šç±»å‹çš„ä»»åŠ¡è¿›åº¦
        function updateTaskProgress(type, amount = 1) {
            let updated = false;

            gameState.tasks.forEach(task => {
                if (!task.completed && (
                    (type === 'harvest' && task.id.startsWith('harvest')) ||
                    (type === 'plant' && task.id.startsWith('plant')) ||
                    (type === 'sell' && task.id.startsWith('sell')) ||
                    (type === 'upgrade' && task.id.startsWith('upgrade')) ||
                    (type === 'expand' && task.id.startsWith('expand'))
                )) {
                    task.progress += amount;
                    if (task.progress >= task.goal) {
                        task.completed = true;
                        showNotification(`ä»»åŠ¡å®Œæˆ: ${task.name}`, 'info');
                    }
                    updated = true;
                }
            });

            if (updated) {
                renderTasks();

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        }

        // é¢†å–ä»»åŠ¡å¥–åŠ±
        function claimTaskReward(taskId) {
            const task = gameState.tasks.find(t => t.id === taskId);
            if (task && task.completed) {
                gameState.money += task.reward;
                gameState.completedTasks++;

                // ç§»é™¤å·²é¢†å–çš„ä»»åŠ¡
                gameState.tasks = gameState.tasks.filter(t => t.id !== taskId);

                updateUI();
                renderTasks();
                checkAchievements();

                showNotification(`å·²é¢†å–ä»»åŠ¡å¥–åŠ± +${task.reward}é‡‘å¸`, 'success');

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        }

        // æ£€æŸ¥æˆå°±
        function checkAchievements() {
            let newAchievements = false;

            achievements.forEach(achievement => {
                if (!gameState.achievements.includes(achievement.id) &&
                    achievement.condition(gameState)) {

                    gameState.achievements.push(achievement.id);
                    gameState.money += achievement.reward;
                    newAchievements = true;

                    showNotification(`è§£é”æˆå°±: ${achievement.name}! +${achievement.reward}é‡‘å¸`, 'info');
                }
            });

            if (newAchievements) {
                updateUI();

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        }

        // æ£€æŸ¥è¿ç»­ç™»å½•
        function checkDailyLogin() {
            const today = new Date().toDateString();
            const lastPlayed = gameState.lastPlayed;

            if (!lastPlayed) {
                // é¦–æ¬¡æ¸¸ç©
                gameState.dailyStreak = 1;
            } else if (lastPlayed !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (lastPlayed === yesterday.toDateString()) {
                    gameState.dailyStreak++;
                } else {
                    gameState.dailyStreak = 1;
                }
            }

            gameState.lastPlayed = today;

            // æ¯æ—¥ç™»å½•å¥–åŠ±
            if (lastPlayed !== today) {
                const reward = 10 * gameState.dailyStreak;
                gameState.money += reward;

                showNotification(`è¿ç»­ç™»å½• ${gameState.dailyStreak} å¤©! +${reward}é‡‘å¸`, 'info');
                updateUI();

                // ä¿å­˜æ¸¸æˆæ•°æ®
                saveGameData();
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification p-3 rounded-lg shadow-lg text-white fade-in ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'}`;
            notification.innerHTML = `<p>${message}</p>`;

            elements.notifications.appendChild(notification);

            // 3ç§’åç§»é™¤é€šçŸ¥
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ç™»å½•é€»è¾‘
        function checkLogin() {
            const loginModal = document.getElementById('login-modal');
            const isLoggedIn = localStorage.getItem('happyFarmLoggedIn');
            if (!isLoggedIn) {
                loginModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            } else {
                loginModal.style.display = 'none';
                document.body.style.overflow = '';
            }
            const loginForm = document.getElementById('login-form');
            const loginAccount = document.getElementById('login-account');
            const loginPassword = document.getElementById('login-password');
            // ç™»å½•æŒ‰é’®äº‹ä»¶
            document.getElementById('login-btn').onclick = function() {
                if(!loginAccount.value || !loginPassword.value){
                    showNotification('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ', 'error');
                    return;
                }
                // ç®¡ç†å‘˜è´¦å·åˆ¤æ–­
                if(loginAccount.value === 'dyyssb' && loginPassword.value === 'dyyssb'){
                    localStorage.setItem('happyFarmLoggedIn', 'admin');
                    loginModal.style.display = 'none';
                    document.body.style.overflow = '';
                    showNotification('ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼', 'success');
                    // æ˜¾ç¤ºç®¡ç†å‘˜æŒ‰é’®
                    document.getElementById('admin-open-btn').style.display = 'block';
                    initGame();
                    return;
                }
                // åªå…è®¸è´¦å·å¯†ç æ–¹å¼ç™»å½•
                const users = JSON.parse(localStorage.getItem('happyFarmUsers') || '[]');
                const userInfo = users.find(u => u.account === loginAccount.value && u.password === loginPassword.value);
                if(userInfo){
                    localStorage.setItem('happyFarmLoggedIn', userInfo.type || 'account');
                    localStorage.setItem('happyFarmUserInfo', JSON.stringify(userInfo));
                    loginModal.style.display = 'none';
                    document.body.style.overflow = '';
                    showNotification('ç™»å½•æˆåŠŸï¼', 'success');
                    initGame();
                } else {
                    showNotification('è´¦å·æˆ–å¯†ç é”™è¯¯ï¼Œè¯·å…ˆæ³¨å†Œï¼', 'error');
                }
            };
            // æ³¨å†ŒæŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.register-btn').forEach(btn => {
                btn.onclick = function() {
                    const currentType = this.getAttribute('data-type');
                    if(!loginAccount.value || !loginPassword.value){
                        showNotification('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ', 'error');
                        return;
                    }
                    // ç®¡ç†å‘˜è´¦å·ä¸èƒ½æ³¨å†Œ
                    if(loginAccount.value === 'dyyssb'){
                        showNotification('è¯¥è´¦å·ä¸ºç®¡ç†å‘˜ä¸“ç”¨ï¼Œä¸èƒ½æ³¨å†Œï¼', 'error');
                        return;
                    }
                    // æ³¨å†Œæ—¶å­˜å…¥happyFarmUsers
                    let users = JSON.parse(localStorage.getItem('happyFarmUsers') || '[]');
                    if(users.find(u => u.account === loginAccount.value)){
                        showNotification('è¯¥è´¦å·å·²è¢«æ³¨å†Œï¼', 'error');
                        return;
                    }
                    const userInfo = {
                        type: currentType,
                        account: loginAccount.value,
                        password: loginPassword.value,
                        lastPlayed: new Date().toLocaleString(),
                        money: 100,
                        xp: 0,
                        level: 1
                    };
                    users.push(userInfo);
                    localStorage.setItem('happyFarmUsers', JSON.stringify(users));
                    localStorage.setItem('happyFarmUserInfo', JSON.stringify(userInfo));
                    localStorage.setItem('happyFarmLoggedIn', currentType);
                    loginModal.style.display = 'none';
                    document.body.style.overflow = '';
                    showNotification('æ³¨å†Œå¹¶ç™»å½•æˆåŠŸï¼', 'success');
                    initGame();
                };
            });
        }
        // é€€å‡ºç™»å½•é€»è¾‘
        function setupLogoutBtn() {
            const logoutBtn = document.getElementById('logout-btn');
            // å§‹ç»ˆæ˜¾ç¤ºé€€å‡ºç™»å½•æŒ‰é’®ï¼ˆå³ä½¿åœ¨ç™»å½•å¼¹çª—æ—¶ä¹Ÿå¯è§ï¼‰
            logoutBtn.style.display = 'block';
            logoutBtn.onclick = function() {
                localStorage.removeItem('happyFarmLoggedIn');
                location.reload();
            };
        }
        // é¡µé¢åŠ è½½æ—¶å…ˆæ£€æŸ¥ç™»å½•
        window.onload = function() {
            checkLogin();
            if (localStorage.getItem('happyFarmLoggedIn')) {
                initGame();
            }
            setupLogoutBtn();
            // ç®¡ç†å‘˜æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
            if(localStorage.getItem('happyFarmLoggedIn') === 'admin'){
                document.getElementById('admin-open-btn').style.display = 'block';
                document.getElementById('admin-grow-btn').style.display = 'block';
            } else {
                document.getElementById('admin-open-btn').style.display = 'none';
                document.getElementById('admin-grow-btn').style.display = 'none';
            }
            document.getElementById('admin-open-btn').onclick = function() {
                showAdminPanel();
            };
            document.getElementById('admin-grow-btn').onclick = function() {
                // ç«‹å³å®Œæˆæ‰€æœ‰å†œç”°ä½œç‰©ç”Ÿé•¿
                if(Array.isArray(gameState.farmData)){
                    for(let i=0;i<gameState.farmData.length;i++){
                        if(gameState.farmData[i].state === 'planted' && gameState.farmData[i].growth !== 'completed'){
                            gameState.farmData[i].growth = 'completed';
                            gameState.farmData[i].progress = gameState.farmData[i].growthTime;
                        }
                    }
                    renderFarm();
                    saveGameData();
                    showNotification('æ‰€æœ‰ä½œç‰©å·²æˆç†Ÿï¼', 'success');
                }
            };
        };

        // ç®¡ç†å‘˜é¢æ¿é€»è¾‘
        function showAdminPanel() {
            const adminPanel = document.getElementById('admin-panel');
            adminPanel.style.display = 'flex';
            // æ˜¾ç¤ºå½“å‰æ¸¸æˆæ•°æ®
            document.getElementById('admin-money').value = gameState.money;
            document.getElementById('admin-xp').value = gameState.xp;
            document.getElementById('admin-level').value = gameState.level;
            document.getElementById('admin-weather').value = gameState.weather;
            // æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
            const users = JSON.parse(localStorage.getItem('happyFarmUsers') || '[]');
            let html = '<table class="min-w-full border text-center"><thead><tr><th class="border px-2">è´¦å·</th><th class="border px-2">æ³¨å†Œæ–¹å¼</th><th class="border px-2">æœ€è¿‘æ¸¸ç©</th><th class="border px-2">é‡‘å¸</th><th class="border px-2">ç»éªŒ</th><th class="border px-2">ç­‰çº§</th></tr></thead><tbody>';
            users.forEach(u => {
                html += `<tr><td class="border px-2">${u.account}</td><td class="border px-2">${u.type}</td><td class="border px-2">${u.lastPlayed||''}</td><td class="border px-2">${u.money||''}</td><td class="border px-2">${u.xp||''}</td><td class="border px-2">${u.level||''}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('admin-users-list').innerHTML = html;
            // ä¿å­˜æŒ‰é’®
            document.getElementById('admin-save').onclick = function() {
                gameState.money = parseInt(document.getElementById('admin-money').value)||0;
                gameState.xp = parseInt(document.getElementById('admin-xp').value)||0;
                gameState.level = parseInt(document.getElementById('admin-level').value)||1;
                gameState.weather = document.getElementById('admin-weather').value;
                updateUI();
                renderWeather();
                saveGameData();
                showNotification('æ•°æ®å·²ä¿å­˜', 'success');
            };
            // å…³é—­æŒ‰é’®
            document.getElementById('admin-close').onclick = function() {
                adminPanel.style.display = 'none';
            };
        }
    </script>
<p style="border-radius: 8px; text-align: center; font-size: 12px; color: #fff; margin-top: 16px;position: fixed; left: 8px; bottom: 8px; z-index: 10; background: rgba(0, 0, 0, 0.8); padding: 4px 8px;">Made with <img src="https://enzostvs-deepsite.hf.space/logo.svg" alt="DeepSite Logo" style="width: 16px; height: 16px; vertical-align: middle;display:inline-block;margin-right:3px;filter:brightness(0) invert(1);"><a href="https://enzostvs-deepsite.hf.space" style="color: #fff;text-decoration: underline;" target="_blank" >DeepSite</a> - ğŸ§¬ <a href="https://enzostvs-deepsite.hf.space?remix=diyuyang/boss" style="color: #fff;text-decoration: underline;" target="_blank" >Remix</a></p></body>
</html>
